<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nasworld ✨ Anastasia's Learning Universe</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Quicksand:wght@400;500;600;700&family=Patrick+Hand&display=swap" rel="stylesheet">
<style>
:root {
  --bg-deep: #0f0b2e;
  --bg-mid: #1a1147;
  --bg-card: #251b5e;
  --bg-card-hover: #2f2370;
  --gold: #ffd700;
  --gold-soft: #ffe566;
  --coral: #ff7b7b;
  --coral-soft: #ffb3b3;
  --mint: #7bffb5;
  --mint-soft: #b3ffd6;
  --lavender: #b57bff;
  --lavender-soft: #d4b3ff;
  --sky: #7bb3ff;
  --sky-soft: #b3d6ff;
  --teal: #7bffe0;
  --pink: #ff7bdb;
  --text-primary: #f0eaff;
  --text-secondary: #b8a9d4;
  --text-dim: #7a6b9a;
  --success: #4ade80;
  --error: #f87171;
  --warning: #fbbf24;
  --radius-sm: 8px;
  --radius-md: 16px;
  --radius-lg: 24px;
  --radius-xl: 32px;
  --shadow-glow: 0 0 30px rgba(181,123,255,0.2);
  --shadow-card: 0 8px 32px rgba(0,0,0,0.3);
  --shadow-float: 0 16px 48px rgba(0,0,0,0.4);
  --font-display: 'Fredoka', sans-serif;
  --font-body: 'Quicksand', sans-serif;
  --font-hand: 'Patrick Hand', cursive;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: var(--font-body);
  background: var(--bg-deep);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

/* === STARFIELD BACKGROUND === */
.starfield {
  position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background: radial-gradient(ellipse at 20% 50%, #1a1060 0%, var(--bg-deep) 70%);
}
.starfield::before, .starfield::after {
  content: ''; position: absolute; inset: 0; border-radius: 50%;
}
.starfield::before {
  background: radial-gradient(2px 2px at 20px 30px, rgba(255,255,255,0.8), transparent),
    radial-gradient(2px 2px at 40px 70px, rgba(255,215,0,0.6), transparent),
    radial-gradient(1px 1px at 90px 40px, rgba(255,255,255,0.5), transparent),
    radial-gradient(2px 2px at 130px 80px, rgba(181,123,255,0.5), transparent),
    radial-gradient(1px 1px at 160px 30px, rgba(255,255,255,0.6), transparent),
    radial-gradient(2px 2px at 200px 60px, rgba(255,215,0,0.4), transparent),
    radial-gradient(1px 1px at 50px 120px, rgba(255,255,255,0.7), transparent),
    radial-gradient(2px 2px at 100px 150px, rgba(123,255,181,0.4), transparent),
    radial-gradient(1px 1px at 180px 140px, rgba(255,255,255,0.5), transparent),
    radial-gradient(2px 2px at 250px 20px, rgba(255,123,219,0.4), transparent);
  background-size: 270px 170px;
  animation: twinkle 8s ease-in-out infinite alternate;
}
.starfield::after {
  background: radial-gradient(1px 1px at 30px 50px, rgba(255,255,255,0.4), transparent),
    radial-gradient(2px 2px at 70px 100px, rgba(255,215,0,0.3), transparent),
    radial-gradient(1px 1px at 110px 20px, rgba(255,255,255,0.5), transparent),
    radial-gradient(1px 1px at 150px 90px, rgba(181,123,255,0.3), transparent),
    radial-gradient(2px 2px at 190px 50px, rgba(255,255,255,0.4), transparent),
    radial-gradient(1px 1px at 230px 110px, rgba(123,179,255,0.4), transparent),
    radial-gradient(1px 1px at 80px 160px, rgba(255,255,255,0.3), transparent);
  background-size: 250px 180px;
  animation: twinkle 12s ease-in-out infinite alternate-reverse;
}

/* === ANIMATIONS === */
@keyframes twinkle {
  0% { opacity: 0.6; }
  100% { opacity: 1; }
}
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-10px); }
}
@keyframes pulse-glow {
  0%, 100% { filter: brightness(1) drop-shadow(0 0 8px currentColor); }
  50% { filter: brightness(1.3) drop-shadow(0 0 16px currentColor); }
}
@keyframes pop-in {
  0% { transform: scale(0) rotate(-10deg); opacity: 0; }
  60% { transform: scale(1.1) rotate(2deg); opacity: 1; }
  100% { transform: scale(1) rotate(0deg); opacity: 1; }
}
@keyframes slide-up {
  0% { transform: translateY(40px); opacity: 0; }
  100% { transform: translateY(0); opacity: 1; }
}
@keyframes shake-wrong {
  0%, 100% { transform: translateX(0); }
  20% { transform: translateX(-8px); }
  40% { transform: translateX(8px); }
  60% { transform: translateX(-4px); }
  80% { transform: translateX(4px); }
}
@keyframes celebrate {
  0% { transform: scale(1); }
  25% { transform: scale(1.15) rotate(-3deg); }
  50% { transform: scale(1.1) rotate(3deg); }
  75% { transform: scale(1.15) rotate(-2deg); }
  100% { transform: scale(1); }
}
@keyframes grow-flower {
  0% { transform: scale(0) translateY(20px); opacity: 0; }
  60% { transform: scale(1.2) translateY(-5px); opacity: 1; }
  100% { transform: scale(1) translateY(0); opacity: 1; }
}
@keyframes particle-rise {
  0% { transform: translateY(0) scale(1); opacity: 1; }
  100% { transform: translateY(-80px) scale(0); opacity: 0; }
}
@keyframes bot-move {
  0% { transform: translate(0, 0); }
  100% { transform: translate(var(--dx), var(--dy)); }
}
@keyframes pulse-border {
  0%, 100% { border-color: rgba(255,215,0,0.3); }
  50% { border-color: rgba(255,215,0,0.8); }
}
@keyframes timer-pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

/* === LAYOUT === */
.app-container {
  position: relative; z-index: 1;
  min-height: 100vh;
  display: flex; flex-direction: column;
}

/* === TOP BAR === */
.top-bar {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 24px;
  background: rgba(26,17,71,0.8);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid rgba(181,123,255,0.15);
  position: sticky; top: 0; z-index: 100;
}
.top-bar-left { display: flex; align-items: center; gap: 12px; }
.top-bar-right { display: flex; align-items: center; gap: 16px; }

.home-btn {
  background: rgba(181,123,255,0.15);
  border: 1px solid rgba(181,123,255,0.3);
  color: var(--lavender-soft);
  font-family: var(--font-display);
  font-size: 18px;
  padding: 6px 14px;
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all 0.3s;
}
.home-btn:hover { background: rgba(181,123,255,0.3); transform: scale(1.05); }

.token-display {
  display: flex; align-items: center; gap: 6px;
  background: rgba(255,215,0,0.1);
  border: 1px solid rgba(255,215,0,0.3);
  padding: 6px 14px;
  border-radius: 50px;
  font-family: var(--font-display);
  font-weight: 600;
  color: var(--gold);
  font-size: 16px;
}
.token-icon { font-size: 20px; animation: float 3s ease-in-out infinite; }

.streak-display {
  display: flex; align-items: center; gap: 6px;
  background: rgba(255,123,123,0.1);
  border: 1px solid rgba(255,123,123,0.3);
  padding: 6px 14px;
  border-radius: 50px;
  font-family: var(--font-display);
  font-weight: 600;
  color: var(--coral);
  font-size: 16px;
}

.level-display {
  display: flex; align-items: center; gap: 6px;
  background: rgba(123,255,181,0.1);
  border: 1px solid rgba(123,255,181,0.3);
  padding: 6px 14px;
  border-radius: 50px;
  font-family: var(--font-display);
  font-weight: 600;
  color: var(--mint);
  font-size: 16px;
}

/* === MAIN CONTENT === */
.main-content {
  flex: 1;
  padding: 24px;
  max-width: 1200px;
  margin: 0 auto;
  width: 100%;
}

/* === SCREENS === */
.screen {
  display: none;
  animation: slide-up 0.5s ease-out;
}
.screen.active { display: block; }

/* === HOME SCREEN === */
.home-hero {
  text-align: center;
  padding: 40px 20px;
}
.home-title {
  font-family: var(--font-display);
  font-size: 42px;
  font-weight: 700;
  background: linear-gradient(135deg, var(--gold), var(--coral), var(--lavender));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 8px;
}
.home-subtitle {
  font-family: var(--font-body);
  font-size: 18px;
  color: var(--text-secondary);
  font-weight: 500;
}

/* Lumi Companion */
.lumi-container {
  display: flex; flex-direction: column; align-items: center;
  margin: 30px 0;
}
.lumi {
  width: 120px; height: 120px;
  position: relative;
  animation: float 4s ease-in-out infinite;
  cursor: pointer;
  transition: transform 0.3s;
}
.lumi:hover { transform: scale(1.1); }
.lumi-body {
  width: 100px; height: 100px;
  border-radius: 50%;
  background: radial-gradient(circle at 35% 35%, #fff5cc, var(--gold), #cc9900);
  position: absolute; top: 10px; left: 10px;
  box-shadow: 0 0 40px rgba(255,215,0,0.5), 0 0 80px rgba(255,215,0,0.2);
}
.lumi-eye {
  width: 14px; height: 16px;
  background: var(--bg-deep);
  border-radius: 50%;
  position: absolute;
  top: 38px;
}
.lumi-eye.left { left: 30px; }
.lumi-eye.right { left: 56px; }
.lumi-eye::after {
  content: ''; position: absolute;
  width: 5px; height: 5px;
  background: white; border-radius: 50%;
  top: 3px; left: 3px;
}
.lumi-mouth {
  width: 20px; height: 10px;
  border-bottom: 3px solid var(--bg-deep);
  border-radius: 0 0 50% 50%;
  position: absolute;
  top: 58px; left: 40px;
}
.lumi-blush {
  width: 12px; height: 8px;
  background: rgba(255,123,123,0.4);
  border-radius: 50%;
  position: absolute;
  top: 52px;
}
.lumi-blush.left { left: 20px; }
.lumi-blush.right { left: 68px; }
.lumi-sparkle {
  position: absolute;
  font-size: 16px;
  animation: pulse-glow 2s ease-in-out infinite;
  color: var(--gold);
}
.lumi-sparkle:nth-child(1) { top: -5px; left: 50px; animation-delay: 0s; }
.lumi-sparkle:nth-child(2) { top: 20px; right: -10px; animation-delay: 0.5s; }
.lumi-sparkle:nth-child(3) { bottom: 0; left: -5px; animation-delay: 1s; }

.lumi-speech {
  background: rgba(255,255,255,0.1);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: var(--radius-lg);
  padding: 16px 24px;
  margin-top: 20px;
  max-width: 400px;
  font-family: var(--font-hand);
  font-size: 20px;
  color: var(--text-primary);
  text-align: center;
  animation: pop-in 0.5s ease-out;
}

/* World Cards */
.worlds-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 24px;
  margin-top: 30px;
}

.world-card {
  background: var(--bg-card);
  border: 2px solid rgba(181,123,255,0.2);
  border-radius: var(--radius-xl);
  padding: 32px 24px;
  text-align: center;
  cursor: pointer;
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  position: relative;
  overflow: hidden;
}
.world-card::before {
  content: '';
  position: absolute; inset: 0;
  background: radial-gradient(circle at 50% 0%, rgba(255,255,255,0.05), transparent 70%);
}
.world-card:hover {
  transform: translateY(-8px) scale(1.02);
  border-color: rgba(181,123,255,0.5);
  box-shadow: var(--shadow-glow), var(--shadow-float);
}
.world-card-icon {
  font-size: 56px;
  margin-bottom: 16px;
  display: block;
}
.world-card-title {
  font-family: var(--font-display);
  font-size: 24px;
  font-weight: 700;
  margin-bottom: 8px;
}
.world-card-desc {
  color: var(--text-secondary);
  font-size: 15px;
  line-height: 1.5;
}
.world-card-progress {
  margin-top: 16px;
  height: 8px;
  background: rgba(255,255,255,0.1);
  border-radius: 50px;
  overflow: hidden;
}
.world-card-progress-fill {
  height: 100%;
  border-radius: 50px;
  transition: width 0.8s ease-out;
}
.world-card.math .world-card-progress-fill { background: linear-gradient(90deg, var(--sky), var(--mint)); }
.world-card.literacy .world-card-progress-fill { background: linear-gradient(90deg, var(--coral), var(--pink)); }
.world-card.stem .world-card-progress-fill { background: linear-gradient(90deg, var(--teal), var(--sky)); }
.world-card.garden .world-card-progress-fill { background: linear-gradient(90deg, var(--lavender), var(--gold)); }
.world-card.challenges .world-card-progress-fill { background: linear-gradient(90deg, var(--gold), var(--coral)); }

/* === ACTIVITY SELECTION === */
.activity-header {
  text-align: center;
  margin-bottom: 32px;
}
.activity-header h2 {
  font-family: var(--font-display);
  font-size: 32px;
  font-weight: 700;
  margin-bottom: 8px;
}
.activity-header p {
  color: var(--text-secondary);
  font-size: 16px;
}

.activity-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 20px;
}

.activity-card {
  background: var(--bg-card);
  border: 2px solid rgba(255,255,255,0.1);
  border-radius: var(--radius-lg);
  padding: 24px 20px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s;
  position: relative;
}
.activity-card:hover {
  transform: translateY(-4px);
  border-color: rgba(181,123,255,0.4);
  box-shadow: var(--shadow-card);
}
.activity-card.locked {
  opacity: 0.5;
  cursor: not-allowed;
  filter: grayscale(0.5);
}
.activity-card.locked:hover {
  transform: none;
  border-color: rgba(255,255,255,0.1);
  box-shadow: none;
}
.activity-card-icon { font-size: 40px; margin-bottom: 12px; display: block; }
.activity-card-name {
  font-family: var(--font-display);
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 6px;
}
.activity-card-level {
  font-size: 13px;
  color: var(--text-dim);
}
.activity-card-lock {
  font-size: 12px;
  color: var(--text-dim);
  margin-top: 6px;
  font-style: italic;
}
.activity-card .mastery-stars {
  margin-top: 10px;
  display: flex; justify-content: center; gap: 4px;
}
.mastery-star { font-size: 18px; opacity: 0.3; }
.mastery-star.filled { opacity: 1; }

/* Grade Section Headers */
.grade-section {
  margin-top: 32px;
}
.grade-label {
  font-family: var(--font-display);
  font-size: 16px;
  font-weight: 600;
  color: var(--text-secondary);
  padding: 8px 16px;
  background: rgba(255,255,255,0.05);
  border-radius: var(--radius-md);
  margin-bottom: 16px;
  display: inline-block;
}

/* === GAME AREA === */
.game-area {
  max-width: 700px;
  margin: 0 auto;
}

.game-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 24px;
}
.game-title {
  font-family: var(--font-display);
  font-size: 22px;
  font-weight: 600;
}
.game-progress-dots {
  display: flex; gap: 6px;
}
.game-dot {
  width: 12px; height: 12px;
  border-radius: 50%;
  background: rgba(255,255,255,0.15);
  transition: all 0.3s;
}
.game-dot.done { background: var(--success); }
.game-dot.current { background: var(--gold); box-shadow: 0 0 8px var(--gold); transform: scale(1.2); }
.game-dot.wrong { background: var(--error); }

.question-card {
  background: var(--bg-card);
  border: 2px solid rgba(181,123,255,0.2);
  border-radius: var(--radius-xl);
  padding: 40px 32px;
  text-align: center;
  position: relative;
  min-height: 300px;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 24px;
}

.question-text {
  font-family: var(--font-display);
  font-size: 28px;
  font-weight: 600;
  line-height: 1.4;
}
.question-text.large { font-size: 48px; }
.question-text.medium { font-size: 32px; }

/* Confidence Check */
.confidence-check {
  display: flex; gap: 16px; justify-content: center;
  margin: 16px 0;
}
.confidence-btn {
  display: flex; flex-direction: column; align-items: center; gap: 4px;
  background: rgba(255,255,255,0.05);
  border: 2px solid rgba(255,255,255,0.1);
  border-radius: var(--radius-md);
  padding: 12px 20px;
  cursor: pointer;
  transition: all 0.3s;
  color: var(--text-secondary);
  font-family: var(--font-body);
  font-size: 13px;
  font-weight: 600;
}
.confidence-btn:hover {
  border-color: rgba(255,215,0,0.5);
  background: rgba(255,215,0,0.1);
  color: var(--gold);
}
.confidence-btn.selected {
  border-color: var(--gold);
  background: rgba(255,215,0,0.15);
  color: var(--gold);
}
.confidence-emoji { font-size: 28px; }

/* Answer Options */
.answer-options {
  display: flex; flex-wrap: wrap; gap: 12px;
  justify-content: center;
  margin-top: 8px;
}
.answer-btn {
  background: rgba(255,255,255,0.08);
  border: 2px solid rgba(255,255,255,0.15);
  border-radius: var(--radius-md);
  padding: 14px 28px;
  font-family: var(--font-display);
  font-size: 24px;
  font-weight: 600;
  color: var(--text-primary);
  cursor: pointer;
  transition: all 0.3s;
  min-width: 80px;
}
.answer-btn:hover {
  border-color: rgba(181,123,255,0.5);
  background: rgba(181,123,255,0.15);
  transform: scale(1.05);
}
.answer-btn.correct {
  border-color: var(--success);
  background: rgba(74,222,128,0.2);
  animation: celebrate 0.6s ease;
}
.answer-btn.wrong {
  border-color: var(--error);
  background: rgba(248,113,113,0.2);
  animation: shake-wrong 0.5s ease;
}

/* Text Input */
.text-input-area {
  width: 100%;
  max-width: 400px;
}
.text-input {
  width: 100%;
  background: rgba(255,255,255,0.08);
  border: 2px solid rgba(255,255,255,0.15);
  border-radius: var(--radius-md);
  padding: 14px 20px;
  font-family: var(--font-display);
  font-size: 28px;
  font-weight: 600;
  color: var(--text-primary);
  text-align: center;
  outline: none;
  transition: all 0.3s;
}
.text-input:focus {
  border-color: var(--lavender);
  box-shadow: 0 0 16px rgba(181,123,255,0.3);
}
.text-input::placeholder { color: var(--text-dim); }

.submit-btn {
  background: linear-gradient(135deg, var(--lavender), var(--sky));
  border: none;
  border-radius: var(--radius-md);
  padding: 14px 40px;
  font-family: var(--font-display);
  font-size: 18px;
  font-weight: 600;
  color: white;
  cursor: pointer;
  transition: all 0.3s;
  margin-top: 12px;
}
.submit-btn:hover { transform: scale(1.05); box-shadow: 0 8px 24px rgba(181,123,255,0.3); }
.submit-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

/* Visual Manipulatives */
.manipulative-area {
  display: flex; flex-wrap: wrap; gap: 8px;
  justify-content: center;
  padding: 20px;
  min-height: 100px;
}

.block {
  width: 48px; height: 48px;
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 20px;
  cursor: pointer;
  transition: all 0.3s;
  user-select: none;
}
.block:hover { transform: scale(1.1); }
.block.filled { background: linear-gradient(135deg, var(--sky), var(--mint)); border: 2px solid var(--sky); }
.block.empty { background: rgba(255,255,255,0.06); border: 2px dashed rgba(255,255,255,0.2); }
.block.selected { box-shadow: 0 0 12px var(--gold); border-color: var(--gold); transform: scale(1.1); }

/* Ten Frame */
.ten-frame {
  display: grid;
  grid-template-columns: repeat(5, 52px);
  grid-template-rows: repeat(2, 52px);
  gap: 6px;
  padding: 12px;
  background: rgba(255,255,255,0.05);
  border: 2px solid rgba(255,255,255,0.1);
  border-radius: var(--radius-md);
}
.ten-frame-cell {
  width: 52px; height: 52px;
  border: 2px solid rgba(255,255,255,0.15);
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.3s;
  cursor: pointer;
}
.ten-frame-cell.filled {
  background: radial-gradient(circle, var(--coral), #e05555);
  border-color: var(--coral);
  box-shadow: 0 2px 8px rgba(255,123,123,0.3);
}
.ten-frame-cell.filled::after {
  content: '\25CF';
  color: white;
  font-size: 24px;
}

/* Number Bond Diagram */
.number-bond {
  position: relative;
  width: 280px; height: 200px;
  margin: 0 auto;
}
.nb-circle {
  width: 70px; height: 70px;
  border-radius: 50%;
  border: 3px solid;
  display: flex; align-items: center; justify-content: center;
  font-family: var(--font-display);
  font-size: 28px;
  font-weight: 700;
  position: absolute;
  background: var(--bg-card);
  cursor: pointer;
  transition: all 0.3s;
}
.nb-circle.top { top: 0; left: 50%; transform: translateX(-50%); border-color: var(--gold); color: var(--gold); }
.nb-circle.left { bottom: 0; left: 30px; border-color: var(--sky); color: var(--sky); }
.nb-circle.right { bottom: 0; right: 30px; border-color: var(--mint); color: var(--mint); }
.nb-circle.target {
  border-style: dashed;
  background: rgba(255,255,255,0.05);
}
.nb-line {
  position: absolute;
  background: rgba(255,255,255,0.2);
  height: 3px;
}
.nb-line.left-line {
  width: 80px;
  top: 95px; left: 55px;
  transform: rotate(40deg);
}
.nb-line.right-line {
  width: 80px;
  top: 95px; right: 55px;
  transform: rotate(-40deg);
}

/* Drag and Drop Words */
.word-bank {
  display: flex; flex-wrap: wrap; gap: 10px;
  justify-content: center;
  padding: 16px;
  background: rgba(255,255,255,0.03);
  border: 1px dashed rgba(255,255,255,0.15);
  border-radius: var(--radius-md);
  min-height: 60px;
}
.word-tile {
  background: linear-gradient(135deg, rgba(181,123,255,0.2), rgba(123,179,255,0.2));
  border: 2px solid rgba(181,123,255,0.3);
  border-radius: var(--radius-sm);
  padding: 8px 16px;
  font-family: var(--font-display);
  font-size: 18px;
  font-weight: 600;
  color: var(--text-primary);
  cursor: grab;
  transition: all 0.2s;
  user-select: none;
}
.word-tile:hover { transform: scale(1.05); border-color: var(--lavender); }
.word-tile.dragging { opacity: 0.5; transform: scale(0.95); }
.word-tile.placed { opacity: 0.4; pointer-events: none; }

.sentence-slots {
  display: flex; flex-wrap: wrap; gap: 8px;
  justify-content: center;
  padding: 16px;
  min-height: 60px;
}
.sentence-slot {
  min-width: 80px;
  height: 44px;
  border: 2px dashed rgba(255,255,255,0.2);
  border-radius: var(--radius-sm);
  display: flex; align-items: center; justify-content: center;
  font-family: var(--font-display);
  font-size: 18px;
  color: var(--text-primary);
  transition: all 0.3s;
  padding: 4px 12px;
}
.sentence-slot.filled {
  border-style: solid;
  border-color: var(--mint);
  background: rgba(123,255,181,0.1);
}
.sentence-slot.highlight {
  border-color: var(--gold);
  background: rgba(255,215,0,0.1);
}

/* === FEEDBACK === */
.feedback-overlay {
  position: fixed; inset: 0;
  display: flex; align-items: center; justify-content: center;
  z-index: 200;
  background: rgba(0,0,0,0.5);
  backdrop-filter: blur(8px);
  animation: fade-in 0.3s ease;
}
@keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }

.feedback-card {
  background: var(--bg-card);
  border-radius: var(--radius-xl);
  padding: 40px;
  text-align: center;
  max-width: 420px;
  width: 90%;
  box-shadow: var(--shadow-float);
  animation: pop-in 0.4s ease-out;
}
.feedback-icon { font-size: 64px; margin-bottom: 16px; }
.feedback-title {
  font-family: var(--font-display);
  font-size: 28px;
  font-weight: 700;
  margin-bottom: 8px;
}
.feedback-message {
  color: var(--text-secondary);
  font-size: 16px;
  margin-bottom: 8px;
  line-height: 1.5;
}
.feedback-tokens {
  font-family: var(--font-display);
  font-size: 20px;
  color: var(--gold);
  font-weight: 600;
  margin: 12px 0;
}
.feedback-reflect {
  background: rgba(255,215,0,0.1);
  border: 1px solid rgba(255,215,0,0.2);
  border-radius: var(--radius-md);
  padding: 12px 16px;
  margin: 12px 0;
  font-family: var(--font-hand);
  font-size: 18px;
  color: var(--gold-soft);
}
.feedback-btn {
  background: linear-gradient(135deg, var(--lavender), var(--sky));
  border: none;
  border-radius: var(--radius-md);
  padding: 14px 36px;
  font-family: var(--font-display);
  font-size: 18px;
  font-weight: 600;
  color: white;
  cursor: pointer;
  transition: all 0.3s;
  margin-top: 16px;
}
.feedback-btn:hover { transform: scale(1.05); }

/* Particles */
.particle {
  position: fixed;
  pointer-events: none;
  z-index: 300;
  animation: particle-rise 1s ease-out forwards;
}

/* === GARDEN VIEW === */
.garden-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
  gap: 12px;
  padding: 24px;
  background: rgba(123,255,181,0.03);
  border: 1px solid rgba(123,255,181,0.1);
  border-radius: var(--radius-xl);
}
.garden-plot {
  width: 80px; height: 80px;
  border-radius: var(--radius-md);
  background: rgba(255,255,255,0.03);
  border: 1px dashed rgba(255,255,255,0.1);
  display: flex; align-items: center; justify-content: center;
  font-size: 36px;
  transition: all 0.3s;
}
.garden-plot.grown { border-style: solid; border-color: rgba(123,255,181,0.3); animation: grow-flower 0.6s ease-out; }
.garden-plot.golden { border-color: rgba(255,215,0,0.5); box-shadow: 0 0 12px rgba(255,215,0,0.2); }

/* === BAR MODEL === */
.bar-model {
  display: flex; flex-direction: column; gap: 8px;
  padding: 20px;
  width: 100%;
  max-width: 500px;
}
.bar-row {
  display: flex; gap: 2px;
  height: 50px;
}
.bar-segment {
  flex: 1;
  border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-family: var(--font-display);
  font-size: 20px;
  font-weight: 700;
  color: white;
  transition: all 0.3s;
}
.bar-segment.part-a { background: linear-gradient(135deg, var(--sky), #5599ff); }
.bar-segment.part-b { background: linear-gradient(135deg, var(--mint), #55cc88); }
.bar-segment.whole { background: linear-gradient(135deg, var(--lavender), #9955ff); }
.bar-segment.unknown {
  background: rgba(255,255,255,0.1);
  border: 2px dashed var(--gold);
  color: var(--gold);
}

.bar-label {
  text-align: center;
  font-family: var(--font-body);
  font-size: 14px;
  color: var(--text-secondary);
  margin-top: 4px;
}

/* === PATTERN AREA === */
.pattern-row {
  display: flex; gap: 12px; align-items: center; justify-content: center;
  flex-wrap: wrap;
}
.pattern-item {
  width: 60px; height: 60px;
  border-radius: var(--radius-md);
  display: flex; align-items: center; justify-content: center;
  font-size: 32px;
  background: rgba(255,255,255,0.05);
  border: 2px solid rgba(255,255,255,0.15);
  transition: all 0.3s;
}
.pattern-item.mystery {
  border: 2px dashed var(--gold);
  background: rgba(255,215,0,0.1);
  font-size: 24px;
  color: var(--gold);
}

/* === PHONICS === */
.letter-display {
  font-family: var(--font-display);
  font-size: 72px;
  font-weight: 700;
  color: var(--coral);
  text-shadow: 0 0 20px rgba(255,123,123,0.3);
}
.sound-btn {
  background: rgba(255,123,123,0.15);
  border: 2px solid rgba(255,123,123,0.3);
  border-radius: 50%;
  width: 56px; height: 56px;
  display: flex; align-items: center; justify-content: center;
  font-size: 24px;
  cursor: pointer;
  transition: all 0.3s;
}
.sound-btn:hover { transform: scale(1.1); background: rgba(255,123,123,0.3); }

/* === STORY GARDEN === */
.story-prompt {
  background: rgba(255,215,0,0.08);
  border: 1px solid rgba(255,215,0,0.2);
  border-radius: var(--radius-lg);
  padding: 24px;
  font-family: var(--font-hand);
  font-size: 22px;
  color: var(--gold-soft);
  text-align: center;
  line-height: 1.5;
}
.story-textarea {
  width: 100%;
  min-height: 150px;
  background: rgba(255,255,255,0.05);
  border: 2px solid rgba(255,255,255,0.15);
  border-radius: var(--radius-md);
  padding: 16px;
  font-family: var(--font-hand);
  font-size: 20px;
  color: var(--text-primary);
  resize: vertical;
  outline: none;
  line-height: 1.6;
}
.story-textarea:focus { border-color: var(--lavender); }
.word-suggestions {
  display: flex; flex-wrap: wrap; gap: 8px;
  margin-top: 12px;
}
.word-suggestion {
  background: rgba(181,123,255,0.1);
  border: 1px solid rgba(181,123,255,0.3);
  border-radius: 50px;
  padding: 4px 12px;
  font-size: 14px;
  color: var(--lavender-soft);
  cursor: pointer;
  transition: all 0.2s;
}
.word-suggestion:hover { background: rgba(181,123,255,0.25); }

/* === SETTINGS / PROGRESS === */
.progress-section {
  background: var(--bg-card);
  border-radius: var(--radius-xl);
  padding: 24px;
  margin-bottom: 20px;
}
.progress-section h3 {
  font-family: var(--font-display);
  font-size: 20px;
  font-weight: 600;
  margin-bottom: 16px;
}
.skill-row {
  display: flex; align-items: center; gap: 12px;
  padding: 8px 0;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}
.skill-row:last-child { border-bottom: none; }
.skill-name { flex: 1; font-size: 15px; }
.skill-bar {
  width: 120px; height: 8px;
  background: rgba(255,255,255,0.1);
  border-radius: 50px;
  overflow: hidden;
}
.skill-bar-fill {
  height: 100%;
  border-radius: 50px;
  background: linear-gradient(90deg, var(--lavender), var(--mint));
  transition: width 0.5s;
}

/* === CODING PLAYGROUND === */
.code-playground {
  display: grid;
  grid-template-columns: 1fr 300px;
  gap: 20px;
  align-items: start;
}
.code-grid-container {
  background: rgba(255,255,255,0.05);
  border: 2px solid rgba(123,179,255,0.2);
  border-radius: var(--radius-lg);
  padding: 16px;
  position: relative;
}
.code-grid {
  display: grid;
  gap: 2px;
  margin: 0 auto;
}
.code-cell {
  width: 48px; height: 48px;
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 4px;
  display: flex; align-items: center; justify-content: center;
  font-size: 20px;
  position: relative;
  transition: all 0.3s;
}
.code-cell.wall { background: rgba(255,255,255,0.15); }
.code-cell.gem { background: rgba(255,215,0,0.1); }
.code-cell.goal { background: rgba(123,255,181,0.1); border-color: var(--mint); }
.code-cell.red { background: rgba(255,123,123,0.15); }
.code-cell.blue { background: rgba(123,179,255,0.15); }
.code-cell.green { background: rgba(123,255,181,0.15); }

.code-bot {
  position: absolute;
  width: 40px; height: 40px;
  font-size: 28px;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.3s ease;
  z-index: 5;
}

.code-panel {
  background: var(--bg-card);
  border-radius: var(--radius-lg);
  padding: 16px;
  display: flex; flex-direction: column; gap: 12px;
}
.code-commands {
  display: flex; flex-wrap: wrap; gap: 8px;
}
.code-cmd-btn {
  background: rgba(123,179,255,0.15);
  border: 2px solid rgba(123,179,255,0.3);
  border-radius: var(--radius-sm);
  padding: 8px 14px;
  font-size: 20px;
  cursor: pointer;
  transition: all 0.2s;
  color: var(--text-primary);
  font-family: var(--font-display);
}
.code-cmd-btn:hover { transform: scale(1.1); background: rgba(123,179,255,0.3); }
.code-cmd-btn.loop { border-color: rgba(255,215,0,0.3); background: rgba(255,215,0,0.1); }
.code-cmd-btn.cond { border-color: rgba(181,123,255,0.3); background: rgba(181,123,255,0.1); }
.code-cmd-btn.func { border-color: rgba(255,123,123,0.3); background: rgba(255,123,123,0.1); }

.code-sequence {
  min-height: 100px;
  background: rgba(255,255,255,0.03);
  border: 1px dashed rgba(255,255,255,0.15);
  border-radius: var(--radius-md);
  padding: 8px;
  display: flex; flex-wrap: wrap; gap: 4px;
  align-content: flex-start;
}
.code-block {
  background: rgba(123,179,255,0.2);
  border: 1px solid rgba(123,179,255,0.3);
  border-radius: var(--radius-sm);
  padding: 4px 10px;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex; align-items: center; gap: 4px;
}
.code-block:hover { background: rgba(123,179,255,0.35); }
.code-block.loop-block {
  border-color: rgba(255,215,0,0.4);
  background: rgba(255,215,0,0.15);
}
.code-block.cond-block {
  border-color: rgba(181,123,255,0.4);
  background: rgba(181,123,255,0.15);
}
.code-block.func-block {
  border-color: rgba(255,123,123,0.4);
  background: rgba(255,123,123,0.15);
}

.code-run-btn {
  background: linear-gradient(135deg, var(--mint), var(--sky));
  border: none;
  border-radius: var(--radius-md);
  padding: 12px;
  font-family: var(--font-display);
  font-size: 16px;
  font-weight: 600;
  color: var(--bg-deep);
  cursor: pointer;
  transition: all 0.3s;
}
.code-run-btn:hover { transform: scale(1.05); }

.code-var-display {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: var(--radius-sm);
  padding: 8px 12px;
  font-family: monospace;
  font-size: 14px;
  color: var(--teal);
}

/* === CIRCUIT BUILDER === */
.circuit-board {
  display: grid;
  gap: 2px;
  background: rgba(255,255,255,0.03);
  border: 2px solid rgba(123,179,255,0.2);
  border-radius: var(--radius-lg);
  padding: 16px;
}
.circuit-cell {
  width: 60px; height: 60px;
  border: 1px solid rgba(255,255,255,0.08);
  display: flex; align-items: center; justify-content: center;
  font-size: 24px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
}
.circuit-cell:hover { background: rgba(255,255,255,0.05); }
.circuit-cell.wire { background: rgba(123,179,255,0.1); }
.circuit-cell.wire::after {
  content: '';
  width: 80%; height: 4px;
  background: var(--sky);
  border-radius: 2px;
}
.circuit-cell.bulb-on { color: var(--gold); text-shadow: 0 0 20px var(--gold); }
.circuit-cell.bulb-off { color: var(--text-dim); }

.circuit-parts {
  display: flex; gap: 12px; flex-wrap: wrap;
  padding: 12px;
  background: rgba(255,255,255,0.03);
  border-radius: var(--radius-md);
  margin-top: 12px;
}
.circuit-part {
  background: rgba(255,255,255,0.08);
  border: 2px solid rgba(255,255,255,0.15);
  border-radius: var(--radius-sm);
  padding: 8px 16px;
  font-size: 20px;
  cursor: grab;
  transition: all 0.2s;
}
.circuit-part:hover { transform: scale(1.1); border-color: var(--sky); }

/* === SCIENCE SIMS === */
.sim-container {
  background: rgba(255,255,255,0.03);
  border: 2px solid rgba(123,255,224,0.2);
  border-radius: var(--radius-lg);
  padding: 20px;
  min-height: 300px;
  position: relative;
}
.sim-interactive {
  display: flex; flex-wrap: wrap; gap: 12px;
  justify-content: center;
  align-items: center;
  padding: 16px;
}
.sim-label {
  font-family: var(--font-display);
  font-size: 14px;
  color: var(--text-secondary);
  text-align: center;
  margin-top: 8px;
}
.sim-object {
  padding: 12px 20px;
  background: rgba(255,255,255,0.08);
  border: 2px solid rgba(255,255,255,0.15);
  border-radius: var(--radius-md);
  font-size: 18px;
  cursor: grab;
  transition: all 0.2s;
  user-select: none;
}
.sim-object:hover { transform: scale(1.05); border-color: var(--teal); }
.sim-dropzone {
  min-width: 100px; min-height: 60px;
  border: 2px dashed rgba(123,255,224,0.3);
  border-radius: var(--radius-md);
  display: flex; align-items: center; justify-content: center;
  padding: 12px;
  transition: all 0.3s;
}
.sim-dropzone.hover { border-color: var(--teal); background: rgba(123,255,224,0.1); }
.sim-dropzone.correct { border-color: var(--success); background: rgba(74,222,128,0.1); }

/* Ramp sim */
.ramp-sim {
  position: relative;
  width: 100%; height: 250px;
}
.ramp-slider {
  -webkit-appearance: none;
  appearance: none;
  width: 200px;
  height: 8px;
  border-radius: 4px;
  background: rgba(255,255,255,0.15);
  outline: none;
}
.ramp-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 20px; height: 20px;
  border-radius: 50%;
  background: var(--teal);
  cursor: pointer;
}

/* === ESCAPE ROOM === */
.escape-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 24px;
}
.escape-timer {
  font-family: var(--font-display);
  font-size: 24px;
  font-weight: 700;
  color: var(--coral);
  padding: 8px 20px;
  background: rgba(255,123,123,0.1);
  border: 2px solid rgba(255,123,123,0.3);
  border-radius: 50px;
}
.escape-timer.warning {
  animation: timer-pulse 1s infinite;
  color: var(--error);
}
.escape-progress {
  display: flex; gap: 8px;
}
.escape-puzzle-dot {
  width: 16px; height: 16px;
  border-radius: 50%;
  background: rgba(255,255,255,0.15);
  transition: all 0.3s;
}
.escape-puzzle-dot.solved { background: var(--success); }
.escape-puzzle-dot.current { background: var(--gold); box-shadow: 0 0 8px var(--gold); }

/* === STAR TRIALS === */
.trial-banner {
  background: linear-gradient(135deg, rgba(255,215,0,0.15), rgba(181,123,255,0.15));
  border: 2px solid rgba(255,215,0,0.3);
  border-radius: var(--radius-xl);
  padding: 24px;
  text-align: center;
  margin: 20px 0;
  cursor: pointer;
  transition: all 0.3s;
}
.trial-banner:hover {
  border-color: rgba(255,215,0,0.6);
  transform: translateY(-4px);
}

/* === COMPREHENSION === */
.passage-box {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: var(--radius-lg);
  padding: 20px 24px;
  font-family: var(--font-body);
  font-size: 17px;
  line-height: 1.8;
  color: var(--text-primary);
  text-align: left;
  max-height: 250px;
  overflow-y: auto;
}

/* Grammar highlight */
.grammar-word {
  display: inline-block;
  padding: 2px 8px;
  margin: 2px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all 0.2s;
  font-size: 18px;
}
.grammar-word:hover { background: rgba(181,123,255,0.2); }
.grammar-word.noun { background: rgba(123,179,255,0.2); border: 1px solid rgba(123,179,255,0.4); }
.grammar-word.verb { background: rgba(255,123,123,0.2); border: 1px solid rgba(255,123,123,0.4); }
.grammar-word.adj { background: rgba(123,255,181,0.2); border: 1px solid rgba(123,255,181,0.4); }
.grammar-word.selected { box-shadow: 0 0 8px currentColor; transform: scale(1.05); }

/* === FRACTION VISUALS === */
.fraction-bar-container {
  display: flex; flex-direction: column; gap: 8px;
  align-items: center;
}
.fraction-bar {
  display: flex;
  width: 300px; height: 50px;
  border: 2px solid rgba(255,255,255,0.2);
  border-radius: var(--radius-sm);
  overflow: hidden;
}
.fraction-part {
  height: 100%;
  display: flex; align-items: center; justify-content: center;
  font-family: var(--font-display);
  font-size: 16px;
  font-weight: 600;
  transition: all 0.3s;
  cursor: pointer;
}
.fraction-part.shaded { background: linear-gradient(135deg, var(--sky), var(--lavender)); color: white; }
.fraction-part.unshaded { background: rgba(255,255,255,0.05); color: var(--text-dim); }
.fraction-part:hover { filter: brightness(1.2); }

.fraction-circle {
  width: 120px; height: 120px;
  border-radius: 50%;
  border: 3px solid rgba(255,255,255,0.2);
  position: relative;
  overflow: hidden;
}

/* === CLOCK FACE === */
.clock-container {
  width: 200px; height: 200px;
  position: relative;
  margin: 0 auto;
}

/* === AREA GRID === */
.area-grid {
  display: grid;
  gap: 1px;
  background: rgba(255,255,255,0.1);
  border: 2px solid rgba(255,255,255,0.2);
  border-radius: var(--radius-sm);
  padding: 2px;
}
.area-cell {
  width: 36px; height: 36px;
  background: rgba(255,255,255,0.03);
  cursor: pointer;
  transition: all 0.2s;
}
.area-cell:hover { background: rgba(123,179,255,0.2); }
.area-cell.selected { background: rgba(123,179,255,0.4); border: 1px solid var(--sky); }
.area-cell.perimeter { background: rgba(255,215,0,0.3); border: 2px solid var(--gold); }

/* === RESPONSIVE === */
@media (max-width: 768px) {
  .home-title { font-size: 28px; }
  .main-content { padding: 16px; }
  .question-card { padding: 24px 16px; }
  .question-text { font-size: 22px; }
  .question-text.large { font-size: 36px; }
  .worlds-grid { grid-template-columns: 1fr; }
  .code-playground { grid-template-columns: 1fr; }
}

/* === SKILL VIEW — Tabbed Learn / Explore / Quiz === */
.skill-view-header {
  display: flex; align-items: center; gap: 16px; margin-bottom: 20px;
}
.skill-view-title {
  font-family: var(--font-display); font-size: 24px; font-weight: 600;
}
.skill-tabs {
  display: flex; gap: 8px; margin-bottom: 24px;
  background: rgba(255,255,255,0.05); border-radius: var(--radius-lg); padding: 6px;
}
.skill-tab {
  flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px;
  padding: 12px 16px; border-radius: var(--radius-md);
  background: transparent; border: none; color: var(--text-dim);
  font-family: var(--font-display); font-size: 15px; font-weight: 600;
  cursor: pointer; transition: all 0.3s;
}
.skill-tab:hover { color: var(--text-secondary); background: rgba(255,255,255,0.05); }
.skill-tab.active {
  background: var(--bg-card); color: var(--text-primary);
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
.skill-tab-icon { font-size: 20px; }
.skill-tab-check { color: var(--success); font-size: 14px; }
.skill-tab-content { min-height: 400px; }

/* Skill quiz start */
.skill-quiz-start { text-align: center; padding: 60px 20px; }
.skill-quiz-icon { font-size: 60px; margin-bottom: 16px; }
.skill-quiz-title { font-family: var(--font-display); font-size: 24px; font-weight: 600; margin-bottom: 8px; }
.skill-quiz-desc { color: var(--text-secondary); margin-bottom: 24px; }

/* === LESSON RENDERER === */
.lesson-dots { display: flex; gap: 6px; justify-content: center; margin-bottom: 20px; }
.lesson-dot { width: 10px; height: 10px; border-radius: 50%; background: rgba(255,255,255,0.15); transition: all 0.3s; }
.lesson-dot.done { background: var(--success); }
.lesson-dot.current { background: var(--gold); box-shadow: 0 0 8px var(--gold); transform: scale(1.3); }

.lesson-visual {
  font-size: 40px; text-align: center; padding: 24px;
  background: rgba(255,255,255,0.05); border-radius: var(--radius-lg);
  margin-bottom: 20px; line-height: 1.6;
}
.lesson-visual.try { border: 2px solid var(--gold); background: rgba(255,215,0,0.05); }

.lesson-image { font-size: 80px; text-align: center; margin-bottom: 16px; }

.lesson-text {
  font-size: 18px; line-height: 1.7; text-align: center;
  color: var(--text-primary); margin-bottom: 20px;
}
.lesson-text b { color: var(--gold); }

.lesson-lumi-tip {
  display: flex; align-items: flex-start; gap: 10px;
  background: rgba(255,215,0,0.08); border: 1px solid rgba(255,215,0,0.2);
  border-radius: var(--radius-md); padding: 12px 16px;
  font-size: 14px; color: var(--gold-soft); margin-bottom: 20px;
}
.lesson-lumi-icon { font-size: 20px; flex-shrink: 0; }

.lesson-nav { display: flex; gap: 12px; justify-content: center; margin-top: 20px; }
.lesson-btn {
  padding: 12px 28px; border-radius: var(--radius-md);
  font-family: var(--font-display); font-size: 16px; font-weight: 600;
  cursor: pointer; border: none; transition: all 0.3s;
}
.lesson-btn-back { background: rgba(255,255,255,0.1); color: var(--text-secondary); }
.lesson-btn-back:hover { background: rgba(255,255,255,0.2); }
.lesson-btn-next { background: linear-gradient(135deg, var(--sky), var(--lavender)); color: white; }
.lesson-btn-next:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(123,179,255,0.4); }
.lesson-btn-done { background: linear-gradient(135deg, var(--mint), var(--teal)); color: var(--bg-deep); }
.lesson-btn-done:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(123,255,181,0.4); }

.lesson-try-badge {
  display: inline-block; background: var(--gold); color: var(--bg-deep);
  font-family: var(--font-display); font-weight: 600; font-size: 14px;
  padding: 4px 16px; border-radius: 50px; margin-bottom: 16px;
}

.lesson-try-options { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; }
.lesson-try-btn {
  padding: 14px 28px; border-radius: var(--radius-md);
  background: var(--bg-card); border: 2px solid rgba(255,255,255,0.15);
  color: var(--text-primary); font-family: var(--font-display);
  font-size: 20px; font-weight: 600; cursor: pointer; transition: all 0.2s;
  min-width: 80px;
}
.lesson-try-btn:hover:not(:disabled) { border-color: var(--lavender); transform: translateY(-2px); }
.lesson-try-btn.correct { border-color: var(--success); background: rgba(74,222,128,0.15); }
.lesson-try-btn.wrong { border-color: var(--error); background: rgba(248,113,113,0.15); }

.lesson-try-input-wrap { display: flex; gap: 12px; justify-content: center; align-items: center; }
.lesson-try-input {
  width: 80px; padding: 12px; text-align: center; font-size: 28px;
  font-family: var(--font-display); font-weight: 700;
  background: var(--bg-card); border: 2px solid rgba(255,255,255,0.2);
  border-radius: var(--radius-md); color: var(--text-primary); outline: none;
}
.lesson-try-input:focus { border-color: var(--lavender); }

.lesson-try-feedback {
  text-align: center; padding: 12px; margin-top: 16px;
  border-radius: var(--radius-md); font-size: 16px; font-weight: 600;
  display: none;
}
.lesson-try-feedback.show { display: block; }
.lesson-try-feedback.correct { background: rgba(74,222,128,0.15); color: var(--success); }
.lesson-try-feedback.wrong { background: rgba(248,113,113,0.15); color: var(--coral-soft); }

.lesson-complete { text-align: center; padding: 40px 20px; }
.lesson-complete-icon { font-size: 60px; margin-bottom: 12px; }
.lesson-complete-title { font-family: var(--font-display); font-size: 28px; font-weight: 700; color: var(--gold); margin-bottom: 8px; }
.lesson-complete-msg { color: var(--text-secondary); font-size: 16px; margin-bottom: 24px; }

.lesson-empty { text-align: center; padding: 60px 20px; color: var(--text-dim); }

/* Lesson demo elements */
.ten-frame-demo {
  display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px;
  max-width: 280px; margin: 0 auto;
}
.tf-dot {
  width: 48px; height: 48px; border-radius: 50%;
  background: rgba(255,255,255,0.08); border: 2px solid rgba(255,255,255,0.15);
}
.tf-dot.filled { background: var(--sky); border-color: var(--sky); }

.bond-demo { text-align: center; }
.bond-whole { font-family: var(--font-display); font-size: 36px; font-weight: 700; color: var(--gold); }
.bond-line { width: 60px; height: 2px; background: var(--text-dim); margin: 8px auto; position: relative; }
.bond-line::before, .bond-line::after {
  content: ''; position: absolute; width: 40px; height: 2px; background: var(--text-dim); top: 0;
}
.bond-line::before { left: -30px; transform: rotate(30deg); transform-origin: right; }
.bond-line::after { right: -30px; transform: rotate(-30deg); transform-origin: left; }
.bond-parts { display: flex; gap: 40px; justify-content: center; margin-top: 8px; }
.bond-part { font-family: var(--font-display); font-size: 28px; font-weight: 600; color: var(--sky); }

.bar-demo { display: flex; height: 40px; border-radius: 8px; overflow: hidden; margin-bottom: 8px; }
.bar-part { display: flex; align-items: center; justify-content: center; font-family: var(--font-display); font-weight: 700; font-size: 18px; }
.bar-total { font-family: var(--font-display); font-size: 18px; font-weight: 600; text-align: center; }

.crossed { text-decoration: line-through; opacity: 0.4; }

.cmp-demo { display: flex; align-items: center; gap: 16px; justify-content: center; flex-wrap: wrap; }
.cmp-group { text-align: center; }
.cmp-count { font-family: var(--font-display); font-size: 32px; font-weight: 700; margin-bottom: 4px; }
.cmp-sign { font-size: 36px; font-weight: 700; color: var(--gold); }

.phon-demo { display: flex; align-items: center; gap: 8px; justify-content: center; font-size: 32px; }
.phon-letter { color: var(--coral); font-weight: 700; }
.phon-blend { color: var(--text-dim); }
.phon-family { color: var(--sky); font-weight: 700; }
.phon-word { color: var(--gold); font-weight: 700; }
.phon-family-list { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; font-size: 24px; }
.phon-family-list b { color: var(--sky); }

.sight-demo { text-align: center; }
.sight-big { font-family: var(--font-display); font-size: 72px; font-weight: 700; color: var(--gold); }
.sight-word-grid { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
.sight-word-grid span {
  padding: 8px 16px; background: var(--bg-card); border-radius: 8px;
  font-family: var(--font-display); font-size: 20px; font-weight: 600;
  border: 1px solid rgba(255,255,255,0.1);
}

.spell-demo { font-size: 32px; display: flex; align-items: center; gap: 8px; justify-content: center; }
.spell-letter {
  display: inline-flex; align-items: center; justify-content: center;
  width: 48px; height: 48px; background: var(--bg-card); border: 2px solid var(--lavender);
  border-radius: 8px; font-family: var(--font-display); font-weight: 700; font-size: 28px;
}

.vocab-compare { display: flex; align-items: center; gap: 16px; justify-content: center; font-size: 24px; }
.vocab-plain { color: var(--text-dim); }
.vocab-arrow { color: var(--text-dim); font-size: 20px; }
.vocab-fancy { color: var(--gold); font-family: var(--font-display); font-weight: 700; }

.sent-demo { font-size: 22px; text-align: center; }
.sent-cap { color: var(--sky); font-weight: 700; }
.sent-verb { color: var(--coral); font-weight: 700; }
.sent-end { color: var(--gold); font-weight: 700; }

.poem-demo { text-align: left; display: inline-block; }
.poem-line { font-family: var(--font-hand); font-size: 22px; margin-bottom: 4px; }

.array-demo { display: flex; flex-direction: column; gap: 4px; align-items: center; }
.array-row { display: flex; gap: 4px; }

.place-val-demo { display: flex; gap: 24px; justify-content: center; }
.pv-col { text-align: center; font-family: var(--font-display); font-weight: 600; }
.pv-label { font-size: 14px; color: var(--text-dim); margin-bottom: 4px; }
.pv-blocks { font-size: 24px; margin-bottom: 4px; }

.code-demo { display: flex; flex-direction: column; gap: 8px; text-align: left; max-width: 300px; margin: 0 auto; }
.code-block {
  padding: 10px 16px; border-radius: 8px; font-family: var(--font-display); font-size: 15px;
  background: rgba(123,179,255,0.1); border-left: 3px solid var(--sky);
}
.code-block.loop { background: rgba(181,123,255,0.1); border-color: var(--lavender); }
.code-block.cond { background: rgba(255,215,0,0.1); border-color: var(--gold); }
.code-block.nested { margin-left: 16px; margin-top: 6px; font-size: 14px; }
.code-block.bug { border-color: var(--error); background: rgba(248,113,113,0.1); }

.var-demo { display: flex; justify-content: center; }
.var-box {
  padding: 16px 24px; border: 2px solid var(--lavender); border-radius: 12px;
  background: rgba(181,123,255,0.1); text-align: center;
}
.var-label { font-size: 12px; color: var(--lavender-soft); text-transform: uppercase; letter-spacing: 0.08em; }
.var-value { font-family: var(--font-display); font-size: 32px; font-weight: 700; color: var(--gold); }

/* Sort interaction */
.lesson-sort-items { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 20px; }
.lesson-sort-chip {
  padding: 10px 16px; border-radius: 50px; font-size: 16px; font-weight: 600;
  background: var(--bg-card); border: 2px solid rgba(255,255,255,0.15);
  cursor: pointer; transition: all 0.2s; user-select: none;
}
.lesson-sort-chip.selected { border-color: var(--gold); background: rgba(255,215,0,0.1); transform: scale(1.05); }
.lesson-sort-chip.placed { opacity: 0.4; cursor: default; }
.lesson-sort-chip.shake { animation: shake-wrong 0.4s; }

.lesson-sort-zones { display: flex; gap: 16px; justify-content: center; flex-wrap: wrap; }
.lesson-sort-zone {
  flex: 1; min-width: 140px; max-width: 200px; padding: 16px;
  border: 2px dashed rgba(255,255,255,0.2); border-radius: var(--radius-lg);
  text-align: center; cursor: pointer; transition: all 0.2s; min-height: 120px;
}
.lesson-sort-zone:hover { border-color: var(--lavender); background: rgba(181,123,255,0.05); }
.lesson-sort-zone-label {
  font-family: var(--font-display); font-size: 16px; font-weight: 600;
  color: var(--text-secondary); margin-bottom: 10px;
}
.lesson-sort-zone-items { display: flex; flex-direction: column; gap: 6px; }

/* Match interaction */
.lesson-match-grid { display: flex; gap: 32px; justify-content: center; }
.lesson-match-col { display: flex; flex-direction: column; gap: 10px; }
.lesson-match-item {
  padding: 12px 20px; border-radius: var(--radius-md);
  background: var(--bg-card); border: 2px solid rgba(255,255,255,0.15);
  cursor: pointer; transition: all 0.2s; font-size: 16px; font-weight: 600;
  text-align: center; min-width: 100px;
}
.lesson-match-item:hover:not(.matched) { border-color: var(--lavender); }
.lesson-match-item.selected { border-color: var(--gold); background: rgba(255,215,0,0.1); }
.lesson-match-item.matched { border-color: var(--success); background: rgba(74,222,128,0.15); opacity: 0.6; cursor: default; }
.lesson-match-item.shake { animation: shake-wrong 0.4s; }

/* === FLASHCARD STYLES === */
.fc-progress { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
.fc-count { font-size: 14px; color: var(--text-dim); white-space: nowrap; }
.fc-bar { flex: 1; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; }
.fc-bar-fill { height: 100%; background: var(--gold); border-radius: 3px; transition: width 0.3s; }

.fc-card {
  perspective: 600px; cursor: pointer; margin: 0 auto 24px; max-width: 400px;
  min-height: 220px;
}
.fc-front, .fc-back {
  padding: 40px 24px; border-radius: var(--radius-xl); text-align: center;
  backface-visibility: hidden; transition: transform 0.5s;
  position: absolute; width: 100%; top: 0;
}
.fc-card { position: relative; }
.fc-front {
  background: var(--bg-card); border: 2px solid rgba(181,123,255,0.3);
  z-index: 2; transform: rotateY(0);
}
.fc-back {
  background: linear-gradient(135deg, var(--bg-card), rgba(181,123,255,0.15));
  border: 2px solid rgba(123,255,181,0.3);
  transform: rotateY(180deg);
}
.fc-card.flipped .fc-front { transform: rotateY(-180deg); }
.fc-card.flipped .fc-back { transform: rotateY(0); }

.fc-image { font-size: 40px; margin-bottom: 8px; }
.fc-front-text { font-family: var(--font-display); font-size: 36px; font-weight: 700; color: var(--text-primary); }
.fc-tap-hint { font-size: 13px; color: var(--text-dim); margin-top: 12px; }
.fc-back-text { font-family: var(--font-display); font-size: 22px; font-weight: 600; color: var(--mint); }
.fc-example { font-size: 15px; color: var(--text-secondary); margin-top: 8px; font-style: italic; }

.fc-rating { text-align: center; margin-top: 16px; }
.fc-rating-label { font-size: 14px; color: var(--text-dim); margin-bottom: 10px; }
.fc-rating-btns { display: flex; gap: 16px; justify-content: center; }
.fc-rate-btn {
  padding: 12px 24px; border-radius: var(--radius-md); border: none;
  font-family: var(--font-display); font-size: 16px; font-weight: 600; cursor: pointer;
  transition: all 0.2s;
}
.fc-rate-no { background: rgba(248,113,113,0.15); color: var(--coral); border: 1px solid var(--coral); }
.fc-rate-no:hover { background: rgba(248,113,113,0.3); }
.fc-rate-yes { background: rgba(74,222,128,0.15); color: var(--success); border: 1px solid var(--success); }
.fc-rate-yes:hover { background: rgba(74,222,128,0.3); }

.fc-results { text-align: center; padding: 40px 20px; }
.fc-results-icon { font-size: 60px; margin-bottom: 12px; }
.fc-results-title { font-family: var(--font-display); font-size: 24px; font-weight: 600; margin-bottom: 4px; }
.fc-results-pct { font-size: 48px; font-family: var(--font-display); font-weight: 700; color: var(--gold); margin-bottom: 8px; }
.fc-results-msg { color: var(--text-secondary); margin-bottom: 24px; }
.fc-results-btns { display: flex; gap: 12px; justify-content: center; }

/* === VERSION BANNER === */
.version-banner {
  background: linear-gradient(135deg, #ff6b6b, #ffd93d, #6bcb77, #4d96ff);
  background-size: 300% 300%;
  animation: banner-shine 3s ease infinite;
  color: #1a1a2e;
  text-align: center;
  padding: 14px 20px;
  border-radius: var(--radius-lg);
  margin-bottom: 20px;
  font-family: var(--font-display);
  font-weight: 700;
  font-size: 1.1rem;
  letter-spacing: 0.03em;
  box-shadow: 0 4px 20px rgba(255,107,107,0.3);
}
@keyframes banner-shine {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

/* === STREAK CALENDAR === */
.streak-calendar {
  background: rgba(255,255,255,0.05); border-radius: var(--radius-lg);
  padding: 16px; text-align: center;
}
.streak-cal-label { font-size: 12px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 10px; }
.streak-cal-dots { display: flex; gap: 10px; justify-content: center; margin-bottom: 8px; }
.streak-cal-dot { text-align: center; }
.streak-cal-day { font-size: 11px; color: var(--text-dim); margin-bottom: 4px; }
.streak-cal-circle {
  width: 28px; height: 28px; border-radius: 50%;
  background: rgba(255,255,255,0.08); border: 2px solid rgba(255,255,255,0.15);
  transition: all 0.3s;
}
.streak-cal-dot.active .streak-cal-circle { background: var(--success); border-color: var(--success); }
.streak-cal-dot.today .streak-cal-circle { border-color: var(--gold); box-shadow: 0 0 8px rgba(255,215,0,0.4); }
.streak-cal-count { font-size: 13px; color: var(--text-secondary); }

/* === REVIEW DUE BADGE === */
.review-due-badge {
  position: absolute; top: -8px; right: -8px;
  background: var(--coral); color: white; font-size: 11px; font-weight: 700;
  padding: 3px 8px; border-radius: 50px; z-index: 2;
  animation: pulse-glow 2s infinite;
}
.review-banner-icon { margin-right: 4px; }
#review-due-banner {
  background: rgba(255,123,123,0.1); border: 1px solid rgba(255,123,123,0.3);
  border-radius: var(--radius-md); padding: 10px 16px;
  color: var(--coral-soft); font-size: 14px; font-weight: 600;
  text-align: center; margin-bottom: 16px; cursor: pointer;
}
.learn-done-dot { font-size: 14px; margin-left: 4px; }

/* === UTILITY === */
.hidden { display: none !important; }
.text-center { text-align: center; }
.mt-2 { margin-top: 16px; }
.mt-3 { margin-top: 24px; }
.mb-2 { margin-bottom: 16px; }
.gap-row { display: flex; gap: 12px; align-items: center; justify-content: center; }

/* Back Button */
.back-btn {
  display: inline-flex; align-items: center; gap: 8px;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: var(--radius-md);
  padding: 8px 16px;
  font-family: var(--font-body);
  font-size: 14px;
  font-weight: 600;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.3s;
  margin-bottom: 20px;
}
.back-btn:hover { background: rgba(255,255,255,0.1); color: var(--text-primary); }

/* Daily Quest */
.quest-banner {
  background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(255,123,123,0.1));
  border: 1px solid rgba(255,215,0,0.25);
  border-radius: var(--radius-lg);
  padding: 16px 24px;
  display: flex; align-items: center; gap: 16px;
  margin-bottom: 24px;
  cursor: pointer;
  transition: all 0.3s;
}
.quest-banner:hover { border-color: rgba(255,215,0,0.5); }
.quest-icon { font-size: 32px; }
.quest-text { flex: 1; }
.quest-title {
  font-family: var(--font-display);
  font-size: 16px;
  font-weight: 600;
  color: var(--gold);
}
.quest-desc {
  font-size: 14px;
  color: var(--text-secondary);
}
.quest-progress {
  font-family: var(--font-display);
  font-size: 14px;
  color: var(--gold-soft);
}

/* Word of the Day */
.wotd-banner {
  background: linear-gradient(135deg, rgba(181,123,255,0.1), rgba(123,179,255,0.1));
  border: 1px solid rgba(181,123,255,0.25);
  border-radius: var(--radius-lg);
  padding: 16px 24px;
  display: flex; align-items: center; gap: 16px;
  margin-bottom: 24px;
  cursor: pointer;
  transition: all 0.3s;
}
.wotd-banner:hover { border-color: rgba(181,123,255,0.5); }
.wotd-word {
  font-family: var(--font-display);
  font-size: 20px;
  font-weight: 700;
  color: var(--lavender);
}
.wotd-def {
  font-size: 14px;
  color: var(--text-secondary);
}

/* Hint button */
.hint-btn {
  background: rgba(255,215,0,0.1);
  border: 1px solid rgba(255,215,0,0.3);
  border-radius: 50px;
  padding: 8px 16px;
  font-family: var(--font-body);
  font-size: 14px;
  font-weight: 600;
  color: var(--gold-soft);
  cursor: pointer;
  transition: all 0.3s;
}
.hint-btn:hover { background: rgba(255,215,0,0.2); }

.hint-text {
  background: rgba(255,215,0,0.08);
  border-radius: var(--radius-md);
  padding: 12px 16px;
  font-family: var(--font-hand);
  font-size: 17px;
  color: var(--gold-soft);
  margin-top: 12px;
  animation: slide-up 0.3s ease-out;
}

/* Visual number transition */
.morphing-number {
  transition: all 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

/* Picture representations */
.picture-objects {
  display: flex; flex-wrap: wrap; gap: 6px; justify-content: center;
}
.picture-object {
  font-size: 28px;
  animation: pop-in 0.3s ease-out;
  animation-fill-mode: both;
}

/* Reset btn */
.reset-btn {
  background: rgba(248,113,113,0.1);
  border: 1px solid rgba(248,113,113,0.3);
  border-radius: var(--radius-md);
  padding: 8px 16px;
  font-size: 13px;
  color: var(--error);
  cursor: pointer;
  transition: all 0.3s;
  font-family: var(--font-body);
}
.reset-btn:hover { background: rgba(248,113,113,0.2); }

/* Challenges section on home */
.challenges-section {
  margin-top: 40px;
}
.challenges-section h3 {
  font-family: var(--font-display);
  font-size: 22px;
  font-weight: 600;
  margin-bottom: 16px;
  text-align: center;
  color: var(--gold);
}
.challenges-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
}

/* === ACHIEVEMENT TOAST === */
.achievement-toast {
  position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
  z-index: 10000; background: linear-gradient(135deg, #251b5e, #3d2d8f);
  border: 2px solid var(--gold); border-radius: var(--radius-lg);
  padding: 14px 20px; display: flex; align-items: center; gap: 14px;
  box-shadow: 0 8px 32px rgba(255,215,0,0.3); transition: top 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  max-width: 380px; width: 90%;
}
.achievement-toast.show { top: 20px; }
.achievement-toast.hide { top: -100px; }
.achievement-toast-icon { font-size: 2.2rem; }
.achievement-toast-body { flex: 1; }
.achievement-toast-label { font-size: 11px; color: var(--gold); text-transform: uppercase; letter-spacing: 0.1em; font-weight: 700; }
.achievement-toast-name { font-size: 16px; font-weight: 700; color: var(--text-primary); margin: 2px 0; }
.achievement-toast-desc { font-size: 12px; color: var(--text-secondary); }

/* === ACHIEVEMENTS SCREEN === */
.achievements-summary { text-align: center; margin-bottom: 24px; }
.achievements-count { font-size: 2rem; font-weight: 700; color: var(--gold); font-family: var(--font-display); }
.achievements-bar { height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; width: 200px; margin: 8px auto; }
.achievements-bar-fill { height: 100%; background: linear-gradient(90deg, var(--gold), var(--coral)); border-radius: 4px; transition: width 0.5s; }
.achievement-category { margin-bottom: 24px; }
.achievement-category-header {
  font-size: 14px; font-weight: 700; color: var(--text-primary); padding: 8px 12px;
  margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;
}
.achievement-category-count { color: var(--text-dim); font-size: 12px; font-weight: 400; }
.achievement-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px;
}
.achievement-badge {
  background: rgba(255,255,255,0.05); border-radius: var(--radius-md); padding: 14px 10px;
  text-align: center; position: relative; border: 1px solid rgba(255,255,255,0.08);
  transition: transform 0.2s;
}
.achievement-badge.earned { background: rgba(255,215,0,0.08); border-color: rgba(255,215,0,0.2); }
.achievement-badge.earned:hover { transform: scale(1.05); }
.achievement-badge.locked { opacity: 0.5; }
.achievement-badge-icon { font-size: 1.8rem; margin-bottom: 6px; display: block; }
.achievement-badge-name { font-size: 12px; font-weight: 700; color: var(--text-primary); margin-bottom: 3px; }
.achievement-badge-desc { font-size: 10px; color: var(--text-dim); line-height: 1.3; }
.achievement-badge-check {
  position: absolute; top: 6px; right: 6px; font-size: 12px; color: var(--success);
  background: rgba(74,222,128,0.2); width: 20px; height: 20px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
}

/* === ACHIEVEMENT SHOWCASE (home) === */
.achievement-showcase-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
.achievement-mini {
  background: rgba(255,215,0,0.08); border: 1px solid rgba(255,215,0,0.15);
  border-radius: 20px; padding: 6px 12px; display: flex; align-items: center; gap: 6px;
  font-size: 12px; cursor: pointer; transition: background 0.2s;
}
.achievement-mini:hover { background: rgba(255,215,0,0.15); }
.achievement-mini-icon { font-size: 16px; }
.achievement-mini-name { color: var(--text-secondary); font-weight: 500; }
.achievement-mini.see-all { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); }

/* === TROPHY BUTTON (topbar) === */
.trophy-btn {
  display: flex; align-items: center; gap: 3px; cursor: pointer;
  font-size: 14px; padding: 4px 8px; border-radius: 12px;
  background: rgba(255,215,0,0.1); border: 1px solid rgba(255,215,0,0.2);
  transition: background 0.2s;
}
.trophy-btn:hover { background: rgba(255,215,0,0.2); }
.trophy-count { font-size: 11px; color: var(--gold); font-weight: 700; }

/* === DYNAMIC QUEST BANNERS === */
.dynamic-quest { cursor: default; }
.dynamic-quest .quest-progress-ring {
  min-width: 44px; height: 44px; border-radius: 50%;
  background: rgba(255,255,255,0.08); border: 2px solid var(--mint);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 700; color: var(--mint);
}
.weekly-quest { border-left: 3px solid var(--gold); }
.weekly-quest .quest-progress-ring { border-color: var(--gold); color: var(--gold); }
.weekly-quest .quest-progress-ring.weekly { border-color: var(--gold); }
.quest-done-check { font-size: 16px; color: var(--success); display: block; margin-top: -2px; }

/* === LUMI MOOD EXPRESSIONS === */
.lumi-mood-excited .lumi-mouth { border-radius: 0 0 50% 50%; height: 10px; background: #333; }
.lumi-mood-proud .lumi-eye { animation: lumi-happy-eyes 2s ease infinite; }
@keyframes lumi-happy-eyes {
  0%, 100% { transform: scaleY(1); }
  50% { transform: scaleY(0.3); }
}
.lumi-mood-concerned .lumi-mouth {
  width: 8px; height: 8px; border-radius: 50%; border: none;
  background: #555; transform: translateX(-50%);
}
.lumi-mood-sleepy .lumi-eye { animation: none; height: 2px; border-radius: 1px; }
.lumi-mouth-grin { border-radius: 0 0 60% 60% !important; height: 10px !important; }
.lumi-mouth-worry { width: 10px !important; height: 6px !important; border-radius: 50% !important; }
.lumi-mouth-sleep { width: 12px !important; height: 2px !important; border-radius: 1px !important; }
.lumi-eye-wide { width: 10px !important; height: 10px !important; }
.lumi-eye-happy { height: 3px !important; border-radius: 3px 3px 0 0 !important; }
.lumi-eye-sleepy { height: 2px !important; }

/* === STORY OVERLAY === */
.story-overlay {
  position: fixed; inset: 0; z-index: 9000; background: rgba(15,11,46,0.92);
  display: flex; align-items: center; justify-content: center; padding: 24px;
  opacity: 0; pointer-events: none; transition: opacity 0.4s;
}
.story-overlay.show { opacity: 1; pointer-events: auto; }
.story-card {
  background: linear-gradient(135deg, #1a1147, #2f2370);
  border: 2px solid var(--gold); border-radius: var(--radius-xl);
  padding: 32px 28px; text-align: center; max-width: 420px; width: 100%;
  box-shadow: 0 0 60px rgba(255,215,0,0.2);
  animation: pop-in 0.5s ease-out;
}
.story-chapter-badge {
  font-size: 11px; text-transform: uppercase; letter-spacing: 0.15em;
  color: var(--gold); font-weight: 700; margin-bottom: 8px;
}
.story-icon { font-size: 3rem; margin-bottom: 12px; }
.story-title { font-size: 20px; font-weight: 700; color: var(--text-primary); font-family: var(--font-display); margin-bottom: 12px; }
.story-text { font-size: 14px; color: var(--text-secondary); line-height: 1.6; margin-bottom: 20px; }
.story-bridge { margin-bottom: 20px; }
.story-bridge-row { display: flex; align-items: center; justify-content: center; gap: 0; }
.story-bridge-star {
  font-size: 24px; opacity: 0.3; transition: opacity 0.3s, transform 0.3s;
}
.story-bridge-star.lit { opacity: 1; transform: scale(1.1); }
.story-bridge-link {
  width: 24px; height: 3px; background: rgba(255,255,255,0.1);
  border-radius: 2px; transition: background 0.3s;
}
.story-bridge-link.lit { background: var(--gold); box-shadow: 0 0 8px rgba(255,215,0,0.4); }

/* === STORY PROGRESS CARD (home) === */
.story-progress-card {
  background: linear-gradient(135deg, rgba(255,215,0,0.08), rgba(181,123,255,0.08));
  border: 1px solid rgba(255,215,0,0.15); border-radius: var(--radius-lg);
  padding: 14px 16px; margin-bottom: 16px; cursor: pointer;
  transition: background 0.2s;
}
.story-progress-card:hover { background: linear-gradient(135deg, rgba(255,215,0,0.12), rgba(181,123,255,0.12)); }
.story-progress-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
.story-progress-icon { font-size: 20px; }
.story-progress-title { font-size: 13px; font-weight: 600; color: var(--text-primary); }
.story-progress-bridge { margin-bottom: 6px; }
.story-progress-bridge .story-bridge-star { font-size: 16px; }
.story-progress-bridge .story-bridge-link { width: 16px; height: 2px; }
.story-progress-next { font-size: 11px; color: var(--text-dim); text-align: center; }

/* === GARDEN ISLAND === */
.island-stage-title { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px; }
.island-stage-name { font-size: 18px; font-weight: 700; color: var(--gold); font-family: var(--font-display); }
.island-stage-next { font-size: 12px; color: var(--text-dim); }
.island-evo-dots { display: flex; gap: 8px; justify-content: center; margin-bottom: 12px; }
.island-evo-dot { font-size: 14px; opacity: 0.3; transition: opacity 0.3s; }
.island-evo-dot.active { opacity: 1; }

.island-visual {
  width: 100%; height: 260px; border-radius: var(--radius-xl); overflow: hidden;
  position: relative; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.1);
  box-shadow: 0 4px 24px rgba(0,0,0,0.3);
}
.island-sky { position: absolute; top: 0; left: 0; right: 0; height: 50%; }
.island-ground {
  position: absolute; bottom: 0; left: 0; right: 0; height: 45%;
  border-radius: 60% 60% 0 0 / 20% 20% 0 0;
}
.island-aurora {
  position: absolute; top: 0; left: 0; right: 0; height: 40%;
  background: linear-gradient(90deg, transparent, rgba(123,255,224,0.15), rgba(181,123,255,0.15), transparent);
  animation: aurora-shift 6s ease-in-out infinite alternate;
}
@keyframes aurora-shift {
  0% { transform: translateX(-10%); opacity: 0.5; }
  100% { transform: translateX(10%); opacity: 1; }
}
.island-rainbow { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); font-size: 40px; opacity: 0.7; }
.island-bird { position: absolute; font-size: 18px; animation: bird-fly 8s linear infinite; }
.island-bird.bird-1 { top: 15%; left: -20px; animation-delay: 0s; }
.island-bird.bird-2 { top: 25%; left: -20px; animation-delay: 4s; }
@keyframes bird-fly {
  0% { transform: translateX(-20px); }
  100% { transform: translateX(calc(100vw + 40px)); }
}
.island-butterfly { position: absolute; font-size: 16px; animation: butterfly-flutter 5s ease-in-out infinite; }
.island-butterfly.bf-1 { top: 40%; left: 20%; }
.island-butterfly.bf-2 { top: 35%; left: 65%; animation-delay: 2.5s; }
@keyframes butterfly-flutter {
  0%, 100% { transform: translate(0, 0) rotate(0deg); }
  25% { transform: translate(15px, -10px) rotate(5deg); }
  50% { transform: translate(30px, 5px) rotate(-5deg); }
  75% { transform: translate(10px, -5px) rotate(3deg); }
}
.island-tree { position: absolute; font-size: 32px; bottom: 55%; }
.island-tree.tree-1 { left: 10%; }
.island-tree.tree-2 { right: 15%; }
.island-waterfall { position: absolute; right: 5%; top: 10%; font-size: 24px; animation: waterfall-flow 2s ease-in-out infinite; }
@keyframes waterfall-flow { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(4px); } }
.island-pond { position: absolute; bottom: 20%; left: 40%; font-size: 20px; opacity: 0.7; }
.island-crystal { position: absolute; font-size: 18px; animation: crystal-glow 3s ease-in-out infinite; }
.island-crystal.c-1 { bottom: 30%; left: 25%; animation-delay: 0s; }
.island-crystal.c-2 { bottom: 25%; right: 20%; animation-delay: 1.5s; }
@keyframes crystal-glow { 0%, 100% { opacity: 0.5; transform: scale(1); } 50% { opacity: 1; transform: scale(1.15); } }
.island-grass { position: absolute; bottom: 10%; left: 50%; transform: translateX(-50%); font-size: 16px; letter-spacing: 12px; opacity: 0.6; }
.island-float-rocks {
  position: absolute; bottom: -10px; left: 10%; right: 10%; height: 20px;
  background: radial-gradient(ellipse at 50% 100%, rgba(100,80,60,0.4), transparent);
}
.island-flowers { position: absolute; inset: 0; pointer-events: none; }
.island-flower {
  position: absolute; transition: all 0.3s;
  animation: flower-sway 4s ease-in-out infinite;
}
.island-flower.golden { filter: drop-shadow(0 0 4px rgba(255,215,0,0.5)); }
@keyframes flower-sway { 0%, 100% { transform: rotate(-3deg); } 50% { transform: rotate(3deg); } }
.island-desc { font-size: 13px; color: var(--text-secondary); text-align: center; font-style: italic; }

/* Island evolution overlay */
.island-evo-overlay {
  position: fixed; inset: 0; z-index: 9500; background: rgba(15,11,46,0.94);
  display: flex; align-items: center; justify-content: center; padding: 24px;
  opacity: 0; pointer-events: none; transition: opacity 0.4s;
}
.island-evo-overlay.show { opacity: 1; pointer-events: auto; }
.island-evo-card {
  background: linear-gradient(135deg, #1a2a47, #2a4a2a);
  border: 2px solid var(--mint); border-radius: var(--radius-xl);
  padding: 32px 28px; text-align: center; max-width: 380px; width: 100%;
  box-shadow: 0 0 60px rgba(123,255,181,0.2); animation: pop-in 0.5s ease-out;
}
.island-evo-badge { font-size: 11px; text-transform: uppercase; letter-spacing: 0.15em; color: var(--mint); font-weight: 700; margin-bottom: 8px; }
.island-evo-icon { font-size: 3rem; margin-bottom: 12px; }
.island-evo-name { font-size: 22px; font-weight: 700; color: var(--text-primary); font-family: var(--font-display); margin-bottom: 8px; }
.island-evo-desc { font-size: 14px; color: var(--text-secondary); line-height: 1.5; margin-bottom: 12px; }
.island-evo-features { font-size: 24px; letter-spacing: 8px; margin-bottom: 16px; }

/* === INTERACTIVE SIMS === */
.sim-fraction-visual { text-align: center; margin: 12px 0; }
.sim-fraction-bar { display: flex; height: 44px; border-radius: 8px; overflow: hidden; border: 2px solid rgba(255,255,255,0.15); max-width: 320px; margin: 0 auto; }
.sim-fraction-piece {
  display: flex; align-items: center; justify-content: center;
  border-right: 1px solid rgba(255,255,255,0.1); cursor: pointer;
  transition: background 0.2s; background: rgba(255,255,255,0.05);
  font-size: 11px; color: var(--text-dim);
}
.sim-fraction-piece:last-child { border-right: none; }
.sim-fraction-piece.filled { background: var(--gold); color: #1a1a2e; font-weight: 700; }
.sim-fraction-piece:hover { background: rgba(255,215,0,0.3); }
.sim-fraction-label { margin-top: 8px; font-size: 20px; font-weight: 700; color: var(--gold); }
.sim-fraction-pie {
  width: 120px; height: 120px; border-radius: 50%; margin: 0 auto;
  position: relative; border: 2px solid rgba(255,255,255,0.15);
}
.sim-fraction-pie-inner {
  position: absolute; inset: 20%; background: #1a1a3e; border-radius: 50%;
  display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--gold); font-size: 16px;
}

/* Place value blocks */
.sim-pv-blocks { display: flex; gap: 16px; justify-content: center; align-items: flex-end; flex-wrap: wrap; margin: 12px 0; }
.sim-pv-group { text-align: center; }
.sim-pv-group-label { font-size: 11px; color: var(--text-dim); margin-bottom: 4px; font-weight: 600; }
.sim-pv-block.hundred { display: grid; grid-template-columns: repeat(10, 6px); gap: 1px; padding: 3px; background: rgba(255,215,0,0.15); border-radius: 4px; border: 1px solid rgba(255,215,0,0.3); }
.sim-pv-block.ten { display: grid; grid-template-columns: 6px; gap: 1px; padding: 3px; background: rgba(123,179,255,0.15); border-radius: 4px; border: 1px solid rgba(123,179,255,0.3); }
.sim-pv-block.one { padding: 3px; background: rgba(123,255,181,0.15); border-radius: 4px; border: 1px solid rgba(123,255,181,0.3); }
.sim-pv-unit { width: 6px; height: 6px; background: var(--gold); border-radius: 1px; }
.sim-pv-block.ten .sim-pv-unit { background: var(--sky); }
.sim-pv-block.one .sim-pv-unit { background: var(--mint); width: 10px; height: 10px; }
.sim-pv-total { font-size: 22px; font-weight: 700; color: var(--gold); align-self: center; }

/* Balance scale */
.sim-balance { text-align: center; margin: 12px 0; }
.sim-balance-base { position: relative; width: 260px; height: 120px; margin: 0 auto; }
.sim-balance-pillar { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 8px; height: 50px; background: var(--text-dim); border-radius: 4px; }
.sim-balance-beam {
  position: absolute; top: 20px; left: 0; right: 0; height: 6px;
  background: var(--text-secondary); border-radius: 3px;
  transform-origin: center; transition: transform 0.5s ease;
}
.sim-balance-pan { position: absolute; top: 10px; width: 80px; text-align: center; }
.sim-balance-pan.left { left: 10px; }
.sim-balance-pan.right { right: 10px; }
.sim-balance-pan-label { font-size: 13px; color: var(--text-secondary); }
.sim-balance-pan-val { font-size: 20px; font-weight: 700; color: var(--gold); background: rgba(255,215,0,0.1); border-radius: 8px; padding: 4px 8px; margin-top: 4px; }
.sim-balance-status { margin-top: 8px; font-size: 14px; color: var(--text-secondary); }

/* Clock face */
.sim-clock-wrap { text-align: center; margin: 12px 0; }
.sim-clock { display: block; margin: 0 auto; }
.sim-clock-time { font-size: 22px; font-weight: 700; color: var(--gold); margin-top: 8px; font-family: var(--font-display); }

/* Array visualiser */
.sim-array-wrap { text-align: center; margin: 12px 0; }
.sim-array-label { font-size: 14px; color: var(--text-secondary); margin-bottom: 8px; }
.sim-array-grid { display: inline-grid; gap: 6px; justify-content: center; }
.sim-array-dot {
  width: 14px; height: 14px; border-radius: 50%; background: var(--gold);
  animation: array-pop 0.3s ease-out both;
}
@keyframes array-pop { from { transform: scale(0); } to { transform: scale(1); } }
.sim-array-equation { margin-top: 10px; font-size: 18px; font-weight: 700; color: var(--gold); }

/* Enhanced bar model */
.sim-barmodel { margin: 12px 0; max-width: 340px; margin-left: auto; margin-right: auto; }
.sim-barmodel-whole {
  height: 36px; background: rgba(255,215,0,0.1); border: 2px solid var(--gold);
  border-radius: 8px; display: flex; align-items: center; justify-content: center;
  margin-bottom: 6px;
}
.sim-barmodel-whole-label { font-weight: 700; color: var(--gold); font-size: 16px; }
.sim-barmodel-parts { display: flex; gap: 3px; }
.sim-barmodel-part {
  height: 36px; border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center;
  background: rgba(123,179,255,0.15); border: 1px solid rgba(123,179,255,0.3);
  font-weight: 700; font-size: 14px; color: var(--sky);
}
.sim-barmodel-part.unknown { background: rgba(255,123,123,0.15); border-color: rgba(255,123,123,0.3); color: var(--coral); }
.sim-barmodel-part-label { font-size: 9px; font-weight: 400; color: var(--text-dim); }

/* Ramp simulator */
.sim-ramp-wrap { margin: 12px 0; }
.sim-ramp-controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 12px; }
.sim-ramp-control { flex: 1; min-width: 120px; }
.sim-ramp-control label { display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; }
.sim-slider { width: 100%; accent-color: var(--gold); }
.sim-select { width: 100%; padding: 4px 8px; background: rgba(255,255,255,0.08); color: var(--text-primary); border: 1px solid rgba(255,255,255,0.15); border-radius: 6px; font-size: 12px; }
.sim-ramp-scene { margin: 8px 0; }
.sim-ramp-svg { width: 100%; max-width: 300px; display: block; margin: 0 auto; }
.sim-ramp-result { text-align: center; font-size: 14px; color: var(--text-secondary); margin: 8px 0; font-weight: 600; }

/* Lifecycle simulator */
.sim-lifecycle-wrap { margin: 12px 0; text-align: center; }
.sim-lifecycle-title { font-size: 16px; font-weight: 700; color: var(--gold); margin-bottom: 12px; }
.sim-lifecycle-slots { display: flex; align-items: center; justify-content: center; gap: 4px; flex-wrap: wrap; margin-bottom: 16px; }
.sim-lifecycle-slot {
  width: 70px; height: 70px; border: 2px dashed rgba(255,255,255,0.15);
  border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center;
  background: rgba(255,255,255,0.03); transition: all 0.3s;
}
.sim-slot-number { font-size: 10px; color: var(--gold); font-weight: 700; }
.sim-slot-label { font-size: 11px; color: var(--text-dim); }
.sim-lifecycle-arrow { font-size: 14px; }
.sim-lifecycle-bank { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
.sim-lifecycle-item {
  padding: 8px 12px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1);
  border-radius: 10px; cursor: pointer; transition: all 0.2s; color: var(--text-primary);
}
.sim-lifecycle-item:hover { background: rgba(255,215,0,0.1); border-color: var(--gold); }

/* Energy chain */
.sim-energy-wrap { margin: 12px 0; text-align: center; }
.sim-energy-title { font-size: 16px; font-weight: 700; color: var(--gold); margin-bottom: 12px; }
.sim-energy-chain { display: flex; align-items: center; justify-content: center; gap: 4px; flex-wrap: wrap; margin-bottom: 16px; }
.sim-energy-slot { width: 80px; padding: 8px; background: rgba(255,255,255,0.03); border: 2px dashed rgba(255,255,255,0.12); border-radius: 10px; }
.sim-energy-slot-label { font-size: 10px; color: var(--text-dim); }
.sim-energy-slot-val { font-size: 12px; color: var(--text-secondary); margin-top: 4px; font-weight: 600; }
.sim-energy-arrow { font-size: 14px; }
.sim-energy-bank { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
.sim-energy-item {
  padding: 6px 12px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1);
  border-radius: 8px; cursor: pointer; font-size: 13px; color: var(--text-primary);
  transition: all 0.2s;
}
.sim-energy-item:hover { background: rgba(255,215,0,0.1); border-color: var(--gold); }

/* === SURPRISE & DELIGHT === */
.surprise-overlay {
  position: fixed; inset: 0; z-index: 9800; background: rgba(15,11,46,0.9);
  display: flex; align-items: center; justify-content: center; padding: 24px;
  opacity: 0; pointer-events: none; transition: opacity 0.3s;
}
.surprise-overlay.show { opacity: 1; pointer-events: auto; }
.surprise-card {
  background: linear-gradient(135deg, #1a1a4e, #2a1a5e);
  border: 2px solid var(--gold); border-radius: var(--radius-xl);
  padding: 32px 28px; text-align: center; max-width: 360px; width: 100%;
  box-shadow: 0 0 60px rgba(255,215,0,0.15); animation: pop-in 0.5s ease-out;
}
.surprise-icon { font-size: 3.5rem; margin-bottom: 12px; display: block; }
.surprise-title { font-size: 22px; font-weight: 700; color: var(--gold); font-family: var(--font-display); margin-bottom: 8px; }
.surprise-desc { font-size: 15px; color: var(--text-secondary); line-height: 1.5; margin-bottom: 12px; }
.surprise-stars { font-size: 18px; font-weight: 700; color: var(--gold); margin-bottom: 12px; }
.surprise-btn {
  background: var(--gold); color: #1a1a2e; border: none; border-radius: 20px;
  padding: 10px 28px; font-size: 16px; font-weight: 700; cursor: pointer;
  font-family: var(--font-display); transition: transform 0.2s;
}
.surprise-btn:hover { transform: scale(1.05); }

/* Surprise animations */
.surprise-bounce { animation: surprise-bounce 1s ease infinite; }
@keyframes surprise-bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }
.surprise-pulse { animation: surprise-pulse 1.5s ease infinite; }
@keyframes surprise-pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(255,215,0,0.4); } 50% { box-shadow: 0 0 0 12px rgba(255,215,0,0); } }
.surprise-spin { animation: surprise-spin 2s linear infinite; }
@keyframes surprise-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

/* Shooting star */
.surprise-shooting-star {
  position: fixed; top: 10%; left: -50px; font-size: 28px; z-index: 9900;
  animation: shoot-across 1.5s linear forwards;
  pointer-events: none;
}
@keyframes shoot-across {
  0% { top: 10%; left: -50px; opacity: 1; }
  100% { top: 60%; left: 110%; opacity: 0; }
}

/* Rain drops */
.surprise-rain-drop {
  position: fixed; top: -20px; font-size: 16px; z-index: 9900;
  animation: rain-fall 1.2s linear forwards; pointer-events: none;
}
@keyframes rain-fall {
  0% { top: -20px; opacity: 1; }
  100% { top: 110vh; opacity: 0; }
}

/* Confetti */
.surprise-confetti {
  position: fixed; top: -10px; width: 8px; height: 8px; z-index: 9900;
  border-radius: 2px; pointer-events: none;
  animation: confetti-fall 1.5s linear forwards;
}
@keyframes confetti-fall {
  0% { top: -10px; transform: rotate(0deg) translateX(0); opacity: 1; }
  100% { top: 110vh; transform: rotate(720deg) translateX(40px); opacity: 0; }
}

/* Lumi dancing */
.lumi-dancing { animation: lumi-dance 0.4s ease-in-out infinite alternate !important; }
@keyframes lumi-dance {
  0% { transform: rotate(-10deg) translateY(0); }
  100% { transform: rotate(10deg) translateY(-6px); }
}

/* Golden glow on question card */
.golden-glow {
  box-shadow: 0 0 30px rgba(255,215,0,0.3), inset 0 0 20px rgba(255,215,0,0.05) !important;
  border-color: var(--gold) !important;
}
.golden-glow::before {
  content: '\uD83C\uDFC5 GOLDEN QUESTION — Triple Stars!';
  display: block; text-align: center; color: var(--gold); font-size: 12px;
  font-weight: 700; margin-bottom: 8px; letter-spacing: 0.1em;
}

/* Daily spin banner */
.daily-spin-banner {
  background: linear-gradient(135deg, rgba(255,215,0,0.12), rgba(181,123,255,0.12));
  border: 1px solid rgba(255,215,0,0.2); border-radius: var(--radius-lg);
  padding: 12px 16px; margin-bottom: 12px; cursor: pointer;
  display: flex; align-items: center; gap: 12px;
  transition: background 0.2s; animation: surprise-pulse 3s ease infinite;
}
.daily-spin-banner:hover { background: linear-gradient(135deg, rgba(255,215,0,0.18), rgba(181,123,255,0.18)); }
.daily-spin-icon { font-size: 28px; }
.daily-spin-text { flex: 1; }
.daily-spin-title { font-size: 14px; font-weight: 700; color: var(--gold); }
.daily-spin-desc { font-size: 12px; color: var(--text-secondary); }
</style>
</head>
<body>

<div class="starfield"></div>

<div class="app-container" id="app">
  <!-- TOP BAR -->
  <div class="top-bar">
    <div class="top-bar-left">
      <button class="home-btn" onclick="showScreen('home')">&#11088; Home</button>
    </div>
    <div class="top-bar-right">
      <div class="level-display"><span>&#127793;</span> <span id="level-text">Sprout</span></div>
      <div class="streak-display"><span>&#128293;</span> <span id="streak-count">0</span></div>
      <div class="token-display"><span class="token-icon">&#11088;</span> <span id="token-count">0</span></div>
      <div class="trophy-btn" onclick="showScreen('achievements')"><span>&#127942;</span><span class="trophy-count" id="achievement-badge-count">0</span></div>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main-content">

    <!-- HOME SCREEN -->
    <div class="screen active" id="screen-home">
      <div class="version-banner">Nasworld v2.1 — Garden Island + Sims + Surprises!</div>

      <div class="home-hero">
        <h1 class="home-title">Nasworld</h1>
        <p class="home-subtitle">Anastasia's Learning Universe — Learn, Explore, Master!</p>
      </div>

      <!-- Lumi -->
      <div class="lumi-container">
        <div class="lumi" onclick="lumiSpeak()">
          <span class="lumi-sparkle">&#10022;</span>
          <span class="lumi-sparkle">&#10022;</span>
          <span class="lumi-sparkle">&#10022;</span>
          <div class="lumi-body">
            <div class="lumi-eye left"></div>
            <div class="lumi-eye right"></div>
            <div class="lumi-mouth"></div>
            <div class="lumi-blush left"></div>
            <div class="lumi-blush right"></div>
          </div>
        </div>
        <div class="lumi-speech" id="lumi-speech">Welcome to Nasworld! Tap any skill to Learn, flip Flashcards, then take a Quiz!</div>
      </div>

      <!-- Word of the Day -->
      <div class="wotd-banner hidden" id="wotd-banner" onclick="claimWotd()">
        <div class="quest-icon">&#128218;</div>
        <div class="quest-text">
          <div class="wotd-word" id="wotd-word"></div>
          <div class="wotd-def" id="wotd-def"></div>
        </div>
        <div class="quest-progress" id="wotd-status">+3 &#11088;</div>
      </div>

      <!-- Daily Lucky Spin -->
      <div id="daily-spin-area"></div>

      <!-- Dynamic Quests (Daily + Weekly) -->
      <div id="dynamic-quest-area"></div>

      <!-- Lumi's Star Bridge Story -->
      <div id="story-progress-area"></div>

      <!-- Achievement Showcase -->
      <div class="hidden" id="achievement-showcase"></div>

      <!-- World Cards -->
      <div class="worlds-grid">
        <div class="world-card math" onclick="showScreen('math-world')">
          <span class="world-card-icon">&#128290;</span>
          <div class="world-card-title">Number World</div>
          <div class="world-card-desc">Explore numbers, solve puzzles, and build your math superpowers!</div>
          <div class="world-card-progress"><div class="world-card-progress-fill" id="math-progress" style="width:0%"></div></div>
        </div>
        <div class="world-card literacy" onclick="showScreen('word-world')">
          <span class="world-card-icon">&#128214;</span>
          <div class="world-card-title">Word World</div>
          <div class="world-card-desc">Discover sounds, build sentences, and grow your story garden!</div>
          <div class="world-card-progress"><div class="world-card-progress-fill" id="word-progress" style="width:0%"></div></div>
        </div>
        <div class="world-card stem" onclick="showScreen('stem-world')">
          <span class="world-card-icon">&#128300;</span>
          <div class="world-card-title">STEM World</div>
          <div class="world-card-desc">Science experiments, coding adventures, and amazing discoveries!</div>
          <div class="world-card-progress"><div class="world-card-progress-fill" id="stem-progress" style="width:0%"></div></div>
        </div>
        <div class="world-card garden" onclick="showScreen('garden')">
          <span class="world-card-icon">&#127800;</span>
          <div class="world-card-title">My Garden</div>
          <div class="world-card-desc">Watch your garden grow with every new thing you learn!</div>
          <div class="world-card-progress"><div class="world-card-progress-fill" id="garden-progress" style="width:0%"></div></div>
        </div>
      </div>

      <!-- Streak Calendar -->
      <div id="streak-calendar-area"></div>

      <!-- Review Due Banner -->
      <div class="hidden" id="review-due-banner"></div>

      <!-- Challenges Section -->
      <div class="challenges-section" id="challenges-section">
        <h3>&#127942; Challenges</h3>
        <div class="challenges-grid" id="challenges-grid"></div>
      </div>
    </div>

    <!-- MATH WORLD SCREEN -->
    <div class="screen" id="screen-math-world">
      <button class="back-btn" onclick="showScreen('home')">&#8592; Back to Home</button>
      <div class="activity-header">
        <h2>&#128290; Number World</h2>
        <p>Choose your adventure!</p>
      </div>
      <div id="math-activities"></div>
    </div>

    <!-- WORD WORLD SCREEN -->
    <div class="screen" id="screen-word-world">
      <button class="back-btn" onclick="showScreen('home')">&#8592; Back to Home</button>
      <div class="activity-header">
        <h2>&#128214; Word World</h2>
        <p>Choose your adventure!</p>
      </div>
      <div id="word-activities"></div>
    </div>

    <!-- STEM WORLD SCREEN -->
    <div class="screen" id="screen-stem-world">
      <button class="back-btn" onclick="showScreen('home')">&#8592; Back to Home</button>
      <div class="activity-header">
        <h2>&#128300; STEM World</h2>
        <p>Explore science and coding!</p>
      </div>
      <div id="stem-activities"></div>
    </div>

    <!-- SKILL VIEW SCREEN (Learn / Explore / Quiz tabs) -->
    <div class="screen" id="screen-skill-view">
      <div class="game-area" id="skill-view-content"></div>
    </div>

    <!-- GAME SCREEN -->
    <!-- ACHIEVEMENTS SCREEN -->
    <div class="screen" id="screen-achievements">
      <button class="back-btn" onclick="showScreen('home')">&#8592; Back to Home</button>
      <div class="activity-header">
        <h2>&#127942; Achievements</h2>
        <p>Collect them all!</p>
      </div>
      <div id="achievements-content"></div>
    </div>

    <div class="screen" id="screen-game">
      <button class="back-btn" id="game-back-btn" onclick="exitGame()">&#8592; Back</button>
      <div class="game-area">
        <div class="game-header">
          <div class="game-title" id="game-title"></div>
          <div class="game-progress-dots" id="game-dots"></div>
        </div>
        <div class="question-card" id="question-card"></div>
      </div>
    </div>

    <!-- GARDEN SCREEN -->
    <div class="screen" id="screen-garden">
      <button class="back-btn" onclick="showScreen('home')">&#8592; Back to Home</button>
      <div class="activity-header">
        <h2>&#127800; Anastasia's Garden Island</h2>
        <p>Watch your island evolve as you learn!</p>
      </div>
      <div id="garden-island"></div>
      <h3 style="margin:20px 0 8px;color:var(--text-secondary)">&#127804; Flower Collection</h3>
      <div class="garden-grid" id="garden-grid"></div>
    </div>

    <!-- STAR TRIALS SCREEN -->
    <div class="screen" id="screen-star-trials">
      <button class="back-btn" onclick="showScreen('home')">&#8592; Back to Home</button>
      <div class="activity-header">
        <h2>&#11088; Star Trials</h2>
        <p>Show Lumi how much you've grown!</p>
      </div>
      <div id="star-trials-content"></div>
    </div>

    <!-- ESCAPE ROOM SCREEN -->
    <div class="screen" id="screen-escape-room">
      <div class="escape-header">
        <button class="back-btn" onclick="exitEscapeRoom()">&#8592; Exit</button>
        <div class="escape-timer" id="escape-timer">5:00</div>
        <div class="escape-progress" id="escape-progress"></div>
      </div>
      <div class="game-area">
        <div class="game-title" id="escape-title"></div>
        <div class="question-card" id="escape-card"></div>
      </div>
    </div>

  </div>
</div>

<!-- FEEDBACK OVERLAY -->
<div class="feedback-overlay hidden" id="feedback-overlay" onclick="closeFeedback(event)">
  <div class="feedback-card" id="feedback-card"></div>
</div>

<!-- SCRIPTS (loaded in dependency order) -->
<script>
// === BUNDLED BY build.sh ===

// --- src/core/utils.js ---
// ============================================================
//  UTILS — Helper functions used throughout the app
// ============================================================

function rand(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function pick(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = rand(0, i);
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function clamp(val, min, max) {
  return Math.max(min, Math.min(max, val));
}

function ordinal(n) {
  const s = ['th','st','nd','rd'];
  const v = n % 100;
  return n + (s[(v - 20) % 10] || s[v] || s[0]);
}

function formatNumber(n) {
  return n.toLocaleString();
}

function generateMCQOptions(correct, min, max, count) {
  const options = new Set([correct]);
  let safety = 0;
  while (options.size < count && safety < 50) {
    const opt = rand(Math.max(0, min), max);
    if (opt !== correct) options.add(opt);
    safety++;
  }
  return shuffle([...options]);
}

function debounce(fn, ms) {
  let timer;
  return function(...args) {
    clearTimeout(timer);
    timer = setTimeout(() => fn.apply(this, args), ms);
  };
}

function gcd(a, b) {
  a = Math.abs(a); b = Math.abs(b);
  while (b) { [a, b] = [b, a % b]; }
  return a;
}

function lcm(a, b) {
  return Math.abs(a * b) / gcd(a, b);
}

// --- src/data/encouragements.js ---
// ============================================================
//  ENCOURAGEMENTS & CONTENT BANKS
// ============================================================

const ENCOURAGEMENTS = [
  "You're amazing, Anastasia!",
  "Look at you go! Brilliant!",
  "Your brain is getting stronger!",
  "That's the way! Keep shining!",
  "Wow, you figured that out!",
  "Superstar thinking!",
  "I knew you could do it!",
  "You're growing so fast!",
  "Incredible work!",
  "That was beautiful thinking!",
  "You make learning look easy!",
  "Your brain just levelled up!",
  "Absolutely fantastic!",
  "Look how far you've come!",
  "You're on fire today!"
];

const TRY_AGAINS = [
  "Hmm, not quite! Let's think again",
  "Almost! Give it another try",
  "That's okay! Mistakes help us learn",
  "Let's look at this differently",
  "Close! You're getting there",
  "Good try! Let's think about it together",
  "Not yet, but you're so close!",
  "Every mistake makes your brain stronger!"
];

const METACOGNITIVE_PROMPTS = [
  "What helped you figure that out?",
  "How did your brain solve that?",
  "What clue did you notice?",
  "What would you tell a friend about this?",
  "Did you use any tricks?",
  "What strategy did you use?",
  "How did you know that was right?",
  "What pattern did you spot?"
];

const CONFIDENCE_PROMPTS = [
  "How does your brain feel about this one?",
  "How sure are you?",
  "What do you think — easy, medium, or tricky?"
];

const OBJECT_EMOJIS = [
  '\uD83C\uDF4E','\uD83C\uDF4A','\u2B50','\uD83E\uDD8B','\uD83D\uDC1F',
  '\uD83C\uDF38','\uD83C\uDF88','\uD83C\uDF6A','\uD83D\uDC1D','\uD83D\uDC22',
  '\uD83C\uDF80','\uD83C\uDF6C','\uD83D\uDC1A','\uD83C\uDF47','\uD83C\uDF3B','\uD83E\uDDF8'
];

const FLOWER_EMOJIS = [
  '\uD83C\uDF38','\uD83C\uDF3A','\uD83C\uDF3B','\uD83C\uDF39','\uD83C\uDF37',
  '\uD83D\uDC90','\uD83C\uDF3C','\uD83C\uDFF5\uFE0F','\uD83D\uDCAE','\uD83C\uDF3F',
  '\uD83C\uDF40','\uD83C\uDF35','\uD83C\uDF34','\uD83C\uDF8B','\uD83E\uDEBB','\uD83E\uDEB7'
];

const GOLDEN_FLOWER = '\uD83C\uDF1F';

const SHAPE_DATA = [
  { name: 'circle', emoji: '\u2B55', sides: 0, desc: 'round, no corners' },
  { name: 'triangle', emoji: '\uD83D\uDD3A', sides: 3, desc: '3 sides, 3 corners' },
  { name: 'square', emoji: '\uD83D\uDFE7', sides: 4, desc: '4 equal sides, 4 corners' },
  { name: 'rectangle', emoji: '\uD83D\uDFE6', sides: 4, desc: '4 sides (2 long, 2 short), 4 corners' },
  { name: 'pentagon', emoji: '\u2B20', sides: 5, desc: '5 sides, 5 corners' },
  { name: 'hexagon', emoji: '\u2B21', sides: 6, desc: '6 sides, 6 corners' }
];

// --- src/data/wotd.js ---
// ============================================================
//  WORD OF THE DAY — 50+ entries
// ============================================================

const WOTD_BANK = [
  { word: 'magnificent', def: 'wonderful and very beautiful', sentence: 'The sunset was magnificent.', partOfSpeech: 'adjective' },
  { word: 'curious', def: 'wanting to know more about something', sentence: 'The curious cat peeked inside the box.', partOfSpeech: 'adjective' },
  { word: 'enormous', def: 'very very big', sentence: 'The elephant was enormous!', partOfSpeech: 'adjective' },
  { word: 'peculiar', def: 'strange and unusual', sentence: 'There was a peculiar sound coming from the attic.', partOfSpeech: 'adjective' },
  { word: 'brave', def: 'not afraid, showing courage', sentence: 'The brave knight faced the dragon.', partOfSpeech: 'adjective' },
  { word: 'delicious', def: 'tastes very good', sentence: 'The homemade cookies were delicious.', partOfSpeech: 'adjective' },
  { word: 'gentle', def: 'soft, kind, and careful', sentence: 'She was gentle with the baby bird.', partOfSpeech: 'adjective' },
  { word: 'ancient', def: 'very very old', sentence: 'The ancient castle stood on the hill.', partOfSpeech: 'adjective' },
  { word: 'ferocious', def: 'fierce and scary', sentence: 'The lion gave a ferocious roar.', partOfSpeech: 'adjective' },
  { word: 'luminous', def: 'glowing with light', sentence: 'The luminous stars lit up the night sky.', partOfSpeech: 'adjective' },
  { word: 'resilient', def: 'able to bounce back from hard times', sentence: 'The resilient plant grew back after the storm.', partOfSpeech: 'adjective' },
  { word: 'meticulous', def: 'very careful and precise', sentence: 'She was meticulous in her drawing.', partOfSpeech: 'adjective' },
  { word: 'vibrant', def: 'full of life and colour', sentence: 'The garden was full of vibrant flowers.', partOfSpeech: 'adjective' },
  { word: 'tranquil', def: 'calm and peaceful', sentence: 'The lake was tranquil in the morning.', partOfSpeech: 'adjective' },
  { word: 'spectacular', def: 'amazing to look at', sentence: 'The fireworks display was spectacular.', partOfSpeech: 'adjective' },
  { word: 'ingenious', def: 'very clever and creative', sentence: 'She came up with an ingenious solution.', partOfSpeech: 'adjective' },
  { word: 'persevere', def: 'to keep trying even when it is hard', sentence: 'She persevered until she solved the puzzle.', partOfSpeech: 'verb' },
  { word: 'discover', def: 'to find something for the first time', sentence: 'They discovered a hidden cave behind the waterfall.', partOfSpeech: 'verb' },
  { word: 'observe', def: 'to watch carefully', sentence: 'The scientist observed the butterflies.', partOfSpeech: 'verb' },
  { word: 'imagine', def: 'to create pictures in your mind', sentence: 'Imagine you could fly like a bird!', partOfSpeech: 'verb' },
  { word: 'collaborate', def: 'to work together with others', sentence: 'The students collaborated on a group project.', partOfSpeech: 'verb' },
  { word: 'investigate', def: 'to look into something carefully', sentence: 'The detective investigated the mystery.', partOfSpeech: 'verb' },
  { word: 'appreciate', def: 'to understand the value of something', sentence: 'I appreciate your help with my homework.', partOfSpeech: 'verb' },
  { word: 'transform', def: 'to change into something different', sentence: 'The caterpillar transforms into a butterfly.', partOfSpeech: 'verb' },
  { word: 'adventure', def: 'an exciting experience', sentence: 'They went on an adventure through the jungle.', partOfSpeech: 'noun' },
  { word: 'constellation', def: 'a group of stars forming a pattern', sentence: 'She pointed out the constellation in the night sky.', partOfSpeech: 'noun' },
  { word: 'ecosystem', def: 'a community of living things and their environment', sentence: 'The coral reef is a beautiful ecosystem.', partOfSpeech: 'noun' },
  { word: 'symmetry', def: 'when both sides look the same', sentence: 'A butterfly has perfect symmetry.', partOfSpeech: 'noun' },
  { word: 'metamorphosis', def: 'a big change in body form', sentence: 'A frog goes through metamorphosis.', partOfSpeech: 'noun' },
  { word: 'hypothesis', def: 'a smart guess you can test', sentence: 'Her hypothesis was that plants grow faster in sunlight.', partOfSpeech: 'noun' },
  { word: 'kaleidoscope', def: 'a tube with mirrors that makes colourful patterns', sentence: 'Looking through a kaleidoscope is magical.', partOfSpeech: 'noun' },
  { word: 'archipelago', def: 'a group of islands', sentence: 'Singapore is part of an archipelago.', partOfSpeech: 'noun' },
  { word: 'labyrinth', def: 'a complicated maze', sentence: 'The garden had a labyrinth made of hedges.', partOfSpeech: 'noun' },
  { word: 'harmony', def: 'things working well together', sentence: 'The choir sang in perfect harmony.', partOfSpeech: 'noun' },
  { word: 'silhouette', def: 'a dark outline against a lighter background', sentence: 'We saw the silhouette of the mountain at sunset.', partOfSpeech: 'noun' },
  { word: 'whimsical', def: 'playful and imaginative', sentence: 'The whimsical painting had flying elephants.', partOfSpeech: 'adjective' },
  { word: 'diligent', def: 'hardworking and careful', sentence: 'The diligent student finished all her work.', partOfSpeech: 'adjective' },
  { word: 'compassionate', def: 'feeling kindness toward others', sentence: 'The compassionate girl helped the lost kitten.', partOfSpeech: 'adjective' },
  { word: 'flourish', def: 'to grow and do well', sentence: 'The flowers flourished in the spring sunshine.', partOfSpeech: 'verb' },
  { word: 'illuminate', def: 'to light up or make clear', sentence: 'The lanterns illuminate the path at night.', partOfSpeech: 'verb' },
  { word: 'phenomenon', def: 'something amazing that happens', sentence: 'A rainbow is a beautiful phenomenon.', partOfSpeech: 'noun' },
  { word: 'extraordinary', def: 'very special and unusual', sentence: 'She has an extraordinary talent for music.', partOfSpeech: 'adjective' },
  { word: 'brilliant', def: 'very bright or very clever', sentence: 'The scientist had a brilliant idea.', partOfSpeech: 'adjective' },
  { word: 'fragile', def: 'easy to break or damage', sentence: 'Be careful with the fragile glass vase.', partOfSpeech: 'adjective' },
  { word: 'abundant', def: 'more than enough', sentence: 'The orchard had abundant fruit this year.', partOfSpeech: 'adjective' },
  { word: 'nocturnal', def: 'active at night', sentence: 'Owls are nocturnal animals.', partOfSpeech: 'adjective' },
  { word: 'migrate', def: 'to move from one place to another', sentence: 'Birds migrate south for the winter.', partOfSpeech: 'verb' },
  { word: 'camouflage', def: 'hiding by blending in', sentence: 'The chameleon uses camouflage to hide.', partOfSpeech: 'noun' },
  { word: 'expedition', def: 'a journey for a special purpose', sentence: 'The team went on an expedition to the Arctic.', partOfSpeech: 'noun' },
  { word: 'masterpiece', def: 'a work of art that is the best of its kind', sentence: 'Her painting was a true masterpiece.', partOfSpeech: 'noun' },
  { word: 'enchanted', def: 'under a magical spell', sentence: 'They walked through the enchanted forest.', partOfSpeech: 'adjective' },
  { word: 'miniature', def: 'very small version of something', sentence: 'She built a miniature house for her dolls.', partOfSpeech: 'adjective' }
];

function getWordOfTheDay() {
  const today = new Date();
  const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / 86400000);
  return WOTD_BANK[dayOfYear % WOTD_BANK.length];
}

// --- src/core/state.js ---
// ============================================================
//  STATE — State management, localStorage, v1 migration
// ============================================================

const Store = {
  _mem: {},
  async get(key) {
    try {
      if (window.storage) {
        const r = await window.storage.get(key);
        return r ? JSON.parse(r.value) : null;
      }
    } catch(e) {}
    try {
      const v = localStorage.getItem('anas_' + key);
      return v ? JSON.parse(v) : null;
    } catch(e) {}
    return this._mem[key] || null;
  },
  async set(key, value) {
    this._mem[key] = value;
    try {
      if (window.storage) {
        await window.storage.set(key, JSON.stringify(value));
        return;
      }
    } catch(e) {}
    try {
      localStorage.setItem('anas_' + key, JSON.stringify(value));
    } catch(e) {}
  }
};

// Default state structure (v2)
let state = {
  version: 2,
  name: 'Anastasia',
  tokens: 0,
  streak: 0,
  bestStreak: 0,
  totalCorrect: 0,
  totalAttempts: 0,
  sessionsCompleted: 0,
  level: 1,  // 1=Sprout, 2=Seedling, 3=Bloom, 4=Star, 5=Supernova, 6=Galaxy
  garden: [],       // [{type, skill, emoji, date, golden?}]
  dailyQuest: { date: '', completed: 0, target: 5, claimed: false },
  skills: {},
  lastVisit: '',
  stories: [],
  achievements: [],
  wotdHistory: [],  // dates of claimed WotDs
  escapeRooms: {},  // { roomId: { completed, bestTime, attempts } }
  starTrials: {},   // { worldType: { completed, bestScore } }
  visitHistory: [], // date strings for visit streak tracking
  questHistory: [], // date strings for quest completion streak
  dynamicQuest: null,  // current daily quest state
  weeklyQuest: null,   // current weekly quest state
  lumiStory: { chapter: 0, shownChapters: [] },
  settings: { language: 'en' }
};

const LEVEL_NAMES = ['', 'Sprout \uD83C\uDF31', 'Seedling \uD83C\uDF3F', 'Bloom \uD83C\uDF38', 'Star \u2B50', 'Supernova \uD83D\uDCAB', 'Galaxy \uD83C\uDF0C'];
const LEVEL_THRESHOLDS = [0, 0, 50, 150, 400, 1000, 2500];

// === V1 → V2 MIGRATION ===
const V1_TO_V2_SKILL_MAP = {
  'counting': 'count',
  'number-bonds': 'nbond',
  'addition': 'add',
  'subtraction': 'sub',
  'comparing': 'cmp',
  'patterns': 'pat',
  'word-problems': 'wp1',
  'shapes': 'shp',
  'phonics': 'phon',
  'sight-words': 'sight',
  'spelling': 'spell',
  'sentence-building': 'sent',
  'vocabulary': 'vocab',
  'story-garden': 'story'
};

function migrateFromV1(oldState) {
  const migrated = {
    version: 2,
    name: oldState.name || 'Anastasia',
    tokens: oldState.tokens || 0,
    streak: oldState.streak || 0,
    bestStreak: oldState.bestStreak || 0,
    totalCorrect: oldState.totalCorrect || 0,
    totalAttempts: oldState.totalAttempts || 0,
    sessionsCompleted: oldState.sessionsCompleted || 0,
    level: oldState.level || 1,
    garden: [],
    dailyQuest: oldState.dailyQuest || { date: '', completed: 0, target: 5, claimed: false },
    skills: {},
    lastVisit: oldState.lastVisit || '',
    stories: oldState.stories || [],
    achievements: oldState.achievements || [],
    wotdHistory: [],
    escapeRooms: {},
    starTrials: {},
    settings: { language: 'en' }
  };

  // Migrate garden entries
  if (Array.isArray(oldState.garden)) {
    migrated.garden = oldState.garden.map(g => ({
      type: g.type || 'flower',
      skill: V1_TO_V2_SKILL_MAP[g.skill] || g.skill,
      emoji: g.emoji,
      date: g.date
    }));
  }

  // Migrate per-skill data
  if (oldState.skills) {
    for (const [oldId, skillData] of Object.entries(oldState.skills)) {
      const newId = V1_TO_V2_SKILL_MAP[oldId] || oldId;
      migrated.skills[newId] = {
        level: skillData.level || 0,
        recentResults: skillData.recentResults || [],
        totalCorrect: skillData.totalCorrect || 0,
        totalAttempts: skillData.totalAttempts || 0,
        streak: skillData.streak || 0,
        bestStreak: skillData.bestStreak || 0,
        mastery: skillData.mastery || 0
      };
    }
  }

  return migrated;
}

// === SKILL STATE ===
function getSkillState(skillId) {
  if (!state.skills[skillId]) {
    state.skills[skillId] = {
      level: 0,
      recentResults: [],
      totalCorrect: 0,
      totalAttempts: 0,
      streak: 0,
      bestStreak: 0,
      mastery: 0,
      lessonViewed: {},
      flashcardProgress: {},
      activity: {}
    };
  }
  // Ensure new fields on existing skills
  var s = state.skills[skillId];
  if (!s.lessonViewed) s.lessonViewed = {};
  if (!s.flashcardProgress) s.flashcardProgress = {};
  if (!s.activity) s.activity = {};
  return s;
}

// === PERSISTENCE ===
async function saveState() {
  await Store.set('gameState', state);
}

async function loadState() {
  const saved = await Store.get('gameState');
  if (saved) {
    // Check if migration needed (v1 has no version field)
    if (!saved.version || saved.version < 2) {
      state = migrateFromV1(saved);
      await saveState();
    } else {
      state = { ...state, ...saved };
    }
    // Ensure new v2 properties exist on loaded state
    if (!state.stories) state.stories = [];
    if (!state.achievements) state.achievements = [];
    if (!state.dailyQuest) state.dailyQuest = { date: '', completed: 0, target: 5, claimed: false };
    if (!state.wotdHistory) state.wotdHistory = [];
    if (!state.escapeRooms) state.escapeRooms = {};
    if (!state.starTrials) state.starTrials = {};
    if (!state.visitHistory) state.visitHistory = [];
    if (!state.questHistory) state.questHistory = [];
    if (!state.dynamicQuest) state.dynamicQuest = null;
    if (!state.weeklyQuest) state.weeklyQuest = null;
    if (!state.lumiStory) state.lumiStory = { chapter: 0, shownChapters: [] };
    if (!state.settings) state.settings = { language: 'en' };
    state.version = 2;
  }
}

// --- src/core/spaced-review.js ---
// ============================================================
//  SPACED REVIEW — Tracks when skills are due for review
//  Multi-factor mastery computation
// ============================================================

// Review intervals in days: 1, 3, 7, 14, 30
var REVIEW_INTERVALS = [1, 3, 7, 14, 30];

// Mark that a skill was actively practised (lesson, explore, or quiz)
function recordSkillActivity(skillId, activityType) {
  var skill = getSkillState(skillId);
  if (!skill.activity) skill.activity = {};
  skill.activity[activityType] = Date.now();
  skill.activity.lastAny = Date.now();

  // Track visit count
  if (!skill.activity.visits) skill.activity.visits = 0;
  skill.activity.visits++;

  saveState();
}

// Check if a skill is due for review
function isSkillDueForReview(skillId) {
  var skill = getSkillState(skillId);
  if (!skill.activity || !skill.activity.lastAny) return false;
  if (skill.totalAttempts === 0) return false; // Never quizzed

  var daysSince = (Date.now() - skill.activity.lastAny) / (1000 * 60 * 60 * 24);

  // Determine review interval based on mastery
  var intervalIdx;
  if (skill.mastery >= 80) intervalIdx = 4;      // 30 days
  else if (skill.mastery >= 60) intervalIdx = 3;  // 14 days
  else if (skill.mastery >= 40) intervalIdx = 2;  // 7 days
  else if (skill.mastery >= 20) intervalIdx = 1;  // 3 days
  else intervalIdx = 0;                            // 1 day

  return daysSince >= REVIEW_INTERVALS[intervalIdx];
}

// Get all skills due for review across all trees
function getSkillsDueForReview() {
  var due = [];
  var allTrees = {};
  if (typeof MATH_TREE !== 'undefined') Object.assign(allTrees, MATH_TREE);
  if (typeof WORD_TREE !== 'undefined') Object.assign(allTrees, WORD_TREE);
  if (typeof STEM_TREE !== 'undefined') Object.assign(allTrees, STEM_TREE);

  for (var id in allTrees) {
    if (isSkillDueForReview(id)) {
      due.push({ id: id, skill: allTrees[id] });
    }
  }
  return due;
}

// Compute multi-factor mastery (replaces the simple accuracy-based mastery)
// Factors: lesson viewed (20%), exploration done (30%), quiz accuracy (50%)
function computeMultiFactorMastery(skillId) {
  var skill = getSkillState(skillId);
  var activity = skill.activity || {};

  // Factor 1: Lesson viewed (0 or 1) — 20%
  var lessonScore = 0;
  if (skill.lessonViewed && skill.lessonViewed[skillId]) {
    lessonScore = 1;
  }

  // Factor 2: Exploration done (0 or 1) — 30%
  var exploreScore = 0;
  if (activity.explore) {
    exploreScore = 1;
  }

  // Factor 3: Quiz accuracy — 50%
  var quizScore = 0;
  if (skill.totalAttempts > 0) {
    var recent = skill.recentResults || [];
    var recentAcc = recent.length > 0
      ? recent.filter(function(r) { return r.correct; }).length / recent.length
      : 0;
    var totalAcc = skill.totalCorrect / skill.totalAttempts;
    // Blend recent and total, weighting recent more
    quizScore = recentAcc * 0.7 + totalAcc * 0.3;
  }

  // Weighted sum
  var mastery = Math.min(100, Math.round(
    lessonScore * 20 + exploreScore * 30 + quizScore * 50
  ));

  return mastery;
}

// Get a 7-day streak calendar (like Lab's streak dots)
function getStreakCalendar() {
  var calendar = [];
  var today = new Date();
  today.setHours(0, 0, 0, 0);

  for (var i = 6; i >= 0; i--) {
    var d = new Date(today);
    d.setDate(d.getDate() - i);
    var dateStr = d.toDateString();

    // Check if any activity happened on this day
    var active = false;
    if (state.skills) {
      for (var sid in state.skills) {
        var s = state.skills[sid];
        if (s.activity && s.activity.lastAny) {
          var actDate = new Date(s.activity.lastAny);
          actDate.setHours(0, 0, 0, 0);
          if (actDate.getTime() === d.getTime()) {
            active = true;
            break;
          }
        }
      }
    }

    // Also check if lastVisit matches
    if (state.lastVisit === dateStr) active = true;

    var dayNames = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
    calendar.push({
      date: dateStr,
      dayLabel: dayNames[d.getDay()],
      active: active,
      isToday: i === 0
    });
  }

  return calendar;
}

// Render streak calendar as HTML
function renderStreakCalendar() {
  var cal = getStreakCalendar();
  var activeDays = cal.filter(function(d) { return d.active; }).length;

  var html = '<div class="streak-calendar">';
  html += '<div class="streak-cal-label">This Week</div>';
  html += '<div class="streak-cal-dots">';
  cal.forEach(function(day) {
    var cls = 'streak-cal-dot';
    if (day.active) cls += ' active';
    if (day.isToday) cls += ' today';
    html += '<div class="' + cls + '">';
    html += '<div class="streak-cal-day">' + day.dayLabel + '</div>';
    html += '<div class="streak-cal-circle"></div>';
    html += '</div>';
  });
  html += '</div>';
  html += '<div class="streak-cal-count">' + activeDays + '/7 days active</div>';
  html += '</div>';

  return html;
}

// --- src/core/achievements.js ---
// ============================================================
//  ACHIEVEMENTS — Badge system with unlock logic & toast UI
// ============================================================

// Achievement definitions grouped by category
var ACHIEVEMENTS = [
  // === CONSISTENCY ===
  { id: 'streak3',    cat: 'consistency', icon: '\uD83D\uDD25', name: 'Warming Up',       desc: 'Get 3 correct in a row',         secret: false },
  { id: 'streak10',   cat: 'consistency', icon: '\uD83D\uDD25', name: 'On Fire',           desc: 'Get 10 correct in a row',        secret: false },
  { id: 'streak25',   cat: 'consistency', icon: '\u2604\uFE0F', name: 'Unstoppable',       desc: 'Get 25 correct in a row',        secret: false },
  { id: 'day3',       cat: 'consistency', icon: '\uD83D\uDCC5', name: '3-Day Learner',     desc: 'Visit 3 days in a row',          secret: false },
  { id: 'day7',       cat: 'consistency', icon: '\uD83D\uDCC5', name: 'Week Warrior',      desc: 'Visit 7 days in a row',          secret: false },
  { id: 'day14',      cat: 'consistency', icon: '\uD83C\uDFC6', name: 'Fortnight Champion', desc: 'Visit 14 days in a row',        secret: false },
  { id: 'day30',      cat: 'consistency', icon: '\uD83D\uDC8E', name: 'Monthly Legend',    desc: 'Visit 30 days in a row',         secret: false },
  { id: 'sessions5',  cat: 'consistency', icon: '\uD83C\uDFAF', name: 'Getting Started',   desc: 'Complete 5 quiz sessions',       secret: false },
  { id: 'sessions25', cat: 'consistency', icon: '\uD83C\uDFAF', name: 'Quiz Regular',      desc: 'Complete 25 quiz sessions',      secret: false },
  { id: 'sessions100',cat: 'consistency', icon: '\uD83C\uDFAF', name: 'Quiz Master',       desc: 'Complete 100 quiz sessions',     secret: false },

  // === MASTERY ===
  { id: 'first80',    cat: 'mastery', icon: '\u2B50',           name: 'First Star',        desc: 'Get any skill to 80% mastery',   secret: false },
  { id: 'first100',   cat: 'mastery', icon: '\uD83C\uDF1F',    name: 'Perfection',        desc: 'Get any skill to 100% mastery',  secret: false },
  { id: 'master5',    cat: 'mastery', icon: '\uD83C\uDF1F',    name: 'Five Stars',        desc: 'Master 5 skills (80%+)',         secret: false },
  { id: 'master10',   cat: 'mastery', icon: '\uD83D\uDCAB',    name: 'Ten Star Galaxy',   desc: 'Master 10 skills (80%+)',        secret: false },
  { id: 'levelUp',    cat: 'mastery', icon: '\uD83C\uDF31',    name: 'Level Up!',         desc: 'Reach the Pictorial CPA level',  secret: false },
  { id: 'abstract',   cat: 'mastery', icon: '\uD83E\uDDE0',    name: 'Abstract Thinker',  desc: 'Reach Abstract level in any skill', secret: false },
  { id: 'challenge',  cat: 'mastery', icon: '\uD83D\uDE80',    name: 'Challenge Accepted', desc: 'Reach Challenge level in any skill', secret: false },
  { id: 'perfect8',   cat: 'mastery', icon: '\uD83D\uDCAF',    name: 'Perfect Quiz',      desc: 'Score 8/8 on any quiz',          secret: false },

  // === EXPLORER ===
  { id: 'tryMath',    cat: 'explorer', icon: '\uD83D\uDD22',   name: 'Number Explorer',   desc: 'Try a skill in Number World',    secret: false },
  { id: 'tryWord',    cat: 'explorer', icon: '\uD83D\uDCD6',   name: 'Word Explorer',     desc: 'Try a skill in Word World',      secret: false },
  { id: 'tryStem',    cat: 'explorer', icon: '\uD83D\uDD2C',   name: 'STEM Explorer',     desc: 'Try a skill in STEM World',      secret: false },
  { id: 'allWorlds',  cat: 'explorer', icon: '\uD83C\uDF0D',   name: 'World Traveller',   desc: 'Try skills in all 3 worlds',     secret: false },
  { id: 'try10',      cat: 'explorer', icon: '\uD83D\uDDFA\uFE0F', name: 'Curious Mind',  desc: 'Try 10 different skills',        secret: false },
  { id: 'lesson5',    cat: 'explorer', icon: '\uD83D\uDCDA',   name: 'Lesson Lover',      desc: 'Complete 5 lessons',             secret: false },
  { id: 'lesson15',   cat: 'explorer', icon: '\uD83D\uDCDA',   name: 'Knowledge Seeker',  desc: 'Complete 15 lessons',            secret: false },
  { id: 'flash5',     cat: 'explorer', icon: '\uD83C\uDCCF',   name: 'Card Flipper',      desc: 'Complete 5 flashcard sessions',  secret: false },

  // === COLLECTOR ===
  { id: 'flower5',    cat: 'collector', icon: '\uD83C\uDF38',   name: 'Budding Garden',    desc: 'Grow 5 flowers in your garden',  secret: false },
  { id: 'flower15',   cat: 'collector', icon: '\uD83C\uDF3A',   name: 'Blooming Garden',   desc: 'Grow 15 flowers in your garden', secret: false },
  { id: 'flower30',   cat: 'collector', icon: '\uD83C\uDF3B',   name: 'Flower Paradise',   desc: 'Grow 30 flowers in your garden', secret: false },
  { id: 'tokens100',  cat: 'collector', icon: '\u2B50',         name: 'Star Saver',        desc: 'Earn 100 stars',                 secret: false },
  { id: 'tokens500',  cat: 'collector', icon: '\u2B50',         name: 'Star Hoarder',      desc: 'Earn 500 stars',                 secret: false },
  { id: 'tokens2500', cat: 'collector', icon: '\uD83C\uDF0C',   name: 'Galaxy of Stars',   desc: 'Earn 2500 stars',                secret: false },
  { id: 'wotd7',      cat: 'collector', icon: '\uD83D\uDCD6',   name: 'Word Collector',    desc: 'Claim 7 Words of the Day',       secret: false },
  { id: 'wotd30',     cat: 'collector', icon: '\uD83D\uDCD6',   name: 'Dictionary Builder', desc: 'Claim 30 Words of the Day',     secret: false },

  // === CHALLENGE ===
  { id: 'escape1',    cat: 'challenge', icon: '\uD83D\uDD13',   name: 'First Escape',      desc: 'Complete an escape room',        secret: false },
  { id: 'escape3',    cat: 'challenge', icon: '\uD83D\uDD13',   name: 'Escape Artist',     desc: 'Complete 3 escape rooms',        secret: false },
  { id: 'escapeAll',  cat: 'challenge', icon: '\uD83D\uDD13',   name: 'Escape Legend',     desc: 'Complete all escape rooms',      secret: false },
  { id: 'trial1',     cat: 'challenge', icon: '\u2B50',         name: 'Trial Taker',       desc: 'Complete a Star Trial',          secret: false },
  { id: 'trialAce',   cat: 'challenge', icon: '\uD83C\uDFC6',   name: 'Trial Ace',         desc: 'Score 100% on any Star Trial',   secret: false },
  { id: 'quest7',     cat: 'challenge', icon: '\uD83D\uDCDC',   name: 'Quest Streak',      desc: 'Complete daily quests 7 days running', secret: false },

  // === SECRET ===
  { id: 'lumiTap',    cat: 'secret', icon: '\u2728',            name: 'Lumi\'s Best Friend', desc: 'Tap Lumi 10 times',           secret: true },
  { id: 'midnight',   cat: 'secret', icon: '\uD83C\uDF19',     name: 'Night Owl',          desc: 'Study after 9 PM',              secret: true },
  { id: 'earlybird',  cat: 'secret', icon: '\uD83C\uDF05',     name: 'Early Bird',         desc: 'Study before 7 AM',             secret: true },
  { id: 'speedrun',   cat: 'secret', icon: '\u26A1',            name: 'Speed Demon',        desc: 'Finish a quiz in under 30 seconds', secret: true },
  { id: 'comeback',   cat: 'secret', icon: '\uD83D\uDCAA',     name: 'Comeback Kid',       desc: 'Get the last 5 right after getting the first 3 wrong', secret: true }
];

var ACHIEVEMENT_CATEGORIES = {
  consistency: { label: 'Consistency', icon: '\uD83D\uDD25', color: '#ff7b7b' },
  mastery:     { label: 'Mastery',     icon: '\u2B50',       color: '#ffd700' },
  explorer:    { label: 'Explorer',    icon: '\uD83C\uDF0D', color: '#7bb3ff' },
  collector:   { label: 'Collector',   icon: '\uD83C\uDF38', color: '#ff7bdb' },
  challenge:   { label: 'Challenge',   icon: '\uD83C\uDFC6', color: '#7bffb5' },
  secret:      { label: 'Secret',      icon: '\u2728',       color: '#b57bff' }
};

// Toast queue
var _achievementToastQueue = [];
var _achievementToastShowing = false;

// Check & unlock an achievement (idempotent)
function unlockAchievement(achievementId) {
  if (!state.achievements) state.achievements = [];
  if (state.achievements.indexOf(achievementId) !== -1) return false; // Already earned

  var def = ACHIEVEMENTS.find(function(a) { return a.id === achievementId; });
  if (!def) return false;

  state.achievements.push(achievementId);
  state.tokens += 10; // Bonus for every achievement
  saveState();

  // Queue toast
  _achievementToastQueue.push(def);
  if (!_achievementToastShowing) showNextAchievementToast();

  if (typeof playSound === 'function') playSound('unlock');
  return true;
}

function showNextAchievementToast() {
  if (_achievementToastQueue.length === 0) {
    _achievementToastShowing = false;
    return;
  }
  _achievementToastShowing = true;
  var def = _achievementToastQueue.shift();

  var toast = document.getElementById('achievement-toast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'achievement-toast';
    toast.className = 'achievement-toast';
    document.body.appendChild(toast);
  }

  toast.innerHTML =
    '<div class="achievement-toast-icon">' + def.icon + '</div>' +
    '<div class="achievement-toast-body">' +
      '<div class="achievement-toast-label">Achievement Unlocked!</div>' +
      '<div class="achievement-toast-name">' + def.name + '</div>' +
      '<div class="achievement-toast-desc">' + def.desc + ' (+10 \u2B50)</div>' +
    '</div>';

  toast.classList.remove('hide');
  toast.classList.add('show');

  if (typeof spawnParticles === 'function') {
    spawnParticles(window.innerWidth / 2, 70, 8, def.icon);
  }

  setTimeout(function() {
    toast.classList.remove('show');
    toast.classList.add('hide');
    setTimeout(function() { showNextAchievementToast(); }, 400);
  }, 3000);
}

// === ACHIEVEMENT CHECKERS ===
// Called after various events; each checks relevant conditions

function checkAchievementsAfterAnswer() {
  var s = state;

  // Streak achievements
  if (s.streak >= 3)  unlockAchievement('streak3');
  if (s.streak >= 10) unlockAchievement('streak10');
  if (s.streak >= 25) unlockAchievement('streak25');

  // Token milestones
  if (s.tokens >= 100)  unlockAchievement('tokens100');
  if (s.tokens >= 500)  unlockAchievement('tokens500');
  if (s.tokens >= 2500) unlockAchievement('tokens2500');

  // Time-based secrets
  var hour = new Date().getHours();
  if (hour >= 21 || hour < 5) unlockAchievement('midnight');
  if (hour >= 5 && hour < 7) unlockAchievement('earlybird');
}

function checkAchievementsAfterQuiz(results, skillId, worldType) {
  var correct = results.filter(function(r) { return r; }).length;
  var total = results.length;
  var pct = total > 0 ? Math.round(correct / total * 100) : 0;

  // Perfect quiz
  if (correct === total && total >= 8) unlockAchievement('perfect8');

  // Session count
  if (state.sessionsCompleted >= 5)   unlockAchievement('sessions5');
  if (state.sessionsCompleted >= 25)  unlockAchievement('sessions25');
  if (state.sessionsCompleted >= 100) unlockAchievement('sessions100');

  // World exploration
  if (worldType === 'math') unlockAchievement('tryMath');
  if (worldType === 'word') unlockAchievement('tryWord');
  if (worldType === 'stem') unlockAchievement('tryStem');

  // All worlds
  var a = state.achievements || [];
  if (a.indexOf('tryMath') !== -1 && a.indexOf('tryWord') !== -1 && a.indexOf('tryStem') !== -1) {
    unlockAchievement('allWorlds');
  }

  // Tried N different skills
  var triedSkills = {};
  if (state.skills) {
    for (var sid in state.skills) {
      if (state.skills[sid].totalAttempts > 0) triedSkills[sid] = true;
    }
  }
  if (Object.keys(triedSkills).length >= 10) unlockAchievement('try10');

  // Speedrun (quiz under 30 seconds) — checked via currentGame.startTime if available
  if (typeof currentGame !== 'undefined' && currentGame._startTime) {
    var elapsed = (Date.now() - currentGame._startTime) / 1000;
    if (elapsed < 30 && correct >= 6) unlockAchievement('speedrun');
  }

  // Comeback kid: first 3 wrong, last 5 right
  if (results.length >= 8) {
    var first3 = results.slice(0, 3).every(function(r) { return !r; });
    var last5 = results.slice(-5).every(function(r) { return r; });
    if (first3 && last5) unlockAchievement('comeback');
  }
}

function checkAchievementsAfterMastery() {
  if (!state.skills) return;
  var masteredCount = 0;
  var hasAbstract = false;
  var hasChallenge = false;
  var has80 = false;
  var has100 = false;
  var hasPictorial = false;

  for (var sid in state.skills) {
    var sk = state.skills[sid];
    if (sk.mastery >= 80) { masteredCount++; has80 = true; }
    if (sk.mastery >= 100) has100 = true;
    if (sk.level >= 1) hasPictorial = true;
    if (sk.level >= 2) hasAbstract = true;
    if (sk.level >= 4) hasChallenge = true;
  }

  if (has80)            unlockAchievement('first80');
  if (has100)           unlockAchievement('first100');
  if (masteredCount >= 5)  unlockAchievement('master5');
  if (masteredCount >= 10) unlockAchievement('master10');
  if (hasPictorial)     unlockAchievement('levelUp');
  if (hasAbstract)      unlockAchievement('abstract');
  if (hasChallenge)     unlockAchievement('challenge');
}

function checkAchievementsAfterGarden() {
  var count = state.garden ? state.garden.length : 0;
  if (count >= 5)  unlockAchievement('flower5');
  if (count >= 15) unlockAchievement('flower15');
  if (count >= 30) unlockAchievement('flower30');
}

function checkAchievementsAfterLesson() {
  if (!state.skills) return;
  var lessonCount = 0;
  for (var sid in state.skills) {
    var sk = state.skills[sid];
    if (sk.lessonViewed) {
      for (var lid in sk.lessonViewed) { if (sk.lessonViewed[lid]) lessonCount++; }
    }
  }
  if (lessonCount >= 5)  unlockAchievement('lesson5');
  if (lessonCount >= 15) unlockAchievement('lesson15');
}

function checkAchievementsAfterFlashcards() {
  if (!state.skills) return;
  var fcSessions = 0;
  for (var sid in state.skills) {
    var sk = state.skills[sid];
    if (sk.flashcardProgress) {
      for (var cid in sk.flashcardProgress) {
        if (sk.flashcardProgress[cid] && sk.flashcardProgress[cid].correct > 0) fcSessions++;
      }
    }
  }
  if (fcSessions >= 5) unlockAchievement('flash5');
}

function checkAchievementsAfterEscape() {
  if (!state.escapeRooms) return;
  var completed = Object.keys(state.escapeRooms).length;
  if (completed >= 1) unlockAchievement('escape1');
  if (completed >= 3) unlockAchievement('escape3');
  if (completed >= 6) unlockAchievement('escapeAll');
}

function checkAchievementsAfterTrial(pct) {
  unlockAchievement('trial1');
  if (pct >= 100) unlockAchievement('trialAce');
}

function checkAchievementsAfterWotd() {
  var count = state.wotdHistory ? state.wotdHistory.length : 0;
  if (count >= 7)  unlockAchievement('wotd7');
  if (count >= 30) unlockAchievement('wotd30');
}

function checkAchievementsAfterDailyQuest() {
  // Quest streak — check consecutive days of quest completion
  if (!state.questHistory) state.questHistory = [];
  var consecutive = 0;
  var today = new Date();
  today.setHours(0, 0, 0, 0);
  for (var i = 0; i < 30; i++) {
    var d = new Date(today);
    d.setDate(d.getDate() - i);
    var ds = d.toDateString();
    if (state.questHistory.indexOf(ds) !== -1) {
      consecutive++;
    } else {
      break;
    }
  }
  if (consecutive >= 7) unlockAchievement('quest7');
}

// Lumi tap counter for secret achievement
var _lumiTapCount = 0;
function checkLumiTapAchievement() {
  _lumiTapCount++;
  if (_lumiTapCount >= 10) unlockAchievement('lumiTap');
}

// Visit streak checker (called on init)
function checkVisitStreakAchievements() {
  if (!state.visitHistory) state.visitHistory = [];
  var today = new Date();
  today.setHours(0, 0, 0, 0);
  var todayStr = today.toDateString();

  // Add today if not present
  if (state.visitHistory.indexOf(todayStr) === -1) {
    state.visitHistory.push(todayStr);
    // Keep last 60 entries
    if (state.visitHistory.length > 60) state.visitHistory = state.visitHistory.slice(-60);
    saveState();
  }

  // Count consecutive days ending today
  var consecutive = 0;
  for (var i = 0; i < 60; i++) {
    var d = new Date(today);
    d.setDate(d.getDate() - i);
    if (state.visitHistory.indexOf(d.toDateString()) !== -1) {
      consecutive++;
    } else {
      break;
    }
  }

  if (consecutive >= 3)  unlockAchievement('day3');
  if (consecutive >= 7)  unlockAchievement('day7');
  if (consecutive >= 14) unlockAchievement('day14');
  if (consecutive >= 30) unlockAchievement('day30');
}

// Get count of earned achievements
function getAchievementCount() {
  return state.achievements ? state.achievements.length : 0;
}

// Render achievements screen
function renderAchievementsScreen() {
  var container = document.getElementById('achievements-content');
  if (!container) return;

  var earned = state.achievements || [];
  var total = ACHIEVEMENTS.length;
  var earnedCount = earned.length;

  var html = '<div class="achievements-summary">';
  html += '<div class="achievements-count">' + earnedCount + ' / ' + total + '</div>';
  html += '<div class="achievements-bar"><div class="achievements-bar-fill" style="width:' + Math.round(earnedCount / total * 100) + '%"></div></div>';
  html += '</div>';

  // By category
  for (var catId in ACHIEVEMENT_CATEGORIES) {
    var cat = ACHIEVEMENT_CATEGORIES[catId];
    var catAchievements = ACHIEVEMENTS.filter(function(a) { return a.cat === catId; });

    html += '<div class="achievement-category">';
    html += '<div class="achievement-category-header" style="border-left:3px solid ' + cat.color + '">';
    html += cat.icon + ' ' + cat.label;
    html += '<span class="achievement-category-count">' +
      catAchievements.filter(function(a) { return earned.indexOf(a.id) !== -1; }).length +
      '/' + catAchievements.length + '</span>';
    html += '</div>';
    html += '<div class="achievement-grid">';

    catAchievements.forEach(function(ach) {
      var isEarned = earned.indexOf(ach.id) !== -1;
      var isSecret = ach.secret && !isEarned;

      html += '<div class="achievement-badge ' + (isEarned ? 'earned' : 'locked') + '">';
      html += '<div class="achievement-badge-icon">' + (isSecret ? '\uD83D\uDD12' : ach.icon) + '</div>';
      html += '<div class="achievement-badge-name">' + (isSecret ? '???' : ach.name) + '</div>';
      html += '<div class="achievement-badge-desc">' + (isSecret ? 'Keep exploring to discover!' : ach.desc) + '</div>';
      if (isEarned) html += '<div class="achievement-badge-check">\u2713</div>';
      html += '</div>';
    });

    html += '</div></div>';
  }

  container.innerHTML = html;
}

// --- src/core/dynamic-quests.js ---
// ============================================================
//  DYNAMIC QUESTS — Varied daily + weekly challenges
// ============================================================

// Quest templates — each defines a type and how to check completion
var QUEST_TEMPLATES = [
  { id: 'do5',       type: 'daily', label: 'Complete 5 challenges',           icon: '\u26A1', target: 5,  check: 'quizzes' },
  { id: 'streak5',   type: 'daily', label: 'Get a 5-answer streak',           icon: '\uD83D\uDD25', target: 5,  check: 'streak' },
  { id: 'learn2',    type: 'daily', label: 'Complete 2 lessons',              icon: '\uD83D\uDCD6', target: 2,  check: 'lessons' },
  { id: 'flash3',    type: 'daily', label: 'Flip through 3 flashcard sets',   icon: '\uD83C\uDCCF', target: 3,  check: 'flashcards' },
  { id: 'review2',   type: 'daily', label: 'Review 2 skills due for review',  icon: '\uD83D\uDD14', target: 2,  check: 'reviews' },
  { id: 'math3',     type: 'daily', label: 'Answer 3 Number World questions', icon: '\uD83D\uDD22', target: 3,  check: 'mathQs' },
  { id: 'word3',     type: 'daily', label: 'Answer 3 Word World questions',   icon: '\uD83D\uDCDA', target: 3,  check: 'wordQs' },
  { id: 'stem3',     type: 'daily', label: 'Answer 3 STEM World questions',   icon: '\uD83D\uDD2C', target: 3,  check: 'stemQs' },
  { id: 'perfect1',  type: 'daily', label: 'Get a perfect score on any quiz', icon: '\uD83D\uDCAF', target: 1,  check: 'perfectQuiz' },
  { id: 'explore2',  type: 'daily', label: 'Try 2 different skills',          icon: '\uD83D\uDDFA\uFE0F', target: 2,  check: 'uniqueSkills' }
];

var WEEKLY_TEMPLATES = [
  { id: 'wk_master',  type: 'weekly', label: 'Master a new skill to 80%',           icon: '\uD83C\uDF1F', target: 1, check: 'newMastery',  reward: 50 },
  { id: 'wk_all3',    type: 'weekly', label: 'Play in all 3 worlds',                icon: '\uD83C\uDF0D', target: 3, check: 'worldsPlayed', reward: 40 },
  { id: 'wk_escape',  type: 'weekly', label: 'Complete an escape room',             icon: '\uD83D\uDD13', target: 1, check: 'escapesDone',  reward: 50 },
  { id: 'wk_streak7', type: 'weekly', label: 'Get a 7-answer streak',               icon: '\uD83D\uDD25', target: 7, check: 'bestStreak',   reward: 40 },
  { id: 'wk_15q',     type: 'weekly', label: 'Answer 15 questions correctly',        icon: '\u2705',       target: 15, check: 'weekCorrect', reward: 40 },
  { id: 'wk_learn5',  type: 'weekly', label: 'Complete 5 lessons',                   icon: '\uD83D\uDCDA', target: 5, check: 'weekLessons',  reward: 50 }
];

// Daily quest tracking counters (reset each day)
var questCounters = {
  quizzes: 0,
  lessons: 0,
  flashcards: 0,
  reviews: 0,
  mathQs: 0,
  wordQs: 0,
  stemQs: 0,
  perfectQuiz: 0,
  uniqueSkills: [],
  streak: 0
};

// Weekly quest tracking
var weeklyCounters = {
  newMastery: 0,
  worldsPlayed: [],
  escapesDone: 0,
  bestStreak: 0,
  weekCorrect: 0,
  weekLessons: 0
};

// Pick today's quest (seeded by date for consistency)
function getDailyQuest() {
  var today = new Date().toDateString();

  // If already generated today, return it
  if (state.dynamicQuest && state.dynamicQuest.date === today) {
    return state.dynamicQuest;
  }

  // Seed from date string for deterministic pick
  var seed = 0;
  for (var i = 0; i < today.length; i++) seed += today.charCodeAt(i);
  var idx = seed % QUEST_TEMPLATES.length;
  var template = QUEST_TEMPLATES[idx];

  state.dynamicQuest = {
    date: today,
    templateId: template.id,
    label: template.label,
    icon: template.icon,
    target: template.target,
    check: template.check,
    progress: 0,
    completed: false,
    claimed: false,
    reward: 20
  };

  saveState();
  return state.dynamicQuest;
}

// Pick this week's quest
function getWeeklyQuest() {
  var now = new Date();
  var weekStart = new Date(now);
  weekStart.setDate(weekStart.getDate() - weekStart.getDay());
  weekStart.setHours(0, 0, 0, 0);
  var weekKey = weekStart.toDateString();

  if (state.weeklyQuest && state.weeklyQuest.weekKey === weekKey) {
    return state.weeklyQuest;
  }

  var seed = 0;
  for (var i = 0; i < weekKey.length; i++) seed += weekKey.charCodeAt(i);
  var idx = seed % WEEKLY_TEMPLATES.length;
  var template = WEEKLY_TEMPLATES[idx];

  state.weeklyQuest = {
    weekKey: weekKey,
    templateId: template.id,
    label: template.label,
    icon: template.icon,
    target: template.target,
    check: template.check,
    progress: 0,
    completed: false,
    claimed: false,
    reward: template.reward
  };

  saveState();
  return state.weeklyQuest;
}

// Increment quest counters (called from various hooks)
function questRecordQuiz(worldType) {
  questCounters.quizzes++;
  if (worldType === 'math') questCounters.mathQs++;
  if (worldType === 'word') questCounters.wordQs++;
  if (worldType === 'stem') questCounters.stemQs++;
  weeklyCounters.weekCorrect++;
  if (worldType && weeklyCounters.worldsPlayed.indexOf(worldType) === -1) {
    weeklyCounters.worldsPlayed.push(worldType);
  }
  updateQuestProgress();
}

function questRecordPerfect() {
  questCounters.perfectQuiz++;
  updateQuestProgress();
}

function questRecordLesson() {
  questCounters.lessons++;
  weeklyCounters.weekLessons++;
  updateQuestProgress();
}

function questRecordFlashcards() {
  questCounters.flashcards++;
  updateQuestProgress();
}

function questRecordReview() {
  questCounters.reviews++;
  updateQuestProgress();
}

function questRecordSkillPlayed(skillId) {
  if (questCounters.uniqueSkills.indexOf(skillId) === -1) {
    questCounters.uniqueSkills.push(skillId);
  }
  updateQuestProgress();
}

function questRecordStreak(streakVal) {
  questCounters.streak = Math.max(questCounters.streak, streakVal);
  weeklyCounters.bestStreak = Math.max(weeklyCounters.bestStreak, streakVal);
  updateQuestProgress();
}

function questRecordEscape() {
  weeklyCounters.escapesDone++;
  updateQuestProgress();
}

function questRecordNewMastery() {
  weeklyCounters.newMastery++;
  updateQuestProgress();
}

// Update quest progress from counters
function updateQuestProgress() {
  var dq = getDailyQuest();
  if (dq && !dq.completed) {
    var val = 0;
    switch (dq.check) {
      case 'quizzes':      val = questCounters.quizzes; break;
      case 'streak':       val = questCounters.streak; break;
      case 'lessons':      val = questCounters.lessons; break;
      case 'flashcards':   val = questCounters.flashcards; break;
      case 'reviews':      val = questCounters.reviews; break;
      case 'mathQs':       val = questCounters.mathQs; break;
      case 'wordQs':       val = questCounters.wordQs; break;
      case 'stemQs':       val = questCounters.stemQs; break;
      case 'perfectQuiz':  val = questCounters.perfectQuiz; break;
      case 'uniqueSkills': val = questCounters.uniqueSkills.length; break;
    }
    dq.progress = Math.min(val, dq.target);
    if (dq.progress >= dq.target) dq.completed = true;
    saveState();
  }

  var wq = getWeeklyQuest();
  if (wq && !wq.completed) {
    var wval = 0;
    switch (wq.check) {
      case 'newMastery':   wval = weeklyCounters.newMastery; break;
      case 'worldsPlayed': wval = weeklyCounters.worldsPlayed.length; break;
      case 'escapesDone':  wval = weeklyCounters.escapesDone; break;
      case 'bestStreak':   wval = weeklyCounters.bestStreak; break;
      case 'weekCorrect':  wval = weeklyCounters.weekCorrect; break;
      case 'weekLessons':  wval = weeklyCounters.weekLessons; break;
    }
    wq.progress = Math.min(wval, wq.target);
    if (wq.progress >= wq.target) wq.completed = true;
    saveState();
  }
}

// Claim daily quest reward
function claimDailyQuest() {
  var dq = getDailyQuest();
  if (!dq || !dq.completed || dq.claimed) return;
  dq.claimed = true;
  state.tokens += dq.reward;

  // Track quest completion history for achievements
  if (!state.questHistory) state.questHistory = [];
  var today = new Date().toDateString();
  if (state.questHistory.indexOf(today) === -1) {
    state.questHistory.push(today);
    if (state.questHistory.length > 60) state.questHistory = state.questHistory.slice(-60);
  }

  if (typeof playSound === 'function') playSound('levelup');
  if (typeof spawnParticles === 'function') {
    spawnParticles(window.innerWidth / 2, window.innerHeight / 2, 12, '\u2B50');
  }
  if (typeof lumiSay === 'function') {
    lumiSay('Quest complete! +' + dq.reward + ' stars! You\'re incredible!');
  }
  if (typeof checkAchievementsAfterDailyQuest === 'function') {
    checkAchievementsAfterDailyQuest();
  }
  saveState();
  if (typeof updateHomeUI === 'function') updateHomeUI();
}

// Claim weekly quest reward
function claimWeeklyQuest() {
  var wq = getWeeklyQuest();
  if (!wq || !wq.completed || wq.claimed) return;
  wq.claimed = true;
  state.tokens += wq.reward;

  if (typeof playSound === 'function') playSound('escape');
  if (typeof spawnParticles === 'function') {
    spawnParticles(window.innerWidth / 2, window.innerHeight / 2, 20, '\uD83C\uDF1F');
  }
  if (typeof lumiSay === 'function') {
    lumiSay('WEEKLY QUEST DONE! +' + wq.reward + ' stars! You\'re a superstar!');
  }
  saveState();
  if (typeof updateHomeUI === 'function') updateHomeUI();
}

// Render quest banners (called from home.js)
function renderDynamicQuestBanner() {
  var dq = getDailyQuest();
  var html = '';

  // Daily Quest
  html += '<div class="quest-banner dynamic-quest" onclick="' +
    (dq.completed && !dq.claimed ? 'claimDailyQuest()' : '') + '">';
  html += '<div class="quest-icon">' + dq.icon + '</div>';
  html += '<div class="quest-text">';
  html += '<div class="quest-title">' + (dq.completed && !dq.claimed ? '\uD83C\uDF89 Quest Complete!' : 'Daily Quest') + '</div>';
  html += '<div class="quest-desc">' + (dq.completed && !dq.claimed ? 'Tap to claim +' + dq.reward + ' stars!' : dq.label) + '</div>';
  html += '</div>';
  html += '<div class="quest-progress-ring">';
  html += '<span>' + dq.progress + '/' + dq.target + '</span>';
  if (dq.completed && dq.claimed) html += '<span class="quest-done-check">\u2713</span>';
  html += '</div>';
  html += '</div>';

  // Weekly Quest
  var wq = getWeeklyQuest();
  html += '<div class="quest-banner weekly-quest" onclick="' +
    (wq.completed && !wq.claimed ? 'claimWeeklyQuest()' : '') + '">';
  html += '<div class="quest-icon">\uD83C\uDFC6</div>';
  html += '<div class="quest-text">';
  html += '<div class="quest-title">' + (wq.completed && !wq.claimed ? '\uD83C\uDF89 Weekly Boss Done!' : 'Weekly Challenge') + '</div>';
  html += '<div class="quest-desc">' + (wq.completed && !wq.claimed ? 'Tap to claim +' + wq.reward + ' stars!' : wq.label) + '</div>';
  html += '</div>';
  html += '<div class="quest-progress-ring weekly">';
  html += '<span>' + wq.progress + '/' + wq.target + '</span>';
  if (wq.completed && wq.claimed) html += '<span class="quest-done-check">\u2713</span>';
  html += '</div>';
  html += '</div>';

  return html;
}

// --- src/core/lumi.js ---
// ============================================================
//  LUMI — Personality engine, story arcs, emotional responses
// ============================================================

// Lumi's mood affects expressions and dialogue
var lumiState = {
  mood: 'happy',       // happy, excited, proud, concerned, sleepy
  tapCount: 0,
  lastMoodChange: 0,
  storyChapter: 0,     // 0 = not started, 1-5 = chapters
  storyShownToday: false
};

// === MOOD SYSTEM ===
var LUMI_MOODS = {
  happy:     { mouth: 'smile',  eyes: 'normal',  sparkle: true,  color: '' },
  excited:   { mouth: 'grin',   eyes: 'wide',    sparkle: true,  color: 'excited' },
  proud:     { mouth: 'smile',  eyes: 'happy',   sparkle: true,  color: 'proud' },
  concerned: { mouth: 'worry',  eyes: 'normal',  sparkle: false, color: 'concerned' },
  sleepy:    { mouth: 'sleep',  eyes: 'sleepy',  sparkle: false, color: 'sleepy' }
};

function setLumiMood(mood) {
  if (!LUMI_MOODS[mood]) return;
  lumiState.mood = mood;
  lumiState.lastMoodChange = Date.now();
  applyLumiMood();
}

function applyLumiMood() {
  var body = document.querySelector('.lumi-body');
  if (!body) return;
  var mood = LUMI_MOODS[lumiState.mood] || LUMI_MOODS.happy;

  // Remove old mood classes
  body.className = 'lumi-body';
  if (mood.color) body.classList.add('lumi-mood-' + mood.color);

  // Mouth expression
  var mouth = body.querySelector('.lumi-mouth');
  if (mouth) {
    mouth.className = 'lumi-mouth';
    mouth.classList.add('lumi-mouth-' + mood.mouth);
  }

  // Eyes
  var eyes = body.querySelectorAll('.lumi-eye');
  eyes.forEach(function(eye) {
    eye.className = eye.className.replace(/lumi-eye-\w+/g, '').trim();
    if (mood.eyes !== 'normal') eye.classList.add('lumi-eye-' + mood.eyes);
  });

  // Sparkles
  var sparkles = document.querySelectorAll('.lumi-sparkle');
  sparkles.forEach(function(s) {
    s.style.display = mood.sparkle ? '' : 'none';
  });
}

// === CONTEXT-AWARE DIALOGUE ===

// Lumi responds to what just happened
function lumiReactTo(event, data) {
  var msg = '';
  var mood = 'happy';

  switch (event) {
    case 'correct':
      mood = 'excited';
      if (state.streak >= 10) {
        msg = pick(LUMI_REACTIONS.bigStreak);
      } else if (state.streak >= 5) {
        msg = pick(LUMI_REACTIONS.streak);
      } else {
        msg = pick(LUMI_REACTIONS.correct);
      }
      break;

    case 'wrong':
      mood = 'concerned';
      msg = pick(LUMI_REACTIONS.wrong);
      break;

    case 'levelUp':
      mood = 'excited';
      msg = pick(LUMI_REACTIONS.levelUp).replace('{level}', LEVEL_NAMES[state.level] || 'a new level');
      break;

    case 'quizComplete':
      var pct = data && data.pct || 0;
      if (pct >= 90) {
        mood = 'proud';
        msg = pick(LUMI_REACTIONS.quizAmazing);
      } else if (pct >= 70) {
        mood = 'happy';
        msg = pick(LUMI_REACTIONS.quizGood);
      } else {
        mood = 'concerned';
        msg = pick(LUMI_REACTIONS.quizTryAgain);
      }
      break;

    case 'lessonComplete':
      mood = 'proud';
      msg = pick(LUMI_REACTIONS.lessonDone);
      break;

    case 'achievementUnlocked':
      mood = 'excited';
      msg = pick(LUMI_REACTIONS.achievement).replace('{name}', data && data.name || 'something special');
      break;

    case 'returnVisit':
      mood = 'happy';
      var hour = new Date().getHours();
      if (hour < 7) {
        mood = 'sleepy';
        msg = pick(LUMI_REACTIONS.earlyMorning);
      } else if (hour < 12) {
        msg = pick(LUMI_REACTIONS.morning);
      } else if (hour < 17) {
        msg = pick(LUMI_REACTIONS.afternoon);
      } else if (hour < 21) {
        msg = pick(LUMI_REACTIONS.evening);
      } else {
        mood = 'sleepy';
        msg = pick(LUMI_REACTIONS.lateNight);
      }
      break;

    case 'comeBack':
      mood = 'excited';
      msg = pick(LUMI_REACTIONS.comeBack);
      break;

    case 'firstVisitToday':
      mood = 'happy';
      msg = pick(LUMI_REACTIONS.firstToday);
      break;

    case 'questComplete':
      mood = 'excited';
      msg = pick(LUMI_REACTIONS.questDone);
      break;

    case 'gardenGrow':
      mood = 'proud';
      msg = pick(LUMI_REACTIONS.gardenGrow);
      break;
  }

  if (msg) {
    setLumiMood(mood);
    lumiSay(msg);
    // Mood fades back to happy after 8 seconds
    setTimeout(function() { setLumiMood('happy'); }, 8000);
  }
}

var LUMI_REACTIONS = {
  correct: [
    "That's right! You're so clever!",
    "YES! Your brain is amazing!",
    "Nailed it! Keep going!",
    "Woohoo! I knew you could do it!",
    "Brilliant thinking, Anastasia!"
  ],
  streak: [
    "You're on a ROLL! " + state.streak + " in a row!",
    "Wow, nothing can stop you!",
    "Your brain is ON FIRE today!",
    "Look at that streak! Incredible!"
  ],
  bigStreak: [
    "TEN IN A ROW?! You're a LEGEND!",
    "I can barely keep up with you!",
    "Stop — you're making me dizzy with excitement!",
    "This is the best streak I've EVER seen!"
  ],
  wrong: [
    "Hmm, not quite — but that's how brains grow!",
    "Mistakes are brain food! Let's try another!",
    "Oops! But I love that you tried!",
    "Your brain just got a tiny bit stronger!",
    "That's okay! Even stars wobble sometimes!"
  ],
  levelUp: [
    "OH WOW! You reached {level}! I'm so proud!",
    "LEVEL UP! {level}! You're shining brighter!",
    "{level}! This calls for a celebration!"
  ],
  quizAmazing: [
    "INCREDIBLE! That was almost perfect!",
    "I am SO proud of you right now!",
    "You absolutely CRUSHED that quiz!",
    "Is there anything you CAN'T do?!"
  ],
  quizGood: [
    "Great job! You really know your stuff!",
    "Solid work! Your brain is getting stronger!",
    "Nice! You're improving every time!"
  ],
  quizTryAgain: [
    "That was tough! But every try makes you better!",
    "Don't worry — even I get tricky ones wrong!",
    "Practice makes progress! Want to try again?"
  ],
  lessonDone: [
    "You just learned something new! How cool is that?",
    "Another lesson done! Your brain is growing!",
    "Look at you, learning like a superstar!",
    "Knowledge unlocked! I love watching you learn!"
  ],
  achievement: [
    "ACHIEVEMENT UNLOCKED: {name}! You're amazing!",
    "Wow! You earned {name}! I'm so impressed!",
    "Look what you did! {name}! Incredible!"
  ],
  earlyMorning: [
    "*yawn* You're up early, Anastasia! Let's learn while the world sleeps!",
    "Wow, you're an early bird! I'm still waking up...",
    "Good moooorning! *stretches* Ready for some brain warmups?"
  ],
  morning: [
    "Good morning, Anastasia! Your brain is fresh and ready!",
    "Rise and shine! What shall we learn today?",
    "Morning! I've been waiting for you! Let's go!",
    "Hello sunshine! Ready for an adventure?"
  ],
  afternoon: [
    "Good afternoon! Perfect time for some learning!",
    "Hey Anastasia! How about a brain workout?",
    "Afternoon brain boost! Let's do this!",
    "Welcome back! Your garden missed you!"
  ],
  evening: [
    "Good evening! Time for some relaxed learning!",
    "Evening study session! My favourite time!",
    "Hi Anastasia! Let's end the day with some fun learning!",
    "The stars are coming out — just like YOUR star potential!"
  ],
  lateNight: [
    "*yawn* Isn't it past your bedtime? Just a quick session then!",
    "A night owl! Just like me! Let's do something fun!",
    "Shh... quiet learning time! Our little secret!"
  ],
  comeBack: [
    "You're BACK! I missed you so much!",
    "Anastasia! It's been a while — I saved your place!",
    "Welcome back! Your garden has been waiting!",
    "I'm so happy to see you again! Let's pick up where we left off!"
  ],
  firstToday: [
    "Welcome back today! Ready for an awesome session?",
    "Hey! Great to see you again today!",
    "Back for more? I love your dedication!"
  ],
  questDone: [
    "QUEST COMPLETE! You're on a mission today!",
    "Done already?! You're AMAZING!",
    "Quest conquered! What's next, champion?"
  ],
  gardenGrow: [
    "A new flower! Your garden is getting so beautiful!",
    "Look! Your garden is growing! Just like your brain!",
    "Another bloom! Keep it up — paradise incoming!"
  ]
};

// === LUMI TAP INTERACTIONS ===
var LUMI_TAP_RESPONSES = [
  { maxTaps: 1, responses: ["Hi! Tap me again!", "Hey there! What's up?", "Let's learn something cool!"] },
  { maxTaps: 3, responses: ["Hehe, that tickles!", "Again! Again!", "You're funny!"] },
  { maxTaps: 5, responses: ["Okay okay, I'm awake!", "So many taps! My sparkles are going crazy!", "You really like tapping me, huh?"] },
  { maxTaps: 8, responses: ["I'm getting dizzy!", "Please... my sparkles need a break!", "Are you trying to break my tap record?!"] },
  { maxTaps: 15, responses: ["OKAY that's a LOT of taps!", "My sparkle meter is OVERLOADING!", "You've discovered my secret tickle spot!"] }
];

function lumiTapped() {
  lumiState.tapCount++;

  if (typeof checkLumiTapAchievement === 'function') {
    checkLumiTapAchievement();
  }

  // Find response tier
  var tier = LUMI_TAP_RESPONSES[0];
  for (var i = LUMI_TAP_RESPONSES.length - 1; i >= 0; i--) {
    if (lumiState.tapCount >= LUMI_TAP_RESPONSES[i].maxTaps) {
      tier = LUMI_TAP_RESPONSES[i];
      break;
    }
  }

  var msg = pick(tier.responses);
  setLumiMood(lumiState.tapCount > 8 ? 'excited' : 'happy');
  lumiSay(msg);
  if (typeof playSound === 'function') playSound('click');

  // Reset tap counter after 5 seconds of no taps
  clearTimeout(lumiState._tapTimer);
  lumiState._tapTimer = setTimeout(function() {
    lumiState.tapCount = 0;
    setLumiMood('happy');
  }, 5000);
}

// === STORY ARC: "Help Lumi Build the Star Bridge" ===
var LUMI_STORY = [
  {
    chapter: 1,
    title: "The Broken Star Bridge",
    unlockFlowers: 0,
    intro: "Anastasia, I need your help! The Star Bridge that connects all the learning worlds is broken! " +
           "Long ago, it shimmered with the light of knowledge... but its stars scattered across the worlds. " +
           "Every time you learn something new, you help me find a star to rebuild it!",
    milestone: "You found the first star! The bridge glimmers faintly...",
    icon: "\uD83C\uDF09"
  },
  {
    chapter: 2,
    title: "The Number Stars",
    unlockFlowers: 5,
    intro: "Look! The Number World stars are beginning to glow! " +
           "The bridge needs stars from all three worlds to be complete. " +
           "Keep learning in Number World and the math stars will light the way!",
    milestone: "The Number World section of the bridge is shining!",
    icon: "\uD83D\uDD22"
  },
  {
    chapter: 3,
    title: "The Word Stars",
    unlockFlowers: 12,
    intro: "The Word Stars are calling! Every word you learn, every story you read, " +
           "sends a new light up to the bridge. I can almost see the words dancing across it!",
    milestone: "Beautiful! The Word Stars illuminate the bridge with stories!",
    icon: "\uD83D\uDCDA"
  },
  {
    chapter: 4,
    title: "The STEM Stars",
    unlockFlowers: 20,
    intro: "We're getting close! The STEM Stars are the trickiest — they need experiments " +
           "and discoveries to shine. But I believe in you, Anastasia. You're the brightest " +
           "learner I've ever met!",
    milestone: "The STEM Stars flash like lightning! The bridge is almost complete!",
    icon: "\uD83D\uDD2C"
  },
  {
    chapter: 5,
    title: "The Complete Star Bridge",
    unlockFlowers: 30,
    intro: "ANASTASIA! LOOK! The Star Bridge is COMPLETE! All three worlds are connected " +
           "by YOUR knowledge and YOUR hard work! Every lesson, every quiz, every discovery " +
           "— they all led to this moment. I am SO proud of you!",
    milestone: "The Star Bridge shines forever, powered by everything you've learned!",
    icon: "\uD83C\uDF1F"
  }
];

function checkStoryProgress() {
  var flowers = state.garden ? state.garden.length : 0;

  // Find current chapter
  var currentChapter = 0;
  for (var i = LUMI_STORY.length - 1; i >= 0; i--) {
    if (flowers >= LUMI_STORY[i].unlockFlowers) {
      currentChapter = i + 1;
      break;
    }
  }

  // Check if new chapter unlocked
  if (!state.lumiStory) state.lumiStory = { chapter: 0, shownChapters: [] };

  if (currentChapter > state.lumiStory.chapter) {
    state.lumiStory.chapter = currentChapter;
    saveState();
    return currentChapter; // New chapter!
  }
  return 0; // No new chapter
}

function showStoryChapter(chapterNum) {
  if (chapterNum < 1 || chapterNum > LUMI_STORY.length) return;

  var ch = LUMI_STORY[chapterNum - 1];
  if (!state.lumiStory) state.lumiStory = { chapter: 0, shownChapters: [] };

  // Mark as shown
  if (state.lumiStory.shownChapters.indexOf(chapterNum) === -1) {
    state.lumiStory.shownChapters.push(chapterNum);
    saveState();
  }

  // Show story overlay
  var overlay = document.getElementById('story-overlay');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.id = 'story-overlay';
    overlay.className = 'story-overlay';
    document.body.appendChild(overlay);
  }

  overlay.innerHTML =
    '<div class="story-card">' +
      '<div class="story-chapter-badge">Chapter ' + chapterNum + '</div>' +
      '<div class="story-icon">' + ch.icon + '</div>' +
      '<div class="story-title">' + ch.title + '</div>' +
      '<div class="story-text">' + ch.intro + '</div>' +
      '<div class="story-bridge">' + renderStoryBridge(chapterNum) + '</div>' +
      '<button class="lesson-btn lesson-btn-done" onclick="closeStoryOverlay()">Continue \u2192</button>' +
    '</div>';

  overlay.classList.add('show');
  setLumiMood('excited');

  if (typeof playSound === 'function') playSound('escape');
}

function closeStoryOverlay() {
  var overlay = document.getElementById('story-overlay');
  if (overlay) overlay.classList.remove('show');
}

// Render a mini star bridge progress visual
function renderStoryBridge(currentChapter) {
  var html = '<div class="story-bridge-row">';
  for (var i = 1; i <= 5; i++) {
    var lit = i <= currentChapter;
    html += '<div class="story-bridge-star ' + (lit ? 'lit' : '') + '">' +
      (lit ? '\u2B50' : '\u2606') + '</div>';
    if (i < 5) html += '<div class="story-bridge-link ' + (lit ? 'lit' : '') + '"></div>';
  }
  html += '</div>';
  return html;
}

// Render story progress bar for home screen
function renderStoryProgress() {
  if (!state.lumiStory) state.lumiStory = { chapter: 0, shownChapters: [] };
  var ch = state.lumiStory.chapter || 0;
  if (ch === 0) ch = 1; // Show chapter 1 by default

  var story = LUMI_STORY[Math.min(ch, LUMI_STORY.length) - 1];
  var nextStory = ch < LUMI_STORY.length ? LUMI_STORY[ch] : null;
  var flowers = state.garden ? state.garden.length : 0;

  var html = '<div class="story-progress-card" onclick="showStoryChapter(' + ch + ')">';
  html += '<div class="story-progress-header">';
  html += '<span class="story-progress-icon">' + story.icon + '</span>';
  html += '<span class="story-progress-title">Star Bridge: ' + story.title + '</span>';
  html += '</div>';
  html += '<div class="story-progress-bridge">' + renderStoryBridge(ch) + '</div>';
  if (nextStory) {
    var needed = nextStory.unlockFlowers - flowers;
    if (needed > 0) {
      html += '<div class="story-progress-next">' + needed + ' more flower' + (needed > 1 ? 's' : '') + ' to unlock Chapter ' + (ch + 1) + '</div>';
    }
  } else if (ch >= LUMI_STORY.length) {
    html += '<div class="story-progress-next" style="color:var(--gold)">Star Bridge Complete!</div>';
  }
  html += '</div>';

  return html;
}

// Called on app init to set Lumi's initial mood and trigger story
function initLumi() {
  var hour = new Date().getHours();
  if (hour < 7 || hour >= 22) {
    setLumiMood('sleepy');
  } else {
    setLumiMood('happy');
  }

  // Check for new story chapter
  var newChapter = checkStoryProgress();
  if (newChapter > 0) {
    // Show new chapter after a short delay
    if (!state.lumiStory.shownChapters || state.lumiStory.shownChapters.indexOf(newChapter) === -1) {
      setTimeout(function() { showStoryChapter(newChapter); }, 1500);
    }
  }

  // React based on visit context
  var today = new Date().toDateString();
  if (state.lastVisit === today) {
    lumiReactTo('firstVisitToday');
  } else if (state.lastVisit) {
    // Calculate days since last visit
    var last = new Date(state.lastVisit);
    var now = new Date();
    var daysDiff = Math.floor((now - last) / (1000 * 60 * 60 * 24));
    if (daysDiff > 3) {
      lumiReactTo('comeBack');
    } else {
      lumiReactTo('returnVisit');
    }
  } else {
    lumiReactTo('returnVisit');
  }
}

// --- src/core/adaptive.js ---
// ============================================================
//  ADAPTIVE ENGINE — ZPD, skill tracking, difficulty, unlocks
// ============================================================

// CPA Level names
const CPA_LEVELS = ['Concrete', 'Pictorial', 'Abstract', 'Fluency', 'Challenge'];

function updateSkillState(skillId, correct, confidence) {
  const skill = getSkillState(skillId);
  skill.recentResults.push({ correct, confidence, timestamp: Date.now() });
  if (skill.recentResults.length > 10) skill.recentResults.shift();
  skill.totalAttempts++;

  if (correct) {
    skill.totalCorrect++;
    skill.streak++;
    if (skill.streak > skill.bestStreak) skill.bestStreak = skill.streak;
  } else {
    skill.streak = 0;
  }

  // Calculate accuracy over recent window (last 8)
  const recent = skill.recentResults.slice(-8);
  const accuracy = recent.length > 0 ? recent.filter(r => r.correct).length / recent.length : 0;

  // ZPD Adaptation — advance or scaffold
  if (recent.length >= 5) {
    if (accuracy >= 0.85 && skill.level < 4) {
      skill.level++;
      addGardenFlower(skillId);
    } else if (accuracy < 0.4 && skill.level > 0) {
      skill.level--;
    }
  }

  // Multi-factor mastery if spaced-review is loaded, else simple
  if (typeof computeMultiFactorMastery === 'function') {
    skill.mastery = computeMultiFactorMastery(skillId);
  } else {
    const totalAcc = skill.totalAttempts > 0 ? skill.totalCorrect / skill.totalAttempts : 0;
    skill.mastery = Math.min(100, Math.round(
      accuracy * 50 + totalAcc * 30 + Math.min(skill.level / 4, 1) * 20
    ));
  }

  return skill;
}

function getSkillDifficulty(skillId) {
  const skill = getSkillState(skillId);
  return {
    level: skill.level,
    isConcrete: skill.level === 0,
    isPictorial: skill.level === 1,
    isAbstract: skill.level >= 2,
    isFluency: skill.level === 3,
    isChallenge: skill.level === 4,
    numberRange: [
      [1, 10],    // concrete
      [1, 10],    // pictorial
      [1, 20],    // abstract
      [1, 50],    // fluency
      [1, 100]    // challenge
    ][skill.level] || [1, 10]
  };
}

// Check if a skill's dependencies are met (>=40% mastery on all deps)
function isSkillUnlocked(skillDef) {
  if (!skillDef.deps || skillDef.deps.length === 0) return true;
  return skillDef.deps.every(depId => {
    const dep = getSkillState(depId);
    return dep.mastery >= 40;
  });
}

// Get unlocked skills from a tree
function getUnlockedSkills(tree) {
  const result = { unlocked: [], locked: [] };
  for (const skill of Object.values(tree)) {
    if (isSkillUnlocked(skill)) {
      result.unlocked.push(skill);
    } else {
      result.locked.push(skill);
    }
  }
  return result;
}

// Calculate average mastery for a set of skill IDs
function calculateWorldProgress(skillIds) {
  if (skillIds.length === 0) return 0;
  const masteries = skillIds.map(id => getSkillState(id).mastery);
  return Math.round(masteries.reduce((a, b) => a + b, 0) / masteries.length);
}

// Suggest next skill based on ZPD (moderate mastery, not too easy/hard)
function getRecommendedSkill(tree) {
  const { unlocked } = getUnlockedSkills(tree);
  if (unlocked.length === 0) return null;

  // Prefer skills with 20-60% mastery (in the learning zone)
  const zpd = unlocked.filter(s => {
    const m = getSkillState(s.id).mastery;
    return m >= 20 && m <= 60;
  });
  if (zpd.length > 0) return pick(zpd);

  // Fallback: lowest mastery that's unlocked
  return unlocked.reduce((best, s) => {
    const m = getSkillState(s.id).mastery;
    const bestM = getSkillState(best.id).mastery;
    return m < bestM ? s : best;
  });
}

// Render activity cards for a skill tree (used by math, word, stem worlds)
function renderActivityCards(tree, containerId, worldType) {
  const container = document.getElementById(containerId);
  if (!container) return;

  // Group by grade if applicable
  const grades = {};
  for (const skill of Object.values(tree)) {
    const group = skill.grade || skill.group || skill.type || 'General';
    if (!grades[group]) grades[group] = [];
    grades[group].push(skill);
  }

  let html = '';
  for (const [grade, skills] of Object.entries(grades)) {
    html += `<div class="grade-section">`;
    html += `<div class="grade-label">${grade}</div>`;
    html += `<div class="activity-grid">`;

    for (const skill of skills) {
      const s = getSkillState(skill.id);
      const unlocked = isSkillUnlocked(skill);
      const stars = Array.from({ length: 5 }, (_, i) =>
        `<span class="mastery-star ${i < Math.ceil(s.mastery / 20) ? 'filled' : ''}">\u2B50</span>`
      ).join('');

      const lockText = unlocked ? '' :
        `<div class="activity-card-lock">Master ${skill.deps.join(' & ')} first</div>`;

      // Review-due badge
      let reviewBadge = '';
      if (unlocked && typeof isSkillDueForReview === 'function' && isSkillDueForReview(skill.id)) {
        reviewBadge = '<div class="review-due-badge">Review due</div>';
      }

      // Lesson-viewed indicator
      let learnBadge = '';
      if (unlocked && s.lessonViewed && s.lessonViewed[skill.id]) {
        learnBadge = '<span class="learn-done-dot" title="Lesson completed">📖</span>';
      }

      html += `<div class="activity-card ${unlocked ? '' : 'locked'}"
        onclick="${unlocked ? `openSkillView('${skill.id}','${worldType}')` : ''}"
        ${unlocked ? '' : 'title="Locked"'}>
        ${reviewBadge}
        <span class="activity-card-icon">${skill.icon}</span>
        <div class="activity-card-name">${skill.name} ${learnBadge}</div>
        <div class="activity-card-level">${unlocked ? `Level ${s.level + 1} \u00B7 ${CPA_LEVELS[s.level] || 'Concrete'}` : '\uD83D\uDD12 Locked'}</div>
        ${lockText}
        <div class="mastery-stars">${stars}</div>
      </div>`;
    }

    html += `</div></div>`;
  }

  container.innerHTML = html;
}

// --- src/core/audio.js ---
// ============================================================
//  AUDIO — Web Audio API sound effects
// ============================================================

let audioCtx = null;

function getAudioCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}

function playSound(type) {
  try {
    const ctx = getAudioCtx();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    gain.gain.value = 0.15;

    if (type === 'correct') {
      osc.frequency.setValueAtTime(523, ctx.currentTime);
      osc.frequency.setValueAtTime(659, ctx.currentTime + 0.1);
      osc.frequency.setValueAtTime(784, ctx.currentTime + 0.2);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
      osc.start(ctx.currentTime);
      osc.stop(ctx.currentTime + 0.4);
    } else if (type === 'wrong') {
      osc.frequency.setValueAtTime(300, ctx.currentTime);
      osc.frequency.setValueAtTime(250, ctx.currentTime + 0.15);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
      osc.start(ctx.currentTime);
      osc.stop(ctx.currentTime + 0.3);
    } else if (type === 'click') {
      osc.frequency.setValueAtTime(600, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.08);
      osc.start(ctx.currentTime);
      osc.stop(ctx.currentTime + 0.1);
    } else if (type === 'levelup') {
      [523, 659, 784, 1047].forEach((f, i) => {
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.connect(g); g.connect(ctx.destination);
        g.gain.value = 0.12;
        o.frequency.setValueAtTime(f, ctx.currentTime + i * 0.15);
        g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + i * 0.15 + 0.3);
        o.start(ctx.currentTime + i * 0.15);
        o.stop(ctx.currentTime + i * 0.15 + 0.3);
      });
    } else if (type === 'token') {
      osc.frequency.setValueAtTime(880, ctx.currentTime);
      osc.frequency.setValueAtTime(1100, ctx.currentTime + 0.05);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
      osc.start(ctx.currentTime);
      osc.stop(ctx.currentTime + 0.15);
    } else if (type === 'streak') {
      [784, 988, 1175, 1319].forEach((f, i) => {
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.connect(g); g.connect(ctx.destination);
        g.gain.value = 0.1;
        o.frequency.setValueAtTime(f, ctx.currentTime + i * 0.1);
        g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + i * 0.1 + 0.2);
        o.start(ctx.currentTime + i * 0.1);
        o.stop(ctx.currentTime + i * 0.1 + 0.2);
      });
    } else if (type === 'unlock') {
      [440, 554, 659, 880].forEach((f, i) => {
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.connect(g); g.connect(ctx.destination);
        g.gain.value = 0.1;
        o.type = 'triangle';
        o.frequency.setValueAtTime(f, ctx.currentTime + i * 0.12);
        g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + i * 0.12 + 0.25);
        o.start(ctx.currentTime + i * 0.12);
        o.stop(ctx.currentTime + i * 0.12 + 0.25);
      });
    } else if (type === 'escape') {
      [523, 659, 784, 1047, 1319].forEach((f, i) => {
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.connect(g); g.connect(ctx.destination);
        g.gain.value = 0.12;
        o.type = 'square';
        o.frequency.setValueAtTime(f, ctx.currentTime + i * 0.12);
        g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + i * 0.12 + 0.3);
        o.start(ctx.currentTime + i * 0.12);
        o.stop(ctx.currentTime + i * 0.12 + 0.3);
      });
    }
  } catch(e) {}
}

// --- src/core/learn-engine.js ---
// ============================================================
//  LEARN ENGINE — Visual step-by-step lesson renderer for P1
//  Renders structured lesson data into interactive visual pages
// ============================================================

// Lesson data format:
// {
//   title: 'Adding Numbers',
//   icon: '➕',
//   lumiSays: 'Let me show you how to add!',
//   steps: [
//     { visual: '🍎🍎🍎', text: 'We have 3 apples.', highlight: 'count' },
//     { visual: '🍎🍎',   text: 'And 2 more apples!', highlight: 'add' },
//     { visual: '🍎🍎🍎🍎🍎', text: '3 + 2 = 5 altogether!', highlight: 'result' },
//     { type: 'try', prompt: 'How many altogether?', visual: '⭐⭐ + ⭐⭐⭐', answer: '5' }
//   ]
// }

function renderLesson(container, lessonData, skillId, onComplete) {
  if (!lessonData || !lessonData.steps || lessonData.steps.length === 0) {
    container.innerHTML = '<div class="lesson-empty">No lesson available yet!</div>';
    return;
  }

  let currentStep = 0;
  const totalSteps = lessonData.steps.length;

  function renderStep() {
    const step = lessonData.steps[currentStep];
    container.innerHTML = '';
    container.style.animation = 'none';
    container.offsetHeight;
    container.style.animation = 'slide-up 0.4s ease-out';

    // Progress dots
    let dotsHtml = '<div class="lesson-dots">';
    for (let i = 0; i < totalSteps; i++) {
      const cls = i < currentStep ? 'done' : i === currentStep ? 'current' : '';
      dotsHtml += '<div class="lesson-dot ' + cls + '"></div>';
    }
    dotsHtml += '</div>';

    // Check if this is a "try it" interactive step
    if (step.type === 'try') {
      renderTryStep(container, step, dotsHtml);
      return;
    }

    // Check if this is a "sort" interactive step
    if (step.type === 'sort') {
      renderSortStep(container, step, dotsHtml);
      return;
    }

    // Check if this is a "match" interactive step
    if (step.type === 'match') {
      renderMatchStep(container, step, dotsHtml);
      return;
    }

    // Regular visual step
    let html = dotsHtml;

    // Visual area
    if (step.visual) {
      html += '<div class="lesson-visual ' + (step.highlight || '') + '">';
      html += step.visual;
      html += '</div>';
    }

    // Image (emoji-based illustration)
    if (step.image) {
      html += '<div class="lesson-image">' + step.image + '</div>';
    }

    // Text explanation
    if (step.text) {
      html += '<div class="lesson-text">' + step.text + '</div>';
    }

    // Lumi tip
    if (step.lumiTip) {
      html += '<div class="lesson-lumi-tip">';
      html += '<span class="lesson-lumi-icon">⭐</span>';
      html += '<span>' + step.lumiTip + '</span>';
      html += '</div>';
    }

    // Navigation
    html += '<div class="lesson-nav">';
    if (currentStep > 0) {
      html += '<button class="lesson-btn lesson-btn-back" id="lesson-prev">← Back</button>';
    }
    if (currentStep < totalSteps - 1) {
      html += '<button class="lesson-btn lesson-btn-next" id="lesson-next">Next →</button>';
    } else {
      html += '<button class="lesson-btn lesson-btn-done" id="lesson-done">Got it! ✓</button>';
    }
    html += '</div>';

    container.innerHTML = html;

    // Bind events
    const prevBtn = document.getElementById('lesson-prev');
    const nextBtn = document.getElementById('lesson-next');
    const doneBtn = document.getElementById('lesson-done');

    if (prevBtn) prevBtn.onclick = function() { currentStep--; renderStep(); };
    if (nextBtn) nextBtn.onclick = function() { currentStep++; renderStep(); };
    if (doneBtn) doneBtn.onclick = function() { completeLesson(); };
  }

  function renderTryStep(cont, step, dotsHtml) {
    let html = dotsHtml;
    html += '<div class="lesson-try-badge">Your Turn!</div>';

    if (step.visual) {
      html += '<div class="lesson-visual try">' + step.visual + '</div>';
    }

    if (step.prompt) {
      html += '<div class="lesson-text">' + step.prompt + '</div>';
    }

    if (step.options) {
      // MCQ try
      html += '<div class="lesson-try-options">';
      step.options.forEach(function(opt) {
        html += '<button class="lesson-try-btn" data-val="' + opt + '">' + opt + '</button>';
      });
      html += '</div>';
    } else {
      // Type-in try
      html += '<div class="lesson-try-input-wrap">';
      html += '<input type="text" class="lesson-try-input" id="lesson-try-answer" inputmode="numeric" autocomplete="off" placeholder="?">';
      html += '<button class="lesson-btn lesson-btn-next" id="lesson-try-check">Check ✓</button>';
      html += '</div>';
    }

    html += '<div class="lesson-try-feedback" id="lesson-try-fb"></div>';

    html += '<div class="lesson-nav">';
    if (currentStep > 0) {
      html += '<button class="lesson-btn lesson-btn-back" id="lesson-prev">← Back</button>';
    }
    html += '</div>';

    cont.innerHTML = html;

    // Bind option buttons
    cont.querySelectorAll('.lesson-try-btn').forEach(function(btn) {
      btn.onclick = function() {
        const val = btn.dataset.val;
        const correct = String(val).trim() === String(step.answer).trim();
        const fb = document.getElementById('lesson-try-fb');
        cont.querySelectorAll('.lesson-try-btn').forEach(function(b) { b.disabled = true; });

        if (correct) {
          btn.classList.add('correct');
          fb.innerHTML = '🎉 ' + (step.successMsg || 'That\'s right!');
          fb.className = 'lesson-try-feedback correct show';
          if (typeof playSound === 'function') playSound('correct');
        } else {
          btn.classList.add('wrong');
          fb.innerHTML = '💡 The answer is ' + step.answer + '. ' + (step.explanation || '');
          fb.className = 'lesson-try-feedback wrong show';
        }

        setTimeout(function() {
          if (currentStep < totalSteps - 1) {
            currentStep++;
            renderStep();
          } else {
            completeLesson();
          }
        }, correct ? 1200 : 2200);
      };
    });

    // Bind type-in check
    var checkBtn = document.getElementById('lesson-try-check');
    var ansInput = document.getElementById('lesson-try-answer');
    if (checkBtn && ansInput) {
      checkBtn.onclick = function() {
        var val = ansInput.value.trim();
        if (!val) return;
        var correct = val === String(step.answer).trim();
        var fb = document.getElementById('lesson-try-fb');
        ansInput.disabled = true;
        checkBtn.disabled = true;

        if (correct) {
          fb.innerHTML = '🎉 ' + (step.successMsg || 'That\'s right!');
          fb.className = 'lesson-try-feedback correct show';
          if (typeof playSound === 'function') playSound('correct');
        } else {
          fb.innerHTML = '💡 The answer is ' + step.answer + '. ' + (step.explanation || '');
          fb.className = 'lesson-try-feedback wrong show';
        }

        setTimeout(function() {
          if (currentStep < totalSteps - 1) {
            currentStep++;
            renderStep();
          } else {
            completeLesson();
          }
        }, correct ? 1200 : 2200);
      };
      ansInput.onkeydown = function(e) { if (e.key === 'Enter') checkBtn.click(); };
    }

    var prevBtn = document.getElementById('lesson-prev');
    if (prevBtn) prevBtn.onclick = function() { currentStep--; renderStep(); };
  }

  function renderSortStep(cont, step, dotsHtml) {
    // Sort items into categories by tapping
    var html = dotsHtml;
    html += '<div class="lesson-try-badge">Sort These!</div>';
    if (step.text) html += '<div class="lesson-text">' + step.text + '</div>';

    var categories = step.categories; // [{name, items, color}]
    var allItems = [];
    categories.forEach(function(cat) {
      cat.items.forEach(function(item) {
        allItems.push({ item: item, category: cat.name });
      });
    });
    allItems = shuffle(allItems);

    html += '<div class="lesson-sort-items" id="sort-items">';
    allItems.forEach(function(entry, i) {
      html += '<span class="lesson-sort-chip" data-idx="' + i + '" data-cat="' + entry.category + '">' + entry.item + '</span>';
    });
    html += '</div>';

    html += '<div class="lesson-sort-zones">';
    categories.forEach(function(cat) {
      html += '<div class="lesson-sort-zone" data-zone="' + cat.name + '">';
      html += '<div class="lesson-sort-zone-label">' + cat.name + '</div>';
      html += '<div class="lesson-sort-zone-items" id="zone-' + cat.name.replace(/\s/g, '') + '"></div>';
      html += '</div>';
    });
    html += '</div>';

    html += '<div class="lesson-try-feedback" id="lesson-try-fb"></div>';
    html += '<div class="lesson-nav">';
    if (currentStep > 0) html += '<button class="lesson-btn lesson-btn-back" id="lesson-prev">← Back</button>';
    html += '</div>';

    cont.innerHTML = html;

    var selected = null;
    var sorted = 0;
    var total = allItems.length;

    cont.querySelectorAll('.lesson-sort-chip').forEach(function(chip) {
      chip.onclick = function() {
        cont.querySelectorAll('.lesson-sort-chip').forEach(function(c) { c.classList.remove('selected'); });
        chip.classList.add('selected');
        selected = chip;
      };
    });

    cont.querySelectorAll('.lesson-sort-zone').forEach(function(zone) {
      zone.onclick = function() {
        if (!selected) return;
        var correctCat = selected.dataset.cat;
        var zoneCat = zone.dataset.zone;
        if (correctCat === zoneCat) {
          zone.querySelector('.lesson-sort-zone-items').appendChild(selected);
          selected.classList.remove('selected');
          selected.classList.add('placed');
          selected.onclick = null;
          selected = null;
          sorted++;
          if (sorted >= total) {
            var fb = document.getElementById('lesson-try-fb');
            fb.innerHTML = '🎉 Great sorting!';
            fb.className = 'lesson-try-feedback correct show';
            if (typeof playSound === 'function') playSound('correct');
            setTimeout(function() {
              if (currentStep < totalSteps - 1) { currentStep++; renderStep(); }
              else completeLesson();
            }, 1500);
          }
        } else {
          selected.classList.add('shake');
          setTimeout(function() { selected.classList.remove('shake'); }, 500);
        }
      };
    });

    var prevBtn = document.getElementById('lesson-prev');
    if (prevBtn) prevBtn.onclick = function() { currentStep--; renderStep(); };
  }

  function renderMatchStep(cont, step, dotsHtml) {
    // Match pairs by tapping two items
    var html = dotsHtml;
    html += '<div class="lesson-try-badge">Match the Pairs!</div>';
    if (step.text) html += '<div class="lesson-text">' + step.text + '</div>';

    var pairs = step.pairs; // [{left, right}]
    var leftItems = shuffle(pairs.map(function(p) { return p.left; }));
    var rightItems = shuffle(pairs.map(function(p) { return p.right; }));

    html += '<div class="lesson-match-grid">';
    html += '<div class="lesson-match-col">';
    leftItems.forEach(function(item, i) {
      html += '<div class="lesson-match-item left" data-val="' + item + '">' + item + '</div>';
    });
    html += '</div>';
    html += '<div class="lesson-match-col">';
    rightItems.forEach(function(item, i) {
      html += '<div class="lesson-match-item right" data-val="' + item + '">' + item + '</div>';
    });
    html += '</div>';
    html += '</div>';

    html += '<div class="lesson-try-feedback" id="lesson-try-fb"></div>';
    html += '<div class="lesson-nav">';
    if (currentStep > 0) html += '<button class="lesson-btn lesson-btn-back" id="lesson-prev">← Back</button>';
    html += '</div>';

    cont.innerHTML = html;

    var pairMap = {};
    pairs.forEach(function(p) { pairMap[p.left] = p.right; });

    var selectedLeft = null;
    var matched = 0;

    cont.querySelectorAll('.lesson-match-item.left').forEach(function(item) {
      item.onclick = function() {
        cont.querySelectorAll('.lesson-match-item.left').forEach(function(i) { i.classList.remove('selected'); });
        item.classList.add('selected');
        selectedLeft = item.dataset.val;
      };
    });

    cont.querySelectorAll('.lesson-match-item.right').forEach(function(item) {
      item.onclick = function() {
        if (!selectedLeft) return;
        if (pairMap[selectedLeft] === item.dataset.val) {
          // Correct match
          item.classList.add('matched');
          cont.querySelector('.lesson-match-item.left[data-val="' + selectedLeft + '"]').classList.add('matched');
          cont.querySelector('.lesson-match-item.left[data-val="' + selectedLeft + '"]').classList.remove('selected');
          cont.querySelector('.lesson-match-item.left[data-val="' + selectedLeft + '"]').onclick = null;
          item.onclick = null;
          selectedLeft = null;
          matched++;
          if (matched >= pairs.length) {
            var fb = document.getElementById('lesson-try-fb');
            fb.innerHTML = '🎉 All matched!';
            fb.className = 'lesson-try-feedback correct show';
            if (typeof playSound === 'function') playSound('correct');
            setTimeout(function() {
              if (currentStep < totalSteps - 1) { currentStep++; renderStep(); }
              else completeLesson();
            }, 1500);
          }
        } else {
          item.classList.add('shake');
          setTimeout(function() { item.classList.remove('shake'); }, 500);
        }
      };
    });

    var prevBtn = document.getElementById('lesson-prev');
    if (prevBtn) prevBtn.onclick = function() { currentStep--; renderStep(); };
  }

  function completeLesson() {
    // Mark lesson as viewed in skill state
    var skill = getSkillState(skillId);
    if (!skill.lessonViewed) skill.lessonViewed = {};
    skill.lessonViewed[skillId] = Date.now();
    saveState();

    container.innerHTML = '<div class="lesson-complete">' +
      '<div class="lesson-complete-icon">🌟</div>' +
      '<div class="lesson-complete-title">Lesson Complete!</div>' +
      '<div class="lesson-complete-msg">Great learning, ' + (state.name || 'Anastasia') + '!</div>' +
      '<button class="lesson-btn lesson-btn-done" id="lesson-finish">Continue →</button>' +
      '</div>';

    if (typeof playSound === 'function') playSound('levelup');

    document.getElementById('lesson-finish').onclick = function() {
      if (typeof onComplete === 'function') onComplete();
    };
  }

  // Start
  renderStep();
}

// --- src/core/flashcard-engine.js ---
// ============================================================
//  FLASHCARD ENGINE — Flip-card system with tracking
//  Supports sight words, math facts, vocab, science terms
// ============================================================

// Flashcard data format:
// [{ front: 'the', back: 'a common sight word', category: 'sight-l1', image: '📖' }]

function renderFlashcards(container, cards, skillId, onComplete) {
  if (!cards || cards.length === 0) {
    container.innerHTML = '<div class="lesson-empty">No flashcards available yet!</div>';
    return;
  }

  var deck = shuffle([...cards]);
  var idx = 0;
  var correct = 0;
  var total = deck.length;
  var isFlipped = false;

  function renderCard() {
    if (idx >= total) {
      showResults();
      return;
    }

    isFlipped = false;
    var card = deck[idx];
    container.innerHTML = '';
    container.style.animation = 'none';
    container.offsetHeight;
    container.style.animation = 'slide-up 0.3s ease-out';

    var html = '';

    // Progress
    html += '<div class="fc-progress">';
    html += '<span class="fc-count">' + (idx + 1) + ' / ' + total + '</span>';
    html += '<div class="fc-bar"><div class="fc-bar-fill" style="width:' + Math.round((idx / total) * 100) + '%"></div></div>';
    html += '</div>';

    // The card
    html += '<div class="fc-card" id="fc-card">';
    html += '<div class="fc-front">';
    if (card.image) html += '<div class="fc-image">' + card.image + '</div>';
    html += '<div class="fc-front-text">' + card.front + '</div>';
    html += '<div class="fc-tap-hint">Tap to reveal</div>';
    html += '</div>';
    html += '<div class="fc-back">';
    html += '<div class="fc-back-text">' + card.back + '</div>';
    if (card.example) html += '<div class="fc-example">' + card.example + '</div>';
    html += '</div>';
    html += '</div>';

    // Rating buttons (shown after flip)
    html += '<div class="fc-rating hidden" id="fc-rating">';
    html += '<div class="fc-rating-label">Did you know it?</div>';
    html += '<div class="fc-rating-btns">';
    html += '<button class="fc-rate-btn fc-rate-no" id="fc-no">Not yet 🤔</button>';
    html += '<button class="fc-rate-btn fc-rate-yes" id="fc-yes">Got it! ⭐</button>';
    html += '</div>';
    html += '</div>';

    container.innerHTML = html;

    // Bind flip
    document.getElementById('fc-card').onclick = function() {
      if (isFlipped) return;
      isFlipped = true;
      this.classList.add('flipped');
      document.getElementById('fc-rating').classList.remove('hidden');
    };

    // Bind rating
    document.getElementById('fc-yes').onclick = function() {
      correct++;
      recordFlashcard(skillId, deck[idx], true);
      idx++;
      renderCard();
    };
    document.getElementById('fc-no').onclick = function() {
      recordFlashcard(skillId, deck[idx], false);
      // Put it back near the end for another try
      if (total - idx > 2) {
        var missed = deck[idx];
        deck.splice(idx, 1);
        var insertAt = Math.min(idx + 3 + Math.floor(Math.random() * 3), deck.length);
        deck.splice(insertAt, 0, missed);
        total = deck.length;
      } else {
        idx++;
      }
      renderCard();
    };
  }

  function recordFlashcard(sid, card, wasCorrect) {
    var skill = getSkillState(sid);
    if (!skill.flashcardProgress) skill.flashcardProgress = {};
    var key = card.front;
    if (!skill.flashcardProgress[key]) {
      skill.flashcardProgress[key] = { correct: 0, attempts: 0, lastSeen: 0 };
    }
    skill.flashcardProgress[key].attempts++;
    if (wasCorrect) skill.flashcardProgress[key].correct++;
    skill.flashcardProgress[key].lastSeen = Date.now();
    saveState();
  }

  function showResults() {
    var pct = Math.round((correct / cards.length) * 100);
    var icon = pct >= 80 ? '🏆' : pct >= 50 ? '⭐' : '📚';
    var msg = pct >= 80 ? 'Amazing recall!' : pct >= 50 ? 'Good progress!' : 'Keep practising!';

    container.innerHTML = '<div class="fc-results">' +
      '<div class="fc-results-icon">' + icon + '</div>' +
      '<div class="fc-results-title">' + correct + ' / ' + cards.length + ' cards mastered</div>' +
      '<div class="fc-results-pct">' + pct + '%</div>' +
      '<div class="fc-results-msg">' + msg + '</div>' +
      '<div class="fc-results-btns">' +
        '<button class="lesson-btn lesson-btn-next" id="fc-retry">Try Again</button>' +
        '<button class="lesson-btn lesson-btn-done" id="fc-done">Continue →</button>' +
      '</div>' +
    '</div>';

    document.getElementById('fc-retry').onclick = function() {
      idx = 0; correct = 0; deck = shuffle([...cards]); total = deck.length;
      renderCard();
    };
    document.getElementById('fc-done').onclick = function() {
      if (typeof onComplete === 'function') onComplete();
    };
  }

  renderCard();
}

// --- src/math/math-tree.js ---
// ============================================================
//  MATH TREE — 28-skill tree with dependencies (P1-P4)
// ============================================================

const MATH_TREE = {
  // === P1 Foundation ===
  count:  { id:'count',  name:'Counting & Ten Frames', icon:'\uD83D\uDD1F', grade:'P1 Foundation', deps:[], desc:'Count objects and use ten frames' },
  nbond:  { id:'nbond',  name:'Number Bonds',          icon:'\uD83D\uDD17', grade:'P1 Foundation', deps:['count'], desc:'Break numbers into parts' },
  add:    { id:'add',    name:'Addition',               icon:'\u2795',       grade:'P1 Foundation', deps:['count'], desc:'Put numbers together' },
  sub:    { id:'sub',    name:'Subtraction',            icon:'\u2796',       grade:'P1 Foundation', deps:['count'], desc:'Take numbers apart' },
  cmp:    { id:'cmp',    name:'Comparing Numbers',      icon:'\u2696\uFE0F', grade:'P1 Foundation', deps:['count'], desc:'Which is bigger or smaller?' },
  pat:    { id:'pat',    name:'Patterns',               icon:'\uD83D\uDD36', grade:'P1 Foundation', deps:['count'], desc:'Find and complete patterns' },
  wp1:    { id:'wp1',    name:'Story Problems',         icon:'\uD83D\uDCDD', grade:'P1 Foundation', deps:['add','sub'], desc:'Solve real-world puzzles' },
  shp:    { id:'shp',    name:'Shape Explorer',         icon:'\uD83D\uDD37', grade:'P1 Foundation', deps:[], desc:'Discover 2D shapes' },

  // === P2 Expansion ===
  add100: { id:'add100', name:'Addition to 100',        icon:'\u2795',       grade:'P2 Expansion', deps:['add','nbond'], desc:'Add bigger numbers with regrouping' },
  sub100: { id:'sub100', name:'Subtraction to 100',     icon:'\u2796',       grade:'P2 Expansion', deps:['sub','nbond'], desc:'Subtract bigger numbers' },
  mul:    { id:'mul',    name:'Multiplication',         icon:'\u2716\uFE0F', grade:'P2 Expansion', deps:['add'], desc:'Times tables 2,3,4,5,10' },
  div:    { id:'div',    name:'Division',               icon:'\u2797',       grade:'P2 Expansion', deps:['mul'], desc:'Equal sharing and grouping' },
  frac1:  { id:'frac1',  name:'Fractions Basics',       icon:'\uD83E\uDD67', grade:'P2 Expansion', deps:['div'], desc:'Halves, thirds, quarters' },
  money:  { id:'money',  name:'Money',                  icon:'\uD83D\uDCB0', grade:'P2 Expansion', deps:['add100','sub100'], desc:'Singapore dollars and cents' },
  time1:  { id:'time1',  name:'Time',                   icon:'\uD83D\uDD50', grade:'P2 Expansion', deps:['count'], desc:'Read clocks and tell time' },
  pgraph: { id:'pgraph', name:'Picture Graphs',         icon:'\uD83D\uDCCA', grade:'P2 Expansion', deps:['count','add'], desc:'Read and make graphs' },
  lenmass:{ id:'lenmass',name:'Length & Mass',           icon:'\uD83D\uDCCF', grade:'P2 Expansion', deps:['cmp'], desc:'Comparing and measuring' },

  // === P3 Deepening ===
  add10k: { id:'add10k', name:'Addition to 10,000',     icon:'\u2795',       grade:'P3 Deepening', deps:['add100'], desc:'Column method with regrouping' },
  sub10k: { id:'sub10k', name:'Subtraction to 10,000',  icon:'\u2796',       grade:'P3 Deepening', deps:['sub100'], desc:'Column subtraction' },
  advmul: { id:'advmul', name:'Advanced Multiplication', icon:'\u2716\uFE0F', grade:'P3 Deepening', deps:['mul'], desc:'Times tables 6-9, multi-digit' },
  divrem: { id:'divrem', name:'Division with Remainder', icon:'\u2797',       grade:'P3 Deepening', deps:['div'], desc:'Division with leftovers' },
  fracadd:{ id:'fracadd',name:'Fraction Add/Subtract',  icon:'\uD83E\uDD67', grade:'P3 Deepening', deps:['frac1'], desc:'Adding fractions (same denominator)' },
  area:   { id:'area',   name:'Area & Perimeter',       icon:'\u2B1C',       grade:'P3 Deepening', deps:['mul','lenmass'], desc:'Count squares and trace edges' },
  angle:  { id:'angle',  name:'Angles',                 icon:'\uD83D\uDCD0', grade:'P3 Deepening', deps:['shp'], desc:'Right, acute, and obtuse angles' },
  bargraph:{ id:'bargraph',name:'Bar Graphs',           icon:'\uD83D\uDCCA', grade:'P3 Deepening', deps:['pgraph'], desc:'Read and interpret bar graphs' },

  // === P4 Mastery ===
  bignum: { id:'bignum', name:'Big Numbers',            icon:'\uD83D\uDD22', grade:'P4 Mastery', deps:['add10k'], desc:'Place value to 100,000' },
  multiop:{ id:'multiop',name:'Long Multiply/Divide',   icon:'\uD83E\uDDEE', grade:'P4 Mastery', deps:['advmul','divrem'], desc:'Multi-digit operations' },
  factor: { id:'factor', name:'Factors & Multiples',    icon:'\uD83C\uDF33', grade:'P4 Mastery', deps:['advmul'], desc:'Factor trees and LCM' },
  mixfrac:{ id:'mixfrac',name:'Mixed Fractions',        icon:'\uD83E\uDD67', grade:'P4 Mastery', deps:['fracadd'], desc:'Improper and mixed fractions' },
  decimal:{ id:'decimal',name:'Decimals',               icon:'\u2024',       grade:'P4 Mastery', deps:['frac1'], desc:'Tenths and hundredths' },
  symm:   { id:'symm',   name:'Symmetry',               icon:'\uD83E\uDE9E', grade:'P4 Mastery', deps:['shp'], desc:'Lines of symmetry' },
  dataan: { id:'dataan', name:'Data Analysis',          icon:'\uD83D\uDCC8', grade:'P4 Mastery', deps:['bargraph'], desc:'Tables, line graphs, averages' },
  multiwp:{ id:'multiwp',name:'Multi-step Problems',    icon:'\uD83E\uDDE9', grade:'P4 Mastery', deps:['wp1','mul'], desc:'Complex word problems' }
};

// --- src/math/math-lessons.js ---
// ============================================================
//  MATH LESSONS — Visual step-by-step lessons for every math skill
//  Each lesson teaches the concept BEFORE quizzing
// ============================================================

var MATH_LESSONS = {
  // ── P1 FOUNDATION ──
  count: {
    title: 'Counting & Ten Frames',
    icon: '🔢',
    lumiSays: 'Let\'s count together! Counting is the start of all maths!',
    steps: [
      { visual: '🍎🍎🍎', text: 'Count the apples. Point and count: 1... 2... 3!', lumiTip: 'Always point at each thing as you count!' },
      { visual: '<div class="ten-frame-demo"><div class="tf-dot filled"></div><div class="tf-dot filled"></div><div class="tf-dot filled"></div><div class="tf-dot filled"></div><div class="tf-dot"></div><div class="tf-dot"></div><div class="tf-dot"></div><div class="tf-dot"></div><div class="tf-dot"></div><div class="tf-dot"></div></div>', text: 'This is a <b>ten frame</b>. It has 10 boxes. We filled 4!', lumiTip: 'A ten frame helps us see numbers up to 10.' },
      { visual: '<div class="ten-frame-demo"><div class="tf-dot filled"></div><div class="tf-dot filled"></div><div class="tf-dot filled"></div><div class="tf-dot filled"></div><div class="tf-dot filled"></div><div class="tf-dot filled"></div><div class="tf-dot filled"></div><div class="tf-dot"></div><div class="tf-dot"></div><div class="tf-dot"></div></div>', text: 'How many empty boxes? 3 empty means 7 are filled!', lumiTip: 'We can count what\'s missing too!' },
      { type: 'try', visual: '🌟🌟🌟🌟🌟', prompt: 'How many stars are there?', options: ['4', '5', '6'], answer: '5', successMsg: 'You counted perfectly!' }
    ]
  },

  nbond: {
    title: 'Number Bonds',
    icon: '🔗',
    lumiSays: 'Number bonds show how numbers fit together!',
    steps: [
      { visual: '<div class="bond-demo"><div class="bond-whole">5</div><div class="bond-line"></div><div class="bond-parts"><span class="bond-part">3</span><span class="bond-part">2</span></div></div>', text: '<b>5</b> can be split into <b>3</b> and <b>2</b>.', lumiTip: 'The parts always add up to the whole!' },
      { visual: '<div class="bond-demo"><div class="bond-whole">7</div><div class="bond-line"></div><div class="bond-parts"><span class="bond-part">4</span><span class="bond-part">3</span></div></div>', text: '<b>7</b> = <b>4</b> + <b>3</b>. The whole is on top!', lumiTip: 'If you know one part, you can find the other.' },
      { visual: '🍎🍎🍎 + 🍎🍎 = 🍎🍎🍎🍎🍎', text: 'See? 3 apples and 2 apples make 5 apples!', lumiTip: 'Number bonds help with adding and subtracting.' },
      { type: 'try', visual: '<div class="bond-demo"><div class="bond-whole">6</div><div class="bond-line"></div><div class="bond-parts"><span class="bond-part">4</span><span class="bond-part">?</span></div></div>', prompt: 'What is the missing part?', options: ['1', '2', '3'], answer: '2', successMsg: '4 + 2 = 6. You found it!' }
    ]
  },

  add: {
    title: 'Addition',
    icon: '➕',
    lumiSays: 'Adding means putting things together!',
    steps: [
      { visual: '🐱🐱 + 🐱🐱🐱', text: 'We have 2 cats and 3 more cats join them.', lumiTip: 'Addition puts groups together.' },
      { visual: '🐱🐱🐱🐱🐱', text: '2 + 3 = <b>5</b> cats altogether!', lumiTip: 'Count them all to find the answer.' },
      { visual: '<div class="bar-demo"><div class="bar-part" style="flex:3;background:var(--sky)">3</div><div class="bar-part" style="flex:4;background:var(--coral)">4</div></div><div class="bar-total">3 + 4 = 7</div>', text: 'A <b>bar model</b> shows how parts make a whole.', lumiTip: 'Bar models are super useful for word problems!' },
      { type: 'try', visual: '🌸🌸🌸🌸 + 🌸🌸', prompt: 'How many flowers altogether?', options: ['5', '6', '7'], answer: '6', successMsg: '4 + 2 = 6. Wonderful!' }
    ]
  },

  sub: {
    title: 'Subtraction',
    icon: '➖',
    lumiSays: 'Subtracting means taking away!',
    steps: [
      { visual: '🍪🍪🍪🍪🍪', text: 'We have 5 cookies.', lumiTip: 'We start with the bigger number.' },
      { visual: '🍪🍪🍪<span class="crossed">🍪🍪</span>', text: 'We eat 2 cookies. Cross them out!', lumiTip: 'Crossing out helps us see what\'s left.' },
      { visual: '🍪🍪🍪', text: '5 − 2 = <b>3</b> cookies left!', lumiTip: 'Subtraction finds how many are left.' },
      { type: 'try', visual: '⭐⭐⭐⭐⭐⭐ take away ⭐⭐', prompt: '6 − 2 = ?', options: ['3', '4', '5'], answer: '4', successMsg: '6 − 2 = 4. Brilliant!' }
    ]
  },

  cmp: {
    title: 'Comparing Numbers',
    icon: '⚖️',
    lumiSays: 'Let\'s learn which numbers are bigger or smaller!',
    steps: [
      { visual: '<div class="cmp-demo"><div class="cmp-group"><div class="cmp-count">3</div>🐸🐸🐸</div><div class="cmp-sign">&lt;</div><div class="cmp-group"><div class="cmp-count">5</div>🐸🐸🐸🐸🐸</div></div>', text: '3 is <b>less than</b> 5. We write 3 &lt; 5.', lumiTip: 'The pointy side faces the smaller number!' },
      { visual: '<div class="cmp-demo"><div class="cmp-group"><div class="cmp-count">7</div>🌺🌺🌺🌺🌺🌺🌺</div><div class="cmp-sign">&gt;</div><div class="cmp-group"><div class="cmp-count">4</div>🌺🌺🌺🌺</div></div>', text: '7 is <b>greater than</b> 4. We write 7 &gt; 4.', lumiTip: 'The open side faces the bigger number — like a hungry crocodile!' },
      { visual: '<div class="cmp-demo"><div class="cmp-group"><div class="cmp-count">5</div>🎈🎈🎈🎈🎈</div><div class="cmp-sign">=</div><div class="cmp-group"><div class="cmp-count">5</div>🎈🎈🎈🎈🎈</div></div>', text: '5 is <b>equal to</b> 5. Same amount!', lumiTip: 'Equal means exactly the same!' },
      { type: 'try', prompt: 'Which is correct? 8 __ 3', options: ['8 < 3', '8 > 3', '8 = 3'], answer: '8 > 3', successMsg: '8 is greater than 3!' }
    ]
  },

  pat: {
    title: 'Patterns',
    icon: '🔄',
    lumiSays: 'Patterns repeat! Let\'s find the rule!',
    steps: [
      { visual: '🔴🔵🔴🔵🔴🔵', text: 'Red, blue, red, blue... the pattern repeats!', lumiTip: 'Look for what comes over and over.' },
      { visual: '🔺🔺⬜🔺🔺⬜🔺🔺❓', text: 'Triangle, triangle, square... what comes next?', lumiTip: 'Find the repeating group first.' },
      { visual: '2, 4, 6, 8, __', text: 'Number patterns! We add 2 each time. Next is <b>10</b>!', lumiTip: 'Ask: what is the rule? +1? +2? +3?' },
      { type: 'try', prompt: 'What comes next? 🌟🌙🌟🌙🌟 __', options: ['🌟', '🌙', '☀️'], answer: '🌙', successMsg: 'The pattern is star, moon, star, moon!' }
    ]
  },

  wp1: {
    title: 'Word Problems',
    icon: '📝',
    lumiSays: 'Word problems are stories with numbers!',
    steps: [
      { visual: '🧸🧸🧸 ➕ 🧸🧸', text: 'Anastasia has 3 toys. She gets 2 more. How many now?', lumiTip: '"Gets more" means we ADD!' },
      { visual: '<div class="bar-demo"><div class="bar-part" style="flex:3;background:var(--sky)">3</div><div class="bar-part" style="flex:2;background:var(--mint)">2</div></div><div class="bar-total">3 + 2 = 5 toys!</div>', text: 'Draw a bar model to help! The parts make the whole.', lumiTip: 'Bar models make word problems easier!' },
      { text: '<b>Key words to look for:</b><br>"altogether" → add<br>"left" or "remaining" → subtract<br>"more than" → add or compare<br>"fewer" → subtract or compare', lumiTip: 'Circle the key words in the question!' },
      { type: 'try', prompt: 'Lumi has 7 stars. She gives 3 away. How many are left?', options: ['3', '4', '10'], answer: '4', successMsg: '7 − 3 = 4. You used the key word "left"!' }
    ]
  },

  shp: {
    title: 'Shapes',
    icon: '🔷',
    lumiSays: 'Shapes are everywhere! Let\'s learn their names!',
    steps: [
      { visual: '<div style="font-size:60px">⬜ ⬟ 🔺 ⭕</div>', text: 'Square, pentagon, triangle, circle!', lumiTip: 'Count the sides and corners!' },
      { text: '<b>Sides and Corners:</b><br>🔺 Triangle = 3 sides, 3 corners<br>⬜ Square = 4 equal sides, 4 corners<br>⬟ Rectangle = 4 sides, 4 corners<br>⭕ Circle = 0 sides, 0 corners', lumiTip: 'A square is a special rectangle!' },
      { type: 'match', text: 'Match the shape to its number of sides!', pairs: [
        { left: '🔺 Triangle', right: '3 sides' },
        { left: '⬜ Square', right: '4 sides' },
        { left: '⭕ Circle', right: '0 sides' },
        { left: '⬟ Pentagon', right: '5 sides' }
      ]},
      { type: 'try', prompt: 'How many corners does a triangle have?', options: ['2', '3', '4'], answer: '3', successMsg: 'A triangle has 3 corners and 3 sides!' }
    ]
  },

  // ── P2 EXPANSION ──
  add100: {
    title: 'Addition to 100',
    icon: '🧮',
    lumiSays: 'Let\'s add bigger numbers!',
    steps: [
      { visual: '<div class="place-val-demo"><div class="pv-col"><div class="pv-label">Tens</div><div class="pv-blocks">🟦🟦🟦</div><div>30</div></div><div class="pv-col"><div class="pv-label">Ones</div><div class="pv-blocks">🟩🟩🟩🟩</div><div>4</div></div></div>', text: '34 = 3 tens and 4 ones!', lumiTip: 'Break numbers into tens and ones.' },
      { text: '<b>Adding with regrouping:</b><br>27 + 15<br>= 20 + 7 + 10 + 5<br>= 30 + 12<br>= 30 + 10 + 2<br>= <b>42</b>', lumiTip: 'When ones add up to more than 10, we regroup!' },
      { type: 'try', prompt: '36 + 22 = ?', options: ['56', '58', '54'], answer: '58', successMsg: '36 + 22 = 58. Great adding!' }
    ]
  },

  sub100: {
    title: 'Subtraction to 100',
    icon: '📐',
    lumiSays: 'Subtracting bigger numbers is the same idea!',
    steps: [
      { text: '<b>Subtracting step by step:</b><br>53 − 21<br>= 50 − 20 and 3 − 1<br>= 30 + 2<br>= <b>32</b>', lumiTip: 'Subtract tens from tens, ones from ones.' },
      { text: '<b>With regrouping:</b><br>42 − 17<br>Ones: 2 − 7? Not enough!<br>Borrow 1 ten: 12 − 7 = 5<br>Tens: 3 − 1 = 2<br>= <b>25</b>', lumiTip: 'Borrow from the tens when ones aren\'t enough.' },
      { type: 'try', prompt: '65 − 23 = ?', options: ['42', '43', '44'], answer: '42', successMsg: '65 − 23 = 42. Well done!' }
    ]
  },

  mul: {
    title: 'Multiplication',
    icon: '✖️',
    lumiSays: 'Multiplication is fast adding!',
    steps: [
      { visual: '<div class="array-demo"><div class="array-row">🍎🍎🍎</div><div class="array-row">🍎🍎🍎</div><div class="array-row">🍎🍎🍎</div><div class="array-row">🍎🍎🍎</div></div>', text: '4 rows of 3 apples = 4 × 3 = <b>12</b>!', lumiTip: 'An array shows multiplication as rows and columns.' },
      { text: '<b>Times tables trick:</b><br>2× = doubles (2,4,6,8,10...)<br>5× = ends in 0 or 5<br>10× = add a zero!', lumiTip: 'Learn 2s, 5s, and 10s first — they\'re the easiest!' },
      { type: 'try', prompt: '3 × 5 = ?', options: ['12', '15', '18'], answer: '15', successMsg: '3 groups of 5 = 15!' }
    ]
  },

  div: {
    title: 'Division',
    icon: '➗',
    lumiSays: 'Division is sharing equally!',
    steps: [
      { visual: '🍬🍬🍬🍬🍬🍬 → 👧👧👧', text: '6 sweets shared among 3 friends. Each gets <b>2</b>!', lumiTip: 'Division is the opposite of multiplication.' },
      { text: '<b>Two ways to think about division:</b><br>12 ÷ 3 = 4<br>• Sharing: 12 sweets in 3 groups = 4 each<br>• Grouping: How many 3s in 12? → 4 groups', lumiTip: 'If you know your times tables, division is easy!' },
      { type: 'try', prompt: '10 ÷ 2 = ?', options: ['4', '5', '6'], answer: '5', successMsg: '10 shared between 2 = 5 each!' }
    ]
  },

  frac1: {
    title: 'Fractions',
    icon: '🥧',
    lumiSays: 'Fractions are parts of a whole!',
    steps: [
      { visual: '<div style="display:flex;gap:4px"><div style="width:50px;height:50px;background:var(--sky);border-radius:4px"></div><div style="width:50px;height:50px;background:var(--bg-mid);border:2px dashed var(--text-dim);border-radius:4px"></div></div>', text: 'This shape is cut into 2 equal parts. 1 is shaded = <b>½</b> (one half)', lumiTip: 'The bottom number tells how many equal parts. The top tells how many are shaded.' },
      { visual: '<div style="display:flex;gap:4px"><div style="width:40px;height:40px;background:var(--coral);border-radius:4px"></div><div style="width:40px;height:40px;background:var(--bg-mid);border:2px dashed var(--text-dim);border-radius:4px"></div><div style="width:40px;height:40px;background:var(--bg-mid);border:2px dashed var(--text-dim);border-radius:4px"></div><div style="width:40px;height:40px;background:var(--bg-mid);border:2px dashed var(--text-dim);border-radius:4px"></div></div>', text: '1 out of 4 parts = <b>¼</b> (one quarter)', lumiTip: 'Equal parts means each piece is the same size!' },
      { type: 'try', prompt: 'A pizza is cut into 4 slices. You eat 2. What fraction did you eat?', options: ['¼', '½', '¾'], answer: '½', successMsg: '2 out of 4 = ½. Half the pizza!' }
    ]
  },

  money: {
    title: 'Money',
    icon: '💰',
    lumiSays: 'Let\'s learn about Singapore money!',
    steps: [
      { text: '<b>Singapore Coins:</b><br>🪙 5¢, 10¢, 20¢, 50¢<br><b>Singapore Notes:</b><br>💵 $2, $5, $10, $50', lumiTip: '100 cents = 1 dollar!' },
      { text: '<b>Adding money:</b><br>A pencil costs $2.<br>An eraser costs $1.<br>Total = $2 + $1 = <b>$3</b>', lumiTip: 'Adding prices is just like regular addition!' },
      { type: 'try', prompt: 'A book costs $5. You pay with $10. What is your change?', options: ['$3', '$5', '$15'], answer: '$5', successMsg: '$10 − $5 = $5 change!' }
    ]
  },

  time1: {
    title: 'Telling Time',
    icon: '🕐',
    lumiSays: 'Let\'s read the clock!',
    steps: [
      { text: '<b>The clock has 2 hands:</b><br>🔵 Short hand = <b>hour</b><br>🔴 Long hand = <b>minutes</b><br>When the long hand points to 12, it\'s "o\'clock"!', lumiTip: 'The short hand moves slowly, the long hand moves fast!' },
      { text: '<b>Half past:</b><br>When the long hand points to 6, it\'s "half past".<br>🕧 = half past 12<br>🕐 = 1 o\'clock', lumiTip: 'Half past means 30 minutes past the hour.' },
      { type: 'try', prompt: 'The short hand is on 3, the long hand is on 12. What time is it?', options: ['12 o\'clock', '3 o\'clock', 'Half past 3'], answer: '3 o\'clock', successMsg: 'Long hand on 12 = o\'clock!' }
    ]
  },

  pgraph: {
    title: 'Picture Graphs',
    icon: '📊',
    lumiSays: 'Graphs help us compare information!',
    steps: [
      { text: '<b>Favourite Fruit:</b><br>🍎🍎🍎🍎 = 4 children<br>🍌🍌🍌 = 3 children<br>🍇🍇🍇🍇🍇 = 5 children', lumiTip: 'Count the pictures to find the number!' },
      { text: '<b>What can we learn?</b><br>Most popular = Grapes (5)<br>Least popular = Banana (3)<br>Difference = 5 − 3 = 2', lumiTip: 'Graphs help us answer questions about data.' },
      { type: 'try', prompt: 'In the graph above, how many more children like grapes than bananas?', options: ['1', '2', '3'], answer: '2', successMsg: '5 − 3 = 2 more children!' }
    ]
  },

  lenmass: {
    title: 'Length & Mass',
    icon: '📏',
    lumiSays: 'Let\'s measure things!',
    steps: [
      { text: '<b>Length</b> tells how long something is.<br>We use <b>cm</b> (centimetres) and <b>m</b> (metres).<br>100 cm = 1 m', lumiTip: 'A ruler measures centimetres. Your arm is about 1 metre!' },
      { text: '<b>Mass</b> tells how heavy something is.<br>We use <b>g</b> (grams) and <b>kg</b> (kilograms).<br>1000 g = 1 kg', lumiTip: 'A bag of rice is about 1 kg!' },
      { type: 'try', prompt: 'Which is longer: 50 cm or 1 m?', options: ['50 cm', '1 m', 'Same'], answer: '1 m', successMsg: '1 m = 100 cm, so 1 m is longer!' }
    ]
  }
};

// Get lesson data for a skill, returns null if not available
function getMathLesson(skillId) {
  return MATH_LESSONS[skillId] || null;
}

// Get flashcard data for math facts
function getMathFlashcards(skillId) {
  var cards = [];

  if (skillId === 'nbond') {
    for (var whole = 3; whole <= 10; whole++) {
      var part1 = Math.floor(Math.random() * (whole - 1)) + 1;
      cards.push({ front: whole + ' = ' + part1 + ' + ?', back: String(whole - part1), image: '🔗' });
    }
  }

  if (skillId === 'add') {
    [[2,3],[4,5],[3,6],[7,2],[5,5],[8,1],[6,4],[3,7],[9,1],[4,4]].forEach(function(pair) {
      cards.push({ front: pair[0] + ' + ' + pair[1], back: String(pair[0] + pair[1]), image: '➕' });
    });
  }

  if (skillId === 'sub') {
    [[5,2],[7,3],[9,4],[8,5],[6,1],[10,3],[7,4],[9,6],[8,3],[10,7]].forEach(function(pair) {
      cards.push({ front: pair[0] + ' − ' + pair[1], back: String(pair[0] - pair[1]), image: '➖' });
    });
  }

  if (skillId === 'mul') {
    [2,3,4,5,10].forEach(function(times) {
      for (var i = 1; i <= 5; i++) {
        cards.push({ front: i + ' × ' + times, back: String(i * times), image: '✖️' });
      }
    });
  }

  return cards.length > 0 ? cards : null;
}

// --- src/word/word-data.js ---
// ============================================================
//  WORD DATA — CVC, sight words, vocab, passages, grammar, poetry
// ============================================================

// ------------------------------------
//  1. CVC Word Families
// ------------------------------------
const CVC_FAMILIES = {
  'at': ['cat','bat','hat','mat','rat','sat','fat','pat'],
  'an': ['can','fan','man','pan','ran','van','tan','ban'],
  'ig': ['big','dig','fig','jig','pig','wig'],
  'it': ['bit','fit','hit','kit','sit','wit','lit','pit'],
  'op': ['cop','hop','mop','pop','top','bop'],
  'ot': ['cot','dot','got','hot','lot','not','pot'],
  'ug': ['bug','dug','hug','jug','mug','rug','tug'],
  'en': ['den','hen','men','pen','ten'],
  'et': ['bet','get','jet','let','met','net','pet','set','wet'],
  'in': ['bin','din','fin','pin','tin','win'],
  'ed': ['bed','fed','led','red'],
  'un': ['bun','fun','gun','nun','run','sun'],
  'up': ['cup','pup','sup']
};

// ------------------------------------
//  2. Sight Words (progressive P1 Singapore levels)
// ------------------------------------
const SIGHT_WORDS_BY_LEVEL = [
  ['the','a','I','is','it','in','to','and','we','my','go','no','up','at','on','he','she','do'],
  ['can','has','am','are','you','all','was','his','her','but','not','an','had','one','two','or'],
  ['they','with','this','have','from','what','were','when','there','how','many','some','like','come','make'],
  ['would','find','way','did','get','made','may','part','over','into','time','look','now','long'],
  ['about','because','before','after','then','first','next','last','every','never','always','around','found','should']
];

// ------------------------------------
//  3. Sentence Patterns
// ------------------------------------
const SENTENCE_PATTERNS = [
  { pattern: ['The','_noun','is','_adj','.'], level: 0 },
  { pattern: ['I','can','_verb','the','_noun','.'], level: 0 },
  { pattern: ['The','_adj','_noun','_verb','s','.'], level: 1 },
  { pattern: ['My','_noun','is','very','_adj','.'], level: 1 },
  { pattern: ['The','_noun','and','the','_noun','are','_adj','.'], level: 2 },
  { pattern: ['_name','_verb','s','to','the','_place','.'], level: 2 },
  { pattern: ['I','like','to','_verb','because','it','is','_adj','.'], level: 3 }
];

// ------------------------------------
//  4. Word Banks
// ------------------------------------
const WORD_BANKS = {
  nouns: ['cat','dog','fish','bird','tree','sun','moon','star','book','ball','cake','house','car','boat','hat','box','frog','duck'],
  adjectives: ['big','small','red','blue','happy','tall','soft','fast','new','old','hot','cold','kind','brave','funny','bright'],
  verbs: ['run','jump','swim','fly','eat','read','sing','play','walk','dance','draw','help','look','sit','clap','hop'],
  names: ['Ana','Ben','Lin','Sam','Mei','Tom','Zara','Kai'],
  places: ['park','school','shop','beach','garden','zoo','lake','hill']
};

// ------------------------------------
//  5. Story Prompts (8 original + 4 Singapore-flavoured)
// ------------------------------------
const STORY_PROMPTS = [
  'One sunny morning, a little cat found a golden key...',
  'In a garden full of talking flowers, there lived...',
  'The stars in the sky began to dance because...',
  'A tiny dragon was afraid of fire, so it...',
  'On the deepest part of the ocean floor, a fish discovered...',
  'When the moon turned purple, everyone knew that...',
  'A pencil that could draw real things was found by...',
  'The smallest ant in the colony had the biggest dream...',
  'At the hawker centre, a magic bowl of laksa began to...',
  'A friendly merlion came to life one night and...',
  'Inside the Botanic Gardens, a talking orchid whispered...',
  'On the MRT train, a tiny fairy was spotted by...'
];

// ------------------------------------
//  6. Vocabulary Items (10 original + 12 new)
// ------------------------------------
const VOCAB_ITEMS = [
  { word: 'enormous', meaning: 'very very big', sentence: 'The elephant was enormous.', options: ['very big','very small','very fast','very quiet'] },
  { word: 'tiny', meaning: 'very very small', sentence: 'The ant was tiny.', options: ['very small','very tall','very loud','very slow'] },
  { word: 'furious', meaning: 'very very angry', sentence: 'The king was furious when the crown went missing.', options: ['very angry','very happy','very tired','very hungry'] },
  { word: 'delighted', meaning: 'very very happy', sentence: 'She was delighted to see her best friend.', options: ['very happy','very sad','very scared','very sleepy'] },
  { word: 'ancient', meaning: 'very very old', sentence: 'The castle was ancient and full of cobwebs.', options: ['very old','very new','very clean','very bright'] },
  { word: 'swift', meaning: 'very very fast', sentence: 'The deer was swift and ran across the field.', options: ['very fast','very slow','very heavy','very small'] },
  { word: 'curious', meaning: 'wanting to know more', sentence: 'The curious cat peeked inside the box.', options: ['wanting to know more','feeling tired','feeling angry','wanting to sleep'] },
  { word: 'brave', meaning: 'not afraid', sentence: 'The brave girl saved the puppy from the river.', options: ['not afraid','very small','very quiet','not happy'] },
  { word: 'gorgeous', meaning: 'very very beautiful', sentence: 'The sunset was gorgeous.', options: ['very beautiful','very ugly','very dark','very cold'] },
  { word: 'exhausted', meaning: 'very very tired', sentence: 'After the long race, he was exhausted.', options: ['very tired','very strong','very excited','very hungry'] },
  { word: 'resilient', meaning: 'able to recover quickly from difficulty', sentence: 'The resilient plant grew back after the storm.', options: ['able to recover quickly','very fragile','very colourful','very tiny'] },
  { word: 'vibrant', meaning: 'full of life and colour', sentence: 'The market was vibrant with bright lights and music.', options: ['full of life and colour','very dull','very quiet','very empty'] },
  { word: 'tranquil', meaning: 'calm and peaceful', sentence: 'The lake was tranquil in the early morning.', options: ['calm and peaceful','very noisy','very dangerous','very dirty'] },
  { word: 'diligent', meaning: 'hardworking and careful', sentence: 'The diligent student finished all her homework on time.', options: ['hardworking and careful','very lazy','very forgetful','very naughty'] },
  { word: 'graceful', meaning: 'moving in a smooth and beautiful way', sentence: 'The ballet dancer was graceful on stage.', options: ['moving beautifully','very clumsy','very stiff','very loud'] },
  { word: 'fragile', meaning: 'easy to break', sentence: 'Be careful with the fragile glass vase.', options: ['easy to break','very strong','very heavy','very large'] },
  { word: 'generous', meaning: 'willing to give and share', sentence: 'The generous boy shared his lunch with his friend.', options: ['willing to share','very greedy','very shy','very mean'] },
  { word: 'brilliant', meaning: 'very clever or very bright', sentence: 'She had a brilliant idea for the school project.', options: ['very clever','very silly','very boring','very quiet'] },
  { word: 'timid', meaning: 'shy and easily frightened', sentence: 'The timid rabbit hid behind the bush.', options: ['shy and easily frightened','very brave','very loud','very naughty'] },
  { word: 'soggy', meaning: 'very wet and soft', sentence: 'His shoes were soggy after walking in the rain.', options: ['very wet and soft','very dry','very hard','very clean'] },
  { word: 'gleaming', meaning: 'shining brightly', sentence: 'The gleaming trophy sat on the shelf.', options: ['shining brightly','very dull','very rough','very old'] },
  { word: 'peculiar', meaning: 'strange or unusual', sentence: 'There was a peculiar sound coming from the attic.', options: ['strange or unusual','very normal','very loud','very soft'] }
];

// ------------------------------------
//  7. Comprehension Passages (12 passages)
// ------------------------------------
const COMPREHENSION_PASSAGES = [
  {
    title: 'The Lost Kitten',
    text: 'Mei found a tiny kitten under the bench at the park. It was grey and wet from the rain. She gently picked it up and brought it home. Her mother helped her dry the kitten with a soft towel.',
    questions: [
      { question: 'Where did Mei find the kitten?', options: ['Under a bench at the park','In her house','At the school','In a shop'], answer: 'Under a bench at the park' },
      { question: 'What colour was the kitten?', options: ['Grey','White','Black','Brown'], answer: 'Grey' },
      { question: 'How do you think Mei felt when she found the kitten?', options: ['Caring and kind','Angry and upset','Bored','Scared'], answer: 'Caring and kind' }
    ]
  },
  {
    title: 'The Big Race',
    text: 'Sam and Ben had a race in the school field. Sam ran as fast as he could but tripped on a stone. Ben stopped running and helped Sam get up. They walked to the finish line together.',
    questions: [
      { question: 'Where did Sam and Ben have their race?', options: ['In the school field','At the park','At the beach','In the garden'], answer: 'In the school field' },
      { question: 'What happened to Sam during the race?', options: ['He tripped on a stone','He won the race','He fell into a puddle','He ran the wrong way'], answer: 'He tripped on a stone' },
      { question: 'What does this story tell us about Ben?', options: ['He is a kind friend','He is very fast','He does not like racing','He is afraid of stones'], answer: 'He is a kind friend' }
    ]
  },
  {
    title: 'A Visit to the Zoo',
    text: 'Lin went to the Singapore Zoo with her family on Saturday. She saw tall giraffes eating leaves from the trees. Her favourite animal was the baby elephant because it sprayed water with its trunk. Lin wished she could visit the zoo every week.',
    questions: [
      { question: 'When did Lin go to the zoo?', options: ['On Saturday','On Sunday','On Monday','On Friday'], answer: 'On Saturday' },
      { question: 'What were the giraffes doing?', options: ['Eating leaves from the trees','Drinking water','Sleeping on the grass','Running around'], answer: 'Eating leaves from the trees' },
      { question: 'Why was the baby elephant Lin\u2019s favourite?', options: ['It sprayed water with its trunk','It was very tall','It could fly','It was sleeping'], answer: 'It sprayed water with its trunk' }
    ]
  },
  {
    title: 'The Magic Paintbrush',
    text: 'Tom found a paintbrush in the garden. When he painted a bird, it came to life and flew away! He painted a plate of cookies next. The cookies became real and he shared them with his sister.',
    questions: [
      { question: 'Where did Tom find the paintbrush?', options: ['In the garden','In his room','At school','In a shop'], answer: 'In the garden' },
      { question: 'What happened when Tom painted a bird?', options: ['It came to life and flew away','It stayed on the paper','It turned into a fish','It disappeared'], answer: 'It came to life and flew away' },
      { question: 'What kind of person is Tom?', options: ['He likes to share','He is selfish','He is lazy','He is always angry'], answer: 'He likes to share' }
    ]
  },
  {
    title: 'Rainy Day Fun',
    text: 'It rained all day so Ana could not go outside to play. She decided to build a fort with pillows and blankets in the living room. Her brother Kai helped her. They pretended they were explorers in a cave.',
    questions: [
      { question: 'Why could Ana not go outside?', options: ['It was raining all day','She was sick','Her mother said no','It was too hot'], answer: 'It was raining all day' },
      { question: 'What did Ana build?', options: ['A fort with pillows and blankets','A sandcastle','A paper boat','A puzzle'], answer: 'A fort with pillows and blankets' },
      { question: 'What did Ana and Kai pretend to be?', options: ['Explorers in a cave','Pirates on a ship','Teachers at school','Chefs in a kitchen'], answer: 'Explorers in a cave' }
    ]
  },
  {
    title: 'The Helpful Ant',
    text: 'A little ant saw a butterfly stuck in a spider web. The ant was very small but it was also very brave. It climbed up and bit through the web thread by thread. The butterfly was free at last and thanked the ant.',
    questions: [
      { question: 'What was stuck in the spider web?', options: ['A butterfly','A bee','A ladybird','A dragonfly'], answer: 'A butterfly' },
      { question: 'How did the ant free the butterfly?', options: ['It bit through the web thread by thread','It called for help','It pushed the butterfly out','It cut the web with a leaf'], answer: 'It bit through the web thread by thread' },
      { question: 'What lesson does this story teach?', options: ['Even small creatures can do big things','Spiders are mean','Ants are stronger than butterflies','Never go near spider webs'], answer: 'Even small creatures can do big things' }
    ]
  },
  {
    title: 'Baking Day',
    text: 'Zara and her grandmother baked a cake together. They mixed flour, eggs, sugar, and butter in a big bowl. Zara stirred the batter while her grandmother turned on the oven. The cake smelled wonderful when it was done.',
    questions: [
      { question: 'Who did Zara bake with?', options: ['Her grandmother','Her mother','Her sister','Her father'], answer: 'Her grandmother' },
      { question: 'What did Zara do while her grandmother turned on the oven?', options: ['She stirred the batter','She ate the batter','She washed the dishes','She set the table'], answer: 'She stirred the batter' },
      { question: 'How do you think the kitchen felt during baking?', options: ['Warm and cheerful','Cold and dark','Empty and quiet','Messy and sad'], answer: 'Warm and cheerful' }
    ]
  },
  {
    title: 'The Garden Surprise',
    text: 'Every morning, Kai watered the seeds he had planted in a small pot. For many days, nothing happened. Then one morning, he saw a tiny green shoot poking out of the soil. Kai was so happy he ran to tell his mother.',
    questions: [
      { question: 'What did Kai do every morning?', options: ['He watered his seeds','He went for a run','He fed the birds','He read a book'], answer: 'He watered his seeds' },
      { question: 'What appeared from the soil?', options: ['A tiny green shoot','A flower','A worm','A stone'], answer: 'A tiny green shoot' },
      { question: 'Why was Kai happy?', options: ['His seeds finally started to grow','He found money','His friend visited','He got a new toy'], answer: 'His seeds finally started to grow' }
    ]
  },
  {
    title: 'Feeding the Fish',
    text: 'Ana has three goldfish in a glass tank. She feeds them every morning before school. The fish swim to the top when they see her because they know it is feeding time. Ana named them Sunny, Goldie, and Splash.',
    questions: [
      { question: 'How many goldfish does Ana have?', options: ['Three','Two','Four','Five'], answer: 'Three' },
      { question: 'When does Ana feed her fish?', options: ['Every morning before school','Every night before bed','Only on weekends','After lunch'], answer: 'Every morning before school' },
      { question: 'Why do the fish swim to the top when they see Ana?', options: ['They know it is feeding time','They are scared','They want to jump out','They are playing'], answer: 'They know it is feeding time' }
    ]
  },
  {
    title: 'The School Library',
    text: 'Every Wednesday, the class visits the school library. Mei always picks a book about animals. Last week she read about dolphins and learned they are very smart. She told her friends all about it during recess.',
    questions: [
      { question: 'When does the class visit the library?', options: ['Every Wednesday','Every Monday','Every Friday','Every day'], answer: 'Every Wednesday' },
      { question: 'What kind of books does Mei like?', options: ['Books about animals','Books about space','Books about food','Books about cars'], answer: 'Books about animals' },
      { question: 'When did Mei tell her friends about dolphins?', options: ['During recess','During class','After school','At the library'], answer: 'During recess' }
    ]
  },
  {
    title: 'A Trip to the Hawker Centre',
    text: 'Sam went to the hawker centre with his father for dinner. There were so many stalls selling different food. Sam chose chicken rice because it is his favourite. His father had a bowl of hot fish soup.',
    questions: [
      { question: 'Who did Sam go to the hawker centre with?', options: ['His father','His mother','His sister','His friend'], answer: 'His father' },
      { question: 'What did Sam choose to eat?', options: ['Chicken rice','Fish soup','Noodles','Satay'], answer: 'Chicken rice' },
      { question: 'Why do you think there were many stalls?', options: ['A hawker centre has many food sellers','It was a supermarket','There was a party','It was a school canteen'], answer: 'A hawker centre has many food sellers' }
    ]
  },
  {
    title: 'The New Student',
    text: 'A new girl joined the class today. Her name was Priya and she looked a little shy. Lin walked up to her and said hello. By the end of the day, Priya had made three new friends.',
    questions: [
      { question: 'What was the new student\u2019s name?', options: ['Priya','Mei','Zara','Ana'], answer: 'Priya' },
      { question: 'How did Priya feel at first?', options: ['A little shy','Very excited','Very angry','Very sleepy'], answer: 'A little shy' },
      { question: 'What does this story tell us about Lin?', options: ['She is friendly and welcoming','She is quiet and shy','She does not like new students','She likes to be alone'], answer: 'She is friendly and welcoming' }
    ]
  }
];

// ------------------------------------
//  8. Grammar Exercises (18 exercises)
// ------------------------------------
const GRAMMAR_EXERCISES = [
  // Identify nouns
  { type: 'identify-noun', instruction: 'Which word is a noun?', sentence: 'The happy dog runs fast.', options: ['dog','happy','runs','fast'], answer: 'dog' },
  { type: 'identify-noun', instruction: 'Which word is a noun?', sentence: 'A bright star shines at night.', options: ['star','bright','shines','at'], answer: 'star' },
  { type: 'identify-noun', instruction: 'Which word is a noun?', sentence: 'My little sister likes cake.', options: ['cake','little','likes','My'], answer: 'cake' },
  { type: 'identify-noun', instruction: 'Which word is a noun?', sentence: 'The red ball rolled away.', options: ['ball','red','rolled','away'], answer: 'ball' },
  { type: 'identify-noun', instruction: 'Which word is a noun?', sentence: 'We saw a beautiful rainbow.', options: ['rainbow','beautiful','saw','We'], answer: 'rainbow' },

  // Identify verbs
  { type: 'identify-verb', instruction: 'Which word is a verb?', sentence: 'She reads a big book.', options: ['reads','She','big','book'], answer: 'reads' },
  { type: 'identify-verb', instruction: 'Which word is a verb?', sentence: 'The children play in the park.', options: ['play','children','park','the'], answer: 'play' },
  { type: 'identify-verb', instruction: 'Which word is a verb?', sentence: 'He draws a pretty picture.', options: ['draws','pretty','picture','He'], answer: 'draws' },
  { type: 'identify-verb', instruction: 'Which word is a verb?', sentence: 'The bird sings a sweet song.', options: ['sings','bird','sweet','song'], answer: 'sings' },
  { type: 'identify-verb', instruction: 'Which word is a verb?', sentence: 'My brother eats his lunch quickly.', options: ['eats','brother','lunch','quickly'], answer: 'eats' },

  // Identify adjectives
  { type: 'identify-adj', instruction: 'Which word is an adjective?', sentence: 'The tall tree has green leaves.', options: ['tall','tree','has','leaves'], answer: 'tall' },
  { type: 'identify-adj', instruction: 'Which word is an adjective?', sentence: 'She wore a pretty dress.', options: ['pretty','wore','dress','She'], answer: 'pretty' },
  { type: 'identify-adj', instruction: 'Which word is an adjective?', sentence: 'The cold wind blew hard.', options: ['cold','wind','blew','hard'], answer: 'cold' },
  { type: 'identify-adj', instruction: 'Which word is an adjective?', sentence: 'I found a shiny coin on the floor.', options: ['shiny','coin','floor','found'], answer: 'shiny' },

  // Subject-verb agreement
  { type: 'sv-agreement', instruction: 'Pick the correct word.', sentence: 'The cat ___ on the mat.', options: ['sits','sit','sitting','sitted'], answer: 'sits' },
  { type: 'sv-agreement', instruction: 'Pick the correct word.', sentence: 'The birds ___ in the sky.', options: ['fly','flies','flying','flyed'], answer: 'fly' },
  { type: 'sv-agreement', instruction: 'Pick the correct word.', sentence: 'She ___ to school every day.', options: ['walks','walk','walking','walkies'], answer: 'walks' },
  { type: 'sv-agreement', instruction: 'Pick the correct word.', sentence: 'They ___ playing in the garden.', options: ['are','is','am','be'], answer: 'are' }
];

// ------------------------------------
//  9. Poetry Data
// ------------------------------------
const POETRY_DATA = {
  rhymeSets: [
    ['cat','hat','bat','mat','sat','flat'],
    ['day','play','say','way','may','stay'],
    ['tree','bee','sea','free','me','see'],
    ['sun','fun','run','bun','done','one'],
    ['night','light','bright','right','sight','flight'],
    ['rain','train','main','plain','gain','lane'],
    ['star','far','car','jar','bar'],
    ['moon','soon','tune','spoon','noon','balloon']
  ],
  syllableWords: {
    1: ['cat','dog','sun','tree','ball','star','run','big','red','fish'],
    2: ['happy','garden','rabbit','purple','window','playing','singing','tiger','button','kitten'],
    3: ['butterfly','elephant','beautiful','adventure','umbrella','wonderful','imagine','discover','banana','dinosaur']
  },
  poemTemplates: [
    { name: 'Couplet', lines: 2, desc: 'Two lines that rhyme', example: 'I saw a cat / Wearing a hat' },
    { name: 'Haiku', lines: 3, desc: '5-7-5 syllables', example: 'A gentle spring rain / Flowers bloom in the garden / Butterflies will dance' },
    { name: 'Acrostic', lines: 4, desc: 'First letters spell a word', example: 'Sunny days are fun / Trees are swaying in the wind / And birds are singing / Rainbows fill the sky' }
  ]
};

// ------------------------------------
//  10. Paragraph Prompts (10 topics)
// ------------------------------------
const PARAGRAPH_PROMPTS = [
  { topic: 'My Favourite Animal', starter: 'My favourite animal is', hints: ['What does it look like?', 'Where does it live?', 'Why do you like it?'] },
  { topic: 'A Fun Day Out', starter: 'Last weekend, I went to', hints: ['Where did you go?', 'Who was with you?', 'What did you do?'] },
  { topic: 'My Best Friend', starter: 'My best friend is', hints: ['What is their name?', 'What do you like to do together?', 'Why are they special?'] },
  { topic: 'My Favourite Food', starter: 'The food I like most is', hints: ['What does it taste like?', 'When do you eat it?', 'Who makes it for you?'] },
  { topic: 'A Rainy Day', starter: 'One rainy day, I', hints: ['What did you do indoors?', 'How did you feel?', 'What happened next?'] },
  { topic: 'My Family', starter: 'My family is special because', hints: ['Who is in your family?', 'What do you do together?', 'What makes them special?'] },
  { topic: 'At the Playground', starter: 'I love going to the playground because', hints: ['What do you play on?', 'Who do you play with?', 'What is your favourite thing to do there?'] },
  { topic: 'My School', starter: 'My school is a great place because', hints: ['What is your favourite subject?', 'Who is your favourite teacher?', 'What do you do during recess?'] },
  { topic: 'A Trip to the Beach', starter: 'When I went to the beach, I', hints: ['What did the beach look like?', 'What did you do in the water?', 'What did you build in the sand?'] },
  { topic: 'If I Could Fly', starter: 'If I could fly, I would', hints: ['Where would you go first?', 'What would you see from above?', 'How would you feel?'] }
];

// ------------------------------------
//  11. Spelling Picture Map (emoji for CVC words)
// ------------------------------------
const SPELLING_PIC_MAP = {
  cat:'\uD83D\uDC31',bat:'\uD83E\uDD87',hat:'\uD83C\uDFA9',rat:'\uD83D\uDC00',
  pig:'\uD83D\uDC37',bug:'\uD83D\uDC1B',sun:'\u2600\uFE0F',cup:'\u2615',
  hen:'\uD83D\uDC14',bed:'\uD83D\uDECF\uFE0F',net:'\uD83E\uDD45',pin:'\uD83D\uDCCC',
  fan:'\uD83C\uDF00',van:'\uD83D\uDE90',rug:'\uD83E\uDDF6',mug:'\u2615',
  jug:'\uD83C\uDFFA',pen:'\uD83D\uDD8A\uFE0F',jet:'\u2708\uFE0F',dog:'\uD83D\uDC15'
};

// --- src/word/word-tree.js ---
// ============================================================
//  WORD TREE — 10-skill tree with dependencies (P1-P4 EL)
// ============================================================

const WORD_TREE = {
  // === P1 Foundation (EL) ===
  phonics:  { id:'phonics',  name:'Phonics & CVC',      icon:'\uD83D\uDD24', grade:'P1 Foundation', deps:[],           desc:'Sound out CVC words' },
  sight:    { id:'sight',    name:'Sight Words',         icon:'\uD83D\uDC41\uFE0F', grade:'P1 Foundation', deps:[],           desc:'Read high-frequency words' },
  spell:    { id:'spell',    name:'Spelling Bee',        icon:'\uD83D\uDC1D', grade:'P1 Foundation', deps:['phonics'],  desc:'Spell CVC words with pictures' },

  // === P2 Expansion (EL) ===
  grammar:  { id:'grammar',  name:'Grammar Garden',      icon:'\uD83C\uDF3B', grade:'P2 Expansion',  deps:['sight'],           desc:'Nouns, verbs, adjectives' },
  vocab:    { id:'vocab',    name:'Vocabulary Vault',     icon:'\uD83D\uDCDA', grade:'P2 Expansion',  deps:['sight'],           desc:'Learn new word meanings' },
  sentence: { id:'sentence', name:'Sentence Builder',     icon:'\uD83D\uDD28', grade:'P2 Expansion',  deps:['grammar'],         desc:'Build correct sentences' },

  // === P3 Deepening (EL) ===
  comprehension: { id:'comprehension', name:'Reading Comprehension', icon:'\uD83D\uDCD6', grade:'P3 Deepening', deps:['vocab','sentence'], desc:'Read passages and answer questions' },
  poetry:        { id:'poetry',        name:'Poetry Playground',     icon:'\uD83C\uDFB6', grade:'P3 Deepening', deps:['spell'],             desc:'Rhymes, syllables, and poems' },

  // === P4 Mastery (EL) ===
  story:     { id:'story',     name:'Story Garden',       icon:'\u270D\uFE0F', grade:'P4 Mastery', deps:['sentence','comprehension'], desc:'Write creative stories' },
  paragraph: { id:'paragraph', name:'Paragraph Power',    icon:'\uD83D\uDCDD', grade:'P4 Mastery', deps:['comprehension'],            desc:'Write structured paragraphs' }
};

// --- src/word/word-lessons.js ---
// ============================================================
//  WORD LESSONS — Visual step-by-step lessons for English skills
//  Adapted for P1 learner (age 6-7)
// ============================================================

var WORD_LESSONS = {
  phon: {
    title: 'Phonics — Word Families',
    icon: '🔤',
    lumiSays: 'Let\'s learn how letters make sounds!',
    steps: [
      { visual: '<div class="phon-demo"><span class="phon-letter">c</span><span class="phon-blend">+</span><span class="phon-family">at</span><span class="phon-blend">=</span><span class="phon-word">cat</span> 🐱</div>', text: 'The <b>-at</b> family! Change the first letter to make new words.', lumiTip: 'Word families share the same ending sound!' },
      { visual: '<div class="phon-family-list"><span>c<b>at</b> 🐱</span><span>b<b>at</b> 🏏</span><span>h<b>at</b> 🎩</span><span>m<b>at</b> 🧹</span><span>r<b>at</b> 🐀</span><span>s<b>at</b> 💺</span></div>', text: 'All these words rhyme! They end in <b>-at</b>.', lumiTip: 'Rhyming words sound the same at the end.' },
      { visual: '<div class="phon-family-list"><span>p<b>ig</b> 🐷</span><span>b<b>ig</b> 📏</span><span>d<b>ig</b> ⛏️</span><span>w<b>ig</b> 💇</span></div>', text: 'The <b>-ig</b> family! Same idea, different ending.', lumiTip: 'Learning one family helps you read many words!' },
      { type: 'try', prompt: 'Which word is in the -at family?', options: ['cat', 'cup', 'dog', 'pig'], answer: 'cat', successMsg: 'Cat ends in -at!' },
      { type: 'try', prompt: 'What word do these letters make? h + o + t', options: ['hat', 'hot', 'hit'], answer: 'hot', successMsg: 'h-o-t = hot! 🔥' }
    ]
  },

  sight: {
    title: 'Sight Words',
    icon: '👀',
    lumiSays: 'Sight words are words you see everywhere! Let\'s learn to recognise them fast!',
    steps: [
      { visual: '<div class="sight-demo"><span class="sight-big">the</span></div>', text: '<b>"the"</b> is the most common word in English!<br>Example: <i>the cat sat on the mat</i>', lumiTip: 'You\'ll see "the" in almost every sentence!' },
      { visual: '<div class="sight-demo"><span class="sight-big">is</span></div>', text: '<b>"is"</b> tells us about something.<br>Example: <i>She is happy.</i>', lumiTip: 'Sight words don\'t always follow phonics rules.' },
      { visual: '<div class="sight-word-grid"><span>the</span><span>is</span><span>and</span><span>a</span><span>to</span><span>in</span><span>it</span><span>he</span><span>she</span><span>we</span></div>', text: 'These are <b>Level 1</b> sight words. Learn them by heart!', lumiTip: 'The more you read, the faster you\'ll spot them!' },
      { type: 'try', prompt: 'Which is a sight word?', options: ['the', 'xyz', 'bloop'], answer: 'the', successMsg: '"the" is the most common sight word!' }
    ]
  },

  spell: {
    title: 'Spelling',
    icon: '✏️',
    lumiSays: 'Spelling helps us write words correctly!',
    steps: [
      { visual: '<div class="spell-demo">🐱 = <span class="spell-letter">c</span><span class="spell-letter">a</span><span class="spell-letter">t</span></div>', text: 'Listen to each sound: /k/ /a/ /t/ → <b>cat</b>', lumiTip: 'Say the word slowly. Listen to each sound.' },
      { text: '<b>Spelling tips:</b><br>1. Say the word slowly<br>2. Listen to each sound<br>3. Write the letter for each sound<br>4. Check: does it look right?', lumiTip: 'Practise makes perfect!' },
      { type: 'try', visual: '🐕 = d-o-?', prompt: 'What is the last letter?', options: ['f', 'g', 'p'], answer: 'g', successMsg: 'd-o-g spells dog! 🐕' }
    ]
  },

  gram: {
    title: 'Grammar',
    icon: '📖',
    lumiSays: 'Grammar helps us put words in the right order!',
    steps: [
      { text: '<b>Nouns</b> are naming words.<br>They name people, animals, places, or things.<br><span style="color:var(--sky)">girl</span>, <span style="color:var(--sky)">cat</span>, <span style="color:var(--sky)">school</span>, <span style="color:var(--sky)">ball</span>', lumiTip: 'If you can touch it or see it, it\'s probably a noun!' },
      { text: '<b>Verbs</b> are doing words.<br>They tell us what someone does.<br><span style="color:var(--coral)">run</span>, <span style="color:var(--coral)">eat</span>, <span style="color:var(--coral)">sleep</span>, <span style="color:var(--coral)">play</span>', lumiTip: 'Can you act it out? Then it\'s a verb!' },
      { text: '<b>Adjectives</b> are describing words.<br>They tell us more about nouns.<br><span style="color:var(--mint)">big</span>, <span style="color:var(--mint)">happy</span>, <span style="color:var(--mint)">red</span>, <span style="color:var(--mint)">tall</span>', lumiTip: 'Adjectives answer: what kind? how many? which one?' },
      { type: 'sort', text: 'Sort these words into the right group!', categories: [
        { name: 'Nouns', items: ['cat', 'ball', 'tree'] },
        { name: 'Verbs', items: ['run', 'jump', 'eat'] }
      ]},
      { type: 'try', prompt: 'What type of word is "happy"?', options: ['Noun', 'Verb', 'Adjective'], answer: 'Adjective', successMsg: '"Happy" describes how someone feels!' }
    ]
  },

  vocab: {
    title: 'Vocabulary',
    icon: '📚',
    lumiSays: 'Big words make your writing sparkle!',
    steps: [
      { visual: '<div class="vocab-compare"><div class="vocab-plain">big</div><div class="vocab-arrow">→</div><div class="vocab-fancy">enormous</div></div>', text: 'Instead of <b>big</b>, try <b>enormous</b>! It means very, very big!', lumiTip: 'Strong words make your stories more interesting!' },
      { visual: '<div class="vocab-compare"><div class="vocab-plain">happy</div><div class="vocab-arrow">→</div><div class="vocab-fancy">delighted</div></div>', text: 'Instead of <b>happy</b>, try <b>delighted</b>!', lumiTip: 'Collect big words like treasure!' },
      { visual: '<div class="vocab-compare"><div class="vocab-plain">said</div><div class="vocab-arrow">→</div><div class="vocab-fancy">exclaimed</div></div>', text: 'Instead of <b>said</b>, try <b>exclaimed</b>! It means said with excitement!', lumiTip: 'Using different "said" words makes dialogue better.' },
      { type: 'try', prompt: '"The elephant is very big." Which word could replace "very big"?', options: ['tiny', 'enormous', 'quiet'], answer: 'enormous', successMsg: 'Enormous means really, really big!' }
    ]
  },

  sent: {
    title: 'Sentence Building',
    icon: '🏗️',
    lumiSays: 'Let\'s build sentences step by step!',
    steps: [
      { text: '<b>A sentence needs:</b><br>1. A <span style="color:var(--sky)">capital letter</span> at the start<br>2. A <span style="color:var(--coral)">verb</span> (doing word)<br>3. A <span style="color:var(--gold)">full stop</span> at the end', lumiTip: 'Every sentence is a complete thought!' },
      { visual: '<div class="sent-demo"><span class="sent-cap">T</span>he cat <span class="sent-verb">sat</span> on the mat<span class="sent-end">.</span></div>', text: 'Capital T, doing word "sat", full stop at the end!', lumiTip: 'Read it aloud. Does it sound complete?' },
      { text: '<b>Make it better!</b><br>❌ the cat sat → missing capital and full stop<br>✅ The fluffy cat sat on the soft mat. → much better!', lumiTip: 'Add adjectives to make sentences sparkle!' },
      { type: 'try', prompt: 'Which is a correct sentence?', options: ['the dog runs', 'The dog runs.', 'dog runs.'], answer: 'The dog runs.', successMsg: 'Capital letter + full stop = correct sentence!' }
    ]
  },

  comp: {
    title: 'Reading Comprehension',
    icon: '📰',
    lumiSays: 'Let\'s read and understand stories!',
    steps: [
      { text: '<b>How to read carefully:</b><br>1. Read the story <b>once</b> for fun<br>2. Read it <b>again</b> slowly<br>3. Look for <b>key words</b> in the question<br>4. Find the answer <b>in the text</b>', lumiTip: 'Always read the story at least twice!' },
      { text: '<div style="background:var(--bg-mid);padding:12px;border-radius:12px;margin-bottom:8px;font-style:italic">"Sam has a red ball. He plays with it in the park every day."</div><b>Question:</b> What colour is Sam\'s ball?<br><b>Answer:</b> Red! (It says "red ball" in the story.)', lumiTip: 'The answer is always in the text!' },
      { type: 'try', prompt: '"Lumi is a golden star. She lives in the sky." Where does Lumi live?', options: ['Under the sea', 'In the sky', 'On a mountain'], answer: 'In the sky', successMsg: 'You found it in the text!' }
    ]
  },

  poetry: {
    title: 'Poetry Corner',
    icon: '🎭',
    lumiSays: 'Poems are like songs made of words!',
    steps: [
      { text: '<b>Rhyming words</b> sound the same at the end:<br>cat / hat / mat<br>star / far / car<br>moon / spoon / June', lumiTip: 'Most poems use rhyming words!' },
      { visual: '<div class="poem-demo"><div class="poem-line">Twinkle twinkle little <b>star</b>,</div><div class="poem-line">How I wonder what you <b>are</b>.</div></div>', text: '<b>star</b> and <b>are</b> rhyme! They have the same ending sound.', lumiTip: 'Listen for the rhyme at the end of each line.' },
      { type: 'try', prompt: 'Which word rhymes with "cat"?', options: ['cup', 'hat', 'dog'], answer: 'hat', successMsg: 'Cat and hat both end in -at!' }
    ]
  },

  story: {
    title: 'Story Garden',
    icon: '🌱',
    lumiSays: 'Let\'s grow stories from tiny seeds!',
    steps: [
      { text: '<b>Every story needs:</b><br>📍 <b>Beginning:</b> Who? Where?<br>⚡ <b>Middle:</b> What happened?<br>🌟 <b>End:</b> How was it solved?', lumiTip: 'Think: beginning → middle → end!' },
      { text: '<b>Story starter words:</b><br>"Once upon a time..."<br>"One sunny morning..."<br>"Long ago, in a land far away..."', lumiTip: 'Good beginnings make readers want to read more!' },
      { text: '<b>Start small:</b><br>First, try completing a sentence:<br>"The cat went to the ___."<br>Then try writing 2 sentences.<br>Then a whole paragraph!', lumiTip: 'Writing is like a muscle — it gets stronger with practice!' },
      { type: 'try', prompt: 'What goes at the END of a story?', options: ['Who the characters are', 'How the problem is solved', 'Where it takes place'], answer: 'How the problem is solved', successMsg: 'The ending wraps up the story!' }
    ]
  },

  para: {
    title: 'Paragraph Writing',
    icon: '📝',
    lumiSays: 'A paragraph is a group of sentences about one thing!',
    steps: [
      { text: '<b>A paragraph has:</b><br>1. <span style="color:var(--gold)">Topic sentence</span> — what it\'s about<br>2. <span style="color:var(--sky)">Detail sentences</span> — more information<br>3. <span style="color:var(--mint)">Closing sentence</span> — wraps it up', lumiTip: 'Think of a paragraph like a sandwich!' },
      { text: '<b>Example:</b><br><span style="color:var(--gold)">I love going to the beach.</span> <span style="color:var(--sky)">The sand is warm and soft. I like to build sandcastles. The waves are fun to splash in.</span> <span style="color:var(--mint)">The beach is my favourite place!</span>', lumiTip: 'The first and last sentences are special!' },
      { type: 'try', prompt: 'Which is a good topic sentence about pets?', options: ['Dogs bark.', 'I love my pet hamster.', 'The end.'], answer: 'I love my pet hamster.', successMsg: 'It tells us what the paragraph will be about!' }
    ]
  }
};

function getWordLesson(skillId) {
  return WORD_LESSONS[skillId] || null;
}

// Flashcards for sight words (P1 high-frequency words)
function getWordFlashcards(skillId) {
  if (skillId === 'sight') {
    return [
      { front: 'the', back: 'Used before a noun', example: 'The cat is sleeping.', image: '👀' },
      { front: 'is', back: 'Tells about something', example: 'She is happy.', image: '👀' },
      { front: 'and', back: 'Joins two things', example: 'Mum and Dad', image: '👀' },
      { front: 'a', back: 'Means one of something', example: 'I see a bird.', image: '👀' },
      { front: 'to', back: 'Shows direction', example: 'Go to school.', image: '👀' },
      { front: 'in', back: 'Means inside', example: 'The toy is in the box.', image: '👀' },
      { front: 'it', back: 'Replaces a thing', example: 'I like it.', image: '👀' },
      { front: 'he', back: 'A boy or man', example: 'He is tall.', image: '👀' },
      { front: 'she', back: 'A girl or woman', example: 'She can sing.', image: '👀' },
      { front: 'we', back: 'Me and you', example: 'We are friends.', image: '👀' },
      { front: 'can', back: 'Means able to', example: 'I can swim.', image: '👀' },
      { front: 'said', back: 'Past of say', example: '"Hello!" said Tom.', image: '👀' },
      { front: 'you', back: 'The person I\'m talking to', example: 'How are you?', image: '👀' },
      { front: 'was', back: 'Past of is', example: 'It was raining.', image: '👀' },
      { front: 'they', back: 'More than one person', example: 'They are playing.', image: '👀' },
      { front: 'my', back: 'Belongs to me', example: 'This is my book.', image: '👀' },
      { front: 'are', back: 'For more than one', example: 'We are here.', image: '👀' },
      { front: 'has', back: 'Means owns or holds', example: 'He has a toy.', image: '👀' },
      { front: 'his', back: 'Belongs to him', example: 'That is his bag.', image: '👀' },
      { front: 'her', back: 'Belongs to her', example: 'I like her dress.', image: '👀' }
    ];
  }

  if (skillId === 'vocab') {
    return [
      { front: 'enormous', back: 'Very, very big', example: 'The elephant is enormous!', image: '📚' },
      { front: 'delighted', back: 'Very happy', example: 'She was delighted to see her friend.', image: '📚' },
      { front: 'peculiar', back: 'Strange or unusual', example: 'The bird had a peculiar cry.', image: '📚' },
      { front: 'exclaimed', back: 'Said with excitement', example: '"Wow!" exclaimed Lumi.', image: '📚' },
      { front: 'magnificent', back: 'Wonderful and impressive', example: 'The palace was magnificent.', image: '📚' },
      { front: 'furious', back: 'Very angry', example: 'The dragon was furious.', image: '📚' },
      { front: 'exhausted', back: 'Very tired', example: 'After running, she was exhausted.', image: '📚' },
      { front: 'glistened', back: 'Sparkled in the light', example: 'The snow glistened in the sun.', image: '📚' },
      { front: 'whispered', back: 'Said very quietly', example: '"Shh," whispered the girl.', image: '📚' },
      { front: 'trembled', back: 'Shook with fear', example: 'The mouse trembled with fear.', image: '📚' }
    ];
  }

  if (skillId === 'phon') {
    return [
      { front: 'c + at = ?', back: 'cat 🐱', image: '🔤' },
      { front: 'b + at = ?', back: 'bat 🏏', image: '🔤' },
      { front: 'h + at = ?', back: 'hat 🎩', image: '🔤' },
      { front: 'p + ig = ?', back: 'pig 🐷', image: '🔤' },
      { front: 'd + og = ?', back: 'dog 🐕', image: '🔤' },
      { front: 'h + ot = ?', back: 'hot 🔥', image: '🔤' },
      { front: 'b + us = ?', back: 'bus 🚌', image: '🔤' },
      { front: 'c + up = ?', back: 'cup ☕', image: '🔤' },
      { front: 's + un = ?', back: 'sun ☀️', image: '🔤' },
      { front: 'r + ed = ?', back: 'red 🔴', image: '🔤' }
    ];
  }

  return null;
}

// --- src/stem/stem-tree.js ---
// ============================================================
//  STEM TREE — 10-skill tree: Science (5) + Coding (5)
// ============================================================

const STEM_TREE = {
  // === Science — P1 Foundation ===
  living:   { id:'living',   name:'Living Things',        icon:'\uD83C\uDF31', grade:'P1 Science',  deps:[],          desc:'Plants, animals, and habitats' },
  material: { id:'material', name:'Materials & Matter',    icon:'\uD83E\uDDEA', grade:'P1 Science',  deps:[],          desc:'Solids, liquids, and properties' },

  // === Science — P2 Expansion ===
  forces:   { id:'forces',   name:'Forces & Energy',      icon:'\u26A1',       grade:'P2 Science',  deps:['material'], desc:'Push, pull, magnets, and energy' },
  earth:    { id:'earth',    name:'Earth & Weather',      icon:'\uD83C\uDF0D', grade:'P2 Science',  deps:['living'],   desc:'Weather, water cycle, and Earth' },
  body:     { id:'body',     name:'Human Body',           icon:'\uD83E\uDEC0', grade:'P2 Science',  deps:['living'],   desc:'Body systems and staying healthy' },

  // === Coding — P1 Foundation ===
  cseq:     { id:'cseq',     name:'Code: Sequences',      icon:'\u27A1\uFE0F', grade:'P1 Coding',   deps:[],           desc:'Step-by-step instructions' },
  cloop:    { id:'cloop',    name:'Code: Loops',           icon:'\uD83D\uDD01', grade:'P1 Coding',   deps:['cseq'],     desc:'Repeat actions with loops' },

  // === Coding — P2 Expansion ===
  ccond:    { id:'ccond',    name:'Code: Conditionals',    icon:'\uD83D\uDD00', grade:'P2 Coding',   deps:['cloop'],    desc:'If-then decisions' },
  cvar:     { id:'cvar',     name:'Code: Variables',       icon:'\uD83D\uDCE6', grade:'P2 Coding',   deps:['ccond'],    desc:'Store and change values' },
  cdebug:   { id:'cdebug',   name:'Code: Debugging',       icon:'\uD83D\uDC1B', grade:'P2 Coding',   deps:['cvar'],     desc:'Find and fix bugs' }
};

// --- src/stem/stem-lessons.js ---
// ============================================================
//  STEM LESSONS — Visual step-by-step lessons for science + coding
//  Adapted for P1 learner (simple, visual, discovery-based)
// ============================================================

var STEM_LESSONS = {
  // ── SCIENCE ──
  living: {
    title: 'Living & Non-Living Things',
    icon: '🌱',
    lumiSays: 'Let\'s discover what is alive and what is not!',
    steps: [
      { visual: '<div style="font-size:48px">🐕 🌷 🪨 🧸</div>', text: 'Some things are <b>alive</b> and some are <b>not alive</b>.', lumiTip: 'Living things do special things!' },
      { text: '<b>Living things can:</b><br>🌱 Grow bigger<br>🍽️ Need food and water<br>🏃 Move on their own<br>👶 Have babies (reproduce)<br>💨 Breathe', lumiTip: 'Remember: grow, eat, move, reproduce, breathe!' },
      { text: '<b>Non-living things:</b><br>🪨 Rock — does not grow<br>🧸 Teddy bear — does not eat<br>📱 Phone — does not breathe<br>They were never alive!', lumiTip: 'Non-living things don\'t do any of those things.' },
      { type: 'sort', text: 'Sort these into Living and Non-Living!', categories: [
        { name: 'Living', items: ['🐱 Cat', '🌻 Flower', '🐛 Worm'] },
        { name: 'Non-Living', items: ['🪨 Rock', '✏️ Pencil', '🧱 Brick'] }
      ]},
      { type: 'try', prompt: 'Which is a living thing?', options: ['A car', 'A fish', 'A table'], answer: 'A fish', successMsg: 'A fish grows, eats, moves, and breathes!' }
    ]
  },

  material: {
    title: 'Materials & Properties',
    icon: '🧱',
    lumiSays: 'Everything is made of different materials!',
    steps: [
      { text: '<b>Materials</b> are what things are made of:<br>🪵 Wood — tables, doors, pencils<br>🪨 Metal — spoons, scissors, coins<br>🧶 Fabric — clothes, curtains<br>🧊 Plastic — bottles, toys', lumiTip: 'Look around you — what materials can you see?' },
      { text: '<b>Properties</b> describe what materials are like:<br>Hard or soft? 🪨 vs 🧸<br>Rough or smooth? 🪵 vs 🧊<br>Waterproof or absorbent? ☔ vs 🧽<br>See-through or opaque? 🪟 vs 🧱', lumiTip: 'Touch things and think about how they feel!' },
      { type: 'sort', text: 'Sort by property: Hard or Soft?', categories: [
        { name: 'Hard', items: ['🪨 Rock', '🪙 Coin', '🧊 Ice'] },
        { name: 'Soft', items: ['🧸 Teddy', '🧽 Sponge', '🧶 Wool'] }
      ]},
      { type: 'try', prompt: 'Which material is waterproof?', options: ['Paper', 'Plastic', 'Fabric'], answer: 'Plastic', successMsg: 'Plastic keeps water out!' }
    ]
  },

  forces: {
    title: 'Forces — Push & Pull',
    icon: '💪',
    lumiSays: 'Forces make things move!',
    steps: [
      { visual: '<div style="font-size:48px">👋 ➡️ 📦</div>', text: 'A <b>push</b> moves something away from you.', lumiTip: 'Pushing a door, kicking a ball — those are pushes!' },
      { visual: '<div style="font-size:48px">📦 ⬅️ 🤲</div>', text: 'A <b>pull</b> moves something towards you.', lumiTip: 'Opening a drawer, pulling a wagon — those are pulls!' },
      { text: '<b>Forces can:</b><br>🚀 Make things <b>start moving</b><br>🛑 Make things <b>stop</b><br>↗️ Change <b>direction</b><br>🏎️ Make things go <b>faster</b> or <b>slower</b>', lumiTip: 'Everything that moves uses forces!' },
      { type: 'sort', text: 'Is it a push or a pull?', categories: [
        { name: 'Push', items: ['Kick a ball', 'Press a button', 'Close a door'] },
        { name: 'Pull', items: ['Tug of war', 'Open a drawer', 'Fish with a rod'] }
      ]},
      { type: 'try', prompt: 'What happens when you push a toy car?', options: ['It stays still', 'It moves away', 'It disappears'], answer: 'It moves away', successMsg: 'A push makes things move away from you!' }
    ]
  },

  earth: {
    title: 'Earth & Weather',
    icon: '🌍',
    lumiSays: 'Let\'s learn about our amazing planet!',
    steps: [
      { visual: '<div style="font-size:60px">☀️ 🌧️ ⛈️ 🌈</div>', text: 'Weather changes every day! Sun, rain, storms, rainbows!', lumiTip: 'Look outside — what\'s the weather today?' },
      { text: '<b>The Water Cycle:</b><br>☀️ Sun heats water → it goes UP as vapour<br>☁️ Vapour cools → becomes clouds<br>🌧️ Clouds get heavy → rain falls<br>💧 Water collects → rivers, lakes, sea<br>🔄 Then it starts again!', lumiTip: 'Water goes round and round forever!' },
      { text: '<b>Singapore\'s weather:</b><br>🌡️ Hot and warm all year<br>🌧️ Rainy season (Nov–Jan)<br>☀️ Dry season (Feb–Apr)<br>🌤️ About 25–31°C', lumiTip: 'Singapore is near the equator — it\'s always warm!' },
      { type: 'try', prompt: 'What makes clouds?', options: ['Wind blowing dust', 'Water vapour cooling', 'Stars falling'], answer: 'Water vapour cooling', successMsg: 'When water vapour cools, it makes tiny droplets = clouds!' }
    ]
  },

  body: {
    title: 'My Body',
    icon: '🫀',
    lumiSays: 'Your body is amazing! Let\'s explore it!',
    steps: [
      { text: '<b>Your 5 senses:</b><br>👀 Eyes — see<br>👂 Ears — hear<br>👃 Nose — smell<br>👅 Tongue — taste<br>✋ Skin — touch', lumiTip: 'We use our senses to learn about the world!' },
      { text: '<b>Important body parts:</b><br>🧠 Brain — thinks and controls everything<br>🫀 Heart — pumps blood around your body<br>🫁 Lungs — help you breathe<br>🦴 Bones — hold your body up<br>💪 Muscles — help you move', lumiTip: 'Your heart beats about 100,000 times a day!' },
      { type: 'match', text: 'Match the sense to its body part!', pairs: [
        { left: '👀 See', right: 'Eyes' },
        { left: '👂 Hear', right: 'Ears' },
        { left: '👃 Smell', right: 'Nose' },
        { left: '👅 Taste', right: 'Tongue' }
      ]},
      { type: 'try', prompt: 'What does the heart do?', options: ['Helps you think', 'Pumps blood', 'Helps you breathe'], answer: 'Pumps blood', successMsg: 'Your heart pumps blood to every part of your body!' }
    ]
  },

  // ── CODING ──
  cseq: {
    title: 'Coding — Sequences',
    icon: '📋',
    lumiSays: 'A sequence is a list of steps in order!',
    steps: [
      { text: '<b>A sequence is steps done in order:</b><br>1️⃣ Wake up<br>2️⃣ Brush teeth<br>3️⃣ Eat breakfast<br>4️⃣ Go to school', lumiTip: 'Order matters! You brush teeth BEFORE eating!' },
      { visual: '<div class="code-demo"><span class="code-block">→ Move right</span><span class="code-block">→ Move right</span><span class="code-block">↓ Move down</span></div>', text: 'In coding, we give the computer a sequence of <b>commands</b>.', lumiTip: 'The computer does exactly what you tell it — in order!' },
      { text: '<b>Commands for the robot:</b><br>→ Move right<br>← Move left<br>↑ Move up<br>↓ Move down<br>The robot follows each step one by one!', lumiTip: 'Plan your path before writing commands!' },
      { type: 'try', prompt: 'To go right 2 spaces, how many "→" commands do you need?', options: ['1', '2', '3'], answer: '2', successMsg: 'One → for each space!' }
    ]
  },

  cloop: {
    title: 'Coding — Loops',
    icon: '🔁',
    lumiSays: 'Loops repeat things without writing them again!',
    steps: [
      { text: '<b>Without a loop:</b><br>→ Move right<br>→ Move right<br>→ Move right<br>→ Move right<br>That\'s 4 commands!', lumiTip: 'Writing the same thing over and over is boring!' },
      { visual: '<div class="code-demo"><span class="code-block loop">🔁 Repeat 4 times:<span class="code-block nested">→ Move right</span></span></div>', text: '<b>With a loop:</b> Repeat 4 times → move right. Same result, less writing!', lumiTip: 'Loops save time and make code shorter!' },
      { text: '<b>When to use loops:</b><br>• Moving in a straight line<br>• Doing the same thing many times<br>• Any repeating pattern!', lumiTip: 'If you see a pattern, you can probably use a loop!' },
      { type: 'try', prompt: '"Repeat 3 times: jump" — How many jumps?', options: ['1', '3', '6'], answer: '3', successMsg: 'The robot jumps 3 times!' }
    ]
  },

  ccond: {
    title: 'Coding — Conditionals',
    icon: '🔀',
    lumiSays: 'Conditionals let the computer make decisions!',
    steps: [
      { text: '<b>IF it is raining ☔</b><br>→ Take an umbrella<br><b>ELSE</b><br>→ Wear sunglasses 😎', lumiTip: 'We make "if" decisions every day!' },
      { visual: '<div class="code-demo"><span class="code-block cond">IF on red tile:<span class="code-block nested">↰ Turn left</span></span><span class="code-block cond">IF on blue tile:<span class="code-block nested">↱ Turn right</span></span></div>', text: 'The robot checks the colour and decides what to do!', lumiTip: 'The robot looks before it acts!' },
      { type: 'try', prompt: '"IF hungry → eat. ELSE → play." You are hungry. What do you do?', options: ['Play', 'Eat', 'Sleep'], answer: 'Eat', successMsg: 'The condition is true, so you eat!' }
    ]
  },

  cvar: {
    title: 'Coding — Variables',
    icon: '📦',
    lumiSays: 'Variables are like labelled boxes that hold values!',
    steps: [
      { visual: '<div class="var-demo"><div class="var-box"><div class="var-label">score</div><div class="var-value">0</div></div></div>', text: 'A <b>variable</b> is a box with a name. This one is called "score" and holds 0.', lumiTip: 'Think of it as a container with a label!' },
      { visual: '<div class="var-demo"><div class="var-box"><div class="var-label">score</div><div class="var-value">0 → 5</div></div></div>', text: 'When you collect a gem: <b>score = score + 5</b>. Now it holds 5!', lumiTip: 'Variables can change — that\'s why they\'re called variables!' },
      { type: 'try', prompt: 'score = 3. You collect 2 gems worth 1 each. What is score now?', options: ['3', '5', '6'], answer: '5', successMsg: '3 + 1 + 1 = 5!' }
    ]
  },

  cdebug: {
    title: 'Coding — Debugging',
    icon: '🐛',
    lumiSays: 'Debugging means finding and fixing mistakes in code!',
    steps: [
      { text: '<b>A bug</b> is a mistake in code.<br><b>Debugging</b> is finding and fixing it!<br><br>Even the best coders make bugs. The skill is <b>finding</b> them!', lumiTip: 'The word "bug" comes from a real moth found in a computer in 1947!' },
      { visual: '<div class="code-demo"><span class="code-block">Goal: Go right 3 steps</span><span class="code-block bug">→ Move right</span><span class="code-block bug">→ Move right</span><span class="code-block bug">↓ Move down ← BUG!</span></div>', text: 'Spot the bug! The third command should be → not ↓.', lumiTip: 'Compare what the code DOES vs what it SHOULD do.' },
      { type: 'try', prompt: '"→ → ↓ →" should go right 4 times. Which step is the bug?', options: ['Step 1', 'Step 2', 'Step 3'], answer: 'Step 3', successMsg: 'Step 3 goes down instead of right — that\'s the bug!' }
    ]
  }
};

function getStemLesson(skillId) {
  return STEM_LESSONS[skillId] || null;
}

function getStemFlashcards(skillId) {
  if (skillId === 'living') {
    return [
      { front: 'Living things can...', back: 'Grow, eat, move, breathe, reproduce', image: '🌱' },
      { front: 'Is a flower living?', back: 'Yes! It grows and needs water.', image: '🌷' },
      { front: 'Is a rock living?', back: 'No! It cannot grow or move.', image: '🪨' },
      { front: 'Is a fish living?', back: 'Yes! It breathes, eats, and grows.', image: '🐟' },
      { front: 'Is a toy car living?', back: 'No! It was never alive.', image: '🚗' }
    ];
  }

  if (skillId === 'body') {
    return [
      { front: '🧠 Brain', back: 'Thinks and controls your body', image: '🫀' },
      { front: '🫀 Heart', back: 'Pumps blood around your body', image: '🫀' },
      { front: '🫁 Lungs', back: 'Help you breathe', image: '🫀' },
      { front: '👀 Eyes', back: 'Let you see', image: '🫀' },
      { front: '👂 Ears', back: 'Let you hear', image: '🫀' }
    ];
  }

  if (skillId === 'forces') {
    return [
      { front: 'Push', back: 'A force that moves things AWAY from you', image: '💪' },
      { front: 'Pull', back: 'A force that moves things TOWARDS you', image: '💪' },
      { front: 'Gravity', back: 'A pull that keeps us on the ground', image: '💪' },
      { front: 'Friction', back: 'A force that slows things down', image: '💪' }
    ];
  }

  return null;
}

// --- src/math/math-gen.js ---
// ============================================================
//  MATH GENERATORS — Question generators for all 28 skills
// ============================================================

function generateMathQuestion(skillId) {
  const diff = getSkillDifficulty(skillId);
  switch (skillId) {
    // P1
    case 'count': return genCount(diff);
    case 'nbond': return genNBond(diff);
    case 'add':   return genAdd(diff);
    case 'sub':   return genSub(diff);
    case 'cmp':   return genCmp(diff);
    case 'pat':   return genPat(diff);
    case 'wp1':   return genWP1(diff);
    case 'shp':   return genShp(diff);
    // P2
    case 'add100':  return genAdd100(diff);
    case 'sub100':  return genSub100(diff);
    case 'mul':     return genMul(diff);
    case 'div':     return genDiv(diff);
    case 'frac1':   return genFrac1(diff);
    case 'money':   return genMoney(diff);
    case 'time1':   return genTime1(diff);
    case 'pgraph':  return genPGraph(diff);
    case 'lenmass': return genLenMass(diff);
    // P3
    case 'add10k':  return genAdd10k(diff);
    case 'sub10k':  return genSub10k(diff);
    case 'advmul':  return genAdvMul(diff);
    case 'divrem':  return genDivRem(diff);
    case 'fracadd': return genFracAdd(diff);
    case 'area':    return genArea(diff);
    case 'angle':   return genAngle(diff);
    case 'bargraph':return genBarGraph(diff);
    // P4
    case 'bignum':  return genBigNum(diff);
    case 'multiop': return genMultiOp(diff);
    case 'factor':  return genFactor(diff);
    case 'mixfrac': return genMixFrac(diff);
    case 'decimal': return genDecimal(diff);
    case 'symm':    return genSymm(diff);
    case 'dataan':  return genDataAn(diff);
    case 'multiwp': return genMultiWP(diff);
    default: return genCount(diff);
  }
}

// ===================== P1 GENERATORS =====================

function genCount(diff) {
  const [min, max] = diff.numberRange;
  const n = rand(min, Math.min(max, 20));
  return { type: 'ten-frame-count', number: n, answer: n, hint: 'Count each dot carefully! Try counting in groups.' };
}

function genNBond(diff) {
  const maxNum = diff.level >= 2 ? 20 : 10;
  const whole = rand(3, maxNum);
  const partA = rand(1, whole - 1);
  const partB = whole - partA;
  const missingPart = Math.random() < 0.5 ? 'left' : 'right';
  return {
    type: 'number-bond', whole, partA, partB, missingPart,
    answer: missingPart === 'left' ? partA : partB,
    hint: 'If the whole is ' + whole + ' and one part is ' + (missingPart === 'left' ? partB : partA) + ', what\'s the other part?',
    isConcrete: diff.isConcrete
  };
}

function genAdd(diff) {
  const [min, max] = diff.numberRange;
  const a = rand(min, Math.floor(max / 2));
  const b = rand(min, Math.floor(max / 2));
  const sum = a + b;
  const emoji = pick(OBJECT_EMOJIS);
  if (diff.isConcrete) {
    return { type: 'addition-concrete', a, b, answer: sum, emoji, hint: 'Count all the objects together! ' + a + ' and ' + b + ' more makes...' };
  } else if (diff.isPictorial) {
    return { type: 'addition-pictorial', a, b, answer: sum, emoji, hint: 'Look at the bar model. How many in total?' };
  } else {
    return { type: 'addition-abstract', a, b, answer: sum, hint: 'Try counting on from the bigger number.' };
  }
}

function genSub(diff) {
  const [min, max] = diff.numberRange;
  const b = rand(min, Math.floor(max / 2));
  const a = rand(b + 1, Math.min(b + Math.floor(max / 2), max));
  const result = a - b;
  const emoji = pick(OBJECT_EMOJIS);
  if (diff.isConcrete) {
    return { type: 'subtraction-concrete', a, b, answer: result, emoji, hint: 'Start with ' + a + ', then take away ' + b + '. How many are left?' };
  } else {
    return { type: 'subtraction-abstract', a, b, answer: result, hint: 'Start at ' + a + ' and count back ' + b + '.' };
  }
}

function genCmp(diff) {
  const [min, max] = diff.numberRange;
  var a, b;
  do { a = rand(min, max); b = rand(min, max); } while (a === b);
  return { type: 'comparing', a, b, answer: a > b ? '>' : '<',
    hint: 'Which number is bigger? Think about which comes later when counting.',
    isConcrete: diff.isConcrete };
}

function genPat(diff) {
  if (Math.random() < 0.5 || diff.level < 2) {
    var emojis = shuffle(['\uD83D\uDD34','\uD83D\uDD35','\uD83D\uDFE1','\uD83D\uDFE2','\uD83D\uDFE3','\uD83D\uDFE0']).slice(0, rand(2, 3));
    var pattern = [];
    for (var i = 0; i < 6; i++) pattern.push(emojis[i % emojis.length]);
    var answer = emojis[6 % emojis.length];
    return { type: 'pattern-shape', pattern, answer, options: shuffle([...emojis, pick(['\u26AB','\u26AA','\uD83D\uDFE4'])]),
      hint: 'Look at how the shapes repeat. What comes next?' };
  } else {
    var start = rand(1, 10);
    var step = rand(1, diff.level >= 3 ? 5 : 3);
    var pat = Array.from({length: 5}, function(_, i) { return start + i * step; });
    var ans = start + 5 * step;
    return { type: 'pattern-number', pattern: pat, answer: ans, step,
      hint: 'Look at the gaps between numbers. Each number goes up by...?' };
  }
}

function genWP1(diff) {
  var templates = [
    { text: function(a,b) { return 'Anastasia has ' + a + ' ' + pick(['apples','stickers','marbles','stars']) + '. She gets ' + b + ' more. How many does she have now?'; }, op: '+' },
    { text: function(a,b) { return 'There are ' + a + ' ' + pick(['birds','butterflies','fish']) + ' in the ' + pick(['tree','pond','garden']) + '. ' + b + ' fly away. How many are left?'; }, op: '-' },
    { text: function(a,b) { return 'Anastasia has ' + a + ' ' + pick(['cookies','sweets','cards']) + '. She gives ' + b + ' to her friend. How many does she have left?'; }, op: '-' },
    { text: function(a,b) { return a + ' ' + pick(['children','kittens','puppies']) + ' are playing. ' + b + ' more join them. How many are there now?'; }, op: '+' }
  ];
  var t = pick(templates);
  var mn = diff.numberRange[0], mx = diff.numberRange[1];
  var a, b, answer;
  if (t.op === '+') {
    a = rand(mn, Math.floor(mx/2)); b = rand(mn, Math.floor(mx/2)); answer = a + b;
  } else {
    b = rand(mn, Math.floor(mx/2)); a = rand(b+1, Math.min(b+Math.floor(mx/2), mx)); answer = a - b;
  }
  return { type: 'word-problem', text: t.text(a, b), a, b, answer, op: t.op,
    hint: 'Is it asking you to put together or take away?', isConcrete: diff.isConcrete };
}

function genShp(diff) {
  if (Math.random() < 0.5) {
    var shape = pick(SHAPE_DATA);
    var wrong = shuffle(SHAPE_DATA.filter(function(s) { return s.name !== shape.name; })).slice(0, 3);
    return { type: 'shape-identify', shape, options: shuffle([shape, ...wrong]), hint: 'Count the sides and corners!' };
  } else {
    var sh = pick(SHAPE_DATA);
    return { type: 'shape-properties', shape: sh, answer: sh.sides, hint: 'Trace around the shape and count each side.' };
  }
}

// ===================== P2 GENERATORS =====================

function genAdd100(diff) {
  var a, b;
  if (diff.isConcrete) {
    a = rand(10, 50); b = rand(10, 50);
  } else if (diff.isPictorial) {
    a = rand(20, 60); b = rand(20, 40);
  } else {
    a = rand(10, 99); b = rand(10, 99 - a);
  }
  return { type: 'addition-100', a, b, answer: a + b, isConcrete: diff.isConcrete, isPictorial: diff.isPictorial,
    hint: 'Try adding the tens first, then the ones.' };
}

function genSub100(diff) {
  var a = rand(30, 99);
  var b = rand(10, a - 1);
  return { type: 'subtraction-100', a, b, answer: a - b, isConcrete: diff.isConcrete,
    hint: 'Try subtracting the tens first, then the ones.' };
}

function genMul(diff) {
  var tables = [2, 3, 4, 5, 10];
  var table = pick(tables);
  var n = rand(1, 10);
  var answer = table * n;
  return { type: 'multiplication', table, n, answer, isConcrete: diff.isConcrete, isPictorial: diff.isPictorial,
    hint: table + ' times ' + n + ' means ' + n + ' groups of ' + table + '.' };
}

function genDiv(diff) {
  var divisors = [2, 3, 4, 5];
  var divisor = pick(divisors);
  var quotient = rand(1, 10);
  var dividend = divisor * quotient;
  return { type: 'division', dividend, divisor, answer: quotient, isConcrete: diff.isConcrete,
    hint: 'Share ' + dividend + ' equally into ' + divisor + ' groups. How many in each group?' };
}

function genFrac1(diff) {
  var denoms = [2, 3, 4, 6, 8];
  var denom = pick(denoms);
  var numer = rand(1, denom - 1);
  if (Math.random() < 0.5) {
    return { type: 'fraction-identify', numerator: numer, denominator: denom, answer: numer + '/' + denom,
      hint: 'Count how many parts are shaded out of the total.' };
  } else {
    return { type: 'fraction-shade', numerator: numer, denominator: denom, answer: numer,
      hint: 'Shade ' + numer + ' out of ' + denom + ' parts.' };
  }
}

function genMoney(diff) {
  var items = [
    { name: 'pencil', price: rand(1, 5) * 10 },
    { name: 'eraser', price: rand(1, 3) * 10 },
    { name: 'notebook', price: rand(1, 8) * 10 + rand(0, 1) * 5 },
    { name: 'ruler', price: rand(2, 6) * 10 },
    { name: 'sticker', price: rand(1, 4) * 10 + rand(0, 1) * 5 }
  ];
  var item = pick(items);
  if (Math.random() < 0.5) {
    var item2 = pick(items.filter(function(i) { return i.name !== item.name; }));
    var total = item.price + item2.price;
    return { type: 'money-add', item1: item, item2: item2, answer: total,
      hint: 'Add the two prices together. ' + item.price + ' + ' + item2.price + ' cents.' };
  } else {
    var paid = Math.ceil(item.price / 100) * 100;
    if (paid <= item.price) paid = item.price + rand(1, 5) * 10;
    var change = paid - item.price;
    return { type: 'money-change', item, paid, answer: change,
      hint: 'How much change from ' + paid + ' cents after buying something for ' + item.price + ' cents?' };
  }
}

function genTime1(diff) {
  var hour = rand(1, 12);
  var minutes;
  if (diff.level <= 1) {
    minutes = pick([0, 30]);
  } else {
    minutes = pick([0, 15, 30, 45]);
  }
  if (Math.random() < 0.5) {
    return { type: 'time-read', hour, minutes, answer: hour + ':' + (minutes < 10 ? '0' : '') + minutes,
      hint: 'The short hand shows the hour, the long hand shows the minutes.' };
  } else {
    return { type: 'time-set', hour, minutes, answer: hour * 60 + minutes,
      hint: 'Set the clock to show ' + hour + ':' + (minutes < 10 ? '0' : '') + minutes + '.' };
  }
}

function genPGraph(diff) {
  var categories = shuffle(['Apples', 'Bananas', 'Oranges', 'Grapes', 'Strawberries']).slice(0, 4);
  var values = categories.map(function() { return rand(1, 10); });
  var qType = pick(['most', 'least', 'total', 'howmany']);
  var answer;
  if (qType === 'most') answer = categories[values.indexOf(Math.max(...values))];
  else if (qType === 'least') answer = categories[values.indexOf(Math.min(...values))];
  else if (qType === 'total') answer = values.reduce(function(a,b) { return a + b; }, 0);
  else { var idx = rand(0, categories.length - 1); answer = values[idx]; qType = 'howmany_' + idx; }
  return { type: 'picture-graph', categories, values, qType, answer,
    hint: 'Look at the graph carefully. Count the pictures.' };
}

function genLenMass(diff) {
  var items = [
    { name: 'pencil', length: rand(10, 20) },
    { name: 'book', length: rand(20, 35) },
    { name: 'ruler', length: 30 },
    { name: 'eraser', length: rand(3, 8) }
  ];
  var a = pick(items);
  var b = pick(items.filter(function(i) { return i.name !== a.name; }));
  if (Math.random() < 0.5) {
    return { type: 'length-compare', itemA: a, itemB: b, answer: a.length > b.length ? a.name : b.name,
      hint: 'Which item is longer?' };
  } else {
    var diff2 = Math.abs(a.length - b.length);
    return { type: 'length-difference', itemA: a, itemB: b, answer: diff2,
      hint: 'What is the difference in length?' };
  }
}

// ===================== P3 GENERATORS =====================

function genAdd10k(diff) {
  var a = rand(100, 5000);
  var b = rand(100, 5000);
  return { type: 'column-add', a, b, answer: a + b,
    hint: 'Line up the digits. Add ones first, then tens, then hundreds.' };
}

function genSub10k(diff) {
  var a = rand(500, 9999);
  var b = rand(100, a - 1);
  return { type: 'column-sub', a, b, answer: a - b,
    hint: 'Line up the digits. Subtract ones first. Remember to regroup if needed.' };
}

function genAdvMul(diff) {
  var table = pick([6, 7, 8, 9]);
  var n = rand(2, 12);
  if (diff.level >= 3) {
    var a = rand(10, 99);
    var b = rand(2, 9);
    return { type: 'multi-digit-mul', a, b, answer: a * b,
      hint: 'Multiply the ones first, then the tens. Add them together.' };
  }
  return { type: 'multiplication', table, n, answer: table * n, isConcrete: diff.isConcrete, isPictorial: diff.isPictorial,
    hint: table + ' x ' + n + ' = ?' };
}

function genDivRem(diff) {
  var divisor = pick([2, 3, 4, 5, 6, 7]);
  var quotient = rand(2, 12);
  var remainder = rand(1, divisor - 1);
  var dividend = divisor * quotient + remainder;
  return { type: 'division-remainder', dividend, divisor, quotient, remainder, answer: quotient + ' R ' + remainder,
    hint: 'Divide ' + dividend + ' by ' + divisor + '. What\'s left over?' };
}

function genFracAdd(diff) {
  var denom = pick([2, 3, 4, 5, 6, 8]);
  var a = rand(1, denom - 1);
  var b = rand(1, denom - a);
  var isAdd = Math.random() < 0.6;
  if (!isAdd && a < b) { var tmp = a; a = b; b = tmp; }
  var answer = isAdd ? a + b : a - b;
  return { type: 'fraction-operation', a, b, denom, op: isAdd ? '+' : '-', answer: answer + '/' + denom,
    answerNum: answer, hint: 'The denominators are the same, so just ' + (isAdd ? 'add' : 'subtract') + ' the numerators.' };
}

function genArea(diff) {
  var w = rand(2, 6);
  var h = rand(2, 5);
  if (Math.random() < 0.5) {
    return { type: 'area-count', width: w, height: h, answer: w * h,
      hint: 'Count all the squares inside the shape. Or use length x width.' };
  } else {
    return { type: 'perimeter-count', width: w, height: h, answer: 2 * (w + h),
      hint: 'Add up all the sides. Or use 2 x (length + width).' };
  }
}

function genAngle(diff) {
  var angles = [
    { type: 'right', degrees: 90, desc: 'exactly 90 degrees' },
    { type: 'acute', degrees: rand(20, 80), desc: 'less than 90 degrees' },
    { type: 'obtuse', degrees: rand(100, 170), desc: 'more than 90 degrees' }
  ];
  var angle = pick(angles);
  return { type: 'angle-identify', angle, answer: angle.type,
    options: shuffle(['right', 'acute', 'obtuse']),
    hint: 'A right angle is exactly 90 degrees. Acute is smaller, obtuse is larger.' };
}

function genBarGraph(diff) {
  var categories = shuffle(['Mon', 'Tue', 'Wed', 'Thu', 'Fri']).slice(0, 4);
  var values = categories.map(function() { return rand(2, 15); });
  var maxVal = Math.max(...values);
  var maxDay = categories[values.indexOf(maxVal)];
  var total = values.reduce(function(a,b) { return a + b; }, 0);
  var qType = pick(['highest', 'total', 'difference']);
  var answer;
  if (qType === 'highest') answer = maxDay;
  else if (qType === 'total') answer = total;
  else {
    var sorted = [...values].sort(function(a,b) { return b - a; });
    answer = sorted[0] - sorted[sorted.length - 1];
  }
  return { type: 'bar-graph', categories, values, qType, answer,
    hint: 'Read the graph carefully. Compare the heights of the bars.' };
}

// ===================== P4 GENERATORS =====================

function genBigNum(diff) {
  var n = rand(10000, 99999);
  var qTypes = ['place-value', 'rounding', 'comparison'];
  var qType = pick(qTypes);
  if (qType === 'place-value') {
    var places = ['ones', 'tens', 'hundreds', 'thousands', 'ten thousands'];
    var placeIdx = rand(0, 4);
    var digit = Math.floor(n / Math.pow(10, placeIdx)) % 10;
    return { type: 'big-number-pv', number: n, place: places[placeIdx], answer: digit,
      hint: 'Look at the digit in the ' + places[placeIdx] + ' place.' };
  } else if (qType === 'rounding') {
    var roundTo = pick([10, 100, 1000]);
    var rounded = Math.round(n / roundTo) * roundTo;
    return { type: 'big-number-round', number: n, roundTo, answer: rounded,
      hint: 'Look at the digit to the right of where you are rounding.' };
  } else {
    var n2 = n + rand(-5000, 5000);
    while (n2 === n) n2 = n + rand(1, 1000);
    return { type: 'comparing', a: n, b: n2, answer: n > n2 ? '>' : '<',
      hint: 'Compare the digits from left to right.', isConcrete: false };
  }
}

function genMultiOp(diff) {
  if (Math.random() < 0.5) {
    var a = rand(10, 99);
    var b = rand(10, 99);
    return { type: 'long-multiplication', a, b, answer: a * b,
      hint: 'Multiply by ones digit, then by tens digit, then add.' };
  } else {
    var divisor = rand(2, 9);
    var quotient = rand(10, 99);
    var dividend = divisor * quotient;
    return { type: 'long-division', dividend, divisor, answer: quotient,
      hint: 'How many times does ' + divisor + ' go into ' + dividend + '?' };
  }
}

function genFactor(diff) {
  var n = pick([12, 18, 24, 30, 36, 40, 48, 60]);
  if (Math.random() < 0.5) {
    var factors = [];
    for (var i = 1; i <= n; i++) { if (n % i === 0) factors.push(i); }
    return { type: 'find-factors', number: n, answer: factors.join(','), factors,
      hint: 'Which numbers divide evenly into ' + n + '?' };
  } else {
    var a = pick([2, 3, 4, 5, 6]);
    var b = pick([3, 4, 5, 6, 7, 8]);
    while (a === b) b = pick([3, 4, 5, 6, 7, 8]);
    return { type: 'find-lcm', a, b, answer: lcm(a, b),
      hint: 'List multiples of ' + a + ' and ' + b + '. Find the smallest number in both lists.' };
  }
}

function genMixFrac(diff) {
  var whole = rand(1, 5);
  var denom = pick([2, 3, 4, 5]);
  var numer = rand(1, denom - 1);
  var improper = whole * denom + numer;
  if (Math.random() < 0.5) {
    return { type: 'mixed-to-improper', whole, numer, denom, answer: improper + '/' + denom,
      hint: 'Multiply the whole number by the denominator, then add the numerator.' };
  } else {
    return { type: 'improper-to-mixed', improper, denom, answer: whole + ' ' + numer + '/' + denom,
      wholeAnswer: whole, numerAnswer: numer,
      hint: 'Divide ' + improper + ' by ' + denom + '. The quotient is the whole number, remainder is the numerator.' };
  }
}

function genDecimal(diff) {
  if (Math.random() < 0.5) {
    var n = rand(1, 99);
    var decimal = (n / 10).toFixed(1);
    return { type: 'decimal-identify', fraction: n + '/10', answer: decimal,
      hint: 'Divide by 10: move the decimal point one place left.' };
  } else {
    var a = (rand(1, 50) / 10).toFixed(1);
    var b = (rand(1, 50) / 10).toFixed(1);
    var sum = (parseFloat(a) + parseFloat(b)).toFixed(1);
    return { type: 'decimal-add', a, b, answer: sum,
      hint: 'Line up the decimal points, then add normally.' };
  }
}

function genSymm(diff) {
  var shapes = [
    { name: 'square', lines: 4 },
    { name: 'rectangle', lines: 2 },
    { name: 'circle', lines: 'infinite' },
    { name: 'equilateral triangle', lines: 3 },
    { name: 'isosceles triangle', lines: 1 },
    { name: 'regular hexagon', lines: 6 }
  ];
  var shape = pick(shapes);
  return { type: 'symmetry', shape, answer: shape.lines,
    options: shuffle([0, 1, 2, 3, 4, 6]),
    hint: 'A line of symmetry divides a shape into two matching halves.' };
}

function genDataAn(diff) {
  var data = Array.from({length: 5}, function() { return rand(5, 30); });
  var total = data.reduce(function(a,b) { return a + b; }, 0);
  var avg = Math.round(total / data.length);
  var qType = pick(['average', 'total', 'range']);
  var answer;
  if (qType === 'average') answer = avg;
  else if (qType === 'total') answer = total;
  else answer = Math.max(...data) - Math.min(...data);
  return { type: 'data-analysis', data, qType, answer,
    hint: qType === 'average' ? 'Add all numbers, then divide by how many there are.' :
          qType === 'total' ? 'Add all the numbers together.' :
          'Subtract the smallest from the largest.' };
}

function genMultiWP(diff) {
  var templates = [
    function() {
      var price = rand(3, 15);
      var qty = rand(2, 5);
      var money = rand(qty * price + 1, qty * price + 20);
      return { text: 'Anastasia buys ' + qty + ' pens at $' + price + ' each. She pays with $' + money + '. How much change does she get?',
        answer: money - (qty * price), hint: 'First find the total cost, then subtract from the amount paid.' };
    },
    function() {
      var a = rand(10, 50);
      var b = rand(5, 20);
      var c = rand(5, 15);
      return { text: 'A shop has ' + a + ' apples. They sell ' + b + ' in the morning and receive ' + c + ' more in the afternoon. How many apples are there now?',
        answer: a - b + c, hint: 'Start with ' + a + ', take away ' + b + ', then add ' + c + '.' };
    },
    function() {
      var people = rand(3, 8);
      var each = rand(4, 12);
      var extra = rand(5, 20);
      return { text: people + ' children each have ' + each + ' stickers. They are given ' + extra + ' more to share equally. How many stickers does each child have now?',
        answer: each + Math.floor(extra / people), hint: 'First find the total, then add the shared extra.' };
    }
  ];
  var gen = pick(templates)();
  return { type: 'multi-step-wp', text: gen.text, answer: gen.answer, hint: gen.hint };
}

// --- src/math/math-render.js ---
// ============================================================
//  MATH RENDER — Interactive renderers for all math question types
// ============================================================

// Returns true if it handled the question type, false otherwise
function renderMathQuestion(card, q) {
  switch (q.type) {
    case 'ten-frame-count':     renderTenFrameCount(card, q); return true;
    case 'number-bond':         renderNumberBond(card, q); return true;
    case 'addition-concrete':   renderAdditionConcrete(card, q); return true;
    case 'addition-pictorial':  renderAdditionPictorial(card, q); return true;
    case 'addition-abstract':   renderAdditionAbstract(card, q); return true;
    case 'subtraction-concrete':renderSubtractionConcrete(card, q); return true;
    case 'subtraction-abstract':renderSubtractionAbstract(card, q); return true;
    case 'comparing':           renderComparing(card, q); return true;
    case 'pattern-number':      renderPatternNumber(card, q); return true;
    case 'pattern-shape':       renderPatternShape(card, q); return true;
    case 'word-problem':        renderWordProblem(card, q); return true;
    case 'shape-identify':      renderShapeIdentify(card, q); return true;
    case 'shape-properties':    renderShapeProperties(card, q); return true;
    case 'addition-100':        renderAddition100(card, q); return true;
    case 'subtraction-100':     renderSubtraction100(card, q); return true;
    case 'multiplication':      renderMultiplication(card, q); return true;
    case 'division':            renderDivision(card, q); return true;
    case 'fraction-identify':   renderFractionIdentify(card, q); return true;
    case 'fraction-shade':      renderFractionShade(card, q); return true;
    case 'money-add':           renderMoneyAdd(card, q); return true;
    case 'money-change':        renderMoneyChange(card, q); return true;
    case 'time-read':           renderTimeRead(card, q); return true;
    case 'time-set':            renderTimeRead(card, q); return true;
    case 'picture-graph':       renderPictureGraph(card, q); return true;
    case 'length-compare':      renderLengthCompare(card, q); return true;
    case 'length-difference':   renderLengthDiff(card, q); return true;
    case 'column-add':          renderColumnOp(card, q, '+'); return true;
    case 'column-sub':          renderColumnOp(card, q, '-'); return true;
    case 'multi-digit-mul':     renderColumnOp(card, q, 'x'); return true;
    case 'division-remainder':  renderDivisionRemainder(card, q); return true;
    case 'fraction-operation':  renderFractionOp(card, q); return true;
    case 'area-count':          renderAreaGrid(card, q, 'area'); return true;
    case 'perimeter-count':     renderAreaGrid(card, q, 'perimeter'); return true;
    case 'angle-identify':      renderAngle(card, q); return true;
    case 'bar-graph':           renderBarGraphQ(card, q); return true;
    case 'big-number-pv':       renderBigNumberPV(card, q); return true;
    case 'big-number-round':    renderBigNumberRound(card, q); return true;
    case 'long-multiplication': renderColumnOp(card, q, 'x'); return true;
    case 'long-division':       renderLongDivision(card, q); return true;
    case 'find-factors':        renderFactors(card, q); return true;
    case 'find-lcm':            renderLCM(card, q); return true;
    case 'mixed-to-improper':   renderMixedFrac(card, q); return true;
    case 'improper-to-mixed':   renderMixedFrac(card, q); return true;
    case 'decimal-identify':    renderDecimalId(card, q); return true;
    case 'decimal-add':         renderDecimalAdd(card, q); return true;
    case 'symmetry':            renderSymmetry(card, q); return true;
    case 'data-analysis':       renderDataAnalysis(card, q); return true;
    case 'multi-step-wp':       renderMultiStepWP(card, q); return true;
    default: return false;
  }
}

// ===================== P1 RENDERERS =====================

function renderTenFrameCount(card, q) {
  var n = q.number;
  var html = '<div class="question-text">How many dots are there?</div>';
  var frames = Math.ceil(n / 10);
  for (var f = 0; f < Math.min(frames, 2); f++) {
    html += '<div class="ten-frame">';
    for (var i = 0; i < 10; i++) {
      var idx = f * 10 + i;
      html += '<div class="ten-frame-cell ' + (idx < n ? 'filled' : '') + '"></div>';
    }
    html += '</div>';
  }
  var options = generateMCQOptions(n, 1, 20, 4);
  html += '<div class="answer-options">' + options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(' + o + ', ' + n + ', this)">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderNumberBond(card, q) {
  var html = '<div class="question-text">Find the missing number!</div>';
  html += '<div class="number-bond">';
  html += '<div class="nb-line left-line"></div><div class="nb-line right-line"></div>';
  html += '<div class="nb-circle top">' + q.whole + '</div>';
  html += '<div class="nb-circle left ' + (q.missingPart === 'left' ? 'target' : '') + '">' + (q.missingPart === 'left' ? '?' : q.partA) + '</div>';
  html += '<div class="nb-circle right ' + (q.missingPart === 'right' ? 'target' : '') + '">' + (q.missingPart === 'right' ? '?' : q.partB) + '</div>';
  html += '</div>';
  if (q.isConcrete) {
    html += '<div class="picture-objects mt-2">';
    var emoji = pick(OBJECT_EMOJIS);
    for (var i = 0; i < q.whole; i++) html += '<span class="picture-object" style="animation-delay:' + (i*0.05) + 's">' + emoji + '</span>';
    html += '</div>';
  }
  var options = generateMCQOptions(q.answer, 0, q.whole, 4);
  html += '<div class="answer-options mt-2">' + options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(' + o + ', ' + q.answer + ', this)">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderAdditionConcrete(card, q) {
  var html = '<div class="question-text">' + q.a + ' + ' + q.b + ' = ?</div>';
  html += '<div style="display:flex;gap:20px;align-items:center;justify-content:center;flex-wrap:wrap">';
  html += '<div class="picture-objects">';
  for (var i = 0; i < q.a; i++) html += '<span class="picture-object" style="animation-delay:' + (i*0.06) + 's">' + q.emoji + '</span>';
  html += '</div><span style="font-size:32px;color:var(--gold)">+</span><div class="picture-objects">';
  for (var j = 0; j < q.b; j++) html += '<span class="picture-object" style="animation-delay:' + ((q.a+j)*0.06) + 's">' + q.emoji + '</span>';
  html += '</div></div>';
  var options = generateMCQOptions(q.answer, 1, q.answer + 5, 4);
  html += '<div class="answer-options mt-2">' + options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(' + o + ', ' + q.answer + ', this)">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderAdditionPictorial(card, q) {
  var html = '<div class="question-text">' + q.a + ' + ' + q.b + ' = ?</div>';
  html += '<div class="bar-model"><div class="bar-row">';
  html += '<div class="bar-segment part-a" style="flex:' + q.a + '">' + q.a + '</div>';
  html += '<div class="bar-segment part-b" style="flex:' + q.b + '">' + q.b + '</div>';
  html += '</div><div class="bar-row">';
  html += '<div class="bar-segment unknown" style="flex:1">?</div>';
  html += '</div></div>';
  var options = generateMCQOptions(q.answer, 1, q.answer + 6, 4);
  html += '<div class="answer-options mt-2">' + options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(' + o + ', ' + q.answer + ', this)">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderAdditionAbstract(card, q) {
  var html = '<div class="question-text large">' + q.a + ' + ' + q.b + ' = ?</div>';
  html += '<div class="text-input-area">';
  html += '<input class="text-input" type="number" id="answer-input" placeholder="?" maxlength="4" onkeydown="if(event.key===\'Enter\')submitTextAnswer(' + q.answer + ')">';
  html += '<button class="submit-btn" onclick="submitTextAnswer(' + q.answer + ')">Check \u2713</button>';
  html += '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
  setTimeout(function() { var el = document.getElementById('answer-input'); if (el) el.focus(); }, 100);
}

function renderSubtractionConcrete(card, q) {
  var html = '<div class="question-text">' + q.a + ' \u2212 ' + q.b + ' = ?</div>';
  html += '<div class="picture-objects">';
  for (var i = 0; i < q.a; i++) {
    var crossed = i >= q.answer;
    html += '<span class="picture-object" style="animation-delay:' + (i*0.06) + 's;' + (crossed ? 'opacity:0.3;text-decoration:line-through' : '') + '">' + q.emoji + '</span>';
  }
  html += '</div>';
  html += '<div style="font-family:var(--font-hand);font-size:18px;color:var(--text-secondary);margin-top:8px">Take away ' + q.b + '. How many are left?</div>';
  var options = generateMCQOptions(q.answer, 0, q.a, 4);
  html += '<div class="answer-options mt-2">' + options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(' + o + ', ' + q.answer + ', this)">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderSubtractionAbstract(card, q) {
  var html = '<div class="question-text large">' + q.a + ' \u2212 ' + q.b + ' = ?</div>';
  html += '<div class="text-input-area">';
  html += '<input class="text-input" type="number" id="answer-input" placeholder="?" maxlength="4" onkeydown="if(event.key===\'Enter\')submitTextAnswer(' + q.answer + ')">';
  html += '<button class="submit-btn" onclick="submitTextAnswer(' + q.answer + ')">Check \u2713</button>';
  html += '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
  setTimeout(function() { var el = document.getElementById('answer-input'); if (el) el.focus(); }, 100);
}

function renderComparing(card, q) {
  var html = '<div class="question-text">Which is correct?</div>';
  if (q.isConcrete && q.a <= 20 && q.b <= 20) {
    html += '<div style="display:flex;gap:40px;align-items:flex-end;justify-content:center;margin:16px 0">';
    var eA = pick(OBJECT_EMOJIS), eB = pick(OBJECT_EMOJIS);
    html += '<div style="text-align:center"><div class="picture-objects" style="flex-direction:column">';
    for (var i = 0; i < q.a; i++) html += '<span class="picture-object">' + eA + '</span>';
    html += '</div><div style="font-size:24px;font-weight:700;margin-top:8px">' + q.a + '</div></div>';
    html += '<div style="text-align:center"><div class="picture-objects" style="flex-direction:column">';
    for (var j = 0; j < q.b; j++) html += '<span class="picture-object">' + eB + '</span>';
    html += '</div><div style="font-size:24px;font-weight:700;margin-top:8px">' + q.b + '</div></div></div>';
  } else {
    html += '<div class="question-text large">' + q.a + '  \u2610  ' + q.b + '</div>';
  }
  html += '<div class="answer-options">';
  html += '<button class="answer-btn" onclick="checkAnswer(\'>\', \'' + q.answer + '\', this)" style="font-size:32px">' + q.a + ' > ' + q.b + '</button>';
  html += '<button class="answer-btn" onclick="checkAnswer(\'<\', \'' + q.answer + '\', this)" style="font-size:32px">' + q.a + ' < ' + q.b + '</button>';
  html += '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderPatternNumber(card, q) {
  var html = '<div class="question-text">What comes next?</div><div class="pattern-row">';
  q.pattern.forEach(function(n) { html += '<div class="pattern-item">' + n + '</div>'; });
  html += '<div class="pattern-item mystery">?</div></div>';
  var options = generateMCQOptions(q.answer, Math.max(1, q.answer - 5), q.answer + 5, 4);
  html += '<div class="answer-options mt-2">' + options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(' + o + ', ' + q.answer + ', this)">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderPatternShape(card, q) {
  var html = '<div class="question-text">What comes next in the pattern?</div><div class="pattern-row">';
  q.pattern.forEach(function(e) { html += '<div class="pattern-item">' + e + '</div>'; });
  html += '<div class="pattern-item mystery">?</div></div>';
  html += '<div class="answer-options mt-2">' + q.options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(\'' + o + '\', \'' + q.answer + '\', this)" style="font-size:28px">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderWordProblem(card, q) {
  var html = '<div class="story-prompt" style="font-size:19px">' + q.text + '</div>';
  if (q.isConcrete) {
    html += '<div class="bar-model"><div class="bar-row">';
    if (q.op === '+') {
      html += '<div class="bar-segment part-a" style="flex:' + q.a + '">' + q.a + '</div>';
      html += '<div class="bar-segment part-b" style="flex:' + q.b + '">' + q.b + '</div>';
    } else {
      html += '<div class="bar-segment whole" style="flex:' + q.a + '">' + q.a + '</div>';
    }
    html += '</div>';
    if (q.op === '-') {
      html += '<div class="bar-row"><div class="bar-segment part-a" style="flex:' + q.b + '">' + q.b + '</div>';
      html += '<div class="bar-segment unknown" style="flex:' + q.answer + '">?</div></div>';
    } else {
      html += '<div class="bar-row"><div class="bar-segment unknown" style="flex:1">?</div></div>';
    }
    html += '</div>';
  }
  var options = generateMCQOptions(q.answer, Math.max(0, q.answer - 3), q.answer + 5, 4);
  html += '<div class="answer-options mt-2">' + options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(' + o + ', ' + q.answer + ', this)">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderShapeIdentify(card, q) {
  var html = '<div class="question-text">Which shape is a <strong>' + q.shape.name + '</strong>?</div>';
  html += '<div style="font-size:16px;color:var(--text-secondary);margin-bottom:12px">' + q.shape.desc + '</div>';
  html += '<div class="answer-options">' + q.options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(\'' + o.name + '\', \'' + q.shape.name + '\', this)" style="font-size:36px" title="' + o.name + '">' + o.emoji + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderShapeProperties(card, q) {
  var html = '<div style="font-size:72px;margin-bottom:8px">' + q.shape.emoji + '</div>';
  html += '<div class="question-text">How many sides does a ' + q.shape.name + ' have?</div>';
  var opts = q.shape.sides === 0 ? shuffle([0, 1, 2, 3]) : generateMCQOptions(q.shape.sides, Math.max(0, q.shape.sides - 2), q.shape.sides + 3, 4);
  html += '<div class="answer-options mt-2">' + opts.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(' + o + ', ' + q.answer + ', this)">' + (o === 0 ? 'None (round!)' : o) + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

// ===================== P2 RENDERERS =====================

function renderAddition100(card, q) {
  var html = '<div class="question-text large">' + q.a + ' + ' + q.b + ' = ?</div>';
  if (q.isConcrete) {
    html += '<div style="display:flex;gap:16px;justify-content:center;flex-wrap:wrap;margin:12px 0">';
    html += renderPlaceValueBlocks(q.a) + '<span style="font-size:28px;color:var(--gold)">+</span>' + renderPlaceValueBlocks(q.b);
    html += '</div>';
  }
  html += '<div class="text-input-area"><input class="text-input" type="number" id="answer-input" placeholder="?" onkeydown="if(event.key===\'Enter\')submitTextAnswer(' + q.answer + ')">';
  html += '<button class="submit-btn" onclick="submitTextAnswer(' + q.answer + ')">Check \u2713</button></div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
  setTimeout(function() { var el = document.getElementById('answer-input'); if (el) el.focus(); }, 100);
}

function renderSubtraction100(card, q) {
  var html = '<div class="question-text large">' + q.a + ' \u2212 ' + q.b + ' = ?</div>';
  html += '<div class="text-input-area"><input class="text-input" type="number" id="answer-input" placeholder="?" onkeydown="if(event.key===\'Enter\')submitTextAnswer(' + q.answer + ')">';
  html += '<button class="submit-btn" onclick="submitTextAnswer(' + q.answer + ')">Check \u2713</button></div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
  setTimeout(function() { var el = document.getElementById('answer-input'); if (el) el.focus(); }, 100);
}

function renderPlaceValueBlocks(n) {
  var tens = Math.floor(n / 10);
  var ones = n % 10;
  var html = '<div style="display:flex;gap:4px;align-items:flex-end">';
  for (var i = 0; i < tens; i++) html += '<div style="width:12px;height:40px;background:var(--sky);border-radius:3px" title="10"></div>';
  for (var j = 0; j < ones; j++) html += '<div style="width:12px;height:12px;background:var(--mint);border-radius:3px" title="1"></div>';
  html += '</div>';
  return html;
}

function renderMultiplication(card, q) {
  var html = '<div class="question-text">' + q.table + ' \u00D7 ' + q.n + ' = ?</div>';
  if (q.isConcrete) {
    html += '<div style="display:flex;gap:16px;justify-content:center;flex-wrap:wrap;margin:12px 0">';
    var emoji = pick(OBJECT_EMOJIS);
    for (var g = 0; g < q.n; g++) {
      html += '<div style="display:flex;gap:4px;padding:8px;background:rgba(255,255,255,0.05);border-radius:8px">';
      for (var i = 0; i < q.table; i++) html += '<span style="font-size:20px">' + emoji + '</span>';
      html += '</div>';
    }
    html += '</div>';
  } else if (q.isPictorial) {
    html += '<div class="area-grid" style="grid-template-columns:repeat(' + q.table + ', 36px);margin:12px auto;width:fit-content">';
    for (var r = 0; r < q.n; r++) for (var c = 0; c < q.table; c++) {
      html += '<div class="area-cell selected"></div>';
    }
    html += '</div>';
    html += '<div style="font-size:14px;color:var(--text-secondary)">' + q.n + ' rows of ' + q.table + '</div>';
  }
  var options = generateMCQOptions(q.answer, Math.max(1, q.answer - 10), q.answer + 10, 4);
  html += '<div class="answer-options mt-2">' + options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(' + o + ', ' + q.answer + ', this)">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderDivision(card, q) {
  var html = '<div class="question-text">' + q.dividend + ' \u00F7 ' + q.divisor + ' = ?</div>';
  if (q.isConcrete) {
    html += '<div style="display:flex;gap:16px;justify-content:center;flex-wrap:wrap;margin:12px 0">';
    var emoji = pick(OBJECT_EMOJIS);
    for (var g = 0; g < q.answer; g++) {
      html += '<div style="padding:8px;background:rgba(255,255,255,0.05);border-radius:8px;text-align:center">';
      for (var i = 0; i < q.divisor; i++) html += '<span style="font-size:20px">' + emoji + '</span>';
      html += '<div style="font-size:12px;color:var(--text-dim);margin-top:4px">Group ' + (g+1) + '</div></div>';
    }
    html += '</div>';
  }
  var options = generateMCQOptions(q.answer, 1, q.answer + 5, 4);
  html += '<div class="answer-options mt-2">' + options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(' + o + ', ' + q.answer + ', this)">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderFractionIdentify(card, q) {
  var html = '<div class="question-text">What fraction is shaded?</div>';
  html += '<div class="fraction-bar-container"><div class="fraction-bar">';
  for (var i = 0; i < q.denominator; i++) {
    html += '<div class="fraction-part ' + (i < q.numerator ? 'shaded' : 'unshaded') + '" style="flex:1">' + (i < q.numerator ? '' : '') + '</div>';
  }
  html += '</div></div>';
  var options = [];
  for (var n = 1; n < q.denominator; n++) options.push(n + '/' + q.denominator);
  options = shuffle(options).slice(0, 3);
  if (!options.includes(q.answer)) options.push(q.answer);
  options = shuffle(options);
  html += '<div class="answer-options mt-2">' + options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(\'' + o + '\', \'' + q.answer + '\', this)" style="font-size:20px">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderFractionShade(card, q) {
  var html = '<div class="question-text">Shade ' + q.numerator + '/' + q.denominator + '</div>';
  html += '<div class="fraction-bar-container"><div class="fraction-bar" id="frac-bar">';
  for (var i = 0; i < q.denominator; i++) {
    html += '<div class="fraction-part unshaded" style="flex:1" onclick="toggleFracPart(this)" data-idx="' + i + '"></div>';
  }
  html += '</div></div>';
  html += '<button class="submit-btn mt-2" onclick="checkFractionShade(' + q.answer + ')">Check \u2713</button>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderMoneyAdd(card, q) {
  var html = '<div class="question-text">' + q.item1.name + ' (' + q.item1.price + '\u00A2) + ' + q.item2.name + ' (' + q.item2.price + '\u00A2) = ?</div>';
  html += '<div style="display:flex;gap:20px;justify-content:center;font-size:40px;margin:12px 0">\uD83D\uDCB0</div>';
  var options = generateMCQOptions(q.answer, q.answer - 30, q.answer + 30, 4);
  html += '<div class="answer-options mt-2">' + options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(' + o + ', ' + q.answer + ', this)">' + o + '\u00A2</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderMoneyChange(card, q) {
  var html = '<div class="question-text">Buy ' + q.item.name + ' for ' + q.item.price + '\u00A2. Pay ' + q.paid + '\u00A2. Change?</div>';
  var options = generateMCQOptions(q.answer, 0, q.answer + 20, 4);
  html += '<div class="answer-options mt-2">' + options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(' + o + ', ' + q.answer + ', this)">' + o + '\u00A2</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderTimeRead(card, q) {
  var html = '<div class="question-text">What time does the clock show?</div>';
  html += renderClockSVG(q.hour, q.minutes, 180);
  var options = [];
  options.push(q.answer);
  while (options.length < 4) {
    var h = rand(1, 12);
    var m = pick([0, 15, 30, 45]);
    var opt = h + ':' + (m < 10 ? '0' : '') + m;
    if (!options.includes(opt)) options.push(opt);
  }
  options = shuffle(options);
  html += '<div class="answer-options mt-2">' + options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(\'' + o + '\', \'' + q.answer + '\', this)" style="font-size:20px">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderClockSVG(hour, minutes, size) {
  var cx = size / 2, cy = size / 2, r = size / 2 - 10;
  var svg = '<svg width="' + size + '" height="' + size + '" style="margin:12px auto;display:block">';
  svg += '<circle cx="' + cx + '" cy="' + cy + '" r="' + r + '" fill="rgba(255,255,255,0.05)" stroke="rgba(255,255,255,0.3)" stroke-width="3"/>';
  for (var i = 1; i <= 12; i++) {
    var angle = (i * 30 - 90) * Math.PI / 180;
    var tx = cx + (r - 20) * Math.cos(angle);
    var ty = cy + (r - 20) * Math.sin(angle);
    svg += '<text x="' + tx + '" y="' + ty + '" fill="var(--text-primary)" font-size="14" font-family="var(--font-display)" text-anchor="middle" dominant-baseline="central">' + i + '</text>';
  }
  // Hour hand
  var hAngle = ((hour % 12) * 30 + minutes * 0.5 - 90) * Math.PI / 180;
  var hx = cx + (r * 0.5) * Math.cos(hAngle);
  var hy = cy + (r * 0.5) * Math.sin(hAngle);
  svg += '<line x1="' + cx + '" y1="' + cy + '" x2="' + hx + '" y2="' + hy + '" stroke="var(--coral)" stroke-width="4" stroke-linecap="round"/>';
  // Minute hand
  var mAngle = (minutes * 6 - 90) * Math.PI / 180;
  var mx = cx + (r * 0.7) * Math.cos(mAngle);
  var my = cy + (r * 0.7) * Math.sin(mAngle);
  svg += '<line x1="' + cx + '" y1="' + cy + '" x2="' + mx + '" y2="' + my + '" stroke="var(--sky)" stroke-width="3" stroke-linecap="round"/>';
  svg += '<circle cx="' + cx + '" cy="' + cy + '" r="5" fill="var(--gold)"/>';
  svg += '</svg>';
  return svg;
}

function renderPictureGraph(card, q) {
  var html = '<div class="question-text">Look at the graph</div>';
  html += '<div style="display:flex;gap:12px;align-items:flex-end;justify-content:center;margin:16px 0;height:150px">';
  var maxVal = Math.max(...q.values);
  q.categories.forEach(function(cat, i) {
    var h = (q.values[i] / maxVal) * 120;
    html += '<div style="text-align:center"><div style="width:40px;height:' + h + 'px;background:linear-gradient(to top,var(--sky),var(--lavender));border-radius:4px 4px 0 0"></div>';
    html += '<div style="font-size:12px;color:var(--text-secondary);margin-top:4px">' + cat + '</div>';
    html += '<div style="font-size:14px;font-weight:600">' + q.values[i] + '</div></div>';
  });
  html += '</div>';
  var qText;
  if (q.qType === 'most') qText = 'Which has the most?';
  else if (q.qType === 'least') qText = 'Which has the least?';
  else if (q.qType === 'total') qText = 'What is the total?';
  else qText = 'How many ' + q.categories[parseInt(q.qType.split('_')[1])] + '?';
  html += '<div class="question-text" style="font-size:20px">' + qText + '</div>';
  if (typeof q.answer === 'string') {
    html += '<div class="answer-options mt-2">' + shuffle(q.categories).map(function(c) {
      return '<button class="answer-btn" onclick="checkAnswer(\'' + c + '\', \'' + q.answer + '\', this)" style="font-size:16px">' + c + '</button>';
    }).join('') + '</div>';
  } else {
    var options = generateMCQOptions(q.answer, Math.max(0, q.answer - 5), q.answer + 5, 4);
    html += '<div class="answer-options mt-2">' + options.map(function(o) {
      return '<button class="answer-btn" onclick="checkAnswer(' + o + ', ' + q.answer + ', this)">' + o + '</button>';
    }).join('') + '</div>';
  }
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderLengthCompare(card, q) {
  var html = '<div class="question-text">Which is longer?</div>';
  html += '<div style="display:flex;flex-direction:column;gap:12px;align-items:center;margin:16px 0">';
  html += '<div style="width:' + (q.itemA.length * 5) + 'px;height:16px;background:var(--sky);border-radius:4px"></div>';
  html += '<div style="font-size:14px">' + q.itemA.name + ' (' + q.itemA.length + ' cm)</div>';
  html += '<div style="width:' + (q.itemB.length * 5) + 'px;height:16px;background:var(--mint);border-radius:4px"></div>';
  html += '<div style="font-size:14px">' + q.itemB.name + ' (' + q.itemB.length + ' cm)</div>';
  html += '</div>';
  html += '<div class="answer-options">';
  html += '<button class="answer-btn" onclick="checkAnswer(\'' + q.itemA.name + '\', \'' + q.answer + '\', this)">' + q.itemA.name + '</button>';
  html += '<button class="answer-btn" onclick="checkAnswer(\'' + q.itemB.name + '\', \'' + q.answer + '\', this)">' + q.itemB.name + '</button>';
  html += '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderLengthDiff(card, q) {
  var html = '<div class="question-text">' + q.itemA.name + ' is ' + q.itemA.length + ' cm. ' + q.itemB.name + ' is ' + q.itemB.length + ' cm. What is the difference?</div>';
  var options = generateMCQOptions(q.answer, 0, q.answer + 10, 4);
  html += '<div class="answer-options mt-2">' + options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(' + o + ', ' + q.answer + ', this)">' + o + ' cm</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

// ===================== P3-P4 RENDERERS =====================

function renderColumnOp(card, q, op) {
  var symbol = op === 'x' ? '\u00D7' : op === '-' ? '\u2212' : '+';
  var html = '<div class="question-text">' + q.a + ' ' + symbol + ' ' + q.b + ' = ?</div>';
  html += '<div class="text-input-area"><input class="text-input" type="number" id="answer-input" placeholder="?" onkeydown="if(event.key===\'Enter\')submitTextAnswer(' + q.answer + ')">';
  html += '<button class="submit-btn" onclick="submitTextAnswer(' + q.answer + ')">Check \u2713</button></div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
  setTimeout(function() { var el = document.getElementById('answer-input'); if (el) el.focus(); }, 100);
}

function renderDivisionRemainder(card, q) {
  var html = '<div class="question-text">' + q.dividend + ' \u00F7 ' + q.divisor + ' = ?</div>';
  html += '<div style="font-size:16px;color:var(--text-secondary);margin-bottom:12px">Include the remainder if there is one</div>';
  var options = [];
  options.push(q.answer);
  options.push(q.quotient + ' R ' + (q.remainder + 1 > q.divisor - 1 ? 0 : q.remainder + 1));
  options.push((q.quotient + 1) + ' R 0');
  options.push((q.quotient - 1) + ' R ' + (q.remainder + q.divisor));
  options = shuffle(options.filter(function(v, i, a) { return a.indexOf(v) === i; })).slice(0, 4);
  html += '<div class="answer-options mt-2">' + options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(\'' + o + '\', \'' + q.answer + '\', this)" style="font-size:18px">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderFractionOp(card, q) {
  var html = '<div class="question-text">' + q.a + '/' + q.denom + ' ' + q.op + ' ' + q.b + '/' + q.denom + ' = ?</div>';
  html += '<div class="fraction-bar-container" style="margin:12px 0"><div class="fraction-bar">';
  for (var i = 0; i < q.denom; i++) {
    var shaded = q.op === '+' ? (i < q.a ? 'part-a' : i < q.a + q.b ? 'part-b' : '') : (i < q.answerNum ? 'part-a' : i < q.a ? 'part-b' : '');
    html += '<div class="fraction-part ' + (shaded ? 'shaded' : 'unshaded') + '" style="flex:1;' + (shaded === 'part-b' ? 'background:linear-gradient(135deg,var(--mint),var(--teal))' : '') + '"></div>';
  }
  html += '</div></div>';
  var options = [];
  for (var n = Math.max(0, q.answerNum - 2); n <= Math.min(q.denom, q.answerNum + 2); n++) {
    if (n >= 0) options.push(n + '/' + q.denom);
  }
  if (!options.includes(q.answer)) options.push(q.answer);
  options = shuffle(options).slice(0, 4);
  html += '<div class="answer-options mt-2">' + options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(\'' + o + '\', \'' + q.answer + '\', this)" style="font-size:20px">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderAreaGrid(card, q, mode) {
  var html = '<div class="question-text">' + (mode === 'area' ? 'What is the area?' : 'What is the perimeter?') + '</div>';
  html += '<div class="area-grid" style="grid-template-columns:repeat(' + q.width + ', 36px);margin:12px auto;width:fit-content">';
  for (var r = 0; r < q.height; r++) for (var c = 0; c < q.width; c++) {
    var isEdge = r === 0 || r === q.height - 1 || c === 0 || c === q.width - 1;
    html += '<div class="area-cell ' + (mode === 'area' ? 'selected' : (isEdge ? 'perimeter' : 'selected')) + '"></div>';
  }
  html += '</div>';
  html += '<div style="font-size:14px;color:var(--text-secondary)">' + q.width + ' \u00D7 ' + q.height + '</div>';
  var options = generateMCQOptions(q.answer, Math.max(1, q.answer - 5), q.answer + 5, 4);
  html += '<div class="answer-options mt-2">' + options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(' + o + ', ' + q.answer + ', this)">' + o + (mode === 'area' ? ' sq units' : ' units') + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderAngle(card, q) {
  var deg = q.angle.degrees;
  var html = '<div class="question-text">What type of angle is this?</div>';
  var size = 150;
  var svg = '<svg width="' + size + '" height="' + size + '" style="margin:12px auto;display:block">';
  var cx = 20, cy = size - 20;
  svg += '<line x1="' + cx + '" y1="' + cy + '" x2="' + (size - 20) + '" y2="' + cy + '" stroke="var(--sky)" stroke-width="3"/>';
  var rad = (-deg) * Math.PI / 180;
  var lx = cx + (size - 40) * Math.cos(rad);
  var ly = cy + (size - 40) * Math.sin(rad);
  svg += '<line x1="' + cx + '" y1="' + cy + '" x2="' + lx + '" y2="' + ly + '" stroke="var(--coral)" stroke-width="3"/>';
  svg += '<text x="' + (cx + 35) + '" y="' + (cy - 10) + '" fill="var(--text-secondary)" font-size="14">' + deg + '\u00B0</text>';
  svg += '</svg>';
  html += svg;
  html += '<div class="answer-options mt-2">' + q.options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(\'' + o + '\', \'' + q.answer + '\', this)" style="font-size:18px">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderBarGraphQ(card, q) {
  return renderPictureGraph(card, q);
}

function renderBigNumberPV(card, q) {
  var html = '<div class="question-text">What digit is in the ' + q.place + ' place?</div>';
  html += '<div class="question-text large" style="color:var(--gold)">' + formatNumber(q.number) + '</div>';
  var options = generateMCQOptions(q.answer, 0, 9, 4);
  html += '<div class="answer-options mt-2">' + options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(' + o + ', ' + q.answer + ', this)">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderBigNumberRound(card, q) {
  var html = '<div class="question-text">Round ' + formatNumber(q.number) + ' to the nearest ' + q.roundTo + '</div>';
  var options = generateMCQOptions(q.answer, q.answer - q.roundTo * 2, q.answer + q.roundTo * 2, 4);
  html += '<div class="answer-options mt-2">' + options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(' + o + ', ' + q.answer + ', this)">' + formatNumber(o) + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderLongDivision(card, q) {
  var html = '<div class="question-text">' + q.dividend + ' \u00F7 ' + q.divisor + ' = ?</div>';
  html += '<div class="text-input-area"><input class="text-input" type="number" id="answer-input" placeholder="?" onkeydown="if(event.key===\'Enter\')submitTextAnswer(' + q.answer + ')">';
  html += '<button class="submit-btn" onclick="submitTextAnswer(' + q.answer + ')">Check \u2713</button></div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
  setTimeout(function() { var el = document.getElementById('answer-input'); if (el) el.focus(); }, 100);
}

function renderFactors(card, q) {
  var html = '<div class="question-text">Find all factors of ' + q.number + '</div>';
  html += '<div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:12px 0" id="factor-picks">';
  var candidates = [];
  for (var i = 1; i <= q.number; i++) candidates.push(i);
  candidates = candidates.filter(function(n) { return n <= 20 || q.factors.includes(n); });
  if (candidates.length > 16) candidates = shuffle(candidates).slice(0, 12).concat(q.factors);
  candidates = [...new Set(candidates)].sort(function(a,b) { return a - b; });
  candidates.forEach(function(n) {
    html += '<button class="answer-btn" style="font-size:16px;padding:8px 14px;min-width:50px" onclick="toggleFactorBtn(this)" data-val="' + n + '">' + n + '</button>';
  });
  html += '</div>';
  html += '<button class="submit-btn mt-2" onclick="checkFactors([' + q.factors.join(',') + '])">Check \u2713</button>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderLCM(card, q) {
  var html = '<div class="question-text">What is the LCM of ' + q.a + ' and ' + q.b + '?</div>';
  html += '<div style="font-size:14px;color:var(--text-secondary);margin-bottom:8px">Lowest Common Multiple</div>';
  var options = generateMCQOptions(q.answer, q.answer - 10, q.answer + 15, 4);
  html += '<div class="answer-options mt-2">' + options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(' + o + ', ' + q.answer + ', this)">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderMixedFrac(card, q) {
  var html;
  if (q.type === 'mixed-to-improper') {
    html = '<div class="question-text">Convert ' + q.whole + ' ' + q.numer + '/' + q.denom + ' to an improper fraction</div>';
  } else {
    html = '<div class="question-text">Convert ' + q.improper + '/' + q.denom + ' to a mixed number</div>';
  }
  html += '<div class="text-input-area"><input class="text-input" type="text" id="answer-input" placeholder="?" onkeydown="if(event.key===\'Enter\')checkMixedFrac(\'' + q.answer.replace(/'/g, "\\'") + '\')">';
  html += '<button class="submit-btn" onclick="checkMixedFrac(\'' + q.answer.replace(/'/g, "\\'") + '\')">Check \u2713</button></div>';
  html += '<div style="font-size:13px;color:var(--text-dim);margin-top:8px">Format: ' + (q.type === 'mixed-to-improper' ? '7/4' : '1 3/4') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
  setTimeout(function() { var el = document.getElementById('answer-input'); if (el) el.focus(); }, 100);
}

function renderDecimalId(card, q) {
  var html = '<div class="question-text">Convert ' + q.fraction + ' to a decimal</div>';
  var options = [];
  options.push(q.answer);
  while (options.length < 4) {
    var fake = (rand(1, 99) / 10).toFixed(1);
    if (!options.includes(fake)) options.push(fake);
  }
  options = shuffle(options);
  html += '<div class="answer-options mt-2">' + options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(\'' + o + '\', \'' + q.answer + '\', this)">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderDecimalAdd(card, q) {
  var html = '<div class="question-text large">' + q.a + ' + ' + q.b + ' = ?</div>';
  html += '<div class="text-input-area"><input class="text-input" type="text" id="answer-input" placeholder="?" onkeydown="if(event.key===\'Enter\')checkDecimalAnswer(\'' + q.answer + '\')">';
  html += '<button class="submit-btn" onclick="checkDecimalAnswer(\'' + q.answer + '\')">Check \u2713</button></div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
  setTimeout(function() { var el = document.getElementById('answer-input'); if (el) el.focus(); }, 100);
}

function renderSymmetry(card, q) {
  var html = '<div class="question-text">How many lines of symmetry does a ' + q.shape.name + ' have?</div>';
  html += '<div style="font-size:64px;margin:12px 0">\u2B1C</div>';
  html += '<div class="answer-options mt-2">' + q.options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(' + (typeof q.answer === 'string' ? '\'' + o + '\', \'' + q.answer + '\'' : o + ', ' + q.answer) + ', this)">' + (o === 'infinite' ? '\u221E' : o) + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderDataAnalysis(card, q) {
  var html = '<div class="question-text">Data: ' + q.data.join(', ') + '</div>';
  var qText = q.qType === 'average' ? 'What is the average (mean)?' :
              q.qType === 'total' ? 'What is the total?' : 'What is the range?';
  html += '<div class="question-text" style="font-size:20px;margin-top:8px">' + qText + '</div>';
  var options = generateMCQOptions(q.answer, Math.max(0, q.answer - 5), q.answer + 5, 4);
  html += '<div class="answer-options mt-2">' + options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(' + o + ', ' + q.answer + ', this)">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderMultiStepWP(card, q) {
  var html = '<div class="story-prompt" style="font-size:18px">' + q.text + '</div>';
  html += '<div class="text-input-area mt-2"><input class="text-input" type="number" id="answer-input" placeholder="?" onkeydown="if(event.key===\'Enter\')submitTextAnswer(' + q.answer + ')">';
  html += '<button class="submit-btn" onclick="submitTextAnswer(' + q.answer + ')">Check \u2713</button></div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
  setTimeout(function() { var el = document.getElementById('answer-input'); if (el) el.focus(); }, 100);
}

// ===================== HELPER FUNCTIONS =====================

function toggleFracPart(el) {
  el.classList.toggle('shaded');
  el.classList.toggle('unshaded');
}

function checkFractionShade(expected) {
  var parts = document.querySelectorAll('#frac-bar .fraction-part.shaded');
  if (parts.length === expected) handleCorrect();
  else handleWrong(expected + ' parts');
}

function toggleFactorBtn(btn) {
  btn.classList.toggle('correct');
}

function checkFactors(correct) {
  var picked = [];
  document.querySelectorAll('#factor-picks .answer-btn.correct').forEach(function(b) {
    picked.push(parseInt(b.dataset.val));
  });
  picked.sort(function(a,b) { return a - b; });
  correct.sort(function(a,b) { return a - b; });
  if (JSON.stringify(picked) === JSON.stringify(correct)) handleCorrect();
  else handleWrong(correct.join(', '));
}

function checkMixedFrac(expected) {
  var input = document.getElementById('answer-input');
  if (!input) return;
  var val = input.value.trim().replace(/\s+/g, ' ');
  if (val === expected) handleCorrect();
  else handleWrong(expected);
}

function checkDecimalAnswer(expected) {
  var input = document.getElementById('answer-input');
  if (!input) return;
  var val = parseFloat(input.value.trim());
  if (!isNaN(val) && val.toFixed(1) === expected) handleCorrect();
  else handleWrong(expected);
}

// --- src/word/word-gen.js ---
// ============================================================
//  WORD GENERATORS — Question generators for all 10 word skills
// ============================================================

function generateWordQuestion(skillId) {
  var diff = getSkillDifficulty(skillId);
  switch (skillId) {
    case 'phonics':       return genPhonics(diff);
    case 'sight':         return genSight(diff);
    case 'spell':         return genSpell(diff);
    case 'grammar':       return genGrammar(diff);
    case 'vocab':         return genVocab(diff);
    case 'sentence':      return genSentence(diff);
    case 'comprehension': return genComprehension(diff);
    case 'poetry':        return genPoetry(diff);
    case 'story':         return genStory(diff);
    case 'paragraph':     return genParagraph(diff);
    default:              return genPhonics(diff);
  }
}

// ===================== P1 GENERATORS =====================

function genPhonics(diff) {
  var families = Object.keys(CVC_FAMILIES);
  var family = pick(families);
  var words = CVC_FAMILIES[family];
  var word = pick(words);

  if (diff.level < 2) {
    // Which word belongs to the -XX family?
    var correct = word;
    var wrongFamilies = families.filter(function(f) { return f !== family; });
    var wrongs = wrongFamilies.slice(0, 3).map(function(f) { return pick(CVC_FAMILIES[f]); });
    return {
      type: 'phonics-family',
      family: family,
      word: correct,
      options: shuffle([correct].concat(wrongs)),
      answer: correct,
      hint: 'This word ends with -' + family + '. Sound it out!'
    };
  } else {
    // What sound does this word start with?
    var firstLetter = word[0].toUpperCase();
    var otherLetters = shuffle('BCDFGHJKLMNPRSTVW'.split('')).filter(function(l) {
      return l !== firstLetter;
    }).slice(0, 3);
    return {
      type: 'phonics-initial',
      word: word,
      options: shuffle([firstLetter].concat(otherLetters)),
      answer: firstLetter,
      hint: 'Say the word slowly. What sound do you hear first?'
    };
  }
}

function genSight(diff) {
  var level = Math.min(diff.level, SIGHT_WORDS_BY_LEVEL.length - 1);
  // Pool words from current level and below
  var pool = [];
  for (var i = 0; i <= level; i++) {
    pool = pool.concat(SIGHT_WORDS_BY_LEVEL[i]);
  }
  var word = pick(pool);

  if (Math.random() < 0.5) {
    // Pick the correct word
    var wrongs = shuffle(pool.filter(function(w) { return w !== word; })).slice(0, 3);
    return {
      type: 'sight-pick',
      targetWord: word,
      options: shuffle([word].concat(wrongs)),
      answer: word,
      hint: 'Look carefully at each word. Which one matches?'
    };
  } else {
    // Find the word that matches (shown briefly, then hidden — flash card style)
    var wrongs2 = shuffle(pool.filter(function(w) { return w !== word; })).slice(0, 3);
    return {
      type: 'sight-flash',
      targetWord: word,
      options: shuffle([word].concat(wrongs2)),
      answer: word,
      hint: 'Try to remember the word you saw. Sound it out in your head!'
    };
  }
}

function genSpell(diff) {
  // Pick a CVC word that has a picture
  var spellableWords = Object.keys(SPELLING_PIC_MAP);
  var word = pick(spellableWords);
  var emoji = SPELLING_PIC_MAP[word];

  if (diff.level < 2) {
    // Fill in the missing letter
    var pos = rand(0, word.length - 1);
    var blank = word.substring(0, pos) + '_' + word.substring(pos + 1);
    var correctLetter = word[pos];
    var otherLetters = shuffle('abcdefghijklmnoprstuvw'.split('')).filter(function(l) {
      return l !== correctLetter;
    }).slice(0, 3);
    return {
      type: 'spell-missing',
      word: word,
      emoji: emoji,
      blank: blank,
      missingLetter: correctLetter,
      options: shuffle([correctLetter].concat(otherLetters)),
      answer: correctLetter,
      hint: 'Say the word for the picture. What letter is missing?'
    };
  } else {
    // Type the full word
    return {
      type: 'spell-full',
      word: word,
      emoji: emoji,
      answer: word,
      hint: 'Look at the picture. Sound out each letter: ' + word.split('').join('-') + '.'
    };
  }
}

// ===================== P2 GENERATORS =====================

function genGrammar(diff) {
  var exercises = GRAMMAR_EXERCISES;
  var ex = pick(exercises);

  return {
    type: 'grammar-mcq',
    instruction: ex.instruction,
    sentence: ex.sentence,
    options: shuffle(ex.options),
    answer: ex.answer,
    grammarType: ex.type,
    hint: ex.type.indexOf('noun') >= 0 ? 'A noun is a person, place, animal, or thing.' :
          ex.type.indexOf('verb') >= 0 ? 'A verb is an action word — something you can do.' :
          ex.type.indexOf('adj') >= 0 ? 'An adjective describes what something is like.' :
          'Think about what sounds right when you say it out loud.'
  };
}

function genVocab(diff) {
  var item = pick(VOCAB_ITEMS);

  if (Math.random() < 0.6) {
    // Pick the meaning
    return {
      type: 'vocab-meaning',
      word: item.word,
      sentence: item.sentence,
      options: shuffle(item.options),
      answer: item.options[0],
      hint: 'Read the sentence. What does "' + item.word + '" mean?'
    };
  } else {
    // Pick the word from meaning
    var wrongs = shuffle(VOCAB_ITEMS.filter(function(v) { return v.word !== item.word; })).slice(0, 3);
    return {
      type: 'vocab-word',
      meaning: item.meaning,
      options: shuffle([item.word].concat(wrongs.map(function(v) { return v.word; }))),
      answer: item.word,
      hint: 'Which word means "' + item.meaning + '"?'
    };
  }
}

function genSentence(diff) {
  var level = Math.min(diff.level, 3);
  var patterns = SENTENCE_PATTERNS.filter(function(p) { return p.level <= level; });
  var pat = pick(patterns);

  // Build the sentence
  var words = pat.pattern.map(function(token) {
    if (token === '_noun') return pick(WORD_BANKS.nouns);
    if (token === '_adj') return pick(WORD_BANKS.adjectives);
    if (token === '_verb') return pick(WORD_BANKS.verbs);
    if (token === '_name') return pick(WORD_BANKS.names);
    if (token === '_place') return pick(WORD_BANKS.places);
    return token;
  });

  var correctSentence = words.join(' ').replace(/ \./g, '.').replace(/ s\./g, 's.');

  // Scramble the words (excluding punctuation)
  var content = words.filter(function(w) { return w !== '.'; });
  var scrambled = shuffle(content);
  // Make sure it's actually scrambled
  var safety = 0;
  while (scrambled.join(' ') === content.join(' ') && safety < 10) {
    scrambled = shuffle(content);
    safety++;
  }

  return {
    type: 'sentence-build',
    words: scrambled,
    answer: correctSentence,
    correctOrder: content,
    hint: 'Start with a capital letter. End with a full stop. What makes sense?'
  };
}

// ===================== P3 GENERATORS =====================

function genComprehension(diff) {
  var passage = pick(COMPREHENSION_PASSAGES);
  var q = pick(passage.questions);

  return {
    type: 'comprehension-mcq',
    title: passage.title,
    text: passage.text,
    question: q.question,
    options: shuffle(q.options),
    answer: q.answer,
    hint: 'Read the passage carefully. The answer is in the text!'
  };
}

function genPoetry(diff) {
  if (diff.level < 2) {
    // Rhyming word match
    var set = pick(POETRY_DATA.rhymeSets);
    var target = pick(set);
    var correctRhyme = pick(set.filter(function(w) { return w !== target; }));
    var otherSets = POETRY_DATA.rhymeSets.filter(function(s) { return s !== set; });
    var wrongs = otherSets.slice(0, 3).map(function(s) { return pick(s); });
    return {
      type: 'poetry-rhyme',
      targetWord: target,
      options: shuffle([correctRhyme].concat(wrongs)),
      answer: correctRhyme,
      hint: 'Which word sounds like "' + target + '" at the end?'
    };
  } else if (diff.level < 3) {
    // Syllable counting
    var syllLevel = pick([1, 2, 3]);
    var word = pick(POETRY_DATA.syllableWords[syllLevel]);
    var options = shuffle([1, 2, 3]);
    if (!options.includes(syllLevel)) options.push(syllLevel);
    options = shuffle(options).slice(0, 4);
    return {
      type: 'poetry-syllable',
      word: word,
      answer: syllLevel,
      options: options,
      hint: 'Clap the word out. How many beats? ' + word
    };
  } else {
    // Complete the couplet
    var rhymeSet = pick(POETRY_DATA.rhymeSets);
    var wordA = rhymeSet[0];
    var wordB = rhymeSet[1];
    var wrongs2 = POETRY_DATA.rhymeSets.filter(function(s) { return s !== rhymeSet; }).slice(0, 3).map(function(s) { return s[0]; });
    return {
      type: 'poetry-couplet',
      line1End: wordA,
      options: shuffle([wordB].concat(wrongs2)),
      answer: wordB,
      hint: 'The second line should rhyme with "' + wordA + '".'
    };
  }
}

// ===================== P4 GENERATORS =====================

function genStory(diff) {
  var prompt = pick(STORY_PROMPTS);
  return {
    type: 'story-write',
    prompt: prompt,
    answer: '__story__',
    hint: 'Let your imagination fly! Write at least 2 sentences.'
  };
}

function genParagraph(diff) {
  var item = pick(PARAGRAPH_PROMPTS);
  return {
    type: 'paragraph-write',
    topic: item.topic,
    starter: item.starter,
    hints: item.hints,
    answer: '__paragraph__',
    hint: 'Use the helper questions to guide your writing!'
  };
}

// --- src/word/word-render.js ---
// ============================================================
//  WORD RENDER — Interactive renderers for all word question types
// ============================================================

function renderWordQuestion(card, q) {
  switch (q.type) {
    case 'phonics-family':    renderPhonicsFamily(card, q); return true;
    case 'phonics-initial':   renderPhonicsInitial(card, q); return true;
    case 'sight-pick':        renderSightPick(card, q); return true;
    case 'sight-flash':       renderSightFlash(card, q); return true;
    case 'spell-missing':     renderSpellMissing(card, q); return true;
    case 'spell-full':        renderSpellFull(card, q); return true;
    case 'grammar-mcq':       renderGrammarMCQ(card, q); return true;
    case 'vocab-meaning':     renderVocabMeaning(card, q); return true;
    case 'vocab-word':        renderVocabWord(card, q); return true;
    case 'sentence-build':    renderSentenceBuild(card, q); return true;
    case 'comprehension-mcq': renderComprehensionMCQ(card, q); return true;
    case 'poetry-rhyme':      renderPoetryRhyme(card, q); return true;
    case 'poetry-syllable':   renderPoetySyllable(card, q); return true;
    case 'poetry-couplet':    renderPoetryCouplet(card, q); return true;
    case 'story-write':       renderStoryWrite(card, q); return true;
    case 'paragraph-write':   renderParagraphWrite(card, q); return true;
    default: return false;
  }
}

// ===================== P1 RENDERERS =====================

function renderPhonicsFamily(card, q) {
  var html = '<div class="question-text">Which word belongs to the <strong>-' + q.family + '</strong> family?</div>';
  html += '<div style="font-size:48px;margin:12px 0;letter-spacing:4px;color:var(--gold)">-' + q.family + '</div>';
  html += '<div class="answer-options">' + q.options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(\'' + o + '\', \'' + q.answer + '\', this)" style="font-size:22px;letter-spacing:2px">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderPhonicsInitial(card, q) {
  var html = '<div class="question-text">What letter does this word start with?</div>';
  html += '<div style="font-size:42px;margin:16px 0;font-family:var(--font-display);color:var(--sky)">' + q.word + '</div>';
  html += '<div class="answer-options">' + q.options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(\'' + o + '\', \'' + q.answer + '\', this)" style="font-size:28px;font-weight:700">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderSightPick(card, q) {
  var html = '<div class="question-text">Find the word:</div>';
  html += '<div style="font-size:42px;margin:16px 0;font-family:var(--font-display);color:var(--gold)">' + q.targetWord + '</div>';
  html += '<div class="answer-options">' + q.options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(\'' + o + '\', \'' + q.answer + '\', this)" style="font-size:24px">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderSightFlash(card, q) {
  var html = '<div class="question-text">Remember this word!</div>';
  html += '<div id="flash-word" style="font-size:48px;margin:16px 0;font-family:var(--font-display);color:var(--gold);transition:opacity 0.5s">' + q.targetWord + '</div>';
  html += '<div id="flash-options" style="display:none">';
  html += '<div class="question-text" style="font-size:20px">Which word did you see?</div>';
  html += '<div class="answer-options">' + q.options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(\'' + o + '\', \'' + q.answer + '\', this)" style="font-size:24px">' + o + '</button>';
  }).join('') + '</div>';
  html += '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;

  // Flash: show word for 2 seconds, then hide and show options
  setTimeout(function() {
    var wordEl = document.getElementById('flash-word');
    var optEl = document.getElementById('flash-options');
    if (wordEl) wordEl.style.opacity = '0';
    setTimeout(function() {
      if (wordEl) wordEl.style.display = 'none';
      if (optEl) optEl.style.display = 'block';
    }, 500);
  }, 2000);
}

function renderSpellMissing(card, q) {
  var html = '<div class="question-text">What letter is missing?</div>';
  html += '<div style="font-size:64px;margin:12px 0">' + q.emoji + '</div>';
  html += '<div style="font-size:36px;font-family:var(--font-display);letter-spacing:8px;margin:12px 0;color:var(--sky)">' + q.blank + '</div>';
  html += '<div class="answer-options">' + q.options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(\'' + o + '\', \'' + q.answer + '\', this)" style="font-size:28px;font-weight:700">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderSpellFull(card, q) {
  var html = '<div class="question-text">Spell the word!</div>';
  html += '<div style="font-size:72px;margin:16px 0">' + q.emoji + '</div>';
  html += '<div class="text-input-area">';
  html += '<input class="text-input" type="text" id="answer-input" placeholder="Type the word..." maxlength="10" autocomplete="off" autocapitalize="off" style="font-size:24px;letter-spacing:4px;text-align:center" onkeydown="if(event.key===\'Enter\')submitSpelling(\'' + q.answer + '\')">';
  html += '<button class="submit-btn" onclick="submitSpelling(\'' + q.answer + '\')">Check \u2713</button>';
  html += '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
  setTimeout(function() { var el = document.getElementById('answer-input'); if (el) el.focus(); }, 100);
}

// ===================== P2 RENDERERS =====================

function renderGrammarMCQ(card, q) {
  var html = '<div class="question-text">' + q.instruction + '</div>';
  // Highlight the sentence
  html += '<div class="story-prompt" style="font-size:20px;margin:16px 0">' + q.sentence + '</div>';
  html += '<div class="answer-options">' + q.options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(\'' + o + '\', \'' + q.answer + '\', this)" style="font-size:20px">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderVocabMeaning(card, q) {
  var html = '<div class="question-text">What does <strong style="color:var(--gold)">' + q.word + '</strong> mean?</div>';
  html += '<div class="story-prompt" style="font-size:18px;margin:12px 0">"' + q.sentence + '"</div>';
  html += '<div class="answer-options">' + q.options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(\'' + escapeQuote(o) + '\', \'' + escapeQuote(q.answer) + '\', this)" style="font-size:16px">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderVocabWord(card, q) {
  var html = '<div class="question-text">Which word means:</div>';
  html += '<div style="font-size:20px;color:var(--mint);margin:12px 0;font-style:italic">"' + q.meaning + '"</div>';
  html += '<div class="answer-options">' + q.options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(\'' + o + '\', \'' + q.answer + '\', this)" style="font-size:20px">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderSentenceBuild(card, q) {
  var html = '<div class="question-text">Put the words in order to make a sentence!</div>';
  html += '<div id="sentence-result" style="min-height:48px;padding:12px;background:rgba(255,255,255,0.05);border-radius:12px;margin:12px 0;font-size:22px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:center"></div>';
  html += '<div id="sentence-bank" style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:12px 0">';
  q.words.forEach(function(w) {
    html += '<button class="answer-btn" style="font-size:20px;cursor:grab" onclick="sentenceWordClick(this, \'' + escapeQuote(w) + '\')">' + w + '</button>';
  });
  html += '</div>';
  html += '<button class="submit-btn mt-2" onclick="checkSentenceOrder()">Check \u2713</button>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;

  // Store correct answer on the card for checking
  card.dataset.sentenceAnswer = q.answer;
}

// ===================== P3 RENDERERS =====================

function renderComprehensionMCQ(card, q) {
  var html = '<div style="font-size:16px;font-weight:700;color:var(--gold);margin-bottom:8px">\uD83D\uDCD6 ' + q.title + '</div>';
  html += '<div class="story-prompt" style="font-size:16px;line-height:1.6;max-height:140px;overflow-y:auto;text-align:left;padding:12px 16px">' + q.text + '</div>';
  html += '<div class="question-text" style="font-size:18px;margin-top:16px">' + q.question + '</div>';
  html += '<div class="answer-options" style="flex-direction:column">' + q.options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(\'' + escapeQuote(o) + '\', \'' + escapeQuote(q.answer) + '\', this)" style="font-size:16px;text-align:left;width:100%">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderPoetryRhyme(card, q) {
  var html = '<div class="question-text">Which word rhymes with <strong style="color:var(--gold)">' + q.targetWord + '</strong>?</div>';
  html += '<div style="font-size:48px;margin:12px 0">\uD83C\uDFB5</div>';
  html += '<div class="answer-options">' + q.options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(\'' + o + '\', \'' + q.answer + '\', this)" style="font-size:22px">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderPoetySyllable(card, q) {
  var html = '<div class="question-text">How many syllables (beats) does this word have?</div>';
  html += '<div style="font-size:36px;margin:16px 0;font-family:var(--font-display);color:var(--sky)">' + q.word + '</div>';
  html += '<div style="font-size:14px;color:var(--text-secondary);margin-bottom:12px">\uD83D\uDC4F Clap it out!</div>';
  html += '<div class="answer-options">' + q.options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(' + o + ', ' + q.answer + ', this)" style="font-size:24px">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderPoetryCouplet(card, q) {
  var html = '<div class="question-text">Pick a word to complete the rhyme!</div>';
  html += '<div style="font-size:20px;margin:16px 0;font-style:italic;color:var(--lavender)">';
  html += 'Line 1 ends with: <strong style="color:var(--gold)">' + q.line1End + '</strong>';
  html += '</div>';
  html += '<div style="font-size:18px;color:var(--text-secondary);margin-bottom:12px">Line 2 should end with...</div>';
  html += '<div class="answer-options">' + q.options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(\'' + o + '\', \'' + q.answer + '\', this)" style="font-size:22px">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

// ===================== P4 RENDERERS =====================

function renderStoryWrite(card, q) {
  var html = '<div class="question-text">\u270D\uFE0F Write a story!</div>';
  html += '<div class="story-prompt" style="font-size:18px;margin:12px 0">' + q.prompt + '</div>';
  html += '<textarea id="story-textarea" class="text-input" style="width:100%;height:140px;font-size:16px;line-height:1.6;resize:none;font-family:var(--font-hand)" placeholder="Continue the story..."></textarea>';
  html += '<div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;justify-content:center" id="word-suggestions">';
  var suggestions = shuffle(WORD_BANKS.adjectives.concat(WORD_BANKS.nouns)).slice(0, 6);
  suggestions.forEach(function(w) {
    html += '<button style="font-size:13px;padding:4px 10px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:20px;color:var(--text-secondary);cursor:pointer" onclick="insertWordSuggestion(\'' + w + '\')">' + w + '</button>';
  });
  html += '</div>';
  html += '<button class="submit-btn mt-2" onclick="submitStory()">Done \u2713</button>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
  setTimeout(function() { var el = document.getElementById('story-textarea'); if (el) el.focus(); }, 100);
}

function renderParagraphWrite(card, q) {
  var html = '<div class="question-text">\uD83D\uDCDD ' + q.topic + '</div>';
  html += '<div style="font-size:16px;color:var(--text-secondary);margin:8px 0">Start with: <em>"' + q.starter + '..."</em></div>';
  html += '<div style="display:flex;flex-direction:column;gap:4px;margin:12px 0">';
  q.hints.forEach(function(h) {
    html += '<div style="font-size:14px;color:var(--mint)">\uD83D\uDCA1 ' + h + '</div>';
  });
  html += '</div>';
  html += '<textarea id="story-textarea" class="text-input" style="width:100%;height:120px;font-size:16px;line-height:1.6;resize:none;font-family:var(--font-hand)" placeholder="' + q.starter + '...">' + q.starter + ' </textarea>';
  html += '<button class="submit-btn mt-2" onclick="submitStory()">Done \u2713</button>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
  setTimeout(function() {
    var el = document.getElementById('story-textarea');
    if (el) { el.focus(); el.setSelectionRange(el.value.length, el.value.length); }
  }, 100);
}

// ===================== WORD HELPER FUNCTIONS =====================

function escapeQuote(str) {
  return String(str).replace(/'/g, "\\'");
}

function sentenceWordClick(btn, word) {
  var result = document.getElementById('sentence-result');
  if (!result) return;

  if (btn.parentElement.id === 'sentence-bank') {
    // Move from bank to result
    btn.remove();
    var tag = document.createElement('button');
    tag.className = 'answer-btn';
    tag.style.cssText = 'font-size:20px;cursor:pointer';
    tag.textContent = word;
    tag.setAttribute('onclick', "sentenceWordReturn(this, '" + escapeQuote(word) + "')");
    result.appendChild(tag);
  }
}

function sentenceWordReturn(btn, word) {
  var bank = document.getElementById('sentence-bank');
  if (!bank) return;
  btn.remove();
  var tag = document.createElement('button');
  tag.className = 'answer-btn';
  tag.style.cssText = 'font-size:20px;cursor:grab';
  tag.textContent = word;
  tag.setAttribute('onclick', "sentenceWordClick(this, '" + escapeQuote(word) + "')");
  bank.appendChild(tag);
}

function checkSentenceOrder() {
  var result = document.getElementById('sentence-result');
  var card = document.getElementById('question-card');
  if (!result || !card) return;
  var words = [];
  result.querySelectorAll('.answer-btn').forEach(function(b) { words.push(b.textContent); });
  var built = words.join(' ') + '.';
  var expected = card.dataset.sentenceAnswer;
  if (built.toLowerCase().replace(/\s+/g, ' ') === expected.toLowerCase().replace(/\s+/g, ' ')) {
    handleCorrect();
  } else {
    handleWrong(expected);
  }
}

function insertWordSuggestion(word) {
  var textarea = document.getElementById('story-textarea');
  if (!textarea) return;
  var pos = textarea.selectionStart;
  var before = textarea.value.substring(0, pos);
  var after = textarea.value.substring(pos);
  textarea.value = before + word + ' ' + after;
  textarea.focus();
  textarea.setSelectionRange(pos + word.length + 1, pos + word.length + 1);
}

function submitStory() {
  var textarea = document.getElementById('story-textarea');
  if (!textarea) return;
  var text = textarea.value.trim();
  if (text.length < 10) {
    textarea.style.borderColor = 'var(--error)';
    textarea.style.animation = 'shake-wrong 0.5s';
    textarea.setAttribute('placeholder', 'Write a bit more! At least 2 sentences.');
    return;
  }
  // Store the story
  state.stories = state.stories || [];
  state.stories.push({ text: text, date: Date.now(), skill: currentGame.skillId });
  handleCorrect(true);
}

// ===================== ENHANCED RENDERERS =====================

// Override phonics family to use animated letter tiles
var _origRenderPhonicsFamily = renderPhonicsFamily;
renderPhonicsFamily = function(card, q) {
  var html = '<div class="question-text">Which word belongs to the <strong>-' + q.family + '</strong> family?</div>';
  html += '<div style="font-size:48px;margin:12px 0;letter-spacing:4px;color:var(--gold)">-' + q.family + '</div>';

  // Animated letter tiles for each option
  html += '<div class="answer-options">' + q.options.map(function(o, idx) {
    var tiles = '';
    for (var i = 0; i < o.length; i++) {
      var isFamily = i >= o.length - q.family.length;
      tiles += '<span class="letter-tile' + (isFamily ? ' family-highlight' : '') + '" style="display:inline-block;padding:4px 8px;margin:2px;background:' + (isFamily ? 'rgba(255,215,0,0.2)' : 'rgba(255,255,255,0.1)') + ';border-radius:6px;font-size:22px;font-weight:700;letter-spacing:1px;animation:pop-in 0.3s ease-out ' + (idx * 0.1 + i * 0.05) + 's both">' + o[i] + '</span>';
    }
    return '<button class="answer-btn" onclick="checkAnswer(\'' + o + '\', \'' + q.answer + '\', this)" style="font-size:22px;letter-spacing:0;display:flex;align-items:center;justify-content:center;gap:0">' + tiles + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
};

// Override sentence build to support touch drag reordering
var _origRenderSentenceBuild = renderSentenceBuild;
renderSentenceBuild = function(card, q) {
  var html = '<div class="question-text">Put the words in order to make a sentence!</div>';

  // Result area with drop zone styling
  html += '<div id="sentence-result" style="min-height:52px;padding:12px;background:rgba(255,255,255,0.05);border-radius:12px;margin:12px 0;font-size:20px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:center;border:2px dashed rgba(255,255,255,0.15);transition:border-color 0.3s">';
  html += '<span style="color:var(--text-dim);font-size:14px" id="sentence-placeholder">Tap words below to build your sentence</span>';
  html += '</div>';

  // Word bank with touch-friendly sizing
  html += '<div id="sentence-bank" style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:12px 0">';
  q.words.forEach(function(w, idx) {
    html += '<button class="answer-btn word-tile" style="font-size:20px;cursor:grab;min-width:60px;animation:pop-in 0.3s ease-out ' + (idx * 0.08) + 's both" onclick="sentenceWordClick(this, \'' + escapeQuote(w) + '\')">' + w + '</button>';
  });
  html += '</div>';

  html += '<div style="display:flex;gap:8px;justify-content:center">';
  html += '<button class="submit-btn" onclick="checkSentenceOrder()">Check \u2713</button>';
  html += '<button class="answer-btn" style="font-size:14px;padding:8px 14px;color:var(--coral)" onclick="resetSentenceBuilder()">Reset</button>';
  html += '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
  card.dataset.sentenceAnswer = q.answer;
};

function resetSentenceBuilder() {
  // Move all words back to bank
  var result = document.getElementById('sentence-result');
  var bank = document.getElementById('sentence-bank');
  if (!result || !bank) return;

  var btns = Array.from(result.querySelectorAll('.answer-btn'));
  btns.forEach(function(btn) {
    btn.remove();
    var word = btn.textContent;
    var newBtn = document.createElement('button');
    newBtn.className = 'answer-btn word-tile';
    newBtn.style.cssText = 'font-size:20px;cursor:grab;min-width:60px';
    newBtn.textContent = word;
    newBtn.setAttribute('onclick', "sentenceWordClick(this, '" + escapeQuote(word) + "')");
    bank.appendChild(newBtn);
  });

  // Restore placeholder
  var placeholder = document.getElementById('sentence-placeholder');
  if (!placeholder) {
    var span = document.createElement('span');
    span.style.cssText = 'color:var(--text-dim);font-size:14px';
    span.id = 'sentence-placeholder';
    span.textContent = 'Tap words below to build your sentence';
    result.appendChild(span);
  }
}

// Override grammar MCQ to highlight parts of speech with colours
var _origRenderGrammarMCQ = renderGrammarMCQ;
renderGrammarMCQ = function(card, q) {
  var html = '<div class="question-text">' + q.instruction + '</div>';

  // Parse sentence for POS colouring based on grammar type
  var styledSentence = q.sentence;
  if (q.grammarType && q.grammarType.indexOf('identify') >= 0 && q.answer) {
    // Bold the answer word in the sentence for visual emphasis after answer
    styledSentence = q.sentence.replace(new RegExp('\\b' + q.answer + '\\b', 'i'), '<u>' + q.answer + '</u>');
  }

  html += '<div class="story-prompt" style="font-size:20px;margin:16px 0">' + styledSentence + '</div>';

  // Colour-coded legend
  html += '<div style="display:flex;gap:12px;justify-content:center;margin:8px 0;font-size:12px">';
  html += '<span style="color:#64B5F6">\u25CF Noun</span>';
  html += '<span style="color:#EF5350">\u25CF Verb</span>';
  html += '<span style="color:#81C784">\u25CF Adjective</span>';
  html += '</div>';

  html += '<div class="answer-options">' + q.options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(\'' + o + '\', \'' + q.answer + '\', this)" style="font-size:20px">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
};

// Enhanced sight word flash — bigger, more dramatic reveal
var _origRenderSightFlash = renderSightFlash;
renderSightFlash = function(card, q) {
  var html = '<div class="question-text">Remember this word!</div>';
  html += '<div id="flash-word" style="font-size:56px;margin:20px 0;font-family:var(--font-display);color:var(--gold);transition:all 0.5s;text-shadow:0 0 20px rgba(255,215,0,0.3)">' + q.targetWord + '</div>';
  html += '<div id="flash-countdown" style="font-size:14px;color:var(--text-dim)">Memorize it...</div>';
  html += '<div id="flash-options" style="display:none">';
  html += '<div class="question-text" style="font-size:20px;animation:pop-in 0.4s ease-out">Which word did you see?</div>';
  html += '<div class="answer-options">' + q.options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(\'' + o + '\', \'' + q.answer + '\', this)" style="font-size:24px">' + o + '</button>';
  }).join('') + '</div>';
  html += '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;

  // Countdown: 3 seconds
  var countdown = document.getElementById('flash-countdown');
  var timeLeft = 3;
  var timer = setInterval(function() {
    timeLeft--;
    if (countdown) countdown.textContent = timeLeft + '...';
    if (timeLeft <= 0) {
      clearInterval(timer);
      var wordEl = document.getElementById('flash-word');
      if (wordEl) {
        wordEl.style.opacity = '0';
        wordEl.style.transform = 'scale(0.5)';
      }
      setTimeout(function() {
        if (wordEl) wordEl.style.display = 'none';
        if (countdown) countdown.style.display = 'none';
        var optEl = document.getElementById('flash-options');
        if (optEl) optEl.style.display = 'block';
      }, 400);
    }
  }, 1000);
};

// --- src/stem/science-gen.js ---
// ============================================================
//  SCIENCE GENERATORS — Question generators for 5 science skills
// ============================================================

function generateScienceQuestion(skillId) {
  var diff = getSkillDifficulty(skillId);
  switch (skillId) {
    case 'living':   return genLiving(diff);
    case 'material': return genMaterial(diff);
    case 'forces':   return genForces(diff);
    case 'earth':    return genEarth(diff);
    case 'body':     return genBody(diff);
    default:         return null;
  }
}

// ===================== SCIENCE DATA =====================

var SCIENCE_LIVING = [
  { q:'Which of these is a living thing?', options:['Tree','Rock','Water','Cloud'], answer:'Tree', hint:'Living things grow, eat, and reproduce.' },
  { q:'What do plants need to grow?', options:['Sunlight, water, and soil','Only water','Only sunlight','Rocks and sand'], answer:'Sunlight, water, and soil', hint:'Plants need three main things to grow.' },
  { q:'Which animal lives in water?', options:['Fish','Cat','Eagle','Rabbit'], answer:'Fish', hint:'Think about which animal has gills and fins.' },
  { q:'What is a habitat?', options:['A place where animals and plants live','A type of food','A kind of weather','A type of rock'], answer:'A place where animals and plants live', hint:'Habitats provide food, water, and shelter.' },
  { q:'Which part of a plant takes in water?', options:['Roots','Leaves','Flower','Stem'], answer:'Roots', hint:'This part grows underground.' },
  { q:'What do animals need to survive?', options:['Food, water, and shelter','Only food','Only water','Only shelter'], answer:'Food, water, and shelter', hint:'Animals have three basic needs.' },
  { q:'Which is NOT a living thing?', options:['A stone','A tree','A dog','A flower'], answer:'A stone', hint:'Living things grow and need food.' },
  { q:'What is the life cycle order for a butterfly?', options:['Egg, caterpillar, pupa, butterfly','Egg, butterfly, caterpillar, pupa','Butterfly, egg, pupa, caterpillar','Caterpillar, egg, butterfly, pupa'], answer:'Egg, caterpillar, pupa, butterfly', hint:'It starts as an egg and ends with wings!' },
  { q:'Which animal is a mammal?', options:['Dog','Frog','Fish','Lizard'], answer:'Dog', hint:'Mammals have fur and feed their babies milk.' },
  { q:'Where does a desert animal get water?', options:['From the food it eats','From the ocean','From snow','From lakes'], answer:'From the food it eats', hint:'Deserts have very little water, so animals adapt!' }
];

var SCIENCE_MATERIAL = [
  { q:'Which is a solid?', options:['Ice cube','Juice','Steam','Air'], answer:'Ice cube', hint:'Solids have a fixed shape.' },
  { q:'Which is a liquid?', options:['Water','Rock','Paper','Air'], answer:'Water', hint:'Liquids flow and take the shape of their container.' },
  { q:'What happens when you heat ice?', options:['It melts into water','It gets harder','It stays the same','It disappears'], answer:'It melts into water', hint:'Heat makes ice change state.' },
  { q:'Which material is waterproof?', options:['Plastic','Paper','Cloth','Cardboard'], answer:'Plastic', hint:'Waterproof means water cannot pass through it.' },
  { q:'Which material is magnetic?', options:['Iron nail','Wooden stick','Rubber band','Glass marble'], answer:'Iron nail', hint:'Only metals made of iron, nickel, or cobalt are magnetic.' },
  { q:'What state of matter is steam?', options:['Gas','Liquid','Solid','Plasma'], answer:'Gas', hint:'When water boils, it turns into a gas called steam.' },
  { q:'Which material is transparent?', options:['Glass','Wood','Metal','Stone'], answer:'Glass', hint:'Transparent means you can see through it.' },
  { q:'What happens when water is cooled to 0\u00B0C?', options:['It freezes into ice','It boils','It evaporates','Nothing happens'], answer:'It freezes into ice', hint:'0\u00B0C is the freezing point of water.' },
  { q:'Which material is flexible?', options:['Rubber','Glass','Brick','Stone'], answer:'Rubber', hint:'Flexible means it can bend without breaking.' },
  { q:'How can you separate sand from water?', options:['By filtering','By freezing','By heating','By shaking'], answer:'By filtering', hint:'A filter lets water pass through but traps the sand.' }
];

var SCIENCE_FORCES = [
  { q:'What force pulls things down to the ground?', options:['Gravity','Magnetism','Friction','Wind'], answer:'Gravity', hint:'This invisible force keeps us on Earth.' },
  { q:'What happens when you push a toy car?', options:['It moves forward','It flies up','It shrinks','It changes colour'], answer:'It moves forward', hint:'Pushing is a force that makes things move.' },
  { q:'What does a magnet attract?', options:['Iron','Wood','Plastic','Paper'], answer:'Iron', hint:'Magnets attract certain metals.' },
  { q:'What is friction?', options:['A force that slows things down','A force that speeds things up','A type of energy','A kind of material'], answer:'A force that slows things down', hint:'Friction happens when two surfaces rub together.' },
  { q:'Which uses electrical energy?', options:['A light bulb','A bicycle','A kite','A book'], answer:'A light bulb', hint:'It needs electricity to work.' },
  { q:'What energy comes from the sun?', options:['Light and heat','Sound','Magnetism','Gravity'], answer:'Light and heat', hint:'The sun is our biggest source of energy.' },
  { q:'Which surface has the most friction?', options:['Rough sandpaper','Smooth ice','Polished marble','Wet glass'], answer:'Rough sandpaper', hint:'Rougher surfaces create more friction.' },
  { q:'What type of energy does a drum make?', options:['Sound energy','Light energy','Heat energy','Magnetic energy'], answer:'Sound energy', hint:'When you hit a drum, it vibrates and makes noise.' },
  { q:'Which is a pulling force?', options:['A dog pulling a leash','Kicking a ball','Blowing a whistle','Clapping hands'], answer:'A dog pulling a leash', hint:'Pulling means moving something towards you.' },
  { q:'What do batteries store?', options:['Electrical energy','Light energy','Sound energy','Water'], answer:'Electrical energy', hint:'Batteries power things like torches and toys.' }
];

var SCIENCE_EARTH = [
  { q:'What is the water cycle?', options:['Water moving between land, sea, and air','Water flowing in rivers','Rain falling from clouds','Ice melting in the sun'], answer:'Water moving between land, sea, and air', hint:'Water constantly moves in a cycle: evaporation, condensation, precipitation.' },
  { q:'What causes rain?', options:['Clouds release water droplets','The sun gets too hot','Wind pushes water up','The moon pulls water'], answer:'Clouds release water droplets', hint:'When clouds get heavy with water, it falls as rain.' },
  { q:'Which is a natural resource?', options:['Water','Plastic','Paper','Glass'], answer:'Water', hint:'Natural resources come from nature, not from factories.' },
  { q:'What is the closest star to Earth?', options:['The Sun','The Moon','Mars','A satellite'], answer:'The Sun', hint:'This star gives us light and warmth every day.' },
  { q:'What causes day and night?', options:['Earth spinning on its axis','The Moon moving','The Sun moving around Earth','Clouds blocking the Sun'], answer:'Earth spinning on its axis', hint:'Earth rotates once every 24 hours.' },
  { q:'Which weather instrument measures temperature?', options:['Thermometer','Rain gauge','Wind vane','Barometer'], answer:'Thermometer', hint:'This instrument has a temperature scale.' },
  { q:'What type of rock is formed from a volcano?', options:['Igneous rock','Sedimentary rock','Metamorphic rock','Crystal rock'], answer:'Igneous rock', hint:'Lava cools down and hardens into this type of rock.' },
  { q:'How can we reduce waste?', options:['Reduce, reuse, recycle','Throw everything away','Burn everything','Bury everything'], answer:'Reduce, reuse, recycle', hint:'The three Rs help protect our environment.' },
  { q:'What is the largest ocean on Earth?', options:['Pacific Ocean','Atlantic Ocean','Indian Ocean','Arctic Ocean'], answer:'Pacific Ocean', hint:'This ocean lies between Asia and the Americas.' },
  { q:'What season comes after winter?', options:['Spring','Summer','Autumn','Winter again'], answer:'Spring', hint:'Flowers start blooming in this season.' }
];

var SCIENCE_BODY = [
  { q:'What organ pumps blood around your body?', options:['Heart','Brain','Lungs','Stomach'], answer:'Heart', hint:'This organ beats about 100,000 times a day!' },
  { q:'What protects your brain?', options:['Skull','Ribs','Skin','Muscles'], answer:'Skull', hint:'This bone surrounds your brain like a helmet.' },
  { q:'What do lungs help us do?', options:['Breathe','Digest food','Move our legs','See things'], answer:'Breathe', hint:'Lungs take in oxygen from the air.' },
  { q:'Which food group helps build strong bones?', options:['Dairy (milk, cheese)','Candy','Chips','Soda'], answer:'Dairy (milk, cheese)', hint:'Calcium makes bones strong, and this food has lots of it.' },
  { q:'How many senses do humans have?', options:['5','3','7','10'], answer:'5', hint:'Sight, hearing, smell, taste, and touch.' },
  { q:'What should you do to stay healthy?', options:['Exercise, eat well, and sleep enough','Only eat candy','Stay up all night','Never go outside'], answer:'Exercise, eat well, and sleep enough', hint:'A healthy lifestyle has three main parts.' },
  { q:'What does the stomach do?', options:['Breaks down food','Pumps blood','Helps you breathe','Helps you think'], answer:'Breaks down food', hint:'Food goes here after you swallow it.' },
  { q:'Which part of the body helps you move?', options:['Muscles','Hair','Nails','Earlobes'], answer:'Muscles', hint:'These work with your bones to help you move.' },
  { q:'Why is sleep important?', options:['It helps your body rest and grow','It wastes time','It makes you hungry','It has no purpose'], answer:'It helps your body rest and grow', hint:'Your body repairs itself while you sleep.' },
  { q:'What carries oxygen in your blood?', options:['Red blood cells','White blood cells','Platelets','Plasma'], answer:'Red blood cells', hint:'These cells are red because of a protein called haemoglobin.' }
];

var SCIENCE_BANKS = {
  living: SCIENCE_LIVING,
  material: SCIENCE_MATERIAL,
  forces: SCIENCE_FORCES,
  earth: SCIENCE_EARTH,
  body: SCIENCE_BODY
};

// ===================== EXPERIMENT QUESTIONS =====================

var SCIENCE_EXPERIMENTS = [
  { skill:'material', scenario:'You put an ice cube on a plate in the sun.', q:'What will happen after 30 minutes?', options:['The ice will melt into water','The ice will get bigger','The ice will turn into gas','Nothing will happen'], answer:'The ice will melt into water', hint:'Heat from the sun changes the state of ice.' },
  { skill:'material', scenario:'You mix sand into a glass of water and stir.', q:'What happens when you stop stirring?', options:['The sand sinks to the bottom','The sand disappears','The water turns into sand','The sand floats'], answer:'The sand sinks to the bottom', hint:'Sand is heavier than water and does not dissolve.' },
  { skill:'forces', scenario:'You slide a toy car on a rough carpet and then on a smooth tile floor.', q:'Where does the car travel farther?', options:['On the smooth tile floor','On the rough carpet','The same on both','Neither \u2014 the car stops immediately'], answer:'On the smooth tile floor', hint:'More friction on carpet slows the car down.' },
  { skill:'forces', scenario:'You hold a ball in the air and let go.', q:'What will happen?', options:['The ball falls to the ground','The ball floats in the air','The ball flies upward','The ball stays still'], answer:'The ball falls to the ground', hint:'Gravity pulls everything toward the ground.' },
  { skill:'living', scenario:'You water one plant but not the other. Both get the same sunlight.', q:'After 2 weeks, what happens?', options:['The watered plant grows; the dry plant wilts','Both plants grow the same','The dry plant grows better','Both plants die'], answer:'The watered plant grows; the dry plant wilts', hint:'Plants need water to survive and grow.' },
  { skill:'living', scenario:'You put a caterpillar in a jar with leaves and air holes.', q:'What might happen after a few weeks?', options:['It forms a chrysalis and becomes a butterfly','It stays a caterpillar forever','It turns into a fish','It disappears'], answer:'It forms a chrysalis and becomes a butterfly', hint:'This is part of the butterfly life cycle!' },
  { skill:'earth', scenario:'You leave a shallow dish of water on a sunny windowsill.', q:'What happens to the water after a few days?', options:['The water evaporates','The water freezes','The water turns green','Nothing happens'], answer:'The water evaporates', hint:'Heat causes water to turn into water vapour.' },
  { skill:'earth', scenario:'You breathe on a cold mirror.', q:'Why does the mirror fog up?', options:['Water vapour in your breath condenses on the cold surface','The mirror is sweating','Magic','The air is dirty'], answer:'Water vapour in your breath condenses on the cold surface', hint:'Cold surfaces cause water vapour to become liquid droplets.' },
  { skill:'body', scenario:'You run around the playground for 5 minutes.', q:'What happens to your heart rate?', options:['It beats faster','It beats slower','It stops','Nothing changes'], answer:'It beats faster', hint:'Exercise makes your heart pump more blood to your muscles.' },
  { skill:'body', scenario:'You eat a big lunch.', q:'What happens in your stomach?', options:['Acids and muscles break down the food','The food stays whole','The food turns into bones','The food goes to your lungs'], answer:'Acids and muscles break down the food', hint:'Your stomach is like a mixer that breaks food into tiny pieces.' }
];

// ===================== SORT QUESTIONS =====================

var SCIENCE_SORTS = [
  { skill:'material', text:'Sort these into Solids and Liquids', categories:['Solid','Liquid'], items:[
    {name:'Ice cube',category:'Solid'},{name:'Water',category:'Liquid'},{name:'Rock',category:'Solid'},{name:'Juice',category:'Liquid'},{name:'Brick',category:'Solid'},{name:'Milk',category:'Liquid'}
  ], hint:'Solids keep their shape. Liquids flow.' },
  { skill:'living', text:'Sort these into Living and Non-Living', categories:['Living','Non-Living'], items:[
    {name:'Dog',category:'Living'},{name:'Rock',category:'Non-Living'},{name:'Tree',category:'Living'},{name:'Chair',category:'Non-Living'},{name:'Fish',category:'Living'},{name:'Book',category:'Non-Living'}
  ], hint:'Living things grow, breathe, and need food.' },
  { skill:'material', text:'Sort these into Magnetic and Not Magnetic', categories:['Magnetic','NotMagnetic'], items:[
    {name:'Iron nail',category:'Magnetic'},{name:'Wooden stick',category:'NotMagnetic'},{name:'Steel paper clip',category:'Magnetic'},{name:'Plastic ruler',category:'NotMagnetic'},{name:'Coin',category:'Magnetic'},{name:'Rubber band',category:'NotMagnetic'}
  ], hint:'Only iron, steel, nickel, and cobalt are magnetic.' },
  { skill:'living', text:'Sort these animals by where they live', categories:['Land','Water'], items:[
    {name:'Dog',category:'Land'},{name:'Fish',category:'Water'},{name:'Cat',category:'Land'},{name:'Whale',category:'Water'},{name:'Horse',category:'Land'},{name:'Dolphin',category:'Water'}
  ], hint:'Think about whether the animal has legs or fins.' }
];

// ===================== SIMULATION QUESTIONS =====================

var SCIENCE_SIM_QUESTIONS = {
  earth: [
    { type:'sim-water-cycle', text:'After seeing the water cycle, what comes after evaporation?', options:['Condensation','Precipitation','Collection','Evaporation again'], answer:'Condensation', hint:'Water vapour rises and cools into clouds.' },
    { type:'sim-water-cycle', text:'What powers the water cycle?', options:['The Sun','The Moon','Wind','Gravity only'], answer:'The Sun', hint:'The Sun heats water and drives evaporation.' }
  ],
  body: [
    { type:'sim-body-explorer', text:'Which organ pumps blood?', options:['Heart','Brain','Lungs','Stomach'], answer:'Heart', hint:'Explore the organs to find out!' },
    { type:'sim-body-explorer', text:'What do the lungs do?', options:['Help you breathe','Pump blood','Digest food','Control thinking'], answer:'Help you breathe', hint:'Tap the lungs to learn their function.' }
  ],
  forces: [
    { type:'sim-magnet', text:'What happens when two North poles face each other?', options:['They repel','They attract','Nothing happens','They stick together'], answer:'They repel', hint:'Try flipping the magnets to see!' },
    { type:'sim-magnet', text:'Which poles attract each other?', options:['North and South','North and North','South and South','East and West'], answer:'North and South', hint:'Opposites attract!' },
    { type:'sim-circuit', text:'What must happen for the bulb to light up?', options:['The switch must be closed','The switch must be open','Remove the battery','Add more wire'], answer:'The switch must be closed', hint:'A complete circuit is needed for electricity to flow.' }
  ],
  living: [
    { type:'sim-plant-growth', text:'What do plants need to grow?', options:['Sunlight, water, and soil','Only water','Only sunlight','Rocks and sand'], answer:'Sunlight, water, and soil', hint:'Toggle the sun and water to see what happens!' },
    { type:'sim-plant-growth', text:'What happens if a plant has no sunlight?', options:['It cannot make food and will wilt','It grows faster','It turns blue','Nothing happens'], answer:'It cannot make food and will wilt', hint:'Plants use sunlight to make food through photosynthesis.' }
  ]
};

// ===================== EXTRA MCQ QUESTIONS =====================

var SCIENCE_LIVING_EXTRA = [
  { q:'What is photosynthesis?', options:['How plants make food using sunlight','How animals breathe','How rocks form','How water flows'], answer:'How plants make food using sunlight', hint:'Plants use sunlight, water, and carbon dioxide to make food.' },
  { q:'Which animal lays eggs?', options:['Chicken','Dog','Cat','Cow'], answer:'Chicken', hint:'Birds and reptiles lay eggs.' },
  { q:'What do herbivores eat?', options:['Only plants','Only meat','Both plants and meat','Only fish'], answer:'Only plants', hint:'Herbivores have flat teeth for grinding plants.' },
  { q:'Which is an insect?', options:['Ant','Spider','Worm','Snail'], answer:'Ant', hint:'Insects have 6 legs and 3 body parts.' },
  { q:'What do seeds need to germinate?', options:['Water, warmth, and air','Only sunlight','Only soil','Only darkness'], answer:'Water, warmth, and air', hint:'Seeds need moisture and warmth to start growing.' }
];

var SCIENCE_MATERIAL_EXTRA = [
  { q:'What happens when you mix oil and water?', options:['They separate into layers','They mix completely','The oil disappears','The water evaporates'], answer:'They separate into layers', hint:'Oil is less dense than water and floats on top.' },
  { q:'Which change is reversible?', options:['Melting ice','Burning paper','Cooking an egg','Baking a cake'], answer:'Melting ice', hint:'Reversible changes can be undone. Can you re-freeze water?' },
  { q:'What is an insulator?', options:['A material that does not conduct heat well','A material that conducts electricity','A type of metal','A liquid'], answer:'A material that does not conduct heat well', hint:'Insulators keep heat in or out, like a woolly jumper.' },
  { q:'Which material is a good conductor of heat?', options:['Metal spoon','Wooden spoon','Plastic spoon','Rubber glove'], answer:'Metal spoon', hint:'Metals transfer heat quickly.' },
  { q:'What is dissolving?', options:['When a solid mixes into a liquid and seems to disappear','When a liquid freezes','When a gas turns to liquid','When a solid breaks into pieces'], answer:'When a solid mixes into a liquid and seems to disappear', hint:'Sugar dissolves in water but sand does not.' }
];

var SCIENCE_FORCES_EXTRA = [
  { q:'What is air resistance?', options:['A force that slows things moving through air','A force that speeds things up','A type of gravity','A push force'], answer:'A force that slows things moving through air', hint:'Parachutes use air resistance to slow down.' },
  { q:'Which simple machine helps lift heavy things?', options:['A lever','A magnet','A battery','A mirror'], answer:'A lever', hint:'A seesaw is an example of a lever.' },
  { q:'What type of energy does food give us?', options:['Chemical energy','Light energy','Sound energy','Magnetic energy'], answer:'Chemical energy', hint:'Our bodies convert food into energy we can use.' },
  { q:'Which travels fastest?', options:['Light','Sound','A car','A plane'], answer:'Light', hint:'Light travels at about 300,000 km per second!' },
  { q:'What makes a shadow?', options:['An object blocking light','The wind','Gravity','Magnetism'], answer:'An object blocking light', hint:'Shadows form on the opposite side from the light source.' }
];

var SCIENCE_EARTH_EXTRA = [
  { q:'What causes the seasons?', options:['Earth tilts on its axis as it orbits the Sun','The Sun gets hotter and cooler','The Moon changes','The wind changes direction'], answer:'Earth tilts on its axis as it orbits the Sun', hint:'The tilt means different parts of Earth get more or less sunlight.' },
  { q:'What is a fossil?', options:['The preserved remains of ancient life','A type of rock','A kind of crystal','A living organism'], answer:'The preserved remains of ancient life', hint:'Fossils can be bones, shells, or footprints from long ago.' },
  { q:'What is erosion?', options:['When wind or water wears away rock and soil','When volcanoes erupt','When earthquakes happen','When ice forms'], answer:'When wind or water wears away rock and soil', hint:'Rivers erode their banks over time.' },
  { q:'Which is a renewable energy source?', options:['Solar power','Coal','Oil','Natural gas'], answer:'Solar power', hint:'Renewable means it will not run out.' },
  { q:'What is the atmosphere?', options:['The layer of gases around Earth','The ocean floor','The centre of Earth','Space beyond Earth'], answer:'The layer of gases around Earth', hint:'The atmosphere protects us from the Sun\'s harmful rays.' }
];

var SCIENCE_BODY_EXTRA = [
  { q:'What is the largest organ in the body?', options:['Skin','Brain','Heart','Liver'], answer:'Skin', hint:'This organ covers your entire body!' },
  { q:'What does the brain do?', options:['Controls the whole body','Only helps you see','Only helps you breathe','Only helps you move'], answer:'Controls the whole body', hint:'The brain sends messages through nerves to every part of your body.' },
  { q:'How many bones does an adult have?', options:['206','100','500','50'], answer:'206', hint:'Babies have more bones that fuse together as they grow!' },
  { q:'What is the function of white blood cells?', options:['Fight germs and infections','Carry oxygen','Clot blood','Make bones'], answer:'Fight germs and infections', hint:'White blood cells are your body\'s soldiers.' },
  { q:'Why do we need to drink water?', options:['To keep our bodies hydrated and working properly','Only to wash food down','Water has no benefit','Only when we are hot'], answer:'To keep our bodies hydrated and working properly', hint:'Water helps transport nutrients and remove waste.' }
];

// Add extra questions to banks
SCIENCE_LIVING = SCIENCE_LIVING.concat(SCIENCE_LIVING_EXTRA);
SCIENCE_MATERIAL = SCIENCE_MATERIAL.concat(SCIENCE_MATERIAL_EXTRA);
SCIENCE_FORCES = SCIENCE_FORCES.concat(SCIENCE_FORCES_EXTRA);
SCIENCE_EARTH = SCIENCE_EARTH.concat(SCIENCE_EARTH_EXTRA);
SCIENCE_BODY = SCIENCE_BODY.concat(SCIENCE_BODY_EXTRA);

// ===================== GENERATORS =====================

function genLiving(diff)   { return genScienceQ('living', diff); }
function genMaterial(diff)  { return genScienceQ('material', diff); }
function genForces(diff)    { return genScienceQ('forces', diff); }
function genEarth(diff)     { return genScienceQ('earth', diff); }
function genBody(diff)      { return genScienceQ('body', diff); }

function genScienceQ(bank, diff) {
  var r = Math.random();

  // At higher levels, include simulations and experiments
  if (diff.level >= 2 && r < 0.25) {
    // Try simulation
    var sims = SCIENCE_SIM_QUESTIONS[bank];
    if (sims && sims.length > 0) {
      var sim = pick(sims);
      return {
        type: sim.type,
        text: sim.text,
        options: shuffle(sim.options),
        answer: sim.answer,
        hint: sim.hint
      };
    }
  }

  if (diff.level >= 1 && r < 0.35) {
    // Try experiment
    var exps = SCIENCE_EXPERIMENTS.filter(function(e) { return e.skill === bank; });
    if (exps.length > 0) {
      var exp = pick(exps);
      return {
        type: 'science-experiment',
        scenario: exp.scenario,
        text: exp.q,
        options: shuffle(exp.options),
        answer: exp.answer,
        hint: exp.hint
      };
    }
  }

  if (diff.level >= 1 && r < 0.45) {
    // Try sort
    var sorts = SCIENCE_SORTS.filter(function(s) { return s.skill === bank; });
    if (sorts.length > 0) {
      var sort = pick(sorts);
      return {
        type: 'science-sort',
        text: sort.text,
        categories: sort.categories,
        items: shuffle(sort.items),
        answer: '__sort__',
        hint: sort.hint
      };
    }
  }

  // Default: MCQ
  return genScienceMCQ(bank, diff);
}

function genScienceMCQ(bank, diff) {
  var items = SCIENCE_BANKS[bank];
  var item = pick(items);
  return {
    type: 'science-mcq',
    text: item.q,
    options: shuffle(item.options),
    answer: item.answer,
    hint: item.hint
  };
}

// --- src/stem/science-sim.js ---
// ============================================================
//  SCIENCE RENDER — Interactive renderers + simulations
// ============================================================

function renderScienceQuestion(card, q) {
  switch (q.type) {
    case 'science-mcq':        renderScienceMCQ(card, q); return true;
    case 'science-sort':       renderScienceSort(card, q); return true;
    case 'science-experiment': renderScienceExperiment(card, q); return true;
    case 'sim-water-cycle':    renderWaterCycleSim(card, q); return true;
    case 'sim-body-explorer':  renderBodyExplorer(card, q); return true;
    case 'sim-magnet':         renderMagnetSim(card, q); return true;
    case 'sim-plant-growth':   renderPlantGrowthSim(card, q); return true;
    case 'sim-circuit':        renderCircuitSim(card, q); return true;
    default: return false;
  }
}

// ===================== BASIC RENDERERS =====================

function renderScienceMCQ(card, q) {
  var html = '<div style="font-size:36px;margin-bottom:8px">\uD83E\uDD14</div>';
  html += '<div class="question-text" style="font-size:20px">' + q.text + '</div>';
  html += '<div class="answer-options" style="flex-direction:column;margin-top:16px">' + q.options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(\'' + escSci(o) + '\', \'' + escSci(q.answer) + '\', this)" style="font-size:16px;text-align:left;width:100%">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderScienceSort(card, q) {
  var html = '<div class="question-text" style="font-size:20px">' + q.text + '</div>';
  html += '<div style="display:flex;gap:16px;justify-content:center;margin:16px 0">';
  q.categories.forEach(function(cat) {
    html += '<div style="flex:1;min-width:100px">';
    html += '<div style="font-weight:700;font-size:16px;color:var(--gold);margin-bottom:8px;padding:6px;background:rgba(255,255,255,0.05);border-radius:8px">' + cat + '</div>';
    html += '<div class="sort-zone" id="sort-' + cat.replace(/\s/g,'') + '" style="min-height:80px;padding:8px;background:rgba(255,255,255,0.03);border-radius:8px;border:2px dashed rgba(255,255,255,0.1)"></div>';
    html += '</div>';
  });
  html += '</div>';
  html += '<div id="sort-bank" style="display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin:12px 0">';
  q.items.forEach(function(item) {
    html += '<button class="answer-btn" style="font-size:14px;padding:6px 12px" onclick="sciSortClick(this,\'' + escSci(item.name) + '\',\'' + escSci(item.category) + '\')">' + item.name + '</button>';
  });
  html += '</div>';
  html += '<button class="submit-btn mt-2" onclick="checkSciSort()">Check \u2713</button>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
  card.dataset.sortAnswer = JSON.stringify(q.items.map(function(i) { return { n: i.name, c: i.category }; }));
}

function renderScienceExperiment(card, q) {
  var html = '<div style="font-size:36px;margin-bottom:8px">\uD83E\uDDEA</div>';
  html += '<div class="question-text" style="font-size:18px">Experiment:</div>';
  html += '<div class="story-prompt" style="font-size:16px;margin:12px 0;text-align:left">' + q.scenario + '</div>';
  html += '<div class="question-text" style="font-size:18px">' + q.text + '</div>';
  html += '<div class="answer-options" style="flex-direction:column;margin-top:12px">' + q.options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(\'' + escSci(o) + '\', \'' + escSci(q.answer) + '\', this)" style="font-size:16px;text-align:left;width:100%">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

// ===================== SORT HELPERS =====================

function sciSortClick(btn, name, correctCat) {
  // Move between bank and sort zones
  var bank = document.getElementById('sort-bank');
  if (btn.parentElement.id === 'sort-bank') {
    // Move to first available zone — let user place it
    var zones = document.querySelectorAll('.sort-zone');
    if (zones.length > 0) {
      // Cycle through zones on subsequent clicks
      var currentZone = btn.dataset.zone || '';
      var zoneArr = Array.from(zones);
      var nextIdx = 0;
      if (currentZone) {
        var curIdx = zoneArr.findIndex(function(z) { return z.id === currentZone; });
        nextIdx = (curIdx + 1) % zoneArr.length;
      }
      btn.remove();
      var clone = document.createElement('button');
      clone.className = 'answer-btn';
      clone.style.cssText = 'font-size:14px;padding:6px 12px';
      clone.textContent = name;
      clone.dataset.zone = zoneArr[nextIdx].id;
      clone.setAttribute('onclick', "sciSortReturn(this,'" + escSci(name) + "','" + escSci(correctCat) + "')");
      zoneArr[nextIdx].appendChild(clone);
    }
  }
}

function sciSortReturn(btn, name, correctCat) {
  btn.remove();
  var bank = document.getElementById('sort-bank');
  if (bank) {
    var newBtn = document.createElement('button');
    newBtn.className = 'answer-btn';
    newBtn.style.cssText = 'font-size:14px;padding:6px 12px';
    newBtn.textContent = name;
    newBtn.setAttribute('onclick', "sciSortClick(this,'" + escSci(name) + "','" + escSci(correctCat) + "')");
    bank.appendChild(newBtn);
  }
}

function checkSciSort() {
  var card = document.getElementById('question-card');
  var data = JSON.parse(card.dataset.sortAnswer || '[]');
  var allCorrect = true;

  data.forEach(function(item) {
    var zoneId = 'sort-' + item.c.replace(/\s/g,'');
    var zone = document.getElementById(zoneId);
    if (!zone) { allCorrect = false; return; }
    var found = false;
    zone.querySelectorAll('.answer-btn').forEach(function(btn) {
      if (btn.textContent === item.n) found = true;
    });
    if (!found) allCorrect = false;
  });

  if (allCorrect) handleCorrect();
  else handleWrong('Sort all items to the correct group');
}

// ===================== WATER CYCLE SIM =====================

function renderWaterCycleSim(card, q) {
  var html = '<div class="question-text">\uD83C\uDF0A Water Cycle</div>';
  html += '<div style="position:relative;width:100%;max-width:340px;height:240px;margin:12px auto;background:linear-gradient(to bottom, #87CEEB 0%, #87CEEB 50%, #8B6914 50%, #228B22 100%);border-radius:16px;overflow:hidden" id="water-cycle-sim">';

  // Sun
  html += '<div style="position:absolute;top:12px;right:20px;font-size:32px">\u2600\uFE0F</div>';

  // Cloud
  html += '<div id="wc-cloud" style="position:absolute;top:20px;left:40px;font-size:36px;transition:all 0.5s">\u2601\uFE0F</div>';

  // Water body
  html += '<div style="position:absolute;bottom:0;left:0;right:0;height:40px;background:rgba(30,144,255,0.6);border-radius:0 0 16px 16px"></div>';

  // Arrows (hidden initially, shown as stages advance)
  html += '<div id="wc-evap" class="wc-arrow" style="position:absolute;bottom:50px;right:60px;color:#ADD8E6;font-size:24px;opacity:0;transition:opacity 0.5s">\u2B06\uFE0F</div>';
  html += '<div id="wc-cond" class="wc-arrow" style="position:absolute;top:60px;left:70px;color:#9999CC;font-size:20px;opacity:0;transition:opacity 0.5s">\uD83D\uDCA7</div>';
  html += '<div id="wc-rain" class="wc-arrow" style="position:absolute;top:65px;left:50px;color:#4169E1;font-size:20px;opacity:0;transition:opacity 0.5s">\uD83C\uDF27\uFE0F</div>';
  html += '<div id="wc-collect" class="wc-arrow" style="position:absolute;bottom:25px;left:30px;color:#1E90FF;font-size:18px;opacity:0;transition:opacity 0.5s">\u27A1\uFE0F</div>';

  // Labels
  html += '<div id="wc-label" style="position:absolute;bottom:50%;left:50%;transform:translate(-50%,50%);background:rgba(0,0,0,0.7);color:white;padding:6px 14px;border-radius:20px;font-size:14px;font-weight:600;transition:all 0.3s">Tap \u25B6 to start</div>';

  html += '</div>';

  // Stage controls
  html += '<div style="display:flex;gap:8px;justify-content:center;margin:12px 0">';
  html += '<button class="answer-btn" style="font-size:14px" onclick="wcAdvance()" id="wc-next-btn">\u25B6 Next Stage</button>';
  html += '</div>';

  // Stage counter
  html += '<div id="wc-stage-info" style="font-size:14px;color:var(--text-secondary);margin:8px 0">Stage 0 of 4</div>';

  // Quiz appears after all stages shown
  html += '<div id="wc-quiz" style="display:none">';
  html += '<div class="question-text" style="font-size:18px;margin-top:12px">' + q.text + '</div>';
  html += '<div class="answer-options" style="flex-direction:column;margin-top:8px">' + q.options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(\'' + escSci(o) + '\', \'' + escSci(q.answer) + '\', this)" style="font-size:16px;text-align:left;width:100%">' + o + '</button>';
  }).join('') + '</div>';
  html += '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
  card.dataset.wcStage = '0';
}

var WC_STAGES = [
  { id: 'wc-evap', label: '1. Evaporation \u2014 Sun heats water, it rises as vapour' },
  { id: 'wc-cond', label: '2. Condensation \u2014 Vapour cools and forms clouds' },
  { id: 'wc-rain', label: '3. Precipitation \u2014 Water falls as rain or snow' },
  { id: 'wc-collect', label: '4. Collection \u2014 Water gathers in rivers, lakes, oceans' }
];

function wcAdvance() {
  var card = document.getElementById('question-card');
  var stage = parseInt(card.dataset.wcStage || '0');

  if (stage < WC_STAGES.length) {
    var s = WC_STAGES[stage];
    var el = document.getElementById(s.id);
    if (el) el.style.opacity = '1';
    var label = document.getElementById('wc-label');
    if (label) label.textContent = s.label;
    stage++;
    card.dataset.wcStage = String(stage);
    var info = document.getElementById('wc-stage-info');
    if (info) info.textContent = 'Stage ' + stage + ' of 4';

    if (stage >= WC_STAGES.length) {
      var btn = document.getElementById('wc-next-btn');
      if (btn) btn.style.display = 'none';
      var quiz = document.getElementById('wc-quiz');
      if (quiz) quiz.style.display = 'block';
      if (info) info.textContent = 'Now answer the question!';
    }
  }
}

// ===================== HUMAN BODY EXPLORER =====================

function renderBodyExplorer(card, q) {
  var html = '<div class="question-text">\uD83E\uDEC0 Body Explorer</div>';
  html += '<div style="position:relative;width:180px;height:260px;margin:12px auto">';

  // Simple body outline using positioned emoji organs
  html += '<div style="position:absolute;top:0;left:50%;transform:translateX(-50%);font-size:32px">\uD83D\uDDE3\uFE0F</div>'; // head

  var organs = [
    { id: 'brain',   emoji: '\uD83E\uDDE0', top: 5,   left: 72, label: 'Brain', desc: 'Controls thinking, memory, and body functions' },
    { id: 'lungs',   emoji: '\uD83E\uDEC1', top: 70,  left: 30, label: 'Lungs', desc: 'Breathe in oxygen, breathe out carbon dioxide' },
    { id: 'heart',   emoji: '\u2764\uFE0F', top: 75,  left: 95, label: 'Heart', desc: 'Pumps blood to every part of your body' },
    { id: 'stomach', emoji: '\uD83E\uDE78', top: 120, left: 60, label: 'Stomach', desc: 'Breaks down food with acids and enzymes' },
    { id: 'bones',   emoji: '\uD83E\uDDB4', top: 170, left: 70, label: 'Bones', desc: 'Support your body and protect organs' }
  ];

  organs.forEach(function(org) {
    html += '<button class="body-organ-btn" style="position:absolute;top:' + org.top + 'px;left:' + org.left + 'px;font-size:28px;background:none;border:2px solid transparent;border-radius:50%;padding:4px;cursor:pointer;transition:all 0.3s" ';
    html += 'onclick="bodyOrganClick(\'' + org.id + '\',\'' + escSci(org.label) + '\',\'' + escSci(org.desc) + '\')" ';
    html += 'title="' + org.label + '">' + org.emoji + '</button>';
  });

  html += '</div>';

  // Info panel
  html += '<div id="body-info" style="min-height:50px;padding:10px;background:rgba(255,255,255,0.05);border-radius:12px;margin:8px 0;font-size:14px;color:var(--text-secondary)">Tap an organ to learn about it!</div>';

  // Count explored organs
  html += '<div id="body-explored" style="font-size:12px;color:var(--text-dim);margin:4px 0">Explored: 0/' + organs.length + '</div>';

  // Quiz (appears after exploring at least 3 organs)
  html += '<div id="body-quiz" style="display:none">';
  html += '<div class="question-text" style="font-size:18px;margin-top:12px">' + q.text + '</div>';
  html += '<div class="answer-options" style="flex-direction:column;margin-top:8px">' + q.options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(\'' + escSci(o) + '\', \'' + escSci(q.answer) + '\', this)" style="font-size:16px;text-align:left;width:100%">' + o + '</button>';
  }).join('') + '</div>';
  html += '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
  card.dataset.bodyExplored = '';
}

function bodyOrganClick(id, label, desc) {
  var info = document.getElementById('body-info');
  if (info) {
    info.innerHTML = '<strong style="color:var(--gold)">' + label + '</strong>: ' + desc;
    info.style.animation = 'none';
    info.offsetHeight;
    info.style.animation = 'pop-in 0.3s ease-out';
  }

  // Highlight the clicked organ
  document.querySelectorAll('.body-organ-btn').forEach(function(b) {
    b.style.borderColor = 'transparent';
  });
  var btns = document.querySelectorAll('.body-organ-btn');
  btns.forEach(function(b) {
    if (b.getAttribute('onclick').indexOf(id) >= 0) {
      b.style.borderColor = 'var(--gold)';
    }
  });

  // Track explored organs
  var card = document.getElementById('question-card');
  var explored = (card.dataset.bodyExplored || '').split(',').filter(function(s) { return s; });
  if (explored.indexOf(id) < 0) explored.push(id);
  card.dataset.bodyExplored = explored.join(',');

  var counter = document.getElementById('body-explored');
  if (counter) counter.textContent = 'Explored: ' + explored.length + '/5';

  // Show quiz after exploring 3+ organs
  if (explored.length >= 3) {
    var quiz = document.getElementById('body-quiz');
    if (quiz) quiz.style.display = 'block';
  }
}

// ===================== MAGNET SIMULATOR =====================

function renderMagnetSim(card, q) {
  var html = '<div class="question-text">\uD83E\uDDF2 Magnet Lab</div>';

  html += '<div style="position:relative;width:100%;max-width:320px;height:120px;margin:16px auto;background:rgba(255,255,255,0.03);border-radius:16px;overflow:hidden" id="magnet-sim">';

  // Left magnet
  html += '<div id="mag-left" style="position:absolute;left:40px;top:35px;width:80px;height:50px;border-radius:8px;display:flex;cursor:pointer;user-select:none" onclick="magFlipLeft()">';
  html += '<div style="flex:1;background:var(--error);border-radius:8px 0 0 8px;display:flex;align-items:center;justify-content:center;font-weight:700;color:white;font-size:20px" id="mag-l-pole">N</div>';
  html += '<div style="flex:1;background:var(--sky);border-radius:0 8px 8px 0;display:flex;align-items:center;justify-content:center;font-weight:700;color:white;font-size:20px">S</div>';
  html += '</div>';

  // Right magnet
  html += '<div id="mag-right" style="position:absolute;right:40px;top:35px;width:80px;height:50px;border-radius:8px;display:flex;cursor:pointer;user-select:none" onclick="magFlipRight()">';
  html += '<div style="flex:1;background:var(--error);border-radius:8px 0 0 8px;display:flex;align-items:center;justify-content:center;font-weight:700;color:white;font-size:20px">N</div>';
  html += '<div style="flex:1;background:var(--sky);border-radius:0 8px 8px 0;display:flex;align-items:center;justify-content:center;font-weight:700;color:white;font-size:20px" id="mag-r-pole">S</div>';
  html += '</div>';

  // Force indicator in the middle
  html += '<div id="mag-force" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:24px;transition:all 0.3s">\u2B05\uFE0F\u27A1\uFE0F</div>';

  html += '</div>';

  html += '<div style="font-size:14px;color:var(--text-secondary);margin:8px 0">Tap a magnet to flip it. Watch what happens!</div>';
  html += '<div id="mag-result" style="font-size:16px;color:var(--mint);font-weight:600;min-height:24px;margin:4px 0">N meets S \u2192 ATTRACT! \uD83E\uDDF2</div>';

  // Quiz
  html += '<div class="question-text" style="font-size:18px;margin-top:16px">' + q.text + '</div>';
  html += '<div class="answer-options" style="flex-direction:column;margin-top:8px">' + q.options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(\'' + escSci(o) + '\', \'' + escSci(q.answer) + '\', this)" style="font-size:16px;text-align:left;width:100%">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
  card.dataset.magLeftFlipped = 'false';
  card.dataset.magRightFlipped = 'false';
}

function magFlipLeft() {
  var card = document.getElementById('question-card');
  var flipped = card.dataset.magLeftFlipped === 'true';
  card.dataset.magLeftFlipped = String(!flipped);
  var mag = document.getElementById('mag-left');
  mag.style.transform = !flipped ? 'scaleX(-1)' : '';
  magUpdateForce();
}

function magFlipRight() {
  var card = document.getElementById('question-card');
  var flipped = card.dataset.magRightFlipped === 'true';
  card.dataset.magRightFlipped = String(!flipped);
  var mag = document.getElementById('mag-right');
  mag.style.transform = !flipped ? 'scaleX(-1)' : '';
  magUpdateForce();
}

function magUpdateForce() {
  var card = document.getElementById('question-card');
  var lFlip = card.dataset.magLeftFlipped === 'true';
  var rFlip = card.dataset.magRightFlipped === 'true';

  // Determine facing poles: left magnet's right side meets right magnet's left side
  var leftFacing = lFlip ? 'N' : 'S';  // right side of left magnet
  var rightFacing = rFlip ? 'S' : 'N'; // left side of right magnet

  var force = document.getElementById('mag-force');
  var result = document.getElementById('mag-result');

  if (leftFacing !== rightFacing) {
    // Attract (opposites)
    force.textContent = '\u27A1\uFE0F\u2B05\uFE0F';
    force.style.color = 'var(--success)';
    result.textContent = leftFacing + ' meets ' + rightFacing + ' \u2192 ATTRACT! \uD83E\uDDF2';
    result.style.color = 'var(--mint)';
  } else {
    // Repel (same)
    force.textContent = '\u2B05\uFE0F\u27A1\uFE0F';
    force.style.color = 'var(--error)';
    result.textContent = leftFacing + ' meets ' + rightFacing + ' \u2192 REPEL! \u274C';
    result.style.color = 'var(--coral)';
  }
}

// ===================== PLANT GROWTH SIM =====================

function renderPlantGrowthSim(card, q) {
  var html = '<div class="question-text">\uD83C\uDF31 Plant Growth Lab</div>';

  // Plant display
  html += '<div style="width:100%;max-width:280px;height:160px;margin:12px auto;position:relative;background:linear-gradient(to bottom, #87CEEB 0%, #87CEEB 60%, #8B4513 60%, #654321 100%);border-radius:16px;overflow:hidden" id="plant-sim">';

  // Sun toggle
  html += '<div id="plant-sun" style="position:absolute;top:10px;right:15px;font-size:28px;opacity:0.3;transition:opacity 0.3s;cursor:pointer" onclick="plantToggle(\'sun\')">\u2600\uFE0F</div>';

  // Rain toggle
  html += '<div id="plant-rain" style="position:absolute;top:10px;left:15px;font-size:28px;opacity:0.3;transition:opacity 0.3s;cursor:pointer" onclick="plantToggle(\'rain\')">\uD83D\uDCA7</div>';

  // Plant stages
  html += '<div id="plant-stage" style="position:absolute;bottom:35%;left:50%;transform:translateX(-50%);font-size:28px;transition:all 0.5s">\uD83C\uDF31</div>';

  // Soil indicator
  html += '<div id="plant-soil" style="position:absolute;bottom:8px;left:50%;transform:translateX(-50%);font-size:12px;color:rgba(255,255,255,0.6)">Soil \u2713</div>';

  html += '</div>';

  // Controls
  html += '<div style="display:flex;gap:10px;justify-content:center;margin:10px 0">';
  html += '<button class="answer-btn" style="font-size:14px;padding:8px 16px" onclick="plantToggle(\'sun\')">\u2600\uFE0F Sun</button>';
  html += '<button class="answer-btn" style="font-size:14px;padding:8px 16px" onclick="plantToggle(\'rain\')">\uD83D\uDCA7 Water</button>';
  html += '<button class="answer-btn" style="font-size:14px;padding:8px 16px" onclick="plantGrow()">\uD83C\uDF31 Grow!</button>';
  html += '</div>';

  html += '<div id="plant-message" style="font-size:14px;color:var(--text-secondary);min-height:24px;margin:4px 0">Toggle sun and water, then tap Grow!</div>';

  // Quiz
  html += '<div class="question-text" style="font-size:18px;margin-top:12px">' + q.text + '</div>';
  html += '<div class="answer-options" style="flex-direction:column;margin-top:8px">' + q.options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(\'' + escSci(o) + '\', \'' + escSci(q.answer) + '\', this)" style="font-size:16px;text-align:left;width:100%">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
  card.dataset.plantSun = 'false';
  card.dataset.plantRain = 'false';
  card.dataset.plantStage = '0';
}

var PLANT_STAGES = ['\uD83C\uDF31', '\uD83C\uDF3F', '\uD83C\uDF3E', '\uD83C\uDF3B', '\uD83C\uDF38'];

function plantToggle(type) {
  var card = document.getElementById('question-card');
  if (type === 'sun') {
    var on = card.dataset.plantSun !== 'true';
    card.dataset.plantSun = String(on);
    var sunEl = document.getElementById('plant-sun');
    if (sunEl) sunEl.style.opacity = on ? '1' : '0.3';
  } else {
    var on2 = card.dataset.plantRain !== 'true';
    card.dataset.plantRain = String(on2);
    var rainEl = document.getElementById('plant-rain');
    if (rainEl) rainEl.style.opacity = on2 ? '1' : '0.3';
  }
}

function plantGrow() {
  var card = document.getElementById('question-card');
  var sun = card.dataset.plantSun === 'true';
  var rain = card.dataset.plantRain === 'true';
  var stage = parseInt(card.dataset.plantStage || '0');
  var msg = document.getElementById('plant-message');

  if (sun && rain) {
    if (stage < PLANT_STAGES.length - 1) {
      stage++;
      card.dataset.plantStage = String(stage);
      var plantEl = document.getElementById('plant-stage');
      if (plantEl) {
        plantEl.textContent = PLANT_STAGES[stage];
        plantEl.style.fontSize = (28 + stage * 6) + 'px';
      }
      if (msg) msg.textContent = 'Growing! Stage ' + (stage + 1) + ' of ' + PLANT_STAGES.length;
      if (stage >= PLANT_STAGES.length - 1 && msg) msg.textContent = '\uD83C\uDF89 Fully grown! Plants need sun + water + soil!';
    }
  } else if (!sun && !rain) {
    if (msg) msg.textContent = 'Nothing happened! The plant needs sun AND water.';
  } else if (!sun) {
    if (msg) msg.textContent = 'The plant has water but no sunlight. Turn on the sun!';
  } else {
    if (msg) msg.textContent = 'The plant has sunlight but no water. Add water!';
  }
}

// ===================== CIRCUIT BUILDER SIM =====================

function renderCircuitSim(card, q) {
  var html = '<div class="question-text">\u26A1 Circuit Lab</div>';

  html += '<div style="position:relative;width:100%;max-width:300px;height:200px;margin:12px auto;background:rgba(0,0,0,0.3);border-radius:16px;padding:16px" id="circuit-sim">';

  // Circuit path (visual representation)
  html += '<div style="display:flex;align-items:center;justify-content:center;gap:4px;flex-wrap:wrap">';

  // Battery
  html += '<div style="padding:8px 12px;background:rgba(255,200,0,0.2);border:2px solid var(--gold);border-radius:8px;font-size:24px;text-align:center">\uD83D\uDD0B<div style="font-size:10px;color:var(--gold)">Battery</div></div>';

  // Wire segment 1
  html += '<div style="width:30px;height:4px;background:var(--text-dim);margin:0 2px" id="circuit-wire1"></div>';

  // Switch
  html += '<div style="padding:8px 12px;background:rgba(255,255,255,0.05);border:2px solid var(--text-dim);border-radius:8px;font-size:20px;cursor:pointer;text-align:center;transition:all 0.3s" id="circuit-switch" onclick="circuitToggleSwitch()">';
  html += '<span id="circuit-switch-icon">\uD83D\uDD34</span>';
  html += '<div style="font-size:10px;color:var(--text-secondary)">Switch</div></div>';

  // Wire segment 2
  html += '<div style="width:30px;height:4px;background:var(--text-dim);margin:0 2px" id="circuit-wire2"></div>';

  // Bulb
  html += '<div style="padding:8px 12px;background:rgba(255,255,255,0.05);border:2px solid var(--text-dim);border-radius:8px;font-size:24px;text-align:center;transition:all 0.3s" id="circuit-bulb">';
  html += '<span id="circuit-bulb-icon">\uD83D\uDCA1</span>';
  html += '<div style="font-size:10px;color:var(--text-secondary)">Bulb</div></div>';

  html += '</div>';

  // Status
  html += '<div id="circuit-status" style="position:absolute;bottom:12px;left:50%;transform:translateX(-50%);font-size:14px;color:var(--text-secondary);white-space:nowrap">Circuit is OPEN \u2014 bulb is OFF</div>';

  html += '</div>';

  html += '<div style="font-size:14px;color:var(--text-secondary);margin:8px 0">Tap the switch to close/open the circuit!</div>';

  // Quiz
  html += '<div class="question-text" style="font-size:18px;margin-top:12px">' + q.text + '</div>';
  html += '<div class="answer-options" style="flex-direction:column;margin-top:8px">' + q.options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(\'' + escSci(o) + '\', \'' + escSci(q.answer) + '\', this)" style="font-size:16px;text-align:left;width:100%">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
  card.dataset.circuitClosed = 'false';
}

function circuitToggleSwitch() {
  var card = document.getElementById('question-card');
  var closed = card.dataset.circuitClosed !== 'true';
  card.dataset.circuitClosed = String(closed);

  var switchEl = document.getElementById('circuit-switch');
  var switchIcon = document.getElementById('circuit-switch-icon');
  var bulb = document.getElementById('circuit-bulb');
  var bulbIcon = document.getElementById('circuit-bulb-icon');
  var wire1 = document.getElementById('circuit-wire1');
  var wire2 = document.getElementById('circuit-wire2');
  var status = document.getElementById('circuit-status');

  if (closed) {
    switchIcon.textContent = '\uD83D\uDFE2';
    switchEl.style.borderColor = 'var(--success)';
    bulb.style.borderColor = 'var(--gold)';
    bulb.style.background = 'rgba(255,255,0,0.2)';
    bulbIcon.textContent = '\uD83D\uDCA1';
    bulb.style.boxShadow = '0 0 20px rgba(255,255,0,0.4)';
    wire1.style.background = 'var(--gold)';
    wire2.style.background = 'var(--gold)';
    if (status) status.textContent = 'Circuit is CLOSED \u2014 bulb is ON! \u2728';
    status.style.color = 'var(--gold)';
  } else {
    switchIcon.textContent = '\uD83D\uDD34';
    switchEl.style.borderColor = 'var(--text-dim)';
    bulb.style.borderColor = 'var(--text-dim)';
    bulb.style.background = 'rgba(255,255,255,0.05)';
    bulbIcon.textContent = '\uD83D\uDCA1';
    bulb.style.boxShadow = 'none';
    wire1.style.background = 'var(--text-dim)';
    wire2.style.background = 'var(--text-dim)';
    if (status) status.textContent = 'Circuit is OPEN \u2014 bulb is OFF';
    status.style.color = 'var(--text-secondary)';
  }
}

// ===================== UTILITY =====================

function escSci(str) {
  return String(str).replace(/'/g, "\\'");
}

// --- src/stem/code-engine.js ---
// ============================================================
//  CODE ENGINE — Coding question generators & renderer
// ============================================================

function generateCodeQuestion(skillId) {
  var diff = getSkillDifficulty(skillId);
  switch (skillId) {
    case 'cseq':   return genCodeSeq(diff);
    case 'cloop':  return genCodeLoop(diff);
    case 'ccond':  return genCodeCond(diff);
    case 'cvar':   return genCodeVar(diff);
    case 'cdebug': return genCodeDebug(diff);
    default:       return null;
  }
}

// ===================== DATA =====================

var CODE_GRID_ICONS = {
  robot: '\uD83E\uDD16',
  star:  '\u2B50',
  gem:   '\uD83D\uDC8E',
  flag:  '\uD83C\uDFC1',
  tree:  '\uD83C\uDF33',
  wall:  '\uD83E\uDDF1',
  empty: '\u2B1C'
};

var CODE_DIRECTIONS = ['right', 'right', 'down', 'right', 'down'];

// ===================== GENERATORS =====================

function genCodeSeq(diff) {
  // Put steps in the correct order
  var tasks = [
    { steps: ['Pick up the brush', 'Dip it in paint', 'Paint the wall', 'Clean the brush'], task: 'Paint a wall' },
    { steps: ['Get the bread', 'Spread the butter', 'Add the jam', 'Eat the sandwich'], task: 'Make a sandwich' },
    { steps: ['Wake up', 'Brush your teeth', 'Eat breakfast', 'Go to school'], task: 'Morning routine' },
    { steps: ['Get a pot', 'Fill with water', 'Put on the stove', 'Wait for it to boil'], task: 'Boil water' },
    { steps: ['Open the book', 'Read the story', 'Close the book', 'Tell a friend about it'], task: 'Read a book' },
    { steps: ['Get the seeds', 'Dig a hole', 'Plant the seeds', 'Water the soil'], task: 'Plant seeds' }
  ];
  var task = pick(tasks);
  var scrambled = shuffle([].concat(task.steps));
  var safety = 0;
  while (scrambled.join(',') === task.steps.join(',') && safety < 10) {
    scrambled = shuffle([].concat(task.steps));
    safety++;
  }

  return {
    type: 'code-sequence',
    task: task.task,
    correctOrder: task.steps,
    scrambled: scrambled,
    answer: task.steps.join(' \u2192 '),
    hint: 'Think about what has to happen first, second, third, and last.'
  };
}

function genCodeLoop(diff) {
  var n = rand(2, diff.level >= 2 ? 5 : 3);
  var actions = [
    { action: 'clap', emoji: '\uD83D\uDC4F' },
    { action: 'jump', emoji: '\uD83E\uDD38' },
    { action: 'step forward', emoji: '\u27A1\uFE0F' },
    { action: 'spin', emoji: '\uD83C\uDF00' },
    { action: 'wave', emoji: '\uD83D\uDC4B' }
  ];
  var act = pick(actions);

  return {
    type: 'code-loop',
    action: act.action,
    emoji: act.emoji,
    repeat: n,
    answer: n,
    hint: 'A loop repeats an action. Count how many times ' + act.emoji + ' appears.'
  };
}

function genCodeCond(diff) {
  var scenarios = [
    { condition: 'it is raining', ifTrue: 'Take an umbrella', ifFalse: 'Wear sunglasses', question: 'It IS raining. What should you do?', answer: 'Take an umbrella' },
    { condition: 'the light is red', ifTrue: 'Stop and wait', ifFalse: 'Cross the road', question: 'The light IS red. What should you do?', answer: 'Stop and wait' },
    { condition: 'you are hungry', ifTrue: 'Eat a snack', ifFalse: 'Keep playing', question: 'You ARE hungry. What should you do?', answer: 'Eat a snack' },
    { condition: 'the door is locked', ifTrue: 'Use the key', ifFalse: 'Push the door open', question: 'The door IS locked. What should you do?', answer: 'Use the key' },
    { condition: 'it is bedtime', ifTrue: 'Go to sleep', ifFalse: 'Keep reading', question: 'It IS bedtime. What should you do?', answer: 'Go to sleep' },
    { condition: 'the water is hot', ifTrue: 'Wait for it to cool', ifFalse: 'Drink it now', question: 'The water IS hot. What should you do?', answer: 'Wait for it to cool' }
  ];
  var s = pick(scenarios);

  return {
    type: 'code-conditional',
    condition: s.condition,
    ifTrue: s.ifTrue,
    ifFalse: s.ifFalse,
    questionText: s.question,
    options: shuffle([s.ifTrue, s.ifFalse]),
    answer: s.answer,
    hint: 'Read the IF condition. Is it true or false? Follow the correct path.'
  };
}

function genCodeVar(diff) {
  var varName = pick(['score', 'apples', 'stars', 'coins', 'lives']);
  var startVal = rand(1, 10);
  var ops = [];
  var steps = rand(2, diff.level >= 2 ? 4 : 3);
  var current = startVal;

  for (var i = 0; i < steps; i++) {
    if (Math.random() < 0.6 || current <= 1) {
      var add = rand(1, 5);
      ops.push({ op: 'add', val: add, text: varName + ' = ' + varName + ' + ' + add });
      current += add;
    } else {
      var sub = rand(1, Math.min(current - 1, 5));
      ops.push({ op: 'sub', val: sub, text: varName + ' = ' + varName + ' - ' + sub });
      current -= sub;
    }
  }

  return {
    type: 'code-variable',
    varName: varName,
    startVal: startVal,
    operations: ops,
    answer: current,
    hint: 'Start with ' + varName + ' = ' + startVal + '. Follow each step one by one.'
  };
}

function genCodeDebug(diff) {
  var bugs = [
    {
      code: ['1. Get a cup', '2. Pour milk', '3. Drink from the plate', '4. Put cup away'],
      bugLine: 2,
      bugText: 'Drink from the plate',
      fixText: 'Drink from the cup',
      task: 'Pour and drink milk'
    },
    {
      code: ['1. Put on socks', '2. Put on shoes', '3. Put on shirt', '4. Go outside'],
      bugLine: 2,
      bugText: 'Put on shirt',
      fixText: 'Tie shoelaces',
      task: 'Get dressed for shoes'
    },
    {
      code: ['1. Open the fridge', '2. Take out an egg', '3. Throw egg on floor', '4. Eat breakfast'],
      bugLine: 2,
      bugText: 'Throw egg on floor',
      fixText: 'Cook the egg',
      task: 'Make breakfast'
    },
    {
      code: ['1. Pick up toothbrush', '2. Squeeze shampoo on it', '3. Brush teeth', '4. Rinse mouth'],
      bugLine: 1,
      bugText: 'Squeeze shampoo on it',
      fixText: 'Squeeze toothpaste on it',
      task: 'Brush your teeth'
    },
    {
      code: ['1. Fill kettle with sand', '2. Turn on the kettle', '3. Wait for it to boil', '4. Pour hot water'],
      bugLine: 0,
      bugText: 'Fill kettle with sand',
      fixText: 'Fill kettle with water',
      task: 'Boil water'
    }
  ];
  var bug = pick(bugs);

  return {
    type: 'code-debug',
    task: bug.task,
    code: bug.code,
    bugLine: bug.bugLine,
    bugText: bug.bugText,
    fixText: bug.fixText,
    options: shuffle(bug.code.map(function(line) { return line; })),
    answer: bug.code[bug.bugLine],
    hint: 'Read each step carefully. Which one does NOT make sense for the task?'
  };
}

// ===================== RENDERER =====================

function renderCodeQuestion(card, q) {
  switch (q.type) {
    case 'code-sequence':    renderCodeSequence(card, q); return true;
    case 'code-loop':        renderCodeLoop(card, q); return true;
    case 'code-conditional': renderCodeConditional(card, q); return true;
    case 'code-variable':    renderCodeVariable(card, q); return true;
    case 'code-debug':       renderCodeDebug(card, q); return true;
    default: return false;
  }
}

function renderCodeSequence(card, q) {
  var html = '<div class="question-text">\uD83E\uDD16 Task: ' + q.task + '</div>';
  html += '<div style="font-size:15px;color:var(--text-secondary);margin-bottom:12px">Put these steps in order!</div>';
  html += '<div id="code-result" style="min-height:48px;padding:12px;background:rgba(255,255,255,0.05);border-radius:12px;margin:8px 0;display:flex;flex-direction:column;gap:6px"></div>';
  html += '<div id="code-bank" style="display:flex;flex-direction:column;gap:6px;margin:8px 0">';
  q.scrambled.forEach(function(step, i) {
    html += '<button class="answer-btn" style="font-size:16px;text-align:left;width:100%" onclick="codeStepClick(this)">' + step + '</button>';
  });
  html += '</div>';
  html += '<button class="submit-btn mt-2" onclick="checkCodeSequence()">Run Code \u25B6</button>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
  card.dataset.codeAnswer = q.correctOrder.join(' \u2192 ');
}

function renderCodeLoop(card, q) {
  var html = '<div class="question-text">\uD83D\uDD01 What does this loop do?</div>';
  html += '<div style="background:rgba(0,0,0,0.3);border-radius:12px;padding:16px;margin:12px 0;font-family:monospace;font-size:18px;text-align:left">';
  html += '<div style="color:var(--sky)">repeat ' + q.repeat + ' times:</div>';
  html += '<div style="margin-left:20px;color:var(--mint)">' + q.emoji + ' ' + q.action + '</div>';
  html += '</div>';
  html += '<div style="font-size:18px;margin:12px 0">How many times will the robot <strong>' + q.action + '</strong>?</div>';
  var options = generateMCQOptions(q.answer, 1, q.answer + 3, 4);
  html += '<div class="answer-options">' + options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(' + o + ', ' + q.answer + ', this)" style="font-size:22px">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderCodeConditional(card, q) {
  var html = '<div class="question-text">\uD83D\uDD00 Follow the code!</div>';
  html += '<div style="background:rgba(0,0,0,0.3);border-radius:12px;padding:16px;margin:12px 0;font-family:monospace;font-size:16px;text-align:left">';
  html += '<div style="color:var(--sky)">IF ' + q.condition + ':</div>';
  html += '<div style="margin-left:20px;color:var(--mint)">\u2192 ' + q.ifTrue + '</div>';
  html += '<div style="color:var(--coral)">ELSE:</div>';
  html += '<div style="margin-left:20px;color:var(--mint)">\u2192 ' + q.ifFalse + '</div>';
  html += '</div>';
  html += '<div class="question-text" style="font-size:18px">' + q.questionText + '</div>';
  html += '<div class="answer-options">' + q.options.map(function(o) {
    var escaped = String(o).replace(/'/g, "\\'");
    var ansEscaped = String(q.answer).replace(/'/g, "\\'");
    return '<button class="answer-btn" onclick="checkAnswer(\'' + escaped + '\', \'' + ansEscaped + '\', this)" style="font-size:18px">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderCodeVariable(card, q) {
  var html = '<div class="question-text">\uD83D\uDCE6 Trace the code!</div>';
  html += '<div style="background:rgba(0,0,0,0.3);border-radius:12px;padding:16px;margin:12px 0;font-family:monospace;font-size:16px;text-align:left">';
  html += '<div style="color:var(--gold)">' + q.varName + ' = ' + q.startVal + '</div>';
  q.operations.forEach(function(op) {
    html += '<div style="color:var(--mint)">' + op.text + '</div>';
  });
  html += '</div>';
  html += '<div class="question-text" style="font-size:18px">What is <strong>' + q.varName + '</strong> at the end?</div>';
  var options = generateMCQOptions(q.answer, Math.max(0, q.answer - 3), q.answer + 4, 4);
  html += '<div class="answer-options">' + options.map(function(o) {
    return '<button class="answer-btn" onclick="checkAnswer(' + o + ', ' + q.answer + ', this)" style="font-size:24px">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

function renderCodeDebug(card, q) {
  var html = '<div class="question-text">\uD83D\uDC1B Find the bug!</div>';
  html += '<div style="font-size:16px;color:var(--text-secondary);margin-bottom:8px">Task: ' + q.task + '</div>';
  html += '<div style="background:rgba(0,0,0,0.3);border-radius:12px;padding:16px;margin:12px 0;font-family:monospace;font-size:16px;text-align:left">';
  q.code.forEach(function(line) {
    html += '<div style="color:var(--mint);padding:4px 0">' + line + '</div>';
  });
  html += '</div>';
  html += '<div style="font-size:16px;margin:8px 0">Which step has the bug?</div>';
  html += '<div class="answer-options" style="flex-direction:column">' + q.options.map(function(o) {
    var escaped = String(o).replace(/'/g, "\\'");
    var ansEscaped = String(q.answer).replace(/'/g, "\\'");
    return '<button class="answer-btn" onclick="checkAnswer(\'' + escaped + '\', \'' + ansEscaped + '\', this)" style="font-size:14px;text-align:left;width:100%">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

// ===================== GRID-BASED CODING ROBOT =====================

// Grid cell types: 0=empty, 1=wall, 2=gem, 3=goal, 4=start
// Directions: 0=right, 1=down, 2=left, 3=up
var GRID_DIR_DELTA = [
  { dr: 0, dc: 1 },  // right
  { dr: 1, dc: 0 },  // down
  { dr: 0, dc: -1 }, // left
  { dr: -1, dc: 0 }  // up
];
var GRID_DIR_ARROWS = ['\u27A1\uFE0F', '\u2B07\uFE0F', '\u2B05\uFE0F', '\u2B06\uFE0F'];
var GRID_DIR_NAMES = ['right', 'down', 'left', 'up'];

function genCodeGrid(diff) {
  // Pick a level from the CODE_GRID_LEVELS bank based on skill and difficulty
  var skillId = ['cseq', 'cloop', 'ccond', 'cvar', 'cdebug'][diff.level] || 'cseq';
  var levels = CODE_GRID_LEVELS.filter(function(l) { return l.skill === skillId; });
  if (levels.length === 0) levels = CODE_GRID_LEVELS.filter(function(l) { return l.skill === 'cseq'; });
  var level = pick(levels);

  return {
    type: 'code-grid',
    grid: level.grid,
    start: level.start,
    goal: level.goal,
    gems: level.gems || [],
    title: level.title || 'Robot Puzzle',
    maxBlocks: level.maxBlocks || 20,
    answer: '__grid__',
    hint: level.hint || 'Guide the robot to the flag! Use the arrow buttons to build your sequence.'
  };
}

function renderCodeGrid(card, q) {
  var rows = q.grid.length;
  var cols = q.grid[0].length;
  var cellSize = Math.min(48, Math.floor(280 / Math.max(rows, cols)));

  var html = '<div class="question-text">\uD83E\uDD16 ' + q.title + '</div>';
  html += '<div style="font-size:13px;color:var(--text-secondary);margin-bottom:8px">Guide the robot to the flag!</div>';

  // Grid display
  html += '<div id="code-grid" style="display:inline-grid;grid-template-columns:repeat(' + cols + ',' + cellSize + 'px);gap:2px;margin:8px auto;background:rgba(0,0,0,0.2);padding:4px;border-radius:8px">';
  for (var r = 0; r < rows; r++) {
    for (var c = 0; c < cols; c++) {
      var cell = q.grid[r][c];
      var content = '';
      var bg = 'rgba(255,255,255,0.05)';

      if (cell === 1) { content = '\uD83E\uDDF1'; bg = 'rgba(100,100,100,0.3)'; }
      else if (cell === 2) { content = '\uD83D\uDC8E'; }
      else if (cell === 3) { content = '\uD83C\uDFC1'; bg = 'rgba(0,255,100,0.1)'; }

      if (r === q.start[0] && c === q.start[1]) { content = '\uD83E\uDD16'; bg = 'rgba(100,200,255,0.15)'; }

      html += '<div class="grid-cell" id="gc-' + r + '-' + c + '" style="width:' + cellSize + 'px;height:' + cellSize + 'px;background:' + bg + ';display:flex;align-items:center;justify-content:center;font-size:' + Math.floor(cellSize * 0.6) + 'px;border-radius:4px;transition:all 0.3s">' + content + '</div>';
    }
  }
  html += '</div>';

  // Command palette
  html += '<div style="display:flex;gap:6px;justify-content:center;margin:8px 0;flex-wrap:wrap">';
  html += '<button class="answer-btn" style="font-size:18px;padding:6px 14px" onclick="gridAddCmd(0)">\u27A1\uFE0F</button>';
  html += '<button class="answer-btn" style="font-size:18px;padding:6px 14px" onclick="gridAddCmd(1)">\u2B07\uFE0F</button>';
  html += '<button class="answer-btn" style="font-size:18px;padding:6px 14px" onclick="gridAddCmd(2)">\u2B05\uFE0F</button>';
  html += '<button class="answer-btn" style="font-size:18px;padding:6px 14px" onclick="gridAddCmd(3)">\u2B06\uFE0F</button>';
  html += '<button class="answer-btn" style="font-size:14px;padding:6px 14px;color:var(--coral)" onclick="gridClearCmds()">\u274C Clear</button>';
  html += '</div>';

  // Command display
  html += '<div id="grid-cmds" style="min-height:32px;padding:8px;background:rgba(0,0,0,0.2);border-radius:8px;margin:4px 0;display:flex;flex-wrap:wrap;gap:4px;justify-content:center;font-size:18px"></div>';
  html += '<div id="grid-cmd-count" style="font-size:12px;color:var(--text-dim)">Commands: 0/' + q.maxBlocks + '</div>';

  // Run button
  html += '<button class="submit-btn mt-2" onclick="gridRunCode()" id="grid-run-btn">Run \u25B6</button>';
  html += '<div id="grid-status" style="font-size:14px;color:var(--text-secondary);min-height:20px;margin:4px 0"></div>';

  html += renderHintBtn(q.hint);
  card.innerHTML = html;

  // Store grid state
  card.dataset.gridRows = String(rows);
  card.dataset.gridCols = String(cols);
  card.dataset.gridData = JSON.stringify(q.grid);
  card.dataset.gridStart = JSON.stringify(q.start);
  card.dataset.gridGoal = JSON.stringify(q.goal);
  card.dataset.gridGems = JSON.stringify(q.gems || []);
  card.dataset.gridCmds = '[]';
  card.dataset.gridMax = String(q.maxBlocks);
}

function gridAddCmd(dir) {
  var card = document.getElementById('question-card');
  var cmds = JSON.parse(card.dataset.gridCmds || '[]');
  var max = parseInt(card.dataset.gridMax || '20');
  if (cmds.length >= max) return;
  cmds.push(dir);
  card.dataset.gridCmds = JSON.stringify(cmds);
  gridUpdateDisplay();
}

function gridClearCmds() {
  var card = document.getElementById('question-card');
  card.dataset.gridCmds = '[]';
  gridUpdateDisplay();
  // Reset grid visuals
  gridResetVisuals();
}

function gridUpdateDisplay() {
  var card = document.getElementById('question-card');
  var cmds = JSON.parse(card.dataset.gridCmds || '[]');
  var max = parseInt(card.dataset.gridMax || '20');
  var el = document.getElementById('grid-cmds');
  var count = document.getElementById('grid-cmd-count');
  if (el) el.innerHTML = cmds.map(function(d) { return GRID_DIR_ARROWS[d]; }).join(' ');
  if (count) count.textContent = 'Commands: ' + cmds.length + '/' + max;
}

function gridResetVisuals() {
  var card = document.getElementById('question-card');
  var grid = JSON.parse(card.dataset.gridData || '[]');
  var start = JSON.parse(card.dataset.gridStart || '[0,0]');
  var gems = JSON.parse(card.dataset.gridGems || '[]');
  var rows = grid.length;
  var cols = grid[0].length;

  for (var r = 0; r < rows; r++) {
    for (var c = 0; c < cols; c++) {
      var cell = document.getElementById('gc-' + r + '-' + c);
      if (!cell) continue;
      var v = grid[r][c];
      var content = '';
      var bg = 'rgba(255,255,255,0.05)';
      if (v === 1) { content = '\uD83E\uDDF1'; bg = 'rgba(100,100,100,0.3)'; }
      else if (v === 2) { content = '\uD83D\uDC8E'; }
      else if (v === 3) { content = '\uD83C\uDFC1'; bg = 'rgba(0,255,100,0.1)'; }
      if (r === start[0] && c === start[1]) { content = '\uD83E\uDD16'; bg = 'rgba(100,200,255,0.15)'; }
      cell.innerHTML = content;
      cell.style.background = bg;
    }
  }
  var status = document.getElementById('grid-status');
  if (status) status.textContent = '';
}

function gridRunCode() {
  var card = document.getElementById('question-card');
  var cmds = JSON.parse(card.dataset.gridCmds || '[]');
  var grid = JSON.parse(card.dataset.gridData || '[]');
  var start = JSON.parse(card.dataset.gridStart || '[0,0]');
  var goal = JSON.parse(card.dataset.gridGoal || '[0,0]');
  var gems = JSON.parse(card.dataset.gridGems || '[]');
  var rows = grid.length;
  var cols = grid[0].length;

  if (cmds.length === 0) {
    var status = document.getElementById('grid-status');
    if (status) status.textContent = 'Add some commands first!';
    return;
  }

  // Disable run button
  var runBtn = document.getElementById('grid-run-btn');
  if (runBtn) runBtn.disabled = true;

  // Reset visuals first
  gridResetVisuals();

  // Animate step by step
  var pos = { r: start[0], c: start[1] };
  var gemsCollected = 0;
  var gemSet = {};
  gems.forEach(function(g) { gemSet[g[0] + ',' + g[1]] = true; });
  var step = 0;

  function animateStep() {
    if (step >= cmds.length) {
      // Check if reached goal
      setTimeout(function() {
        if (pos.r === goal[0] && pos.c === goal[1]) {
          var statusEl = document.getElementById('grid-status');
          if (statusEl) statusEl.textContent = '\uD83C\uDF89 Goal reached!';
          handleCorrect();
        } else {
          var statusEl2 = document.getElementById('grid-status');
          if (statusEl2) statusEl2.textContent = '\u274C Didn\'t reach the flag. Try again!';
          handleWrong('Reach the flag');
        }
        if (runBtn) runBtn.disabled = false;
      }, 300);
      return;
    }

    var dir = cmds[step];
    var delta = GRID_DIR_DELTA[dir];
    var nr = pos.r + delta.dr;
    var nc = pos.c + delta.dc;

    // Check bounds and walls
    if (nr < 0 || nr >= rows || nc < 0 || nc >= cols || grid[nr][nc] === 1) {
      // Hit wall or out of bounds
      var statusEl = document.getElementById('grid-status');
      if (statusEl) statusEl.textContent = '\uD83E\uDDF1 Blocked! The robot hit a wall.';
      handleWrong('Avoid walls and stay on the grid');
      if (runBtn) runBtn.disabled = false;
      return;
    }

    // Clear old position
    var oldCell = document.getElementById('gc-' + pos.r + '-' + pos.c);
    if (oldCell) {
      oldCell.innerHTML = '';
      oldCell.style.background = 'rgba(200,255,200,0.08)'; // trail
    }

    // Move
    pos.r = nr;
    pos.c = nc;

    // Check for gem
    var gemKey = nr + ',' + nc;
    if (gemSet[gemKey]) {
      gemsCollected++;
      delete gemSet[gemKey];
    }

    // Draw new position
    var newCell = document.getElementById('gc-' + nr + '-' + nc);
    if (newCell) {
      newCell.innerHTML = '\uD83E\uDD16';
      newCell.style.background = 'rgba(100,200,255,0.15)';
    }

    step++;
    setTimeout(animateStep, 350);
  }

  animateStep();
}

// Add grid rendering to the code question router
var _origRenderCodeQ = renderCodeQuestion;
renderCodeQuestion = function(card, q) {
  if (q.type === 'code-grid') { renderCodeGrid(card, q); return true; }
  return _origRenderCodeQ(card, q);
};

// At higher difficulty, coding skills use grid puzzles
var _origGenCodeSeq = genCodeSeq;
genCodeSeq = function(diff) {
  if (diff.level >= 3 && typeof CODE_GRID_LEVELS !== 'undefined') {
    var levels = CODE_GRID_LEVELS.filter(function(l) { return l.skill === 'cseq'; });
    if (levels.length > 0) return genCodeGrid(diff);
  }
  return _origGenCodeSeq(diff);
};

var _origGenCodeLoop = genCodeLoop;
genCodeLoop = function(diff) {
  if (diff.level >= 3 && typeof CODE_GRID_LEVELS !== 'undefined') {
    var levels = CODE_GRID_LEVELS.filter(function(l) { return l.skill === 'cloop'; });
    if (levels.length > 0) return genCodeGrid(diff);
  }
  return _origGenCodeLoop(diff);
};

// ===================== CODE HELPERS =====================

function codeStepClick(btn) {
  var result = document.getElementById('code-result');
  var bank = document.getElementById('code-bank');
  if (!result || !bank) return;

  if (btn.parentElement.id === 'code-bank') {
    btn.remove();
    var tag = document.createElement('button');
    tag.className = 'answer-btn';
    tag.style.cssText = 'font-size:16px;text-align:left;width:100%;cursor:pointer';
    tag.textContent = btn.textContent;
    tag.setAttribute('onclick', 'codeStepReturn(this)');
    result.appendChild(tag);
  }
}

function codeStepReturn(btn) {
  var bank = document.getElementById('code-bank');
  if (!bank) return;
  btn.remove();
  var tag = document.createElement('button');
  tag.className = 'answer-btn';
  tag.style.cssText = 'font-size:16px;text-align:left;width:100%;cursor:grab';
  tag.textContent = btn.textContent;
  tag.setAttribute('onclick', 'codeStepClick(this)');
  bank.appendChild(tag);
}

function checkCodeSequence() {
  var result = document.getElementById('code-result');
  var card = document.getElementById('question-card');
  if (!result || !card) return;
  var steps = [];
  result.querySelectorAll('.answer-btn').forEach(function(b) { steps.push(b.textContent); });
  var built = steps.join(' \u2192 ');
  var expected = card.dataset.codeAnswer;
  if (built === expected) {
    handleCorrect();
  } else {
    handleWrong(expected);
  }
}

// --- src/stem/code-levels.js ---
// ============================================================
//  CODE LEVELS — Theme descriptions + 60 grid puzzle levels
// ============================================================

var CODE_LEVEL_THEMES = [
  // Sequence levels
  { skill: 'cseq', level: 0, title: 'Robot\u2019s First Steps',    desc: 'Help the robot follow simple instructions!' },
  { skill: 'cseq', level: 1, title: 'Kitchen Helper',              desc: 'Put cooking steps in the right order.' },
  { skill: 'cseq', level: 2, title: 'Garden Planner',              desc: 'Sequence the steps to grow a plant.' },
  { skill: 'cseq', level: 3, title: 'Adventure Guide',             desc: 'Plan a treasure hunt step by step.' },
  { skill: 'cseq', level: 4, title: 'Space Commander',             desc: 'Launch a rocket with perfect sequencing!' },
  // Loop levels
  { skill: 'cloop', level: 0, title: 'Clap Along',                 desc: 'Count how many times the robot claps.' },
  { skill: 'cloop', level: 1, title: 'Dance Repeat',               desc: 'How many dance moves in the loop?' },
  { skill: 'cloop', level: 2, title: 'Pattern Maker',              desc: 'Loops can create beautiful patterns!' },
  { skill: 'cloop', level: 3, title: 'Music Maestro',              desc: 'Repeat musical notes with loops.' },
  { skill: 'cloop', level: 4, title: 'Loop Master',                desc: 'Nested loops and complex repetitions.' },
  // Conditional levels
  { skill: 'ccond', level: 0, title: 'Weather Checker',            desc: 'IF it rains, THEN take an umbrella!' },
  { skill: 'ccond', level: 1, title: 'Traffic Light',              desc: 'Stop or go? Follow the signals.' },
  { skill: 'ccond', level: 2, title: 'Animal Sorter',              desc: 'Sort animals by their features.' },
  { skill: 'ccond', level: 3, title: 'Decision Tree',              desc: 'Multiple conditions, multiple paths.' },
  { skill: 'ccond', level: 4, title: 'Logic Gate',                 desc: 'AND, OR, NOT \u2014 become a logic expert!' },
  // Variable levels
  { skill: 'cvar', level: 0, title: 'Score Keeper',                desc: 'Track the score as it changes.' },
  { skill: 'cvar', level: 1, title: 'Piggy Bank',                  desc: 'Add and remove coins from your bank.' },
  { skill: 'cvar', level: 2, title: 'Health Bar',                  desc: 'Track a character\u2019s health points.' },
  { skill: 'cvar', level: 3, title: 'Inventory Manager',           desc: 'Keep track of items collected.' },
  { skill: 'cvar', level: 4, title: 'Variable Wizard',             desc: 'Multiple variables working together!' },
  // Debug levels
  { skill: 'cdebug', level: 0, title: 'Spot the Mistake',          desc: 'Something silly is in the instructions!' },
  { skill: 'cdebug', level: 1, title: 'Fix the Recipe',            desc: 'The recipe has a wrong step.' },
  { skill: 'cdebug', level: 2, title: 'Code Doctor',               desc: 'Diagnose and fix the broken code.' },
  { skill: 'cdebug', level: 3, title: 'Bug Detective',             desc: 'Find the sneaky bug hiding in the code.' },
  { skill: 'cdebug', level: 4, title: 'Debug Champion',            desc: 'Fix tricky multi-step bugs!' }
];

function getCodeLevelTheme(skillId) {
  var skill = getSkillState(skillId);
  var theme = CODE_LEVEL_THEMES.find(function(t) {
    return t.skill === skillId && t.level === skill.level;
  });
  return theme || { title: 'Code Challenge', desc: 'Solve the coding puzzle!' };
}

// ============================================================
//  GRID PUZZLE LEVELS — 60 levels for the visual robot coding
// ============================================================
// Grid: 0=empty, 1=wall, 2=gem, 3=goal
// start: [row, col], goal: [row, col], gems: [[row,col],...]

var CODE_GRID_LEVELS = [
  // ============ SEQUENCE LEVELS (12) ============
  // S1: straight line right (3x3)
  { skill:'cseq', title:'Walk the Path', grid:[[4,0,0],[0,0,0],[0,0,3]], start:[0,0], goal:[2,2], gems:[], maxBlocks:4, hint:'Go right, then down, then right, then down.' },
  // S2: L-shape (3x3)
  { skill:'cseq', title:'Turn the Corner', grid:[[4,0,1],[0,0,1],[0,0,3]], start:[0,0], goal:[2,2], gems:[], maxBlocks:5, hint:'Go down first to avoid the walls, then right.' },
  // S3: collect a gem (3x3)
  { skill:'cseq', title:'Gem Collector', grid:[[4,2,0],[0,0,0],[0,0,3]], start:[0,0], goal:[2,2], gems:[[0,1]], maxBlocks:5, hint:'Pick up the gem on your way!' },
  // S4: zigzag (3x4)
  { skill:'cseq', title:'Zigzag Path', grid:[[4,0,0,0],[1,1,0,1],[0,0,0,3]], start:[0,0], goal:[2,3], gems:[], maxBlocks:7, hint:'Find a path around the walls.' },
  // S5: 4x4 with walls
  { skill:'cseq', title:'Maze Runner', grid:[[4,0,1,0],[0,0,1,0],[0,0,0,0],[1,1,0,3]], start:[0,0], goal:[3,3], gems:[], maxBlocks:8, hint:'Navigate around both wall sections.' },
  // S6: gems on path (4x4)
  { skill:'cseq', title:'Treasure Trail', grid:[[4,2,0,0],[0,0,0,1],[1,0,2,0],[0,0,0,3]], start:[0,0], goal:[3,3], gems:[[0,1],[2,2]], maxBlocks:8, hint:'Collect both gems on your way.' },
  // S7: 4x4 longer path
  { skill:'cseq', title:'The Long Way', grid:[[4,0,0,0],[1,1,1,0],[0,0,0,0],[0,1,1,3]], start:[0,0], goal:[3,3], gems:[], maxBlocks:10, hint:'You\'ll need to go around the long way.' },
  // S8: 5x5 intro
  { skill:'cseq', title:'Big Grid', grid:[[4,0,0,0,0],[0,1,1,1,0],[0,0,0,0,0],[0,1,1,0,1],[0,0,0,0,3]], start:[0,0], goal:[4,4], gems:[], maxBlocks:12, hint:'Plan your route before starting!' },
  // S9: 5x5 with gems
  { skill:'cseq', title:'Gem Hunt', grid:[[4,0,2,0,0],[0,1,0,1,0],[0,0,0,0,2],[0,1,1,0,0],[0,0,0,0,3]], start:[0,0], goal:[4,4], gems:[[0,2],[2,4]], maxBlocks:12, hint:'Can you collect both gems and reach the flag?' },
  // S10: snake path
  { skill:'cseq', title:'Snake Path', grid:[[4,0,0,0,0],[1,1,1,1,0],[0,0,0,0,0],[0,1,1,1,1],[0,0,0,0,3]], start:[0,0], goal:[4,4], gems:[], maxBlocks:16, hint:'Follow the snake-like path.' },
  // S11: 5x5 complex
  { skill:'cseq', title:'Expert Navigator', grid:[[0,0,4,0,0],[0,1,0,1,0],[0,0,0,0,0],[0,1,0,1,0],[0,0,3,0,0]], start:[0,2], goal:[4,2], gems:[], maxBlocks:10, hint:'Straight down won\'t work \u2014 find a path around.' },
  // S12: 6x6 finale
  { skill:'cseq', title:'Master Sequence', grid:[[4,0,1,0,0,0],[0,0,1,0,1,0],[0,0,0,0,1,0],[1,1,0,1,0,0],[0,0,0,1,0,1],[0,0,0,0,0,3]], start:[0,0], goal:[5,5], gems:[], maxBlocks:14, hint:'This is a tricky one! Plan ahead.' },

  // ============ LOOP LEVELS (12) ============
  // L1: straight line (needs repeat right)
  { skill:'cloop', title:'Repeat Right', grid:[[4,0,0,0,3]], start:[0,0], goal:[0,4], gems:[], maxBlocks:4, hint:'Use 4 rights. A loop would be: repeat 4 \u2192.' },
  // L2: straight down
  { skill:'cloop', title:'Repeat Down', grid:[[4],[0],[0],[0],[3]], start:[0,0], goal:[4,0], gems:[], maxBlocks:4, hint:'Go down 4 times.' },
  // L3: L-shape repeated
  { skill:'cloop', title:'Staircase', grid:[[4,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,3]], start:[0,0], goal:[4,4], gems:[], maxBlocks:8, hint:'Right then down, repeat that pattern.' },
  // L4: gems in a line
  { skill:'cloop', title:'Gem Line', grid:[[4,2,2,2,3]], start:[0,0], goal:[0,4], gems:[[0,1],[0,2],[0,3]], maxBlocks:4, hint:'Collect all 3 gems by going right 4 times.' },
  // L5: border walk
  { skill:'cloop', title:'Border Patrol', grid:[[4,0,0,3],[0,0,0,0],[0,0,0,0]], start:[0,0], goal:[0,3], gems:[], maxBlocks:3, hint:'Go right 3 times.' },
  // L6: zigzag loop
  { skill:'cloop', title:'Zigzag Loop', grid:[[4,0,0],[1,1,0],[0,0,0],[0,1,1],[0,0,3]], start:[0,0], goal:[4,2], gems:[], maxBlocks:10, hint:'Right-right-down, then left-left-down. Repeat pattern!' },
  // L7: spiral inward
  { skill:'cloop', title:'Spiral In', grid:[[4,0,0,0],[1,1,1,0],[0,0,0,0],[0,1,1,3]], start:[0,0], goal:[3,3], gems:[], maxBlocks:10, hint:'Go right, then down, then left, then down, then right.' },
  // L8: gem collection loop
  { skill:'cloop', title:'Collect & Repeat', grid:[[4,0,2,0,2,0,3]], start:[0,0], goal:[0,6], gems:[[0,2],[0,4]], maxBlocks:6, hint:'6 rights — and you\'ll collect 2 gems along the way.' },
  // L9: 4x4 loop pattern
  { skill:'cloop', title:'Pattern Walk', grid:[[4,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,3]], start:[0,0], goal:[3,3], gems:[], maxBlocks:6, hint:'3 rights, then 3 downs. Or alternate right-down.' },
  // L10: long collection
  { skill:'cloop', title:'Long Loop', grid:[[4,2,0,2,0,2,0,3]], start:[0,0], goal:[0,7], gems:[[0,1],[0,3],[0,5]], maxBlocks:7, hint:'Just keep going right! 7 times.' },
  // L11: staircase with gems
  { skill:'cloop', title:'Gem Stairs', grid:[[4,0,0,0,0],[0,2,0,0,0],[0,0,2,0,0],[0,0,0,2,0],[0,0,0,0,3]], start:[0,0], goal:[4,4], gems:[[1,1],[2,2],[3,3]], maxBlocks:8, hint:'Right-down repeating pattern collects all gems.' },
  // L12: border circuit
  { skill:'cloop', title:'Full Circuit', grid:[[4,0,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0]], start:[0,0], goal:[0,3], gems:[], maxBlocks:3, hint:'Three rights gets you there.' },

  // ============ CONDITIONAL LEVELS (12) ============
  // C1-C12: simple to complex paths with decision points
  { skill:'ccond', title:'Fork in the Road', grid:[[0,4,0],[0,0,0],[3,1,0]], start:[0,1], goal:[2,0], gems:[], maxBlocks:4, hint:'Go down and left to avoid the wall.' },
  { skill:'ccond', title:'Which Way?', grid:[[4,1,0],[0,1,0],[0,0,3]], start:[0,0], goal:[2,2], gems:[], maxBlocks:4, hint:'Can\'t go right at start. Go down first.' },
  { skill:'ccond', title:'Wall Dodge', grid:[[4,0,0,0],[1,1,1,0],[0,0,0,0],[0,0,0,3]], start:[0,0], goal:[3,3], gems:[], maxBlocks:8, hint:'Go right to the end, then down, then navigate around.' },
  { skill:'ccond', title:'Two Paths', grid:[[4,0,0],[0,1,0],[0,1,0],[0,0,3]], start:[0,0], goal:[3,2], gems:[], maxBlocks:6, hint:'Both paths work \u2014 but one is shorter.' },
  { skill:'ccond', title:'Gem or Speed?', grid:[[4,0,0,0],[0,1,2,0],[0,0,1,0],[0,0,0,3]], start:[0,0], goal:[3,3], gems:[[1,2]], maxBlocks:8, hint:'Choose: straight to goal, or detour for the gem?' },
  { skill:'ccond', title:'Dead End Detector', grid:[[4,0,1],[0,1,0],[0,0,3]], start:[0,0], goal:[2,2], gems:[], maxBlocks:5, hint:'Going right hits a dead end. Go down first!' },
  { skill:'ccond', title:'Maze Choice', grid:[[4,0,0,0,0],[1,1,0,1,0],[0,0,0,1,0],[0,1,0,0,0],[0,0,0,1,3]], start:[0,0], goal:[4,4], gems:[], maxBlocks:12, hint:'Find the one path through the maze.' },
  { skill:'ccond', title:'Triple Fork', grid:[[0,4,0,0,0],[0,0,0,0,0],[1,0,1,0,1],[0,0,0,0,0],[0,0,3,0,0]], start:[0,1], goal:[4,2], gems:[], maxBlocks:6, hint:'Go down, pick the right gap in the wall.' },
  { skill:'ccond', title:'Barrier Maze', grid:[[4,0,0,0],[1,0,1,0],[0,0,0,0],[0,1,0,1],[0,0,3,0]], start:[0,0], goal:[4,2], gems:[], maxBlocks:8, hint:'Zigzag through the barriers.' },
  { skill:'ccond', title:'Island Hop', grid:[[4,0,1,0,0],[0,0,1,0,0],[1,0,0,0,1],[0,0,1,0,0],[0,0,1,0,3]], start:[0,0], goal:[4,4], gems:[], maxBlocks:10, hint:'Find the gaps between the wall islands.' },
  { skill:'ccond', title:'Decision Maze', grid:[[4,0,0,0,0],[0,1,0,1,0],[0,0,0,0,0],[0,1,0,1,0],[0,0,0,0,3]], start:[0,0], goal:[4,4], gems:[], maxBlocks:8, hint:'Multiple correct paths exist!' },
  { skill:'ccond', title:'The Gauntlet', grid:[[4,0,1,0,0,0],[1,0,1,0,1,0],[0,0,0,0,1,0],[0,1,1,0,0,0],[0,0,0,1,0,1],[0,0,0,0,0,3]], start:[0,0], goal:[5,5], gems:[], maxBlocks:14, hint:'Navigate carefully through this challenging maze.' },

  // ============ VARIABLE LEVELS (12) ============
  // V1-V12: paths with gem counting
  { skill:'cvar', title:'Count the Gems', grid:[[4,2,2,3]], start:[0,0], goal:[0,3], gems:[[0,1],[0,2]], maxBlocks:3, hint:'How many gems will the robot collect? Go right 3 times.' },
  { skill:'cvar', title:'Gem Path', grid:[[4,2,0],[0,2,0],[0,2,3]], start:[0,0], goal:[2,2], gems:[[0,1],[1,1],[2,1]], maxBlocks:5, hint:'Collect all 3 gems on your path.' },
  { skill:'cvar', title:'Corner Gems', grid:[[4,0,2],[0,0,0],[2,0,3]], start:[0,0], goal:[2,2], gems:[[0,2],[2,0]], maxBlocks:6, hint:'You can only reach one corner gem. Which path to choose?' },
  { skill:'cvar', title:'Max Collection', grid:[[4,2,0,0],[0,2,2,0],[0,0,2,0],[0,0,0,3]], start:[0,0], goal:[3,3], gems:[[0,1],[1,1],[1,2],[2,2]], maxBlocks:7, hint:'Try to collect as many gems as possible.' },
  { skill:'cvar', title:'Gem Maze', grid:[[4,0,2,0],[1,0,1,0],[0,2,0,0],[0,0,2,3]], start:[0,0], goal:[3,3], gems:[[0,2],[2,1],[3,2]], maxBlocks:8, hint:'Navigate the maze and collect gems!' },
  { skill:'cvar', title:'Rich Path', grid:[[4,2,2,2,3]], start:[0,0], goal:[0,4], gems:[[0,1],[0,2],[0,3]], maxBlocks:4, hint:'Go right 4 times to collect all 3 gems.' },
  { skill:'cvar', title:'Diagonal Gems', grid:[[4,0,0,0],[0,2,0,0],[0,0,2,0],[0,0,0,3]], start:[0,0], goal:[3,3], gems:[[1,1],[2,2]], maxBlocks:6, hint:'The gems are on the diagonal!' },
  { skill:'cvar', title:'Scattered Treasure', grid:[[4,0,2,0,0],[0,0,0,0,2],[2,0,0,0,0],[0,0,2,0,0],[0,0,0,0,3]], start:[0,0], goal:[4,4], gems:[[0,2],[1,4],[2,0],[3,2]], maxBlocks:10, hint:'Not all gems are reachable. Prioritize your path!' },
  { skill:'cvar', title:'Gem Collector Pro', grid:[[4,2,0,2],[0,0,0,0],[2,0,0,2],[0,0,0,3]], start:[0,0], goal:[3,3], gems:[[0,1],[0,3],[2,0],[2,3]], maxBlocks:8, hint:'Plan a route that maximizes gem collection.' },
  { skill:'cvar', title:'Hidden Gems', grid:[[4,0,0,0,0],[0,1,2,1,0],[0,0,0,0,0],[0,1,2,1,0],[0,0,0,0,3]], start:[0,0], goal:[4,4], gems:[[1,2],[3,2]], maxBlocks:10, hint:'The gems are hidden behind walls. Find the gaps!' },
  { skill:'cvar', title:'Double Diamond', grid:[[4,0,0,0],[0,2,0,0],[0,0,0,0],[0,0,2,0],[0,0,0,3]], start:[0,0], goal:[4,3], gems:[[1,1],[3,2]], maxBlocks:8, hint:'Both gems are along a staircase path.' },
  { skill:'cvar', title:'Treasure Vault', grid:[[4,2,2,0,0],[0,0,0,0,0],[0,2,0,2,0],[0,0,0,0,0],[0,0,2,2,3]], start:[0,0], goal:[4,4], gems:[[0,1],[0,2],[2,1],[2,3],[4,2],[4,3]], maxBlocks:10, hint:'So many gems! Find the path that grabs the most.' },

  // ============ DEBUG LEVELS (12) ============
  // D1-D12: paths where you need to find the right route
  { skill:'cdebug', title:'Wrong Turn', grid:[[4,0,0],[1,0,0],[0,0,3]], start:[0,0], goal:[2,2], gems:[], maxBlocks:4, hint:'Going down first hits a wall!' },
  { skill:'cdebug', title:'Blocked Path', grid:[[4,0,1,0],[0,0,1,0],[0,0,0,3]], start:[0,0], goal:[2,3], gems:[], maxBlocks:6, hint:'The middle wall blocks a direct path.' },
  { skill:'cdebug', title:'Trap Avoidance', grid:[[4,0,0,0],[1,1,0,0],[0,0,0,1],[0,0,0,3]], start:[0,0], goal:[3,3], gems:[], maxBlocks:8, hint:'Watch for walls that trap you in corners.' },
  { skill:'cdebug', title:'Hidden Wall', grid:[[4,0,0,0],[0,0,1,0],[0,0,0,0],[0,1,0,3]], start:[0,0], goal:[3,3], gems:[], maxBlocks:7, hint:'The walls aren\'t where you expect.' },
  { skill:'cdebug', title:'One Way Out', grid:[[0,4,0],[1,0,1],[0,0,0],[0,1,0],[0,3,0]], start:[0,1], goal:[4,1], gems:[], maxBlocks:6, hint:'Only one path leads down through the gaps.' },
  { skill:'cdebug', title:'False Start', grid:[[4,1,0,0],[0,1,0,0],[0,0,0,1],[0,0,0,3]], start:[0,0], goal:[3,3], gems:[], maxBlocks:8, hint:'The obvious path right is blocked!' },
  { skill:'cdebug', title:'Maze Debug', grid:[[4,0,0,0,0],[1,1,0,1,0],[0,0,0,1,0],[0,1,0,0,0],[0,0,0,1,3]], start:[0,0], goal:[4,4], gems:[], maxBlocks:12, hint:'Trace the path carefully before coding.' },
  { skill:'cdebug', title:'Corner Trap', grid:[[4,0,0],[0,1,0],[0,0,3]], start:[0,0], goal:[2,2], gems:[], maxBlocks:4, hint:'The wall in the middle forces a specific path.' },
  { skill:'cdebug', title:'Double Wall', grid:[[4,0,0,0],[0,1,0,0],[0,1,0,0],[0,0,0,3]], start:[0,0], goal:[3,3], gems:[], maxBlocks:7, hint:'Two walls in a column \u2014 go around both.' },
  { skill:'cdebug', title:'Tricky Turns', grid:[[4,0,0,0,0],[0,0,1,1,0],[0,0,0,0,0],[0,1,1,0,0],[0,0,0,0,3]], start:[0,0], goal:[4,4], gems:[], maxBlocks:10, hint:'Plan your turns to avoid both wall sections.' },
  { skill:'cdebug', title:'Bug in the Walls', grid:[[4,0,1,0,0],[0,0,1,0,0],[0,0,0,0,1],[1,0,0,0,0],[0,0,0,0,3]], start:[0,0], goal:[4,4], gems:[], maxBlocks:10, hint:'The walls create a winding path.' },
  { skill:'cdebug', title:'Final Debug', grid:[[4,0,0,0,0,0],[1,1,0,1,1,0],[0,0,0,0,0,0],[0,1,1,0,1,1],[0,0,0,0,0,0],[0,0,1,0,0,3]], start:[0,0], goal:[5,5], gems:[], maxBlocks:14, hint:'This is the hardest maze. Plan every move!' }
];

// --- src/challenges/star-trials.js ---
// ============================================================
//  STAR TRIALS — Multi-skill challenge assessments
// ============================================================

var STAR_TRIALS = [
  {
    id: 'trial-math-p1',
    name: 'Math Foundations Trial',
    icon: '\u2795',
    desc: 'Prove your P1 Math mastery!',
    skills: ['count','add','sub','cmp'],
    questionsPerSkill: 2,
    unlockFlowers: 3,
    reward: 30
  },
  {
    id: 'trial-math-p2',
    name: 'Math Explorer Trial',
    icon: '\u2716\uFE0F',
    desc: 'Take on P2 multiplication and more!',
    skills: ['mul','div','frac1','money'],
    questionsPerSkill: 2,
    unlockFlowers: 8,
    reward: 50
  },
  {
    id: 'trial-word-p1',
    name: 'Word Foundations Trial',
    icon: '\uD83D\uDD24',
    desc: 'Show your phonics and spelling skills!',
    skills: ['phonics','sight','spell'],
    questionsPerSkill: 3,
    unlockFlowers: 3,
    reward: 30
  },
  {
    id: 'trial-word-p2',
    name: 'Word Explorer Trial',
    icon: '\uD83D\uDCDA',
    desc: 'Grammar, vocabulary, and reading!',
    skills: ['grammar','vocab','comprehension'],
    questionsPerSkill: 2,
    unlockFlowers: 8,
    reward: 50
  },
  {
    id: 'trial-stem',
    name: 'STEM Challenger Trial',
    icon: '\uD83E\uDDEA',
    desc: 'Science and coding combined!',
    skills: ['living','material','cseq','cloop'],
    questionsPerSkill: 2,
    unlockFlowers: 6,
    reward: 50
  },
  {
    id: 'trial-ultimate',
    name: 'Ultimate Star Trial',
    icon: '\uD83C\uDFC6',
    desc: 'The ultimate test across all worlds!',
    skills: ['add','mul','vocab','comprehension','living','cseq'],
    questionsPerSkill: 2,
    unlockFlowers: 15,
    reward: 100
  }
];

// Render trial cards for the home screen challenges section
function renderStarTrialCards(flowerCount) {
  var html = '';
  STAR_TRIALS.forEach(function(trial) {
    var unlocked = flowerCount >= trial.unlockFlowers;
    var completed = state.starTrials && state.starTrials[trial.id];
    var bestScore = completed ? state.starTrials[trial.id].best : 0;

    html += '<div class="activity-card ' + (unlocked ? '' : 'locked') + '" ' +
      (unlocked ? 'onclick="startStarTrial(\'' + trial.id + '\')"' : '') + '>';
    html += '<span class="activity-card-icon">' + trial.icon + '</span>';
    html += '<div class="activity-card-name">' + trial.name + '</div>';
    if (unlocked) {
      if (completed) {
        html += '<div class="activity-card-level" style="color:var(--gold)">Best: ' + bestScore + '%</div>';
      } else {
        html += '<div class="activity-card-level">' + trial.desc + '</div>';
      }
      html += '<div style="font-size:12px;color:var(--mint)">Reward: ' + trial.reward + ' \u2B50</div>';
    } else {
      html += '<div class="activity-card-level">\uD83D\uDD12 ' + trial.unlockFlowers + ' flowers needed</div>';
    }
    html += '</div>';
  });
  return html;
}

// Start a Star Trial
function startStarTrial(trialId) {
  var trial = STAR_TRIALS.find(function(t) { return t.id === trialId; });
  if (!trial) return;

  playSound('click');

  // Generate questions across all skills
  var questions = [];
  trial.skills.forEach(function(skillId) {
    for (var i = 0; i < trial.questionsPerSkill; i++) {
      // Determine world type
      var worldType = 'math';
      if (typeof WORD_TREE !== 'undefined' && WORD_TREE[skillId]) worldType = 'word';
      if (typeof STEM_TREE !== 'undefined' && STEM_TREE[skillId]) worldType = 'stem';

      var q = generateQuestion(skillId, worldType);
      q._trialSkillId = skillId;
      q._trialWorldType = worldType;
      questions.push(q);
    }
  });

  questions = shuffle(questions);

  // Use the standard game engine
  currentGame = {
    skillId: trial.skills[0],
    worldType: 'math',
    questions: questions,
    currentIndex: 0,
    totalQuestions: questions.length,
    results: [],
    currentConfidence: -1,
    hintShown: false,
    attempts: 0,
    isStarTrial: true,
    trialId: trialId,
    trialReward: trial.reward
  };

  document.getElementById('game-title').textContent = trial.icon + ' ' + trial.name;
  showScreen('game');
  renderGameDots();
  renderCurrentQuestion();
}

// Override endGame to handle Star Trial completion (called from navigation.js)
var _originalEndGame = typeof endGame === 'function' ? endGame : null;

function endGameWithTrialCheck() {
  if (currentGame.isStarTrial) {
    endStarTrial();
  } else if (_originalEndGame) {
    _originalEndGame();
  }
}

function endStarTrial() {
  var correct = currentGame.results.filter(function(r) { return r; }).length;
  var total = currentGame.results.length;
  var pct = Math.round(correct / total * 100);

  if (!state.starTrials) state.starTrials = {};
  var prev = state.starTrials[currentGame.trialId];

  if (!prev || pct > prev.best) {
    state.starTrials[currentGame.trialId] = { best: pct, date: Date.now() };
  }

  // Award tokens for first-time or new record
  if (pct >= 70) {
    var bonus = (!prev) ? currentGame.trialReward : (pct > (prev ? prev.best : 0) ? Math.round(currentGame.trialReward / 2) : 0);
    state.tokens += bonus;
  }

  state.sessionsCompleted++;

  var overlay = document.getElementById('feedback-overlay');
  var card = document.getElementById('feedback-card');

  var html = '';
  if (pct >= 80) {
    html += '<div class="feedback-icon">\uD83C\uDFC6</div>';
    html += '<div class="feedback-title" style="color:var(--gold)">Star Trial Complete!</div>';
    playSound('levelup');
    spawnParticles(window.innerWidth / 2, window.innerHeight / 3, 20, '\u2B50');
  } else if (pct >= 50) {
    html += '<div class="feedback-icon">\uD83C\uDF1F</div>';
    html += '<div class="feedback-title" style="color:var(--mint)">Good effort!</div>';
  } else {
    html += '<div class="feedback-icon">\uD83C\uDF31</div>';
    html += '<div class="feedback-title" style="color:var(--lavender)">Keep practising!</div>';
  }

  html += '<div class="feedback-message">' + correct + ' out of ' + total + ' correct (' + pct + '%)</div>';

  if (pct >= 70 && currentGame.trialReward > 0) {
    html += '<div class="feedback-tokens">\u2B50 +' + currentGame.trialReward + ' stars!</div>';
  }

  html += '<div style="display:flex;gap:12px;justify-content:center;margin-top:16px">';
  html += '<button class="feedback-btn" onclick="startStarTrial(\'' + currentGame.trialId + '\')" style="background:linear-gradient(135deg,var(--mint),var(--sky))">Try Again</button>';
  html += '<button class="feedback-btn" onclick="document.getElementById(\'feedback-overlay\').classList.add(\'hidden\');showScreen(\'home\')">Home</button>';
  html += '</div>';

  card.innerHTML = html;
  overlay.classList.remove('hidden');
  saveState();
}

// --- src/challenges/escape-rooms.js ---
// ============================================================
//  ESCAPE ROOMS — Timed multi-puzzle challenge rooms
// ============================================================

var ESCAPE_ROOMS = [
  {
    id: 'escape-treasure',
    name: 'Treasure Island',
    icon: '\uD83C\uDFDD\uFE0F',
    desc: 'Solve puzzles to find the hidden treasure!',
    unlockFlowers: 5,
    timeLimit: 300,
    rooms: [
      { type: 'math', skills: ['add','sub'], count: 2 },
      { type: 'word', skills: ['phonics','sight'], count: 2 },
      { type: 'riddle', riddle: 'I have keys but no locks. I have space but no room. You can enter but can\'t go inside. What am I?', answer: 'keyboard', options: ['keyboard','piano','door','house'] }
    ]
  },
  {
    id: 'escape-space',
    name: 'Space Station',
    icon: '\uD83D\uDE80',
    desc: 'Fix the spaceship before time runs out!',
    unlockFlowers: 10,
    timeLimit: 300,
    rooms: [
      { type: 'math', skills: ['mul','add100'], count: 2 },
      { type: 'stem', skills: ['material','forces'], count: 2 },
      { type: 'riddle', riddle: 'I orbit the Earth but I am not a satellite. I shine at night but I make no light of my own. What am I?', answer: 'The Moon', options: ['The Moon','A star','The Sun','A comet'] }
    ]
  },
  {
    id: 'escape-castle',
    name: 'Enchanted Castle',
    icon: '\uD83C\uDFF0',
    desc: 'Unlock rooms in the magical castle!',
    unlockFlowers: 12,
    timeLimit: 360,
    rooms: [
      { type: 'word', skills: ['vocab','grammar'], count: 2 },
      { type: 'math', skills: ['frac1','mul'], count: 2 },
      { type: 'stem', skills: ['living','earth'], count: 1 },
      { type: 'riddle', riddle: 'The more you take, the more you leave behind. What am I?', answer: 'Footsteps', options: ['Footsteps','Shadows','Memories','Time'] }
    ]
  },
  {
    id: 'escape-jungle',
    name: 'Jungle Expedition',
    icon: '\uD83C\uDF34',
    desc: 'Navigate through the dense jungle!',
    unlockFlowers: 15,
    timeLimit: 360,
    rooms: [
      { type: 'stem', skills: ['living','body'], count: 2 },
      { type: 'word', skills: ['comprehension','sentence'], count: 2 },
      { type: 'math', skills: ['area','advmul'], count: 2 },
      { type: 'riddle', riddle: 'I can fly without wings. I can cry without eyes. Wherever I go, darkness follows me. What am I?', answer: 'A cloud', options: ['A cloud','A bird','The wind','A ghost'] }
    ]
  },
  {
    id: 'escape-deepsea',
    name: 'Deep Sea Discovery',
    icon: '\uD83C\uDF0A',
    desc: 'Explore the ocean depths and surface!',
    unlockFlowers: 20,
    timeLimit: 360,
    rooms: [
      { type: 'stem', skills: ['earth','material'], count: 2 },
      { type: 'math', skills: ['sub','div'], count: 2 },
      { type: 'word', skills: ['vocab','spell'], count: 2 },
      { type: 'cipher', cipher: { text: 'XBUFS', shift: 1, answer: 'WATER' } },
      { type: 'riddle', riddle: 'I have a heart that doesn\'t beat. I have a mouth but don\'t eat. I have a bed but don\'t sleep. What am I?', answer: 'A river', options: ['A river','A mountain','A tree','A cave'] }
    ]
  },
  {
    id: 'escape-volcano',
    name: 'Volcano Escape',
    icon: '\uD83C\uDF0B',
    desc: 'Escape before the volcano erupts!',
    unlockFlowers: 25,
    timeLimit: 300,
    rooms: [
      { type: 'math', skills: ['add10k','sub10k'], count: 2 },
      { type: 'stem', skills: ['forces','earth'], count: 2 },
      { type: 'lock', lock: { q1: { text: 'What is 7 + 8?', answer: 15 }, q2: { text: 'What is 6 x 4?', answer: 24 }, q3: { text: 'What is 50 - 17?', answer: 33 } } },
      { type: 'riddle', riddle: 'I am not alive, but I grow. I don\'t have lungs, but I need air. I don\'t have a mouth, but water kills me. What am I?', answer: 'Fire', options: ['Fire','A plant','A cloud','A rock'] }
    ]
  }
];

// === ESCAPE ROOM STATE ===
var escapeState = {
  roomId: null,
  questions: [],
  currentIndex: 0,
  results: [],
  timer: null,
  timeLeft: 0,
  startTime: 0
};

// Render escape room cards for the home screen
function renderEscapeRoomCards(flowerCount) {
  var html = '';
  ESCAPE_ROOMS.forEach(function(room) {
    var unlocked = flowerCount >= room.unlockFlowers;
    var completed = state.escapeRooms && state.escapeRooms[room.id];
    var bestTime = completed ? state.escapeRooms[room.id].bestTime : null;

    html += '<div class="activity-card ' + (unlocked ? '' : 'locked') + '" ' +
      (unlocked ? 'onclick="startEscapeRoom(\'' + room.id + '\')"' : '') + '>';
    html += '<span class="activity-card-icon">' + room.icon + '</span>';
    html += '<div class="activity-card-name">' + room.name + '</div>';
    if (unlocked) {
      if (completed) {
        html += '<div class="activity-card-level" style="color:var(--gold)">Best: ' + formatTime(bestTime) + '</div>';
      } else {
        html += '<div class="activity-card-level">' + room.desc + '</div>';
      }
      html += '<div style="font-size:12px;color:var(--text-dim)">\u23F1 ' + Math.floor(room.timeLimit / 60) + ' min</div>';
    } else {
      html += '<div class="activity-card-level">\uD83D\uDD12 ' + room.unlockFlowers + ' flowers needed</div>';
    }
    html += '</div>';
  });
  return html;
}

function formatTime(seconds) {
  if (!seconds && seconds !== 0) return '--:--';
  var m = Math.floor(seconds / 60);
  var s = seconds % 60;
  return m + ':' + (s < 10 ? '0' : '') + s;
}

// Start an escape room
function startEscapeRoom(roomId) {
  var room = ESCAPE_ROOMS.find(function(r) { return r.id === roomId; });
  if (!room) return;

  playSound('click');

  // Generate all questions
  var questions = [];
  room.rooms.forEach(function(section) {
    if (section.type === 'riddle') {
      questions.push({
        type: 'escape-riddle',
        text: section.riddle,
        options: shuffle(section.options),
        answer: section.answer,
        hint: 'Think about it carefully. Read each word of the riddle.'
      });
    } else if (section.type === 'cipher') {
      questions.push({
        type: 'escape-cipher',
        cipherText: section.cipher.text,
        shift: section.cipher.shift,
        answer: section.cipher.answer,
        hint: 'Each letter is shifted by ' + section.cipher.shift + '. A becomes B, B becomes C, etc.'
      });
    } else if (section.type === 'lock') {
      questions.push({
        type: 'escape-lock',
        q1: section.lock.q1,
        q2: section.lock.q2,
        q3: section.lock.q3,
        answer: '' + section.lock.q1.answer + section.lock.q2.answer + section.lock.q3.answer,
        hint: 'Solve each mini-problem to get a digit of the code.'
      });
    } else {
      for (var i = 0; i < section.count; i++) {
        var skillId = pick(section.skills);
        var q = generateQuestion(skillId, section.type);
        questions.push(q);
      }
    }
  });

  escapeState = {
    roomId: roomId,
    questions: questions,
    currentIndex: 0,
    results: [],
    timer: null,
    timeLeft: room.timeLimit,
    startTime: Date.now()
  };

  document.getElementById('escape-title').textContent = room.icon + ' ' + room.name;
  showScreen('escape-room');
  renderEscapeProgress();
  startEscapeTimer();
  renderEscapeQuestion();
}

function startEscapeTimer() {
  updateTimerDisplay();
  escapeState.timer = setInterval(function() {
    escapeState.timeLeft--;
    updateTimerDisplay();
    if (escapeState.timeLeft <= 0) {
      clearInterval(escapeState.timer);
      endEscapeRoom(true);
    }
  }, 1000);
}

function updateTimerDisplay() {
  var el = document.getElementById('escape-timer');
  if (el) {
    el.textContent = formatTime(escapeState.timeLeft);
    if (escapeState.timeLeft <= 30) {
      el.style.color = 'var(--error)';
      el.style.animation = 'pulse-glow 0.5s ease-in-out infinite';
    } else if (escapeState.timeLeft <= 60) {
      el.style.color = 'var(--warning)';
    } else {
      el.style.color = 'var(--text-primary)';
      el.style.animation = '';
    }
  }
}

function renderEscapeProgress() {
  var el = document.getElementById('escape-progress');
  if (!el) return;
  var total = escapeState.questions.length;
  var html = '';
  for (var i = 0; i < total; i++) {
    var cls = 'game-dot';
    if (i < escapeState.currentIndex) cls += escapeState.results[i] ? ' done' : ' wrong';
    else if (i === escapeState.currentIndex) cls += ' current';
    html += '<div class="' + cls + '"></div>';
  }
  el.innerHTML = html;
}

function renderEscapeQuestion() {
  if (escapeState.currentIndex >= escapeState.questions.length) {
    endEscapeRoom(false);
    return;
  }

  var q = escapeState.questions[escapeState.currentIndex];
  var card = document.getElementById('escape-card');

  card.innerHTML = '';
  card.style.animation = 'none';
  card.offsetHeight;
  card.style.animation = 'slide-up 0.4s ease-out';

  if (q.type === 'escape-riddle') { renderEscapeRiddle(card, q); return; }
  if (q.type === 'escape-cipher') { renderEscapeCipher(card, q); return; }
  if (q.type === 'escape-lock') { renderEscapeLock(card, q); return; }

  // Use standard renderers
  if (typeof renderMathQuestion === 'function' && renderMathQuestion(card, q)) return;
  if (typeof renderWordQuestion === 'function' && renderWordQuestion(card, q)) return;
  if (typeof renderScienceQuestion === 'function' && renderScienceQuestion(card, q)) return;
  if (typeof renderCodeQuestion === 'function' && renderCodeQuestion(card, q)) return;

  // Fallback
  var html = '<div class="question-text">' + (q.text || 'Solve this!') + '</div>';
  if (q.options) {
    html += '<div class="answer-options">' + q.options.map(function(o) {
      return '<button class="answer-btn" onclick="escapeCheckAnswer(\'' + String(o).replace(/'/g, "\\'") + '\', \'' + String(q.answer).replace(/'/g, "\\'") + '\', this)">' + o + '</button>';
    }).join('') + '</div>';
  }
  card.innerHTML = html;
}

function renderEscapeRiddle(card, q) {
  var html = '<div style="font-size:36px;margin-bottom:8px">\uD83E\uDD14</div>';
  html += '<div class="question-text" style="font-size:18px">Riddle:</div>';
  html += '<div class="story-prompt" style="font-size:18px;font-style:italic;margin:12px 0">' + q.text + '</div>';
  html += '<div class="answer-options" style="flex-direction:column">' + q.options.map(function(o) {
    return '<button class="answer-btn" onclick="escapeCheckAnswer(\'' + String(o).replace(/'/g, "\\'") + '\', \'' + String(q.answer).replace(/'/g, "\\'") + '\', this)" style="font-size:18px;width:100%">' + o + '</button>';
  }).join('') + '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
}

// === CIPHER PUZZLE RENDERER ===
function renderEscapeCipher(card, q) {
  var html = '<div style="font-size:36px;margin-bottom:8px">\uD83D\uDD10</div>';
  html += '<div class="question-text" style="font-size:18px">Crack the Code!</div>';
  html += '<div style="font-size:14px;color:var(--text-secondary);margin:8px 0">Each letter has been shifted forward by ' + q.shift + '. Decode the secret word!</div>';

  // Show cipher text as letter tiles
  html += '<div style="display:flex;gap:6px;justify-content:center;margin:16px 0">';
  for (var i = 0; i < q.cipherText.length; i++) {
    html += '<div style="width:42px;height:48px;background:rgba(255,255,255,0.1);border:2px solid var(--gold);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:700;color:var(--gold)">' + q.cipherText[i] + '</div>';
  }
  html += '</div>';

  // Alphabet reference
  html += '<div style="font-size:12px;color:var(--text-dim);margin:8px 0">A B C D E F G H I J K L M N O P Q R S T U V W X Y Z</div>';

  // Input
  html += '<div class="text-input-area">';
  html += '<input class="text-input" type="text" id="cipher-input" placeholder="Type the decoded word..." maxlength="' + q.cipherText.length + '" autocomplete="off" autocapitalize="characters" style="font-size:22px;letter-spacing:6px;text-align:center;text-transform:uppercase" onkeydown="if(event.key===\'Enter\')checkCipher()">';
  html += '<button class="submit-btn" onclick="checkCipher()">Decode \u2713</button>';
  html += '</div>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
  card.dataset.cipherAnswer = q.answer;
  setTimeout(function() { var el = document.getElementById('cipher-input'); if (el) el.focus(); }, 100);
}

function checkCipher() {
  var input = document.getElementById('cipher-input');
  var card = document.getElementById('escape-card');
  if (!input || !card) return;
  var val = input.value.trim().toUpperCase();
  var expected = card.dataset.cipherAnswer;
  if (val === expected) {
    input.style.borderColor = 'var(--success)';
    escapeCheckAnswer(val, expected, null);
  } else {
    input.style.borderColor = 'var(--error)';
    input.style.animation = 'shake-wrong 0.5s';
    if (val.length === expected.length) {
      escapeCheckAnswer(val, expected, null);
    }
  }
}

// === LOCK COMBINATION PUZZLE RENDERER ===
function renderEscapeLock(card, q) {
  var html = '<div style="font-size:36px;margin-bottom:8px">\uD83D\uDD12</div>';
  html += '<div class="question-text" style="font-size:18px">Crack the Lock!</div>';
  html += '<div style="font-size:14px;color:var(--text-secondary);margin:8px 0">Solve each problem to find the combination!</div>';

  // Three combination slots
  html += '<div style="display:flex;gap:12px;justify-content:center;margin:16px 0;align-items:flex-end">';

  var questions = [q.q1, q.q2, q.q3];
  questions.forEach(function(sub, idx) {
    html += '<div style="text-align:center">';
    html += '<div style="font-size:13px;color:var(--text-secondary);margin-bottom:6px">' + sub.text + '</div>';
    html += '<input type="number" id="lock-input-' + idx + '" class="text-input" style="width:60px;font-size:24px;text-align:center;padding:8px" maxlength="4">';
    html += '</div>';
  });

  html += '</div>';

  html += '<button class="submit-btn mt-2" onclick="checkLock()">Unlock \uD83D\uDD13</button>';
  html += renderHintBtn(q.hint);
  card.innerHTML = html;
  card.dataset.lockAnswer = q.answer;
  setTimeout(function() { var el = document.getElementById('lock-input-0'); if (el) el.focus(); }, 100);
}

function checkLock() {
  var card = document.getElementById('escape-card');
  if (!card) return;
  var val = '';
  for (var i = 0; i < 3; i++) {
    var input = document.getElementById('lock-input-' + i);
    val += (input ? input.value.trim() : '');
  }
  var expected = card.dataset.lockAnswer;
  if (val === expected) {
    escapeCheckAnswer(val, expected, null);
  } else {
    // Shake all inputs
    for (var j = 0; j < 3; j++) {
      var inp = document.getElementById('lock-input-' + j);
      if (inp) {
        inp.style.borderColor = 'var(--error)';
        inp.style.animation = 'shake-wrong 0.5s';
      }
    }
    escapeCheckAnswer(val, expected, null);
  }
}

// Override answer checking for escape rooms
var _origCheckAnswer = typeof checkAnswer === 'function' ? checkAnswer : null;
var _origSubmitText = typeof submitTextAnswer === 'function' ? submitTextAnswer : null;

function escapeCheckAnswer(given, correct, btnEl) {
  if (btnEl && btnEl.dataset.checked) return;
  var allBtns = btnEl ? btnEl.parentElement.querySelectorAll('.answer-btn') : [];
  allBtns.forEach(function(b) { b.dataset.checked = 'true'; });

  var isCorrect = String(given) === String(correct);
  escapeState.results[escapeState.currentIndex] = isCorrect;

  if (isCorrect) {
    if (btnEl) btnEl.classList.add('correct');
    playSound('correct');
    spawnParticles(window.innerWidth / 2, window.innerHeight / 3, 5, '\u2B50');
  } else {
    if (btnEl) btnEl.classList.add('wrong');
    playSound('wrong');
  }

  setTimeout(function() {
    escapeState.currentIndex++;
    renderEscapeProgress();
    renderEscapeQuestion();
  }, isCorrect ? 800 : 1200);
}

function endEscapeRoom(timedOut) {
  if (escapeState.timer) clearInterval(escapeState.timer);

  var correct = escapeState.results.filter(function(r) { return r; }).length;
  var total = escapeState.questions.length;
  var pct = total > 0 ? Math.round(correct / total * 100) : 0;
  var elapsed = Math.round((Date.now() - escapeState.startTime) / 1000);

  // Save best time
  if (!state.escapeRooms) state.escapeRooms = {};
  if (pct >= 70) {
    var prev = state.escapeRooms[escapeState.roomId];
    if (!prev || elapsed < prev.bestTime) {
      state.escapeRooms[escapeState.roomId] = { bestTime: elapsed, best: pct, date: Date.now() };
    }
  }

  // Award tokens
  var reward = 0;
  if (!timedOut && pct >= 70) {
    reward = 25 + Math.round((pct - 70) / 10) * 5;
    state.tokens += reward;
  }

  var overlay = document.getElementById('feedback-overlay');
  var card = document.getElementById('feedback-card');

  var html = '';
  if (timedOut) {
    html += '<div class="feedback-icon">\u23F0</div>';
    html += '<div class="feedback-title" style="color:var(--warning)">Time\'s Up!</div>';
  } else if (pct >= 80) {
    html += '<div class="feedback-icon">\uD83D\uDD13</div>';
    html += '<div class="feedback-title" style="color:var(--gold)">Escaped!</div>';
    playSound('levelup');
    spawnParticles(window.innerWidth / 2, window.innerHeight / 3, 15, '\uD83C\uDF89');
  } else if (pct >= 50) {
    html += '<div class="feedback-icon">\uD83D\uDE4C</div>';
    html += '<div class="feedback-title" style="color:var(--mint)">Almost there!</div>';
  } else {
    html += '<div class="feedback-icon">\uD83D\uDD12</div>';
    html += '<div class="feedback-title" style="color:var(--lavender)">Try again!</div>';
  }

  html += '<div class="feedback-message">' + correct + '/' + total + ' puzzles solved';
  if (!timedOut) html += ' in ' + formatTime(elapsed);
  html += '</div>';

  if (reward > 0) {
    html += '<div class="feedback-tokens">\u2B50 +' + reward + ' stars!</div>';
  }

  html += '<div style="display:flex;gap:12px;justify-content:center;margin-top:16px">';
  html += '<button class="feedback-btn" onclick="startEscapeRoom(\'' + escapeState.roomId + '\')" style="background:linear-gradient(135deg,var(--mint),var(--sky))">Retry</button>';
  html += '<button class="feedback-btn" onclick="document.getElementById(\'feedback-overlay\').classList.add(\'hidden\');showScreen(\'home\')">Home</button>';
  html += '</div>';

  card.innerHTML = html;
  overlay.classList.remove('hidden');
  saveState();
}

// Patch the global checkAnswer/submitTextAnswer to handle escape rooms
(function() {
  var origCheck = typeof checkAnswer === 'function' ? checkAnswer : function() {};
  var origSubmit = typeof submitTextAnswer === 'function' ? submitTextAnswer : function() {};

  // Only intercept when in escape room screen
  var _prevCheckAnswer = window.checkAnswer;
  var _prevSubmitText = window.submitTextAnswer;

  window.checkAnswer = function(given, correct, btnEl) {
    var escScreen = document.getElementById('screen-escape-room');
    if (escScreen && escScreen.classList.contains('active')) {
      escapeCheckAnswer(String(given), String(correct), btnEl);
    } else {
      _prevCheckAnswer(given, correct, btnEl);
    }
  };

  window.submitTextAnswer = function(correct) {
    var escScreen = document.getElementById('screen-escape-room');
    if (escScreen && escScreen.classList.contains('active')) {
      var input = document.getElementById('answer-input');
      if (!input) return;
      var val = parseInt(input.value);
      if (isNaN(val)) return;
      escapeCheckAnswer(String(val), String(correct), null);
      if (String(val) === String(correct)) {
        input.style.borderColor = 'var(--success)';
      } else {
        input.style.borderColor = 'var(--error)';
        input.style.animation = 'shake-wrong 0.5s';
      }
    } else {
      _prevSubmitText(correct);
    }
  };
})();

// --- src/core/interactive-sims.js ---
// ============================================================
//  INTERACTIVE SIMS — Rich canvas-like simulations for learning
// ============================================================
// Upgrades the emoji-based illustrations to proper interactive
// visual simulations using HTML/CSS (no canvas dependency)

// === FRACTION VISUALISER ===
// Renders an interactive fraction bar or pie that can be manipulated

function renderFractionVisual(container, numerator, denominator, type) {
  type = type || 'bar';
  var html = '<div class="sim-fraction-visual">';

  if (type === 'bar') {
    html += '<div class="sim-fraction-bar">';
    for (var i = 0; i < denominator; i++) {
      var filled = i < numerator;
      html += '<div class="sim-fraction-piece' + (filled ? ' filled' : '') + '" ' +
        'style="width:' + (100 / denominator) + '%" ' +
        'onclick="simFractionToggle(this)">' +
        '<span>' + (i + 1) + '</span>' +
        '</div>';
    }
    html += '</div>';
    html += '<div class="sim-fraction-label" id="sim-frac-label">' + numerator + '/' + denominator + '</div>';
  } else {
    // Pie chart using conic-gradient
    var deg = (numerator / denominator) * 360;
    html += '<div class="sim-fraction-pie" style="background:conic-gradient(var(--gold) 0deg ' + deg + 'deg, rgba(255,255,255,0.1) ' + deg + 'deg 360deg)">';
    html += '<div class="sim-fraction-pie-inner">' + numerator + '/' + denominator + '</div>';
    html += '</div>';
    // Denominator lines
    html += '<div class="sim-fraction-pie-lines">';
    for (var j = 0; j < denominator; j++) {
      var angle = (j / denominator) * 360;
      html += '<div class="sim-pie-line" style="transform:rotate(' + angle + 'deg)"></div>';
    }
    html += '</div>';
  }

  html += '</div>';
  container.innerHTML += html;
}

function simFractionToggle(el) {
  el.classList.toggle('filled');
  // Update label
  var bar = el.parentElement;
  var filled = bar.querySelectorAll('.filled').length;
  var total = bar.children.length;
  var label = document.getElementById('sim-frac-label');
  if (label) label.textContent = filled + '/' + total;
}

// === NUMBER LINE ===
// Interactive number line with draggable marker

function renderNumberLine(container, min, max, targetValue, label) {
  var range = max - min;
  var steps = Math.min(range, 20);
  var stepSize = range / steps;

  var html = '<div class="sim-numberline-wrap">';
  if (label) html += '<div class="sim-numberline-label">' + label + '</div>';
  html += '<div class="sim-numberline" id="sim-numberline">';

  // Track
  html += '<div class="sim-nl-track">';
  for (var i = 0; i <= steps; i++) {
    var val = min + Math.round(i * stepSize);
    var pct = (i / steps) * 100;
    var isMajor = i === 0 || i === steps || i % 5 === 0;
    html += '<div class="sim-nl-tick' + (isMajor ? ' major' : '') + '" style="left:' + pct + '%">';
    if (isMajor) html += '<span>' + val + '</span>';
    html += '</div>';
  }
  html += '</div>';

  // Draggable marker
  var targetPct = ((targetValue - min) / range) * 100;
  html += '<div class="sim-nl-marker" id="sim-nl-marker" style="left:' + targetPct + '%">';
  html += '<div class="sim-nl-marker-head">\u25BC</div>';
  html += '<div class="sim-nl-marker-value" id="sim-nl-value">' + targetValue + '</div>';
  html += '</div>';

  html += '</div>';
  html += '</div>';
  container.innerHTML += html;
}

// === PLACE VALUE BLOCKS ===
// Visual hundreds/tens/ones blocks

function renderPlaceValueBlocks(container, number) {
  var hundreds = Math.floor(number / 100);
  var tens = Math.floor((number % 100) / 10);
  var ones = number % 10;

  var html = '<div class="sim-pv-blocks">';

  // Hundreds
  if (hundreds > 0) {
    html += '<div class="sim-pv-group">';
    html += '<div class="sim-pv-group-label">Hundreds</div>';
    for (var h = 0; h < hundreds; h++) {
      html += '<div class="sim-pv-block hundred" title="100">';
      // 10x10 grid
      for (var r = 0; r < 10; r++) {
        for (var c = 0; c < 10; c++) {
          html += '<div class="sim-pv-unit"></div>';
        }
      }
      html += '</div>';
    }
    html += '</div>';
  }

  // Tens
  if (tens > 0) {
    html += '<div class="sim-pv-group">';
    html += '<div class="sim-pv-group-label">Tens</div>';
    for (var t = 0; t < tens; t++) {
      html += '<div class="sim-pv-block ten" title="10">';
      for (var u = 0; u < 10; u++) {
        html += '<div class="sim-pv-unit"></div>';
      }
      html += '</div>';
    }
    html += '</div>';
  }

  // Ones
  if (ones > 0) {
    html += '<div class="sim-pv-group">';
    html += '<div class="sim-pv-group-label">Ones</div>';
    for (var o = 0; o < ones; o++) {
      html += '<div class="sim-pv-block one" title="1"><div class="sim-pv-unit"></div></div>';
    }
    html += '</div>';
  }

  html += '<div class="sim-pv-total">' + number + '</div>';
  html += '</div>';
  container.innerHTML += html;
}

// === BALANCE SCALE ===
// Visual balance for equation solving

function renderBalanceScale(container, leftVal, rightVal, leftLabel, rightLabel) {
  var diff = leftVal - rightVal;
  var tilt = clamp(diff * 3, -15, 15); // degrees

  var html = '<div class="sim-balance">';
  html += '<div class="sim-balance-base">';
  html += '<div class="sim-balance-pillar"></div>';
  html += '<div class="sim-balance-beam" style="transform:rotate(' + tilt + 'deg)">';

  // Left pan
  html += '<div class="sim-balance-pan left">';
  html += '<div class="sim-balance-pan-label">' + (leftLabel || leftVal) + '</div>';
  html += '<div class="sim-balance-pan-val">' + leftVal + '</div>';
  html += '</div>';

  // Right pan
  html += '<div class="sim-balance-pan right">';
  html += '<div class="sim-balance-pan-label">' + (rightLabel || rightVal) + '</div>';
  html += '<div class="sim-balance-pan-val">' + rightVal + '</div>';
  html += '</div>';

  html += '</div>'; // beam
  html += '</div>'; // base

  var status = diff === 0 ? 'Balanced! \u2696\uFE0F' : (diff > 0 ? 'Left is heavier' : 'Right is heavier');
  html += '<div class="sim-balance-status">' + status + '</div>';
  html += '</div>';
  container.innerHTML += html;
}

// === CLOCK FACE ===
// SVG clock face for time-telling

function renderClockFace(container, hours, minutes, interactive) {
  var hourAngle = ((hours % 12) + minutes / 60) * 30; // 360/12 = 30 per hour
  var minAngle = minutes * 6; // 360/60 = 6 per minute

  var html = '<div class="sim-clock-wrap">';
  html += '<svg class="sim-clock" viewBox="0 0 200 200" width="180" height="180">';

  // Face
  html += '<circle cx="100" cy="100" r="95" fill="#1a1a3e" stroke="var(--gold)" stroke-width="3"/>';

  // Hour marks
  for (var i = 1; i <= 12; i++) {
    var a = (i * 30 - 90) * Math.PI / 180;
    var x = 100 + 78 * Math.cos(a);
    var y = 100 + 78 * Math.sin(a);
    html += '<text x="' + x + '" y="' + (y + 5) + '" text-anchor="middle" fill="var(--text-primary)" font-size="14" font-weight="700">' + i + '</text>';
  }

  // Minute ticks
  for (var m = 0; m < 60; m++) {
    var am = (m * 6 - 90) * Math.PI / 180;
    var inner = m % 5 === 0 ? 82 : 88;
    var x1 = 100 + inner * Math.cos(am);
    var y1 = 100 + inner * Math.sin(am);
    var x2 = 100 + 92 * Math.cos(am);
    var y2 = 100 + 92 * Math.sin(am);
    html += '<line x1="' + x1 + '" y1="' + y1 + '" x2="' + x2 + '" y2="' + y2 + '" stroke="rgba(255,255,255,0.3)" stroke-width="' + (m % 5 === 0 ? 2 : 1) + '"/>';
  }

  // Hour hand
  var ha = (hourAngle - 90) * Math.PI / 180;
  var hx = 100 + 50 * Math.cos(ha);
  var hy = 100 + 50 * Math.sin(ha);
  html += '<line x1="100" y1="100" x2="' + hx + '" y2="' + hy + '" stroke="var(--gold)" stroke-width="5" stroke-linecap="round"/>';

  // Minute hand
  var ma = (minAngle - 90) * Math.PI / 180;
  var mx = 100 + 70 * Math.cos(ma);
  var my = 100 + 70 * Math.sin(ma);
  html += '<line x1="100" y1="100" x2="' + mx + '" y2="' + my + '" stroke="var(--mint)" stroke-width="3" stroke-linecap="round"/>';

  // Center dot
  html += '<circle cx="100" cy="100" r="5" fill="var(--gold)"/>';

  html += '</svg>';

  // Time display
  var hStr = hours < 10 ? '0' + hours : hours;
  var mStr = minutes < 10 ? '0' + minutes : minutes;
  html += '<div class="sim-clock-time">' + hStr + ':' + mStr + '</div>';

  html += '</div>';
  container.innerHTML += html;
}

// === ARRAY VISUALISER ===
// For multiplication — shows rows x columns of dots

function renderArrayVisual(container, rows, cols, label) {
  var html = '<div class="sim-array-wrap">';
  if (label) html += '<div class="sim-array-label">' + label + '</div>';
  html += '<div class="sim-array-grid" style="grid-template-columns:repeat(' + cols + ', 1fr)">';

  for (var r = 0; r < rows; r++) {
    for (var c = 0; c < cols; c++) {
      html += '<div class="sim-array-dot" style="animation-delay:' + ((r * cols + c) * 0.03) + 's"></div>';
    }
  }

  html += '</div>';
  html += '<div class="sim-array-equation">' + rows + ' \u00D7 ' + cols + ' = ' + (rows * cols) + '</div>';
  html += '</div>';
  container.innerHTML += html;
}

// === BAR MODEL (enhanced) ===
// Proper bar model for word problems

function renderEnhancedBarModel(container, parts, whole, unknownIndex) {
  var html = '<div class="sim-barmodel">';

  // Whole bar
  html += '<div class="sim-barmodel-whole">';
  html += '<div class="sim-barmodel-whole-label">' + (whole !== null ? whole : '?') + '</div>';
  html += '</div>';

  // Parts
  html += '<div class="sim-barmodel-parts">';
  parts.forEach(function(p, i) {
    var widthPct = whole ? (p.value / whole * 100) : (100 / parts.length);
    var isUnknown = (i === unknownIndex);
    html += '<div class="sim-barmodel-part' + (isUnknown ? ' unknown' : '') + '" style="width:' + widthPct + '%">';
    html += '<span>' + (isUnknown ? '?' : p.value) + '</span>';
    if (p.label) html += '<div class="sim-barmodel-part-label">' + p.label + '</div>';
    html += '</div>';
  });
  html += '</div>';

  html += '</div>';
  container.innerHTML += html;
}

// === RAMP / FORCES SIMULATOR (enhanced) ===
// Proper sliding object with angle and friction controls

function renderRampSim(container, questionData) {
  var html = '<div class="sim-ramp-wrap" id="sim-ramp">';

  // Controls
  html += '<div class="sim-ramp-controls">';
  html += '<div class="sim-ramp-control">';
  html += '<label>Angle: <span id="ramp-angle-val">30</span>\u00B0</label>';
  html += '<input type="range" min="5" max="60" value="30" oninput="simRampUpdate()" id="ramp-angle-slider" class="sim-slider">';
  html += '</div>';
  html += '<div class="sim-ramp-control">';
  html += '<label>Push force: <span id="ramp-push-val">0</span></label>';
  html += '<input type="range" min="0" max="10" value="0" oninput="simRampUpdate()" id="ramp-push-slider" class="sim-slider">';
  html += '</div>';
  html += '<div class="sim-ramp-control">';
  html += '<label>Surface:</label>';
  html += '<select id="ramp-surface" onchange="simRampUpdate()" class="sim-select">';
  html += '<option value="0.1">Ice (slippery)</option>';
  html += '<option value="0.3" selected>Wood (medium)</option>';
  html += '<option value="0.6">Carpet (rough)</option>';
  html += '<option value="0.9">Sandpaper (very rough)</option>';
  html += '</select>';
  html += '</div>';
  html += '</div>';

  // Visual ramp
  html += '<div class="sim-ramp-scene">';
  html += '<svg viewBox="0 0 300 180" class="sim-ramp-svg" id="ramp-svg">';

  // Ground
  html += '<line x1="0" y1="170" x2="300" y2="170" stroke="rgba(255,255,255,0.2)" stroke-width="2"/>';

  // Ramp (recalculated on update)
  html += '<polygon id="ramp-triangle" points="30,170 250,170 250,50" fill="rgba(255,255,255,0.08)" stroke="var(--text-dim)" stroke-width="2"/>';

  // Object on ramp
  html += '<rect id="ramp-object" x="120" y="90" width="24" height="24" rx="4" fill="var(--gold)" stroke="rgba(255,215,0,0.5)" stroke-width="1"/>';

  // Force arrows
  html += '<line id="ramp-arrow-push" x1="100" y1="102" x2="120" y2="102" stroke="var(--mint)" stroke-width="3" marker-end="url(#arrowhead)" opacity="0"/>';
  html += '<line id="ramp-arrow-gravity" x1="132" y1="114" x2="132" y2="140" stroke="var(--coral)" stroke-width="2" marker-end="url(#arrowhead-red)"/>';
  html += '<line id="ramp-arrow-friction" x1="144" y1="102" x2="160" y2="102" stroke="var(--warning)" stroke-width="2" opacity="0.5"/>';

  // Arrow markers
  html += '<defs>';
  html += '<marker id="arrowhead" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="var(--mint)"/></marker>';
  html += '<marker id="arrowhead-red" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="var(--coral)"/></marker>';
  html += '</defs>';

  html += '</svg>';
  html += '</div>';

  // Result
  html += '<div class="sim-ramp-result" id="ramp-result">Adjust the controls and watch the forces!</div>';
  html += '<button class="answer-btn" style="margin:8px auto;display:block" onclick="simRampGo()">Push! \u25B6</button>';

  html += '</div>';
  container.innerHTML += html;
}

function simRampUpdate() {
  var angle = parseInt(document.getElementById('ramp-angle-slider').value);
  var push = parseInt(document.getElementById('ramp-push-slider').value);
  document.getElementById('ramp-angle-val').textContent = angle;
  document.getElementById('ramp-push-val').textContent = push;

  // Update triangle shape
  var rampHeight = 170 - (120 * Math.sin(angle * Math.PI / 180));
  var tri = document.getElementById('ramp-triangle');
  if (tri) tri.setAttribute('points', '30,170 250,170 250,' + Math.round(rampHeight));

  // Show push arrow if force > 0
  var pushArrow = document.getElementById('ramp-arrow-push');
  if (pushArrow) pushArrow.style.opacity = push > 0 ? '1' : '0';
}

function simRampGo() {
  var angle = parseInt(document.getElementById('ramp-angle-slider').value);
  var push = parseInt(document.getElementById('ramp-push-slider').value);
  var friction = parseFloat(document.getElementById('ramp-surface').value);

  var gravity = Math.sin(angle * Math.PI / 180) * 10;
  var frictionForce = Math.cos(angle * Math.PI / 180) * friction * 10;
  var net = gravity + push - frictionForce;

  var result = document.getElementById('ramp-result');
  var obj = document.getElementById('ramp-object');

  if (net > 1) {
    result.textContent = 'The object slides DOWN! (gravity + push > friction)';
    result.style.color = 'var(--mint)';
    if (obj) {
      obj.style.transition = 'transform 1s ease-in';
      obj.style.transform = 'translate(60px, 40px)';
    }
  } else if (net < -1) {
    result.textContent = 'Friction holds! The object stays put.';
    result.style.color = 'var(--warning)';
    if (obj) { obj.style.transition = 'transform 0.3s'; obj.style.transform = 'translate(0,0)'; }
  } else {
    result.textContent = 'Just barely balanced! The forces are almost equal.';
    result.style.color = 'var(--gold)';
    if (obj) {
      obj.style.transition = 'transform 0.5s';
      obj.style.transform = 'translate(3px, 2px)';
      setTimeout(function() { obj.style.transform = 'translate(0,0)'; }, 500);
    }
  }

  if (typeof playSound === 'function') playSound('click');
}

// === LIFECYCLE DRAG-AND-DROP ===
// Renders lifecycle stages to be ordered

function renderLifecycleSim(container, organism, stages, correctOrder) {
  var shuffled = shuffle(stages.slice());

  var html = '<div class="sim-lifecycle-wrap">';
  html += '<div class="sim-lifecycle-title">Lifecycle of a ' + organism + '</div>';

  // Drop zones (numbered slots)
  html += '<div class="sim-lifecycle-slots" id="lifecycle-slots">';
  for (var i = 0; i < correctOrder.length; i++) {
    html += '<div class="sim-lifecycle-slot" data-index="' + i + '">';
    html += '<div class="sim-slot-number">' + (i + 1) + '</div>';
    html += '<div class="sim-slot-label" id="slot-label-' + i + '">?</div>';
    html += '</div>';
    if (i < correctOrder.length - 1) {
      html += '<div class="sim-lifecycle-arrow">\u27A1\uFE0F</div>';
    }
  }
  html += '</div>';

  // Draggable stages
  html += '<div class="sim-lifecycle-bank" id="lifecycle-bank">';
  shuffled.forEach(function(stage) {
    html += '<button class="sim-lifecycle-item" onclick="lifecyclePlace(this, \'' + stage.id + '\', \'' + stage.label.replace(/'/g, "\\'") + '\')">';
    html += '<div style="font-size:28px">' + stage.emoji + '</div>';
    html += '<div style="font-size:12px">' + stage.label + '</div>';
    html += '</button>';
  });
  html += '</div>';

  html += '<button class="submit-btn mt-2" onclick="checkLifecycle()" style="margin:12px auto;display:block">Check Order \u2713</button>';
  html += '</div>';

  container.innerHTML += html;
  container.dataset.lifecycleOrder = JSON.stringify(correctOrder);
  container.dataset.lifecyclePlaced = JSON.stringify([]);
}

var _lifecycleCurrent = 0;
function lifecyclePlace(btn, id, label) {
  var placed = JSON.parse(document.getElementById('question-card').dataset.lifecyclePlaced || '[]');
  if (placed.length >= parseInt(document.getElementById('question-card').dataset.lifecycleOrder ? JSON.parse(document.getElementById('question-card').dataset.lifecycleOrder).length : 4)) return;

  placed.push(id);
  document.getElementById('question-card').dataset.lifecyclePlaced = JSON.stringify(placed);

  var slotLabel = document.getElementById('slot-label-' + (placed.length - 1));
  if (slotLabel) {
    slotLabel.textContent = label;
    slotLabel.style.color = 'var(--text-primary)';
  }

  btn.style.opacity = '0.3';
  btn.style.pointerEvents = 'none';
  if (typeof playSound === 'function') playSound('click');
}

function checkLifecycle() {
  var card = document.getElementById('question-card');
  var correct = JSON.parse(card.dataset.lifecycleOrder || '[]');
  var placed = JSON.parse(card.dataset.lifecyclePlaced || '[]');

  if (placed.length < correct.length) {
    if (typeof lumiSay === 'function') lumiSay('Place all the stages first!');
    return;
  }

  var allRight = true;
  for (var i = 0; i < correct.length; i++) {
    if (placed[i] !== correct[i]) { allRight = false; break; }
  }

  if (allRight) {
    if (typeof handleCorrect === 'function') handleCorrect();
  } else {
    if (typeof handleWrong === 'function') handleWrong('Try again — think about what comes first!');
    // Reset
    card.dataset.lifecyclePlaced = JSON.stringify([]);
    for (var j = 0; j < correct.length; j++) {
      var sl = document.getElementById('slot-label-' + j);
      if (sl) { sl.textContent = '?'; sl.style.color = ''; }
    }
    var bank = document.getElementById('lifecycle-bank');
    if (bank) {
      bank.querySelectorAll('.sim-lifecycle-item').forEach(function(b) {
        b.style.opacity = '1';
        b.style.pointerEvents = '';
      });
    }
  }
}

// === ENERGY CHAIN BUILDER ===
// Connect energy transformations

function renderEnergyChain(container, steps, correctChain) {
  var shuffled = shuffle(steps.slice());

  var html = '<div class="sim-energy-wrap">';
  html += '<div class="sim-energy-title">\u26A1 Energy Transformation Chain</div>';
  html += '<div class="sim-energy-chain" id="energy-chain">';
  for (var i = 0; i < correctChain.length; i++) {
    html += '<div class="sim-energy-slot" id="energy-slot-' + i + '">';
    html += '<div class="sim-energy-slot-label">Step ' + (i + 1) + '</div>';
    html += '<div class="sim-energy-slot-val" id="energy-val-' + i + '">?</div>';
    html += '</div>';
    if (i < correctChain.length - 1) {
      html += '<div class="sim-energy-arrow">\u27A1\uFE0F</div>';
    }
  }
  html += '</div>';

  html += '<div class="sim-energy-bank" id="energy-bank">';
  shuffled.forEach(function(step) {
    html += '<button class="sim-energy-item" onclick="energyPlace(this, \'' + step.id + '\', \'' + step.label.replace(/'/g, "\\'") + '\')">';
    html += step.emoji + ' ' + step.label;
    html += '</button>';
  });
  html += '</div>';

  html += '<button class="submit-btn mt-2" onclick="checkEnergyChain()" style="margin:12px auto;display:block">Check Chain \u2713</button>';
  html += '</div>';

  container.innerHTML += html;
  container.dataset.energyCorrect = JSON.stringify(correctChain);
  container.dataset.energyPlaced = JSON.stringify([]);
}

function energyPlace(btn, id, label) {
  var card = document.getElementById('question-card');
  var placed = JSON.parse(card.dataset.energyPlaced || '[]');
  var correct = JSON.parse(card.dataset.energyCorrect || '[]');
  if (placed.length >= correct.length) return;

  placed.push(id);
  card.dataset.energyPlaced = JSON.stringify(placed);

  var valEl = document.getElementById('energy-val-' + (placed.length - 1));
  if (valEl) valEl.textContent = label;

  btn.style.opacity = '0.3';
  btn.style.pointerEvents = 'none';
  if (typeof playSound === 'function') playSound('click');
}

function checkEnergyChain() {
  var card = document.getElementById('question-card');
  var correct = JSON.parse(card.dataset.energyCorrect || '[]');
  var placed = JSON.parse(card.dataset.energyPlaced || '[]');

  if (placed.length < correct.length) {
    if (typeof lumiSay === 'function') lumiSay('Connect all the steps!');
    return;
  }

  var allRight = placed.every(function(id, i) { return id === correct[i]; });
  if (allRight) {
    if (typeof handleCorrect === 'function') handleCorrect();
  } else {
    if (typeof handleWrong === 'function') handleWrong('Think about how energy changes form!');
    card.dataset.energyPlaced = JSON.stringify([]);
    for (var j = 0; j < correct.length; j++) {
      var v = document.getElementById('energy-val-' + j);
      if (v) v.textContent = '?';
    }
    var bank = document.getElementById('energy-bank');
    if (bank) {
      bank.querySelectorAll('.sim-energy-item').forEach(function(b) {
        b.style.opacity = '1'; b.style.pointerEvents = '';
      });
    }
  }
}

// --- src/core/surprise-events.js ---
// ============================================================
//  SURPRISE & DELIGHT — Random fun events that keep Anastasia
//  coming back. Unpredictable rewards, mini-games, and moments.
// ============================================================

// === RANDOM EVENT ENGINE ===
// After each quiz answer there's a small chance of a surprise event

var SURPRISE_COOLDOWN = 0; // Timestamp of last surprise

var SURPRISE_EVENTS = [
  {
    id: 'shooting-star',
    name: 'Shooting Star!',
    chance: 0.06,          // 6% per correct answer
    minStreak: 0,
    fn: triggerShootingStar
  },
  {
    id: 'bonus-rain',
    name: 'Star Rain!',
    chance: 0.04,
    minStreak: 3,
    fn: triggerBonusRain
  },
  {
    id: 'lumi-dance',
    name: 'Lumi Dance Party!',
    chance: 0.05,
    minStreak: 5,
    fn: triggerLumiDance
  },
  {
    id: 'mystery-box',
    name: 'Mystery Box!',
    chance: 0.04,
    minStreak: 0,
    fn: triggerMysteryBox
  },
  {
    id: 'fireworks',
    name: 'Fireworks!',
    chance: 0.03,
    minStreak: 8,
    fn: triggerFireworks
  },
  {
    id: 'lucky-streak',
    name: 'Lucky Streak!',
    chance: 0.05,
    minStreak: 0,
    fn: triggerLuckyStreak
  },
  {
    id: 'confetti-burst',
    name: 'Confetti Party!',
    chance: 0.06,
    minStreak: 2,
    fn: triggerConfettiBurst
  },
  {
    id: 'lumi-riddle',
    name: 'Lumi\'s Riddle!',
    chance: 0.03,
    minStreak: 0,
    fn: triggerLumiRiddle
  },
  {
    id: 'golden-question',
    name: 'Golden Question!',
    chance: 0.03,
    minStreak: 3,
    fn: triggerGoldenQuestion
  },
  {
    id: 'time-warp',
    name: 'Time Warp!',
    chance: 0.04,
    minStreak: 0,
    fn: triggerTimeWarp
  }
];

// Roll for a surprise after correct answer
function rollForSurprise() {
  // Cooldown: at least 60 seconds between surprises
  if (Date.now() - SURPRISE_COOLDOWN < 60000) return;

  var streak = state.streak || 0;
  var eligible = SURPRISE_EVENTS.filter(function(e) {
    return streak >= e.minStreak;
  });

  for (var i = 0; i < eligible.length; i++) {
    if (Math.random() < eligible[i].chance) {
      SURPRISE_COOLDOWN = Date.now();
      // Delay so it doesn't overlap with answer feedback
      var evt = eligible[i];
      setTimeout(function() { evt.fn(); }, 1800);
      return;
    }
  }
}

// === SURPRISE IMPLEMENTATIONS ===

function triggerShootingStar() {
  showSurpriseOverlay('\uD83C\uDF20', 'Shooting Star!', 'You caught a shooting star! +5 bonus stars!', 5);

  // Animate a star across the screen
  var star = document.createElement('div');
  star.className = 'surprise-shooting-star';
  star.textContent = '\u2B50';
  document.body.appendChild(star);
  setTimeout(function() { star.remove(); }, 2000);
}

function triggerBonusRain() {
  var bonus = rand(3, 8);
  showSurpriseOverlay('\uD83C\uDF27\uFE0F', 'Star Rain!', 'Stars are raining down! +' + bonus + ' bonus stars!', bonus);

  // Rain particles
  for (var i = 0; i < 20; i++) {
    (function(idx) {
      setTimeout(function() {
        var drop = document.createElement('div');
        drop.className = 'surprise-rain-drop';
        drop.textContent = '\u2B50';
        drop.style.left = (10 + Math.random() * 80) + '%';
        drop.style.animationDuration = (0.8 + Math.random() * 0.6) + 's';
        document.body.appendChild(drop);
        setTimeout(function() { drop.remove(); }, 1500);
      }, idx * 100);
    })(i);
  }
}

function triggerLumiDance() {
  showSurpriseOverlay('\uD83D\uDD7A', 'Lumi Dance Party!', 'Lumi is so happy, they\'re dancing! +3 stars!', 3);

  // Make Lumi wobble
  var lumi = document.querySelector('.lumi-body');
  if (lumi) {
    lumi.classList.add('lumi-dancing');
    setTimeout(function() { lumi.classList.remove('lumi-dancing'); }, 4000);
  }
}

function triggerMysteryBox() {
  // Show a box that reveals a random reward when clicked
  var overlay = getSurpriseOverlay();

  var rewards = [
    { emoji: '\u2B50', text: '5 bonus stars!', stars: 5 },
    { emoji: '\uD83C\uDF38', text: 'A rare flower for your garden!', stars: 0, flower: true },
    { emoji: '\u2728', text: '8 bonus stars!', stars: 8 },
    { emoji: '\uD83D\uDD25', text: 'Streak shield! (Your next wrong answer won\'t break your streak!)', stars: 0, shield: true },
    { emoji: '\uD83C\uDF1F', text: '10 bonus stars!', stars: 10 }
  ];

  overlay.innerHTML =
    '<div class="surprise-card mystery-box-card">' +
      '<div class="surprise-icon surprise-bounce">\uD83C\uDF81</div>' +
      '<div class="surprise-title">Mystery Box!</div>' +
      '<div class="surprise-desc">Tap to open!</div>' +
      '<button class="surprise-btn surprise-pulse" onclick="openMysteryBox()">Open \uD83C\uDF81</button>' +
    '</div>';

  overlay.classList.add('show');
  overlay.dataset.mysteryReward = JSON.stringify(pick(rewards));
}

function openMysteryBox() {
  var overlay = getSurpriseOverlay();
  var reward = JSON.parse(overlay.dataset.mysteryReward || '{}');

  if (reward.stars) {
    state.tokens += reward.stars;
  }
  if (reward.flower && typeof addGardenFlower === 'function') {
    addGardenFlower('surprise', false);
  }
  if (reward.shield) {
    state._streakShield = true;
  }

  overlay.innerHTML =
    '<div class="surprise-card">' +
      '<div class="surprise-icon">' + (reward.emoji || '\u2728') + '</div>' +
      '<div class="surprise-title">You got:</div>' +
      '<div class="surprise-desc">' + (reward.text || 'Something special!') + '</div>' +
      '<button class="surprise-btn" onclick="closeSurpriseOverlay()">Awesome!</button>' +
    '</div>';

  if (typeof playSound === 'function') playSound('unlock');
  if (typeof spawnParticles === 'function') {
    spawnParticles(window.innerWidth / 2, window.innerHeight / 2, 15, reward.emoji || '\u2728');
  }
  if (typeof updateUI === 'function') updateUI();
  saveState();
}

function triggerFireworks() {
  showSurpriseOverlay('\uD83C\uDF86', 'Fireworks!', 'What an amazing streak! +7 bonus stars!', 7);

  // Firework particles in waves
  var emojis = ['\uD83C\uDF86', '\uD83C\uDF87', '\u2728', '\uD83C\uDF1F', '\u2B50'];
  for (var wave = 0; wave < 3; wave++) {
    (function(w) {
      setTimeout(function() {
        var x = window.innerWidth * (0.2 + w * 0.3);
        var y = window.innerHeight * (0.2 + Math.random() * 0.2);
        if (typeof spawnParticles === 'function') {
          spawnParticles(x, y, 10, pick(emojis));
        }
        if (typeof playSound === 'function') playSound('token');
      }, w * 500);
    })(wave);
  }
}

function triggerLuckyStreak() {
  // Next 3 correct answers are worth double
  state._luckyMultiplier = 3; // 3 questions remaining with double
  showSurpriseOverlay('\uD83C\uDF40', 'Lucky Streak!', 'Your next 3 correct answers earn DOUBLE stars!', 0);
}

function triggerConfettiBurst() {
  showSurpriseOverlay('\uD83C\uDF8A', 'Confetti Party!', 'You\'re doing so well! +4 bonus stars!', 4);

  // Confetti shower
  var confettiColors = ['#ff6b6b', '#ffd93d', '#6bcb77', '#4d96ff', '#b57bff', '#ff7bdb'];
  for (var i = 0; i < 40; i++) {
    (function(idx) {
      setTimeout(function() {
        var c = document.createElement('div');
        c.className = 'surprise-confetti';
        c.style.left = Math.random() * 100 + '%';
        c.style.background = confettiColors[idx % confettiColors.length];
        c.style.animationDuration = (1 + Math.random()) + 's';
        c.style.animationDelay = (Math.random() * 0.3) + 's';
        document.body.appendChild(c);
        setTimeout(function() { c.remove(); }, 2500);
      }, idx * 50);
    })(i);
  }
}

function triggerLumiRiddle() {
  var riddles = [
    { q: 'I have hands but can\'t clap. What am I?', a: 'A clock!' },
    { q: 'What has a head and a tail but no body?', a: 'A coin!' },
    { q: 'What gets wetter the more it dries?', a: 'A towel!' },
    { q: 'I\'m full of holes but I hold water. What am I?', a: 'A sponge!' },
    { q: 'What has legs but doesn\'t walk?', a: 'A table!' },
    { q: 'What has teeth but can\'t bite?', a: 'A comb!' },
    { q: 'What can you catch but not throw?', a: 'A cold!' },
    { q: 'What goes up but never comes down?', a: 'Your age!' }
  ];

  var riddle = pick(riddles);
  var overlay = getSurpriseOverlay();

  overlay.innerHTML =
    '<div class="surprise-card">' +
      '<div class="surprise-icon">\uD83E\uDD14</div>' +
      '<div class="surprise-title">Lumi\'s Riddle!</div>' +
      '<div class="surprise-desc" style="font-size:18px;margin:16px 0">' + riddle.q + '</div>' +
      '<button class="surprise-btn" onclick="revealRiddle(\'' + riddle.a.replace(/'/g, "\\'") + '\')">Reveal Answer</button>' +
    '</div>';

  overlay.classList.add('show');
}

function revealRiddle(answer) {
  var overlay = getSurpriseOverlay();
  overlay.innerHTML =
    '<div class="surprise-card">' +
      '<div class="surprise-icon">\uD83D\uDCA1</div>' +
      '<div class="surprise-title">' + answer + '</div>' +
      '<div class="surprise-desc">+3 stars for thinking about it!</div>' +
      '<button class="surprise-btn" onclick="closeSurpriseOverlay()">Cool!</button>' +
    '</div>';

  state.tokens += 3;
  if (typeof playSound === 'function') playSound('token');
  if (typeof updateUI === 'function') updateUI();
  saveState();
}

function triggerGoldenQuestion() {
  // The current question's rewards are tripled
  state._goldenActive = true;
  showSurpriseOverlay('\uD83C\uDFC5', 'Golden Question!', 'Your NEXT correct answer is worth TRIPLE stars!', 0);

  // Add golden glow to the question card
  var qCard = document.getElementById('question-card');
  if (qCard) qCard.classList.add('golden-glow');
}

function triggerTimeWarp() {
  // Show a fun "time warp" visual then give bonus
  var overlay = getSurpriseOverlay();

  overlay.innerHTML =
    '<div class="surprise-card">' +
      '<div class="surprise-icon surprise-spin">\u231B</div>' +
      '<div class="surprise-title">Time Warp!</div>' +
      '<div class="surprise-desc">Whoooosh! You just time-travelled!</div>' +
      '<div class="surprise-desc" style="font-size:14px">Future-Anastasia says: "Keep going, you\'re amazing!" +5 stars!</div>' +
      '<button class="surprise-btn" onclick="closeSurpriseOverlay()">Wow!</button>' +
    '</div>';

  overlay.classList.add('show');
  state.tokens += 5;
  if (typeof playSound === 'function') playSound('escape');
  if (typeof updateUI === 'function') updateUI();
  saveState();
}

// === MILESTONE CELEBRATIONS ===
// Big celebrations at key milestones

function checkMilestoneCelebration() {
  var milestones = [
    { count: 50,   emoji: '\uD83C\uDF89', msg: '50 correct answers! You\'re a learning machine!' },
    { count: 100,  emoji: '\uD83C\uDFC6', msg: '100 correct answers! A true champion!' },
    { count: 250,  emoji: '\uD83C\uDF1F', msg: '250 correct answers! You\'re a STAR!' },
    { count: 500,  emoji: '\uD83D\uDE80', msg: '500 correct answers! You\'re out of this world!' },
    { count: 1000, emoji: '\uD83C\uDF0C', msg: '1000 correct answers! You\'re a GALAXY of knowledge!' }
  ];

  for (var i = 0; i < milestones.length; i++) {
    var m = milestones[i];
    if (state.totalCorrect === m.count) {
      showSurpriseOverlay(m.emoji, m.count + ' Correct Answers!', m.msg, 15);
      return true;
    }
  }
  return false;
}

// === DAILY LUCKY SPIN (once per day on home screen) ===

function checkDailyLuckySpin() {
  var today = new Date().toDateString();
  if (state._lastLuckySpin === today) return false;
  return true;
}

function triggerDailyLuckySpin() {
  var today = new Date().toDateString();
  if (state._lastLuckySpin === today) return;
  state._lastLuckySpin = today;
  saveState();

  var prizes = [
    { emoji: '\u2B50', text: '3 bonus stars!', stars: 3 },
    { emoji: '\u2B50', text: '5 bonus stars!', stars: 5 },
    { emoji: '\u2B50', text: '8 bonus stars!', stars: 8 },
    { emoji: '\uD83D\uDD25', text: 'Start with a 3-streak!', streak: 3 },
    { emoji: '\uD83C\uDF40', text: 'Lucky boost! Double stars for 3 questions!', lucky: 3 },
    { emoji: '\uD83C\uDF38', text: 'A bonus flower for your garden!', flower: true }
  ];

  var prize = pick(prizes);

  var overlay = getSurpriseOverlay();
  overlay.innerHTML =
    '<div class="surprise-card">' +
      '<div class="surprise-icon surprise-spin">\uD83C\uDFA1</div>' +
      '<div class="surprise-title">Daily Spin!</div>' +
      '<div class="surprise-desc">Tap to see today\'s bonus!</div>' +
      '<button class="surprise-btn surprise-pulse" onclick="revealDailySpin()">Spin! \uD83C\uDFA1</button>' +
    '</div>';

  overlay.classList.add('show');
  overlay.dataset.spinPrize = JSON.stringify(prize);
}

function revealDailySpin() {
  var overlay = getSurpriseOverlay();
  var prize = JSON.parse(overlay.dataset.spinPrize || '{}');

  if (prize.stars) state.tokens += prize.stars;
  if (prize.streak) state.streak = Math.max(state.streak, prize.streak);
  if (prize.lucky) state._luckyMultiplier = prize.lucky;
  if (prize.flower && typeof addGardenFlower === 'function') addGardenFlower('lucky-spin', false);

  overlay.innerHTML =
    '<div class="surprise-card">' +
      '<div class="surprise-icon">' + (prize.emoji || '\u2B50') + '</div>' +
      '<div class="surprise-title">You won!</div>' +
      '<div class="surprise-desc" style="font-size:18px">' + (prize.text || 'Something special!') + '</div>' +
      '<button class="surprise-btn" onclick="closeSurpriseOverlay()">Yay!</button>' +
    '</div>';

  if (typeof playSound === 'function') playSound('unlock');
  if (typeof spawnParticles === 'function') {
    spawnParticles(window.innerWidth / 2, window.innerHeight / 2, 12, prize.emoji || '\u2B50');
  }
  if (typeof updateUI === 'function') updateUI();
  saveState();
}

// === SURPRISE OVERLAY HELPERS ===

function getSurpriseOverlay() {
  var overlay = document.getElementById('surprise-overlay');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.id = 'surprise-overlay';
    overlay.className = 'surprise-overlay';
    document.body.appendChild(overlay);
  }
  return overlay;
}

function showSurpriseOverlay(emoji, title, desc, stars) {
  var overlay = getSurpriseOverlay();

  if (stars > 0) {
    state.tokens += stars;
    if (typeof updateUI === 'function') updateUI();
    saveState();
  }

  overlay.innerHTML =
    '<div class="surprise-card">' +
      '<div class="surprise-icon">' + emoji + '</div>' +
      '<div class="surprise-title">' + title + '</div>' +
      '<div class="surprise-desc">' + desc + '</div>' +
      (stars > 0 ? '<div class="surprise-stars">+' + stars + ' \u2B50</div>' : '') +
      '<button class="surprise-btn" onclick="closeSurpriseOverlay()">Awesome!</button>' +
    '</div>';

  overlay.classList.add('show');
  if (typeof playSound === 'function') playSound('token');
}

function closeSurpriseOverlay() {
  var overlay = document.getElementById('surprise-overlay');
  if (overlay) overlay.classList.remove('show');

  // Remove golden glow if active
  var qCard = document.getElementById('question-card');
  if (qCard) qCard.classList.remove('golden-glow');
}

// === HOOK INTO FEEDBACK SYSTEM ===
// Called from handleCorrect — checks lucky multiplier, golden, streak shield

function applySurpriseModifiers() {
  // Lucky streak multiplier
  if (state._luckyMultiplier && state._luckyMultiplier > 0) {
    state.tokens += 5; // extra 5 stars for lucky
    state._luckyMultiplier--;
    if (state._luckyMultiplier <= 0) delete state._luckyMultiplier;
  }

  // Golden question
  if (state._goldenActive) {
    state.tokens += 10; // triple effect (normal 5 + extra 10)
    delete state._goldenActive;
  }
}

function applyStreakShield() {
  if (state._streakShield) {
    delete state._streakShield;
    return true; // Don't break streak
  }
  return false;
}

// --- src/ui/topbar.js ---
// ============================================================
//  TOPBAR — Token/streak/level display and updates
// ============================================================

function updateUI() {
  document.getElementById('token-count').textContent = state.tokens;
  document.getElementById('streak-count').textContent = state.streak;
  const lvl = clamp(state.level, 1, LEVEL_NAMES.length - 1);
  document.getElementById('level-text').textContent = LEVEL_NAMES[lvl] || 'Sprout \uD83C\uDF31';

  // Achievement count badge
  var achBadge = document.getElementById('achievement-badge-count');
  if (achBadge && typeof getAchievementCount === 'function') {
    achBadge.textContent = getAchievementCount();
  }

  // Check level up
  for (let i = LEVEL_THRESHOLDS.length - 1; i > 0; i--) {
    if (state.tokens >= LEVEL_THRESHOLDS[i] && state.level < i) {
      state.level = i;
      playSound('levelup');
      document.getElementById('level-text').textContent = LEVEL_NAMES[i];
      spawnParticles(window.innerWidth / 2, 50, 12, '\u2728');
      if (typeof lumiReactTo === 'function') {
        lumiReactTo('levelUp');
      } else {
        lumiSay('Amazing! You reached ' + LEVEL_NAMES[i] + '!');
      }
      break;
    }
  }

  // Streak celebrations
  if (state.streak === 5 || state.streak === 10 || state.streak === 20) {
    playSound('streak');
    spawnParticles(window.innerWidth / 2, window.innerHeight / 3, 10, '\uD83D\uDD25');
  }

  // Streak for quest tracking
  if (typeof questRecordStreak === 'function') {
    questRecordStreak(state.streak);
  }
}

// --- src/ui/feedback.js ---
// ============================================================
//  FEEDBACK — Correct/wrong overlays, particles, answer checking
// ============================================================

// === PARTICLES ===
function spawnParticles(x, y, count, emoji) {
  for (let i = 0; i < count; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    p.textContent = emoji || '\u2B50';
    p.style.left = (x + (Math.random() - 0.5) * 60) + 'px';
    p.style.top = (y + (Math.random() - 0.5) * 30) + 'px';
    p.style.fontSize = (16 + Math.random() * 16) + 'px';
    p.style.animationDuration = (0.6 + Math.random() * 0.6) + 's';
    document.body.appendChild(p);
    setTimeout(() => p.remove(), 1200);
  }
}

// === ANSWER CHECKING ===
function checkAnswer(given, correct, btnEl) {
  if (btnEl && btnEl.dataset.checked) return;
  const allBtns = btnEl?.parentElement?.querySelectorAll('.answer-btn') || [];
  allBtns.forEach(b => b.dataset.checked = 'true');

  const isCorrect = String(given) === String(correct);

  if (isCorrect) {
    if (btnEl) btnEl.classList.add('correct');
    handleCorrect();
  } else {
    if (btnEl) btnEl.classList.add('wrong');
    allBtns.forEach(b => {
      if (b.textContent.trim() == correct || b.textContent.includes(correct + ' ')) {
        setTimeout(() => b.classList.add('correct'), 500);
      }
    });
    handleWrong(correct);
  }
}

function submitTextAnswer(correct) {
  const input = document.getElementById('answer-input');
  if (!input) return;
  const val = parseInt(input.value);
  if (isNaN(val)) return;
  if (val === correct) {
    input.style.borderColor = 'var(--success)';
    handleCorrect();
  } else {
    input.style.borderColor = 'var(--error)';
    input.style.animation = 'shake-wrong 0.5s';
    handleWrong(correct);
  }
}

function submitSpelling(correct) {
  const input = document.getElementById('answer-input');
  if (!input) return;
  const val = input.value.trim().toLowerCase();
  if (!val) return;
  if (val === correct.toLowerCase()) {
    handleCorrect();
  } else {
    handleWrong(correct);
  }
}

// === CORRECT / WRONG HANDLERS ===
function handleCorrect(isStory) {
  playSound('correct');
  const tokens = currentGame.hintShown ? 2 : (currentGame.attempts === 0 ? 5 : 3);
  state.tokens += tokens;
  state.streak++;
  if (state.streak > state.bestStreak) state.bestStreak = state.streak;
  state.totalCorrect++;
  state.totalAttempts++;
  currentGame.results[currentGame.currentIndex] = true;

  updateSkillState(currentGame.skillId, true, currentGame.currentConfidence);

  // Daily quest (legacy counter)
  const today = new Date().toDateString();
  if (state.dailyQuest.date === today) {
    state.dailyQuest.completed++;
  }

  // Dynamic quest tracking
  if (typeof questRecordQuiz === 'function') {
    questRecordQuiz(currentGame.worldType);
  }
  if (typeof questRecordSkillPlayed === 'function') {
    questRecordSkillPlayed(currentGame.skillId);
  }

  spawnParticles(window.innerWidth / 2, window.innerHeight / 3, 8, '\u2B50');

  const showMeta = Math.random() < 0.3;
  showFeedback(true, tokens, isStory, showMeta);

  // Achievement checks
  if (typeof checkAchievementsAfterAnswer === 'function') checkAchievementsAfterAnswer();
  if (typeof checkAchievementsAfterMastery === 'function') checkAchievementsAfterMastery();
  if (typeof checkAchievementsAfterGarden === 'function') checkAchievementsAfterGarden();

  // Surprise event modifiers (lucky streak, golden question)
  if (typeof applySurpriseModifiers === 'function') applySurpriseModifiers();

  // Roll for surprise event
  if (typeof rollForSurprise === 'function') rollForSurprise();

  // Milestone celebrations (50, 100, 250... correct)
  if (typeof checkMilestoneCelebration === 'function') checkMilestoneCelebration();

  // Lumi reacts
  if (typeof lumiReactTo === 'function') lumiReactTo('correct');

  updateUI();
  saveState();
}

function handleWrong(correct) {
  playSound('wrong');

  // Streak shield from mystery box
  if (typeof applyStreakShield === 'function' && applyStreakShield()) {
    // Shield used — streak preserved!
    if (typeof lumiSay === 'function') lumiSay('Streak shield activated! Your streak is safe!');
    if (typeof spawnParticles === 'function') spawnParticles(window.innerWidth / 2, window.innerHeight / 3, 5, '\uD83D\uDEE1\uFE0F');
  } else {
    state.streak = 0;
  }
  state.totalAttempts++;
  currentGame.results[currentGame.currentIndex] = false;
  currentGame.attempts++;

  updateSkillState(currentGame.skillId, false, currentGame.currentConfidence);

  setTimeout(() => {
    showFeedback(false, 0, false, false, correct);
  }, 600);

  updateUI();
  saveState();
}

// === FEEDBACK OVERLAY ===
function showFeedback(correct, tokens, isStory, showMeta, correctAnswer) {
  const overlay = document.getElementById('feedback-overlay');
  const card = document.getElementById('feedback-card');

  let html = '';
  if (correct) {
    html += '<div class="feedback-icon">\uD83C\uDF89</div>';
    html += '<div class="feedback-title" style="color:var(--success)">' + pick(ENCOURAGEMENTS) + '</div>';
    if (isStory) {
      html += '<div class="feedback-message">Beautiful story, Anastasia! Your imagination is incredible!</div>';
    }
    html += '<div class="feedback-tokens">+' + tokens + ' \u2B50</div>';
    if (state.streak >= 3) {
      html += '<div class="feedback-message" style="color:var(--coral)">\uD83D\uDD25 ' + state.streak + ' in a row!</div>';
    }
    if (showMeta) {
      html += '<div class="feedback-reflect">\uD83E\uDD14 ' + pick(METACOGNITIVE_PROMPTS) + '</div>';
    }
  } else {
    html += '<div class="feedback-icon">\uD83E\uDD14</div>';
    html += '<div class="feedback-title" style="color:var(--warning)">' + pick(TRY_AGAINS) + '</div>';
    if (correctAnswer !== undefined) {
      html += '<div class="feedback-message">The answer was: <strong style="color:var(--gold);font-size:20px">' + correctAnswer + '</strong></div>';
    }
    html += '<div class="feedback-message" style="font-size:14px">Mistakes are how your brain grows stronger! \uD83D\uDCAA</div>';
  }

  html += '<button class="feedback-btn" onclick="nextQuestion()">Continue \u2192</button>';
  card.innerHTML = html;
  overlay.classList.remove('hidden');
}

function closeFeedback(e) {
  if (e.target === document.getElementById('feedback-overlay')) {
    nextQuestion();
  }
}

// === HINT SYSTEM ===
function renderHintBtn(hintText) {
  const escaped = hintText.replace(/'/g, "\\'");
  return '<div class="mt-2"><button class="hint-btn" onclick="showHint(this, \'' + escaped + '\')">\uD83D\uDCA1 Need a hint?</button></div>';
}

function showHint(btn, text) {
  if (currentGame.hintShown) return;
  currentGame.hintShown = true;
  const hintDiv = document.createElement('div');
  hintDiv.className = 'hint-text';
  hintDiv.textContent = '\uD83D\uDCA1 ' + text;
  btn.parentElement.replaceWith(hintDiv);
  playSound('click');
}

// --- src/ui/garden.js ---
// ============================================================
//  GARDEN — Flower renderer with golden flower support
// ============================================================

function addGardenFlower(skillId, golden) {
  state.garden.push({
    type: golden ? 'golden' : 'flower',
    skill: skillId,
    emoji: golden ? GOLDEN_FLOWER : pick(FLOWER_EMOJIS),
    date: new Date().toISOString()
  });

  // Check if island evolved
  if (typeof checkIslandEvolution === 'function') {
    checkIslandEvolution();
  }
  // Check story progress
  if (typeof checkStoryProgress === 'function') {
    var newChapter = checkStoryProgress();
    if (newChapter > 0 && typeof showStoryChapter === 'function') {
      setTimeout(function() { showStoryChapter(newChapter); }, 2000);
    }
  }
}

function renderGarden() {
  const grid = document.getElementById('garden-grid');
  if (!grid) return;
  const plots = Math.max(30, state.garden.length + 10);
  let html = '';
  for (let i = 0; i < plots; i++) {
    if (i < state.garden.length) {
      const g = state.garden[i];
      const isGolden = g.type === 'golden';
      html += '<div class="garden-plot grown ' + (isGolden ? 'golden' : '') + '" title="' +
        (g.skill || '') + '">' + g.emoji + '</div>';
    } else {
      html += '<div class="garden-plot">\u00B7</div>';
    }
  }
  grid.innerHTML = html;
}

function getGardenFlowerCount() {
  return state.garden.length;
}

function getGoldenFlowerCount() {
  return state.garden.filter(g => g.type === 'golden').length;
}

// --- src/ui/garden-island.js ---
// ============================================================
//  GARDEN EVOLUTION — Island that evolves visually with progress
// ============================================================
// The garden transforms from barren dirt → sprouting patch →
// lush meadow → tropical garden → magical floating island
// Based on flower count milestones

var ISLAND_STAGES = [
  {
    name: 'Barren Ground',
    minFlowers: 0,
    bg: 'linear-gradient(180deg, #1a1147 0%, #2d1f6b 40%, #5c4a3d 60%, #3d2b1f 100%)',
    groundColor: '#5c4a3d',
    features: [],
    ambientEmoji: [],
    desc: 'A quiet patch of earth, waiting for life...'
  },
  {
    name: 'Sprouting Patch',
    minFlowers: 3,
    bg: 'linear-gradient(180deg, #1a1147 0%, #2d1f6b 30%, #4a6741 55%, #3d5a35 70%, #2d4228 100%)',
    groundColor: '#4a6741',
    features: ['grass'],
    ambientEmoji: ['\uD83E\uDEB1', '\uD83C\uDF3F'],
    desc: 'Green shoots push through! Your island is waking up!'
  },
  {
    name: 'Blooming Meadow',
    minFlowers: 8,
    bg: 'linear-gradient(180deg, #0f1b4d 0%, #1a3a6b 25%, #2d7a4a 50%, #4a9a5a 65%, #3d7a45 100%)',
    groundColor: '#2d7a4a',
    features: ['grass', 'pond', 'butterflies'],
    ambientEmoji: ['\uD83E\uDD8B', '\uD83D\uDC1B', '\uD83C\uDF3C'],
    desc: 'Butterflies have arrived! A little pond glistens.'
  },
  {
    name: 'Lush Garden',
    minFlowers: 15,
    bg: 'linear-gradient(180deg, #0a1a3d 0%, #1a4a6b 20%, #1a6b4a 45%, #2d9a5a 60%, #4aaa6a 75%, #3d8a50 100%)',
    groundColor: '#2d9a5a',
    features: ['grass', 'pond', 'butterflies', 'trees', 'birds'],
    ambientEmoji: ['\uD83C\uDF33', '\uD83D\uDC26', '\uD83E\uDD8B', '\uD83C\uDF3A'],
    desc: 'Trees grow tall! Birds sing from the branches!'
  },
  {
    name: 'Tropical Paradise',
    minFlowers: 25,
    bg: 'linear-gradient(180deg, #0a0f3d 0%, #1a3a8b 15%, #0a6a9a 30%, #1a8a5a 50%, #3aaa6a 65%, #5aba7a 80%, #4a9a60 100%)',
    groundColor: '#3aaa6a',
    features: ['grass', 'pond', 'butterflies', 'trees', 'birds', 'waterfall', 'rainbow'],
    ambientEmoji: ['\uD83C\uDF34', '\uD83E\uDD9C', '\uD83C\uDF08', '\uD83D\uDC20', '\uD83C\uDF3A'],
    desc: 'A waterfall cascades! Parrots soar! A rainbow shines!'
  },
  {
    name: 'Floating Star Island',
    minFlowers: 35,
    bg: 'linear-gradient(180deg, #050520 0%, #0a0a40 20%, #1a1a6b 35%, #2a4a8b 50%, #3a8a6a 65%, #5aba8a 80%, #7adaa0 95%)',
    groundColor: '#3a8a6a',
    features: ['grass', 'pond', 'butterflies', 'trees', 'birds', 'waterfall', 'rainbow', 'floating', 'aurora', 'crystals'],
    ambientEmoji: ['\uD83D\uDD2E', '\u2728', '\uD83C\uDF1F', '\uD83E\uDD84', '\uD83C\uDF08'],
    desc: 'Your island FLOATS among the stars! Crystals glow with aurora light!'
  }
];

function getIslandStage() {
  var flowers = state.garden ? state.garden.length : 0;
  var stage = 0;
  for (var i = ISLAND_STAGES.length - 1; i >= 0; i--) {
    if (flowers >= ISLAND_STAGES[i].minFlowers) {
      stage = i;
      break;
    }
  }
  return stage;
}

function renderGardenIsland() {
  var container = document.getElementById('garden-island');
  if (!container) return;

  var stageIdx = getIslandStage();
  var stage = ISLAND_STAGES[stageIdx];
  var flowers = state.garden ? state.garden.length : 0;
  var nextStage = stageIdx < ISLAND_STAGES.length - 1 ? ISLAND_STAGES[stageIdx + 1] : null;

  var html = '';

  // Island stage title
  html += '<div class="island-stage-title">';
  html += '<span class="island-stage-name">' + stage.name + '</span>';
  if (nextStage) {
    var needed = nextStage.minFlowers - flowers;
    html += '<span class="island-stage-next">' + needed + ' more flower' + (needed > 1 ? 's' : '') + ' to evolve</span>';
  } else {
    html += '<span class="island-stage-next" style="color:var(--gold)">Maximum evolution!</span>';
  }
  html += '</div>';

  // Evolution progress dots
  html += '<div class="island-evo-dots">';
  for (var d = 0; d < ISLAND_STAGES.length; d++) {
    html += '<div class="island-evo-dot' + (d <= stageIdx ? ' active' : '') + '">' +
      (d <= stageIdx ? '\u2B50' : '\u2606') + '</div>';
  }
  html += '</div>';

  // The island visual
  html += '<div class="island-visual" style="background:' + stage.bg + '">';

  // Sky elements
  html += '<div class="island-sky">';
  if (stage.features.indexOf('aurora') >= 0) {
    html += '<div class="island-aurora"></div>';
  }
  if (stage.features.indexOf('rainbow') >= 0) {
    html += '<div class="island-rainbow">\uD83C\uDF08</div>';
  }
  if (stage.features.indexOf('birds') >= 0) {
    html += '<div class="island-bird bird-1">\uD83D\uDC26</div>';
    html += '<div class="island-bird bird-2">\uD83E\uDD9C</div>';
  }
  if (stage.features.indexOf('butterflies') >= 0) {
    html += '<div class="island-butterfly bf-1">\uD83E\uDD8B</div>';
    html += '<div class="island-butterfly bf-2">\uD83E\uDD8B</div>';
  }
  html += '</div>';

  // Ground layer
  html += '<div class="island-ground" style="background:' + stage.groundColor + '">';

  // Floating effect
  if (stage.features.indexOf('floating') >= 0) {
    html += '<div class="island-float-rocks"></div>';
  }

  // Landscape features
  if (stage.features.indexOf('trees') >= 0) {
    html += '<div class="island-tree tree-1">\uD83C\uDF33</div>';
    html += '<div class="island-tree tree-2">\uD83C\uDF34</div>';
  }
  if (stage.features.indexOf('waterfall') >= 0) {
    html += '<div class="island-waterfall">\uD83C\uDF0A</div>';
  }
  if (stage.features.indexOf('pond') >= 0) {
    html += '<div class="island-pond">\uD83D\uDCA7</div>';
  }
  if (stage.features.indexOf('crystals') >= 0) {
    html += '<div class="island-crystal c-1">\uD83D\uDD2E</div>';
    html += '<div class="island-crystal c-2">\uD83D\uDD2E</div>';
  }
  if (stage.features.indexOf('grass') >= 0) {
    html += '<div class="island-grass">\uD83C\uDF3F \uD83C\uDF3F \uD83C\uDF3F</div>';
  }

  // Planted flowers on the island
  var gardenFlowers = state.garden || [];
  html += '<div class="island-flowers">';
  gardenFlowers.forEach(function(g, idx) {
    var x = 10 + (idx * 37 % 80);
    var y = 5 + (idx * 23 % 60);
    var size = g.type === 'golden' ? 22 : 18;
    html += '<span class="island-flower' + (g.type === 'golden' ? ' golden' : '') + '" style="left:' + x + '%;top:' + y + '%;font-size:' + size + 'px">' + g.emoji + '</span>';
  });
  html += '</div>';

  html += '</div>'; // ground
  html += '</div>'; // island-visual

  // Description
  html += '<div class="island-desc">' + stage.desc + '</div>';

  container.innerHTML = html;
}

// Check if island evolved (called after adding flower)
function checkIslandEvolution() {
  if (!state._lastIslandStage) state._lastIslandStage = 0;
  var newStage = getIslandStage();

  if (newStage > state._lastIslandStage) {
    state._lastIslandStage = newStage;
    var stage = ISLAND_STAGES[newStage];

    // Celebration!
    if (typeof playSound === 'function') playSound('escape');
    if (typeof spawnParticles === 'function') {
      spawnParticles(window.innerWidth / 2, window.innerHeight / 2, 20, pick(stage.ambientEmoji));
    }
    if (typeof lumiReactTo === 'function') {
      lumiReactTo('gardenGrow');
    }
    if (typeof lumiSay === 'function') {
      setTimeout(function() {
        lumiSay('Your island evolved to ' + stage.name + '! ' + stage.desc);
      }, 1500);
    }

    // Show evolution overlay
    showIslandEvolution(newStage);
    return true;
  }
  return false;
}

function showIslandEvolution(stageIdx) {
  var stage = ISLAND_STAGES[stageIdx];
  var overlay = document.getElementById('island-evo-overlay');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.id = 'island-evo-overlay';
    overlay.className = 'island-evo-overlay';
    document.body.appendChild(overlay);
  }

  overlay.innerHTML =
    '<div class="island-evo-card">' +
      '<div class="island-evo-badge">Island Evolution!</div>' +
      '<div class="island-evo-icon">' + (stage.ambientEmoji[0] || '\u2728') + '</div>' +
      '<div class="island-evo-name">' + stage.name + '</div>' +
      '<div class="island-evo-desc">' + stage.desc + '</div>' +
      '<div class="island-evo-features">' +
        stage.ambientEmoji.join(' ') +
      '</div>' +
      '<button class="lesson-btn lesson-btn-done" onclick="closeIslandEvolution()">Amazing! \u2192</button>' +
    '</div>';

  overlay.classList.add('show');
}

function closeIslandEvolution() {
  var overlay = document.getElementById('island-evo-overlay');
  if (overlay) overlay.classList.remove('show');
}

// --- src/ui/home.js ---
// ============================================================
//  HOME — Home screen, Lumi companion, daily quest, WotD
// ============================================================

const LUMI_GREETINGS = [
  "Let's learn something awesome today!",
  "Your garden is waiting to grow!",
  "I believe in you, Anastasia!",
  "Every challenge makes you stronger!",
  "Ready for an adventure? Let's go!",
  "You're getting so smart! Keep it up!",
  "What shall we explore today?",
  "The stars are cheering for you!",
  "Today is going to be amazing!",
  "Let's make your brain sparkle!"
];

function lumiSpeak() {
  // Use upgraded Lumi tap system if available
  if (typeof lumiTapped === 'function') {
    lumiTapped();
    return;
  }
  lumiSay(pick(LUMI_GREETINGS));
  playSound('click');
}

function lumiSay(text) {
  const el = document.getElementById('lumi-speech');
  if (!el) return;
  el.style.animation = 'none';
  el.offsetHeight;
  el.style.animation = 'pop-in 0.5s ease-out';
  el.textContent = text;
}

function updateHomeUI() {
  updateUI();

  // World progress bars
  if (typeof MATH_TREE !== 'undefined') {
    const mathIds = Object.keys(MATH_TREE);
    const mathAvg = calculateWorldProgress(mathIds);
    document.getElementById('math-progress').style.width = mathAvg + '%';
  }
  if (typeof WORD_TREE !== 'undefined') {
    const wordIds = Object.keys(WORD_TREE);
    const wordAvg = calculateWorldProgress(wordIds);
    document.getElementById('word-progress').style.width = wordAvg + '%';
  }
  if (typeof STEM_TREE !== 'undefined') {
    const stemIds = Object.keys(STEM_TREE);
    const stemAvg = calculateWorldProgress(stemIds);
    document.getElementById('stem-progress').style.width = stemAvg + '%';
  }

  const gardenPct = Math.min(100, (state.garden.length / 50) * 100);
  document.getElementById('garden-progress').style.width = gardenPct + '%';

  // Daily lucky spin
  var spinArea = document.getElementById('daily-spin-area');
  if (spinArea && typeof checkDailyLuckySpin === 'function') {
    if (checkDailyLuckySpin()) {
      spinArea.innerHTML = '<div class="daily-spin-banner" onclick="triggerDailyLuckySpin()">' +
        '<div class="daily-spin-icon">\uD83C\uDFA1</div>' +
        '<div class="daily-spin-text">' +
          '<div class="daily-spin-title">Daily Lucky Spin!</div>' +
          '<div class="daily-spin-desc">Tap to see today\'s bonus!</div>' +
        '</div>' +
        '</div>';
    } else {
      spinArea.innerHTML = '';
    }
  }

  // Dynamic quest banners
  var questArea = document.getElementById('dynamic-quest-area');
  if (questArea && typeof renderDynamicQuestBanner === 'function') {
    questArea.innerHTML = renderDynamicQuestBanner();
  }

  // Story progress
  var storyArea = document.getElementById('story-progress-area');
  if (storyArea && typeof renderStoryProgress === 'function') {
    storyArea.innerHTML = renderStoryProgress();
  }

  // Achievement showcase (latest 3)
  var achArea = document.getElementById('achievement-showcase');
  if (achArea && typeof ACHIEVEMENTS !== 'undefined') {
    var earned = state.achievements || [];
    if (earned.length > 0) {
      var recent = earned.slice(-3).reverse();
      var html = '<div class="achievement-showcase-row">';
      recent.forEach(function(id) {
        var def = ACHIEVEMENTS.find(function(a) { return a.id === id; });
        if (def) {
          html += '<div class="achievement-mini">' +
            '<span class="achievement-mini-icon">' + def.icon + '</span>' +
            '<span class="achievement-mini-name">' + def.name + '</span>' +
            '</div>';
        }
      });
      html += '<div class="achievement-mini see-all" onclick="showScreen(\'achievements\')">' +
        '<span class="achievement-mini-icon">\u2192</span>' +
        '<span class="achievement-mini-name">See all (' + earned.length + ')</span>' +
        '</div>';
      html += '</div>';
      achArea.innerHTML = html;
      achArea.classList.remove('hidden');
    } else {
      achArea.classList.add('hidden');
    }
  }

  // Streak calendar
  var streakEl = document.getElementById('streak-calendar-area');
  if (streakEl && typeof renderStreakCalendar === 'function') {
    streakEl.innerHTML = renderStreakCalendar();
  }

  // Review-due count
  if (typeof getSkillsDueForReview === 'function') {
    var due = getSkillsDueForReview();
    var reviewEl = document.getElementById('review-due-banner');
    if (reviewEl) {
      if (due.length > 0) {
        reviewEl.innerHTML = '<span class="review-banner-icon">\uD83D\uDD14</span> ' +
          due.length + ' skill' + (due.length > 1 ? 's' : '') + ' due for review!';
        reviewEl.classList.remove('hidden');
      } else {
        reviewEl.classList.add('hidden');
      }
    }
  }

  updateWotd();
  updateChallengesSection();
}

// === WORD OF THE DAY ===
function updateWotd() {
  const banner = document.getElementById('wotd-banner');
  if (!banner) return;

  const wotd = getWordOfTheDay();
  const today = new Date().toDateString();
  const alreadyClaimed = state.wotdHistory && state.wotdHistory.includes(today);

  document.getElementById('wotd-word').textContent = wotd.word;
  document.getElementById('wotd-def').textContent = wotd.def;

  if (alreadyClaimed) {
    document.getElementById('wotd-status').textContent = '\u2705 Learned!';
  } else {
    document.getElementById('wotd-status').textContent = '+3 \u2B50';
  }

  banner.classList.remove('hidden');
}

function claimWotd() {
  const today = new Date().toDateString();
  if (state.wotdHistory && state.wotdHistory.includes(today)) {
    const wotd = getWordOfTheDay();
    lumiSay('"' + wotd.word + '" means ' + wotd.def + '. Example: ' + wotd.sentence);
    return;
  }

  if (!state.wotdHistory) state.wotdHistory = [];
  state.wotdHistory.push(today);
  state.tokens += 3;
  playSound('token');
  spawnParticles(window.innerWidth / 2, window.innerHeight / 2, 6, '\u2B50');

  const wotd = getWordOfTheDay();
  lumiSay('New word: "' + wotd.word + '" means ' + wotd.def + '! +3 stars!');

  if (typeof checkAchievementsAfterWotd === 'function') checkAchievementsAfterWotd();

  updateUI();
  updateWotd();
  saveState();
}

// === CHALLENGES SECTION ===
function updateChallengesSection() {
  const grid = document.getElementById('challenges-grid');
  const section = document.getElementById('challenges-section');
  if (!grid || !section) return;

  const flowerCount = getGardenFlowerCount();
  let html = '';

  // Star Trials
  if (typeof renderStarTrialCards === 'function') {
    html += renderStarTrialCards(flowerCount);
  }

  // Escape Rooms
  if (typeof renderEscapeRoomCards === 'function') {
    html += renderEscapeRoomCards(flowerCount);
  }

  if (html) {
    grid.innerHTML = html;
    section.classList.remove('hidden');
  } else {
    section.classList.add('hidden');
  }
}

// --- src/ui/navigation.js ---
// ============================================================
//  NAVIGATION — Screen management, game engine, init
// ============================================================

// === GAME SESSION STATE ===
let currentGame = {
  skillId: '',
  worldType: '',
  questions: [],
  currentIndex: 0,
  totalQuestions: 8,
  results: [],
  currentConfidence: -1,
  hintShown: false,
  attempts: 0
};

// === SCREEN MANAGEMENT ===
function showScreen(screenId) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const screen = document.getElementById('screen-' + screenId);
  if (screen) screen.classList.add('active');

  if (screenId === 'home') updateHomeUI();
  if (screenId === 'achievements' && typeof renderAchievementsScreen === 'function') {
    renderAchievementsScreen();
  }
  if (screenId === 'math-world' && typeof MATH_TREE !== 'undefined') {
    renderActivityCards(MATH_TREE, 'math-activities', 'math');
  }
  if (screenId === 'word-world' && typeof WORD_TREE !== 'undefined') {
    renderActivityCards(WORD_TREE, 'word-activities', 'word');
  }
  if (screenId === 'stem-world' && typeof STEM_TREE !== 'undefined') {
    renderActivityCards(STEM_TREE, 'stem-activities', 'stem');
  }
  if (screenId === 'garden') {
    if (typeof renderGardenIsland === 'function') renderGardenIsland();
    renderGarden();
  }
}

// === SKILL VIEW — Tabbed Learn / Explore / Quiz ===
function openSkillView(skillId, worldType) {
  playSound('click');

  // Record activity
  if (typeof recordSkillActivity === 'function') {
    recordSkillActivity(skillId, 'visit');
  }

  // Look up skill name/icon
  var allTrees = Object.assign({},
    typeof MATH_TREE !== 'undefined' ? MATH_TREE : {},
    typeof WORD_TREE !== 'undefined' ? WORD_TREE : {},
    typeof STEM_TREE !== 'undefined' ? STEM_TREE : {}
  );
  var skill = allTrees[skillId];
  var skillName = skill ? skill.icon + ' ' + skill.name : skillId;

  // Get lesson, flashcards
  var lesson = null;
  var flashcards = null;

  if (worldType === 'math') {
    if (typeof getMathLesson === 'function') lesson = getMathLesson(skillId);
    if (typeof getMathFlashcards === 'function') flashcards = getMathFlashcards(skillId);
  } else if (worldType === 'word') {
    if (typeof getWordLesson === 'function') lesson = getWordLesson(skillId);
    if (typeof getWordFlashcards === 'function') flashcards = getWordFlashcards(skillId);
  } else if (worldType === 'stem') {
    if (typeof getStemLesson === 'function') lesson = getStemLesson(skillId);
    if (typeof getStemFlashcards === 'function') flashcards = getStemFlashcards(skillId);
  }

  var hasLesson = !!lesson;
  var hasFlashcards = flashcards && flashcards.length > 0;
  var s = getSkillState(skillId);
  var lessonDone = s.lessonViewed && s.lessonViewed[skillId];

  // If no lesson and no flashcards, go straight to quiz
  if (!hasLesson && !hasFlashcards) {
    startGame(skillId, worldType);
    return;
  }

  // Build the skill view screen
  showScreen('skill-view');

  var container = document.getElementById('skill-view-content');
  if (!container) return;

  // Render tab header
  var html = '';
  html += '<div class="skill-view-header">';
  html += '<button class="back-btn" id="skill-view-back">&#8592; Back</button>';
  html += '<div class="skill-view-title">' + skillName + '</div>';
  html += '</div>';

  // Tabs
  html += '<div class="skill-tabs">';
  if (hasLesson) {
    html += '<button class="skill-tab active" data-tab="learn">';
    html += '<span class="skill-tab-icon">📖</span>';
    html += '<span>Learn</span>';
    if (lessonDone) html += '<span class="skill-tab-check">✓</span>';
    html += '</button>';
  }
  if (hasFlashcards) {
    html += '<button class="skill-tab' + (!hasLesson ? ' active' : '') + '" data-tab="flashcards">';
    html += '<span class="skill-tab-icon">🃏</span>';
    html += '<span>Cards</span>';
    html += '</button>';
  }
  html += '<button class="skill-tab' + (!hasLesson && !hasFlashcards ? ' active' : '') + '" data-tab="quiz">';
  html += '<span class="skill-tab-icon">⚡</span>';
  html += '<span>Quiz</span>';
  html += '</button>';
  html += '</div>';

  // Tab content area
  html += '<div class="skill-tab-content" id="skill-tab-content"></div>';

  container.innerHTML = html;

  // Back button
  document.getElementById('skill-view-back').onclick = function() {
    var worldMap = { math: 'math-world', word: 'word-world', stem: 'stem-world' };
    showScreen(worldMap[worldType] || 'home');
  };

  // Tab switching
  var tabs = container.querySelectorAll('.skill-tab');
  tabs.forEach(function(tab) {
    tab.onclick = function() {
      tabs.forEach(function(t) { t.classList.remove('active'); });
      tab.classList.add('active');
      showTabContent(tab.dataset.tab);
    };
  });

  function showTabContent(tabName) {
    var content = document.getElementById('skill-tab-content');
    content.innerHTML = '';

    if (tabName === 'learn' && hasLesson) {
      renderLesson(content, lesson, skillId, function() {
        // After lesson, switch to explore or quiz
        var nextTab = hasFlashcards ? 'flashcards' : 'quiz';
        tabs.forEach(function(t) { t.classList.remove('active'); });
        container.querySelector('[data-tab="' + nextTab + '"]').classList.add('active');
        // Update learn tab checkmark
        var learnTab = container.querySelector('[data-tab="learn"]');
        if (learnTab && !learnTab.querySelector('.skill-tab-check')) {
          learnTab.insertAdjacentHTML('beforeend', '<span class="skill-tab-check">✓</span>');
        }
        showTabContent(nextTab);
      });
      if (typeof recordSkillActivity === 'function') {
        recordSkillActivity(skillId, 'learn');
      }
    } else if (tabName === 'flashcards' && hasFlashcards) {
      renderFlashcards(content, flashcards, skillId, function() {
        tabs.forEach(function(t) { t.classList.remove('active'); });
        container.querySelector('[data-tab="quiz"]').classList.add('active');
        showTabContent('quiz');
      });
      if (typeof recordSkillActivity === 'function') {
        recordSkillActivity(skillId, 'explore');
      }
    } else if (tabName === 'quiz') {
      // Show quiz in the tab content area
      content.innerHTML = '<div class="skill-quiz-start">' +
        '<div class="skill-quiz-icon">⚡</div>' +
        '<div class="skill-quiz-title">Ready for the quiz?</div>' +
        '<div class="skill-quiz-desc">8 questions to test your understanding</div>' +
        '<button class="lesson-btn lesson-btn-done" id="start-quiz-btn">Start Quiz →</button>' +
        '</div>';
      document.getElementById('start-quiz-btn').onclick = function() {
        startGame(skillId, worldType);
      };
    }
  }

  // Show initial tab
  var initialTab = hasLesson ? 'learn' : (hasFlashcards ? 'flashcards' : 'quiz');
  showTabContent(initialTab);
}

// === GAME ENGINE ===
function startGame(skillId, worldType) {
  playSound('click');
  currentGame = {
    skillId,
    worldType: worldType || 'math',
    questions: [],
    currentIndex: 0,
    totalQuestions: 8,
    results: [],
    currentConfidence: -1,
    hintShown: false,
    attempts: 0,
    _startTime: Date.now()
  };

  // Generate questions
  for (let i = 0; i < currentGame.totalQuestions; i++) {
    currentGame.questions.push(generateQuestion(skillId, worldType));
  }

  // Set title
  const allTrees = Object.assign({},
    typeof MATH_TREE !== 'undefined' ? MATH_TREE : {},
    typeof WORD_TREE !== 'undefined' ? WORD_TREE : {},
    typeof STEM_TREE !== 'undefined' ? STEM_TREE : {}
  );
  const skill = allTrees[skillId];
  document.getElementById('game-title').textContent = skill ? skill.icon + ' ' + skill.name : skillId;

  showScreen('game');
  renderGameDots();
  renderCurrentQuestion();
}

function exitGame() {
  const worldMap = {
    math: 'math-world',
    word: 'word-world',
    stem: 'stem-world'
  };
  showScreen(worldMap[currentGame.worldType] || 'home');
  saveState();
}

function renderGameDots() {
  const dots = document.getElementById('game-dots');
  if (!dots) return;
  dots.innerHTML = '';
  for (let i = 0; i < currentGame.totalQuestions; i++) {
    const dot = document.createElement('div');
    dot.className = 'game-dot';
    if (i < currentGame.currentIndex) {
      dot.className += currentGame.results[i] ? ' done' : ' wrong';
    } else if (i === currentGame.currentIndex) {
      dot.className += ' current';
    }
    dots.appendChild(dot);
  }
}

function renderCurrentQuestion() {
  if (currentGame.currentIndex >= currentGame.totalQuestions) {
    endGame();
    return;
  }

  currentGame.currentConfidence = -1;
  currentGame.hintShown = false;
  currentGame.attempts = 0;

  const q = currentGame.questions[currentGame.currentIndex];
  const card = document.getElementById('question-card');

  card.innerHTML = '';
  card.style.animation = 'none';
  card.offsetHeight;
  card.style.animation = 'slide-up 0.4s ease-out';

  // Route to appropriate renderer
  if (typeof renderMathQuestion === 'function' && renderMathQuestion(card, q)) return;
  if (typeof renderWordQuestion === 'function' && renderWordQuestion(card, q)) return;
  if (typeof renderScienceQuestion === 'function' && renderScienceQuestion(card, q)) return;
  if (typeof renderCodeQuestion === 'function' && renderCodeQuestion(card, q)) return;

  // Fallback generic MCQ
  renderGenericMCQ(card, q);
}

function renderGenericMCQ(card, q) {
  let html = '<div class="question-text">' + (q.text || 'Question') + '</div>';
  if (q.options) {
    html += '<div class="answer-options mt-2">' + q.options.map(function(o) {
      return '<button class="answer-btn" onclick="checkAnswer(\'' + o + '\', \'' + q.answer + '\', this)">' + o + '</button>';
    }).join('') + '</div>';
  }
  card.innerHTML = html;
}

function nextQuestion() {
  document.getElementById('feedback-overlay').classList.add('hidden');
  currentGame.currentIndex++;
  renderGameDots();
  renderCurrentQuestion();
}

function endGame() {
  const correct = currentGame.results.filter(r => r).length;
  const total = currentGame.results.length;
  const pct = Math.round(correct / total * 100);
  state.sessionsCompleted++;

  // Achievement & quest hooks
  if (typeof checkAchievementsAfterQuiz === 'function') {
    checkAchievementsAfterQuiz(currentGame.results, currentGame.skillId, currentGame.worldType);
  }
  if (correct === total && total >= 8 && typeof questRecordPerfect === 'function') {
    questRecordPerfect();
  }
  if (typeof lumiReactTo === 'function') {
    lumiReactTo('quizComplete', { pct: pct });
  }

  const overlay = document.getElementById('feedback-overlay');
  const card = document.getElementById('feedback-card');

  let html = '';
  if (pct >= 80) {
    html += '<div class="feedback-icon">\uD83C\uDFC6</div>';
    html += '<div class="feedback-title" style="color:var(--gold)">Amazing, Anastasia!</div>';
    playSound('levelup');
    spawnParticles(window.innerWidth / 2, window.innerHeight / 3, 20, '\u2728');
  } else if (pct >= 50) {
    html += '<div class="feedback-icon">\uD83C\uDF1F</div>';
    html += '<div class="feedback-title" style="color:var(--mint)">Great effort!</div>';
  } else {
    html += '<div class="feedback-icon">\uD83C\uDF31</div>';
    html += '<div class="feedback-title" style="color:var(--lavender)">Keep growing!</div>';
  }

  html += '<div class="feedback-message">' + correct + ' out of ' + total + ' correct (' + pct + '%)</div>';

  const skill = getSkillState(currentGame.skillId);
  html += '<div style="margin:16px 0">';
  html += '<div style="font-size:14px;color:var(--text-secondary);margin-bottom:6px">Mastery Level</div>';
  html += '<div class="skill-bar" style="width:200px;margin:0 auto;height:12px">';
  html += '<div class="skill-bar-fill" style="width:' + skill.mastery + '%"></div>';
  html += '</div>';
  html += '<div style="font-size:12px;color:var(--text-dim);margin-top:4px">' + skill.mastery + '%</div>';
  html += '</div>';

  if (pct === 100) {
    const bonus = 10;
    state.tokens += bonus;
    html += '<div class="feedback-tokens">\uD83C\uDF1F Perfect bonus: +' + bonus + ' \u2B50</div>';
  }

  html += '<div style="display:flex;gap:12px;justify-content:center;margin-top:16px">';
  html += '<button class="feedback-btn" onclick="startGame(\'' + currentGame.skillId + '\',\'' + currentGame.worldType + '\')" style="background:linear-gradient(135deg,var(--mint),var(--sky))">Play Again</button>';
  html += '<button class="feedback-btn" onclick="exitFromEnd()">Back to World</button>';
  html += '</div>';

  card.innerHTML = html;
  overlay.classList.remove('hidden');
  saveState();
}

function exitFromEnd() {
  document.getElementById('feedback-overlay').classList.add('hidden');
  exitGame();
}

function exitEscapeRoom() {
  if (typeof endEscapeRoom === 'function') endEscapeRoom();
  showScreen('home');
}

// === QUESTION GENERATOR DISPATCHER ===
function generateQuestion(skillId, worldType) {
  if (worldType === 'math' && typeof generateMathQuestion === 'function') {
    return generateMathQuestion(skillId);
  }
  if (worldType === 'word' && typeof generateWordQuestion === 'function') {
    return generateWordQuestion(skillId);
  }
  if (worldType === 'stem') {
    if (typeof generateScienceQuestion === 'function') {
      const sciResult = generateScienceQuestion(skillId);
      if (sciResult) return sciResult;
    }
    if (typeof generateCodeQuestion === 'function') {
      const codeResult = generateCodeQuestion(skillId);
      if (codeResult) return codeResult;
    }
  }
  // Fallback
  return { type: 'generic', text: 'Coming soon!', options: ['OK'], answer: 'OK' };
}

// === INIT ===
async function init() {
  await loadState();
  updateUI();

  // Visit streak tracking for achievements
  if (typeof checkVisitStreakAchievements === 'function') {
    checkVisitStreakAchievements();
  }

  // Initialize dynamic quests for today
  if (typeof getDailyQuest === 'function') getDailyQuest();
  if (typeof getWeeklyQuest === 'function') getWeeklyQuest();

  // Initialize Lumi with personality
  if (typeof initLumi === 'function') {
    initLumi();
  } else {
    // Fallback: basic greeting
    const hour = new Date().getHours();
    let greeting;
    if (hour < 12) greeting = 'Good morning, Anastasia! Ready to learn?';
    else if (hour < 17) greeting = 'Good afternoon, Anastasia! Let\'s have some fun!';
    else greeting = 'Good evening, Anastasia! Time for a brain workout!';

    const today = new Date().toDateString();
    if (state.lastVisit === today) {
      greeting = pick([
        'Welcome back, Anastasia! Your garden missed you!',
        'Hey Anastasia! Let\'s pick up where you left off!',
        'You\'re back! Lumi is so happy to see you!'
      ]);
    } else if (state.lastVisit) {
      greeting = 'Welcome back, Anastasia! I\'ve been waiting for you!';
    }
    lumiSay(greeting);
  }

  state.lastVisit = new Date().toDateString();
  saveState();

  showScreen('home');
}

// Run!
init();
</script>

</body>
</html>
